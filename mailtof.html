<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mail-To Simplifi√©</title>
  <link rel="icon" type="image/jpeg" href="logo.png">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f9;
      padding: 30px;
    }
    h2 {
      color: #1a237e;
      margin-bottom: 10px;
    }
    .container {
      max-width: 650px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .email-list {
      margin: 20px 0;
      padding: 10px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 10px;
    }
    .email-list label {
      display: block;
      margin-bottom: 8px;
    }
    textarea, input[type="email"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 10px;
      font-size: 15px;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
    }
    button:hover { background-color: #1d4ed8; }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #bubble-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
      align-items: flex-end;
    }
    .bubble {
      max-width: 300px;
      padding: 10px 15px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .administratif { background: #2196F3; }
    .alerte { background: #f44336; }

.modalna {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(5px); /* flou de l'√©cran */
  z-index: 9999;
}

.modalna .card {
  background: #fff;
  padding: 24px 32px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modalna h2 {
  color: #d32f2f; /* rouge pour danger/erreur */
  margin-bottom: 12px;
}

.modalna p {
  font-size: 16px;
  margin-bottom: 20px;
}

.modalna .btn {
  padding: 10px 20px;
  font-size: 14px;

	#loadingModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      justify-content: center;
      align-items: center;
      z-index: 200;
    }

   .modal-content {
  background: white;
  border-radius: 12px;
  padding: 24px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  animation: fadeIn 0.3s ease-out;
  text-align: center;         
  display: flex;
  flex-direction: column;
  align-items: center;        
  justify-content: center;   
}

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
.loader-wrapper {
  position: relative;
  width: 100px;
  height: 100px;
  margin: auto;
}

.loader-logo {
  position: absolute;
  top: 50%;
  left: 50%;
  height: 55px;
  transform: translate(-50%, -50%);
  z-index: 2;
}

.loader-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 90px;
  height: 90px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #2563eb;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  animation: spin 1s linear infinite;
  z-index: 1;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

  </style>
</head>
<body>
  <div class="container">
    <h2>üìß Envoyer un email</h2>
    <p>S√©lectionnez les destinataires et r√©digez votre message :</p>

    <div class="email-list" id="emailList"></div>

    <label>
      <strong><label><input type="checkbox" id="otherEmailCheck"> <strong>Autre email :</strong></label>
      <input type="email" id="otherEmailInput" placeholder="exemple@mail.com" disabled></strong>
    </label>

    <label style="margin-top:20px;">
      <strong>Message :</strong>
      <textarea id="messageText" rows="7" placeholder="Votre message..."></textarea>
    </label>

    <button id="btnEnvoyerMail">Envoyer</button>
<div id="loadingModal">
  <div class="modal-content">

    <div class="loader-wrapper">
      <img src="https://junior2704.github.io/urgences-/logo.png" class="loader-logo" alt="Logo">
      <div class="loader-ring"></div>
    </div>

    <p>Envoi en cours...</p>
  </div>
</div>


  </div>
<div id="modal-no-access" class="modalna">
  <div class="card">
    <h2>‚õîÔ∏è Acc√®s refus√©</h2>
    <p>Vous n‚Äôavez pas acc√®s √† cette page.</p>
  </div>
</div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
      authDomain: "urgences-a8ed4.firebaseapp.com",
      projectId: "urgences-a8ed4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
const otherCheck = document.getElementById("otherEmailCheck");
const otherInput = document.getElementById("otherEmailInput");
if (otherCheck && otherInput) {
  otherCheck.addEventListener("change", (e) => {
    otherInput.disabled = !e.target.checked;
    if (!e.target.checked) otherInput.value = "";
  });
}
const show = id => document.getElementById(id).style.display = "flex";
    const hide = id => document.getElementById(id).style.display = "none";
    const patientId = new URLSearchParams(window.location.search).get("id");
    let destinataires = [];

    const emailList = document.getElementById("emailList");

    function afficherBulle(texte, type) {
      let c = document.getElementById("bubble-container");
      if (!c) { c = document.createElement("div"); c.id = "bubble-container"; document.body.appendChild(c); }
      const b = document.createElement("div");
      b.className = "bubble " + type;
      b.textContent = texte;
      c.appendChild(b);
      setTimeout(() => b.remove(), 3000);
    }

    if (patientId) {
      db.collection("patients").doc(patientId).get().then(doc => {
        if (doc.exists) {
          let emailsString = doc.data().email || "";
          const emails = emailsString.split("//").filter(e => e.includes("@"));

          if (emails.length === 0) {
            emailList.innerHTML = `<p style='color:#777;'>Aucune adresse enregistr√©e.</p>`;
          } else {
            emails.forEach(email => {
              emailList.innerHTML += `<label><input type='checkbox' value='${email}' checked> ${email}</label>`;
            });
          }
        }
      });
    }

    document.getElementById("btnEnvoyerMail").addEventListener("click", async () => {
	
      const checked = document.querySelectorAll("#emailList input:checked");
      destinataires = Array.from(checked).map(cb => cb.value.trim());

const other = document.getElementById("otherEmailCheck").checked
  ? document.getElementById("otherEmailInput").value.trim()
  : "";
      if (other) destinataires.push(other);

      if (destinataires.length === 0) {
        return alert("Veuillez s√©lectionner au moins une adresse email.");
      }

      const message = document.getElementById("messageText").value.trim();
      if (!message) return alert("Veuillez r√©diger un message.");

show("loadingModal");
      const comptesEmailJS = [
        { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
        { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
        { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
      ];

            const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Message du Service des Urgences</title>
</head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI',Roboto,Arial,sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#0057a4; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.png" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>
    <tr>
      <td style="padding:30px;">
        <div style="font-size:15px; line-height:1.6; color:#555;">${message.replace(/\n/g,"<br>")}</div>
        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

      for (const email of destinataires) {
        let envoy√© = false;
        for (const compte of comptesEmailJS) {
          try {
            await emailjs.send(compte.serviceID, compte.templateID, {
              to_email: email,
              html_message: htmlMessage,
              subject: "Message du Service des Urgences"
            }, compte.publicKey);
            afficherBulle(`üì® Message envoy√© √† ${email}`, "administratif");
            envoy√© = true;
			hide("loadingModal");
            break;
          } catch (err) {
            console.warn("√âchec avec", compte.serviceID, err.text || err);
          }
        }
        if (!envoy√©) afficherBulle(`‚ùå √âchec d'envoi √† ${email}`, "alerte");
		hide("loadingModal");
      }

      
    });
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const docRef = doc(db, "medecins", user.uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
      window.location.href = "index.html";
      return;
    }

    const data = docSnap.data();
    const medecinNom = data.nom || "";
    const medecinSpecialite = data.specialite || "";
    const medecinLieu = data.lieu || "";

    // variables globales
    window.medecinNom = medecinNom;
    window.medecinSpecialite = medecinSpecialite;
    window.medecinLieu = medecinLieu;

   
const pages = data.pages || {};
    const currentPath = window.location.pathname;
const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

// Mapping pour Firestore
const pageMapping = {
  "mailtof": "maito" 
};

const pageKey = pageMapping[currentPage] || currentPage;
console.log("Page actuelle :", currentPage);
console.log("Page Firestore :", pageKey);
if (!pages[pageKey]) {
  const modal = document.getElementById("modal-no-access");
  if (modal) modal.style.display = "flex";
  console.warn("Acc√®s refus√© √†", currentPage);
  return; // Stoppe l'ex√©cution pour ceux qui n'ont pas acc√®s
} else {
  console.log("Acc√®s autoris√© √†", currentPage);
  // Ici tu peux mettre tout le code sp√©cifique √† cette page
}

  } catch (error) {
    console.error("Erreur chargement m√©decin :", error);
    alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
  }
});
</script>
</body>
</html>
