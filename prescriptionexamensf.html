<!DOCTYPE html>
<html lang="fr">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üß™ Prescripteur d'Examens</title>
  <link rel="icon" type="image/jpeg" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<!-- EmailJS (fallback d'envoi d'e-mails multi-comptes) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f4f6f9;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007BFF;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .exam-button {
      background-color: #007BFF;
      color: white;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 16px;
    }
    .exam-button:hover {
      background-color: #0056b3;
    }
    .sub-list {
      display: none;
      margin-top: 10px;
      padding-left: 10px;
    }
    .sub-list label {
      display: block;
      margin: 5px 0;
      cursor: pointer;
    }
    .prescription-item {
      background: #eef;
      padding: 10px;
      margin: 5px 0;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
    }
    .btn-delete {
      background-color: red;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .ordonnance {
      margin-top: 30px;
      padding: 20px;
      background-color: #fafafa;
      border-radius: 12px;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .ordonnance h2 {
      font-size: 28px;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    .doctor-info, .patient-info, .date-info {
      margin-bottom: 10px;
      font-size: 16px;
      color: #555;
    }
    .buttons-wrapper::after {
      content: "";
      display: table;
      clear: both;
    }
    .btn-print {
      background-color: #007BFF;
      float: left;
    }
    .btn-download {
      background-color: #FFC107;
      float: right;
    }
    .btn-print, .btn-download {
      width: 48%;
      height: 50px;
      font-size: 16px;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      color: white;
      transition: background-color 0.3s;
    }
    #bubble-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
      align-items: flex-end;
    }
    .bubble {
      max-width: 300px;
      padding: 10px 15px;
      border-radius: 8px;
      color: white;
      font-family: sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: fadeout 0.5s ease-in-out 1.5s forwards;
    }
    .administratif {
      background-color: #007BFF;
    }
    .alerte {
      background-color: #f44336;
    }
    @keyframes fadeout {
      to {
        opacity: 0;
        transform: translateX(-20px);
      }
    }

       .back-button {
      display: block;
      margin: 0 auto 40px;
      background-color: #3182ce;
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      padding: 12px 28px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
      transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
    }

    .back-button:hover {
      background-color: #2b6cb0;
      box-shadow: 0 6px 16px rgba(44, 82, 130, 0.6);
      transform: translateY(-2px);
    }

    .back-button:active {
      transform: translateY(1px);
    }
    .hidden-field {
    display: none !important;
}
.modalna {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(5px); /* flou de l'√©cran */
  z-index: 9999;
}

.modalna .card {
  background: #fff;
  padding: 24px 32px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modalna h2 {
  color: #d32f2f; /* rouge pour danger/erreur */
  margin-bottom: 12px;
}

.modalna p {
  font-size: 16px;
  margin-bottom: 20px;
}

.modalna .btn {
  padding: 10px 20px;
  font-size: 14px;
}

  </style>

</head>
<body>
<div class="container">
  <h1>üß™ Prescripteur d'Examens</h1>
         <div class="form-group hidden-field">
  <div class="form-group">
    <label>Pr√©nom</label>
    <input type="text" id="patient-first-name" oninput="updateOrdonnance()">
  </div>
  <div class="form-group">
    <label>Nom</label>
    <input type="text" id="patient-last-name" oninput="updateOrdonnance()">
  </div>
  <div class="form-group">
    <label>Date de naissance</label>
    <input type="date" id="patient-birthdate" onchange="updateOrdonnance()">
  </div>
  <div class="form-group">
    <label>Sexe</label>
    <select id="sexe" onchange="updateOrdonnance()">
      <option value="M">M</option>
      <option value="Mme">Mme</option>
      <option value="L'enfant">L'enfant</option>
    </select>
  </div>
</div>
  <!-- Boutons d'examens -->
  <button class="exam-button" onclick="toggleSublist('prise-sang-list')">ü©∏ Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (Num√©ration Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Calc√©mie"> Calc√©mie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan h√©patique"> Bilan h√©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan r√©nal"> Bilan r√©nal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="H√©moglobine glyqu√©e (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="S√©rologies virales (VIH, VHB, VHC)"> S√©rologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('radio-list')">üì∏ Radiologie</button>
  <div class="sub-list" id="radio-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du cr√¢ne"> Cr√¢ne</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('urine-list')">üß™ Examens urinaires</button>
  <div class="sub-list" id="urine-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobact√©riologique des urines)"> ECBU</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Prot√©inurie des 24h"> Prot√©inurie 24h</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage cr√©atinine urinaire"> Cr√©atinine urinaire</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('irm-list')">üß≤ IRM</button>
  <div class="sub-list" id="irm-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM c√©r√©brale"> C√©r√©brale</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM √©paule"> √âpaule</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('scanner-list')">üñ•Ô∏è Scanner</button>
  <div class="sub-list" id="scanner-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner c√©r√©bral"> C√©r√©bral</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner c√©r√©bral"> Angioscanner c√©r√©bral</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('echo-list')">üß≠ √âchographie</button>
  <div class="sub-list" id="echo-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie abdominale"> Abdominale</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie pelvienne"> Pelvienne</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie r√©nale"> R√©nale</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie h√©patique"> H√©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie thyro√Ødienne"> Thyro√Ødienne</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie mammaire"> Mammaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie testiculaire"> Testiculaire</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie cardiaque (ETT)"> Cardiaque (ETT)</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres inf√©rieurs"> Doppler veineux MI</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler art√©riel des membres inf√©rieurs"> Doppler art√©riel MI</label>
  </div>

  <button class="exam-button" onclick="toggleSublist('eos-list')">ü¶¥ EOS</button>
  <div class="sub-list" id="eos-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres inf√©rieurs"> Membres inf√©rieurs</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres sup√©rieurs"> Membres sup√©rieurs</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
  </div>
  <br><br>
  <div class="form-group hidden-field">
  <label for="commentaireExamen">üí¨ Commentaire</label><br>
  <textarea id="commentaireExamen" placeholder="D√©tails suppl√©mentaires..." oninput="updateOrdonnance()"></textarea>
</div>
  <div id="prescription-list" class="prescription-list"></div>

<!-- Bouton de validation -->
<div class="d-grid mb-3" style="margin-top:20px; text-align:center;">
  <button id="btnValiderPrescription" type="button" class="exam-button"
          style="background:#2563eb; color:white; padding:14px; font-size:18px; border-radius:10px;"
          onclick="validerPrescription()">
    üìù Valider & enregistrer la prescription
  </button>
</div>

<!-- Zone affich√©e apr√®s validation -->
<div id="postValidationActions" style="display:none; margin-top:20px; text-align:center;">
  <h3>‚úî Prescription valid√©e</h3>
<button type="button" class="exam-button" style="background:#16a34a; margin:8px 6px;" onclick="imprimer()">
     üñ®Ô∏è Imprimer la prescription
  </button>
 
  <button type="button" class="exam-button" style="background:#16a34a; margin:8px 6px;" onclick="telechargerPrescription()">
    üì• T√©l√©charger la prescription
  </button>

  <button type="button" class="exam-button" id="btnOpenEmailModal" style="background:#0ea5e9; margin:8px 6px;">
    ‚úâ Envoyer par e-mail
  </button>
</div>
 </div> 
<!-- ===== Modal s√©lection e-mails ===== -->
<!-- ===== Modal s√©lection e-mails ===== -->
<div id="emailSelectModal" style="display:none; position: fixed; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(6px); justify-content:center; align-items:center; z-index:200;">
  <div class="modal-content" style="width:380px; max-width:90%; background:white; border-radius:16px; padding:20px;">
    <h3 style="text-align:center; margin-top:0;">üìß Choisissez les destinataires</h3>

    <div id="emailCheckboxes" style="margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto; padding-right:6px;"></div>

    <hr style="margin:12px 0;">

    <label style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
      <input type="checkbox" id="otherEmailCheck"> Autre destinataire :
    </label>
    <input type="email" id="otherEmailInput" placeholder="exemple@mail.com" disabled style="margin-top:6px; width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1;">

    <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
      <button onclick="closeEmailSelectModal()" style="background:#e2e8f0; padding:8px 12px; border-radius:8px; border:none;">Annuler</button>
      <button id="confirmEmails" style="background:#2563eb; color:white; padding:8px 12px; border-radius:8px; border:none;">Envoyer</button>
    </div>
  </div>
</div>



<div id="notification-container" style="position:fixed; top:12px; right:12px; z-index:99999;"></div>



<div id="bubble-container"></div>
<div id="modal-no-access" class="modalna">
  <div class="card">
    <h2>‚õîÔ∏è Acc√®s refus√©</h2>
    <p>Vous n‚Äôavez pas acc√®s √† cette page.</p>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "accueil.html";
    return;
  }

  try {
    const docRef = doc(db, "medecins", user.uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
      window.location.href = "accueil.html";
      return;
    }

    const data = docSnap.data();
    const medecinNom = data.nom || "";
    const medecinSpecialite = data.specialite || "";
    const medecinLieu = data.lieu || "";

    // variables globales
    window.medecinNom = medecinNom;
    window.medecinSpecialite = medecinSpecialite;
    window.medecinLieu = medecinLieu;

   
const pages = data.pages || {};
    const currentPath = window.location.pathname;
const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

// Mapping pour Firestore
const pageMapping = {
  "prescriptionexamensf": "prescriptionexamens" // Ordonnancierf.html utilise les droits de Ordonnancier
};

const pageKey = pageMapping[currentPage] || currentPage;
console.log("Page actuelle :", currentPage);
console.log("Page Firestore :", pageKey);
if (!pages[pageKey]) {
  const modal = document.getElementById("modal-no-access");
  if (modal) modal.style.display = "flex";
  console.warn("Acc√®s refus√© √†", currentPage);
  return; // Stoppe l'ex√©cution pour ceux qui n'ont pas acc√®s
} else {
  console.log("Acc√®s autoris√© √†", currentPage);
  // Ici tu peux mettre tout le code sp√©cifique √† cette page
}

  } catch (error) {
    console.error("Erreur chargement m√©decin :", error);
    alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
  }
});
</script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Pr√©-remplissage patient depuis URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

if(patientId){
  db.collection("patients").doc(patientId).get().then(doc=>{
    if(doc.exists){
      const data = doc.data();
      document.getElementById("patient-first-name").value = data.prenom || "";
      document.getElementById("patient-last-name").value = data.nom || "";
      document.getElementById("sexe").value = data.sexe || "M";
      const naissance = data.dateNaissance;
      if(naissance instanceof firebase.firestore.Timestamp){
        document.getElementById("patient-birthdate").valueAsDate = naissance.toDate();
      } else if(typeof naissance === "string"){
        document.getElementById("patient-birthdate").value = naissance;
      }
      updateOrdonnance();
    }
  });
}
function imprimer() {
    // V√©rifie que l'ID du document existe
    if (!window.pdfIdExistante) {
        afficherBulle("‚ùå Aucun document disponible pour impression", "alerte");
        return;
    }

    // Envoie le message au parent pour ouvrir un nouvel onglet
    window.parent.postMessage(
        {
            type: "OPEN_TAB",
            title: "Prescription",
            url: `viewer.html?docId=${window.pdfIdExistante}` // URL avec l'ID existant
        },
        "*"
    );
}

function toggleSublist(listId){
  const sublist = document.getElementById(listId);
  sublist.style.display = sublist.style.display === "block" ? "none" : "block";
}

function toggleExam(checkbox){
  const exam = checkbox.value;  // <-- corrige ici
  
  const prescriptionList = document.getElementById("prescription-list");

  if (checkbox.checked) {

    const div = document.createElement("div");
    div.className = "prescription-item";
    div.dataset.exam = exam;

    div.innerHTML = `
      <div style="display:flex; flex-direction:column; width:100%;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span><strong>${exam}</strong></span>

          <button onclick="removeExam('${exam}')"
                  style="border:none; background:transparent; font-size:20px; cursor:pointer;">√ó</button>
        </div>

        <textarea 
          class="comment-exam"
          placeholder="Commentaire pour cet examen‚Ä¶"
          data-comment-for="${exam}"
          style="margin-top:6px; padding:6px; border-radius:6px; border:1px solid #ccc; width:100%; min-height:45px;"></textarea>
      </div>
    `;

    prescriptionList.appendChild(div);

  } else {
    Array.from(prescriptionList.children).forEach(child => {
      if (child.dataset.exam === exam) prescriptionList.removeChild(child);
    });
  }

  checkIfPrescriptionsRemain();
  updateOrdonnance();
}


function removeExam(exam){
  const prescriptionList = document.getElementById("prescription-list");

  Array.from(prescriptionList.children).forEach(div => {
    if (div.dataset.exam === exam) div.remove();
  });

  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    if (cb.value === exam) cb.checked = false;
  });

  checkIfPrescriptionsRemain();
  updateOrdonnance();
}

function checkIfPrescriptionsRemain(){
  const ordonnance = document.getElementById("ordonnance");
  const buttonsWrapper = ordonnance.querySelector(".buttons-wrapper");
  if(document.getElementById("prescription-list").children.length > 0){
    ordonnance.style.display = "block";
    buttonsWrapper.style.display = "block";
  } else {
    ordonnance.style.display = "none";
    buttonsWrapper.style.display = "none";
  }
}


function telechargerExamens(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(18);
  doc.text("üß™ Prescription d'Examens", 105, 20, null, null, "center");
  doc.setFontSize(12);
  doc.text(`M√©decin: ${medecinNom} - ${medecinSpecialite}`, 10, 30);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, 10, 40);
  const patientName = document.getElementById("patient-first-name").value + " " + document.getElementById("patient-last-name").value;
  doc.text(`Patient: ${patientName}`, 10, 50);
  doc.text("Examens prescrits:", 10, 60);
  let y = 70;
  Array.from(document.getElementById("prescription-list").children).forEach(item=>{
    doc.text("- " + item.dataset.exam, 15, y);
    y += 10;
  });
  const commentaire = document.getElementById("commentaireExamen").value;
  if(commentaire){
    doc.text("Commentaire: " + commentaire, 10, y + 10);
  }
  doc.save("Prescription_Examens.pdf");
}

async function validerPrescription() {
  const prenom = document.getElementById("patient-first-name").value.trim();
  const nom = document.getElementById("patient-last-name").value.trim();

  if (!prenom || !nom) {
    afficherBulle("Veuillez remplir nom et pr√©nom du patient", "warning");
    return;
  }

  const nb = document.getElementById("prescription-list").children.length;
  if (nb === 0) {
    afficherBulle("Aucun examen s√©lectionn√©", "warning");
    return;
  }

  const pdfBase64 = await genererPrescription(false);

  const examensAvecCommentaires = Array.from(document.getElementById("prescription-list").children).map(div => {
  const exam = div.dataset.exam;
  const commentaire = div.querySelector(".comment-exam")?.value.trim() || "";
  return { examen: exam, commentaire: commentaire };
});


  const commentaire = document.getElementById("commentaireExamen").value.trim();
  const contenuFinal = items + (commentaire ? "\nCommentaire : " + commentaire : "");

  try {
    const idUnique = Math.random().toString(36).substring(2, 10);
    const dateCreation = new Date().toLocaleString("fr-FR");
    const prenom = document.getElementById("patient-first-name").value.trim();
    const nom = document.getElementById("patient-last-name").value.trim();
const fileName = `Prescription - ${prenom || ""} ${nom || ""}.pdf`;
window.pdfIdExistante = idUnique;
    await db.collection("documents").doc(idUnique).set({
      patientId: patientId,
      nomFicher: fileName,
      dateCreation: dateCreation,
      type: "Prescription d‚Äôexamens",
      contenu: examensAvecCommentaires,
      pdfBase64: pdfBase64
    });

    afficherBulle("‚úî Prescription enregistr√©e", "success");

  } catch (err) {
    console.error(err);
    afficherBulle("Erreur enregistrement Firestore", "alerte");
    return;
  }

  // D√©sactiver tout
  const allInputs = document.querySelectorAll("input, textarea, select, button");
  allInputs.forEach(el => {
    if (!el.closest("#postValidationActions") && !el.closest("#emailSelectModal")) {
      el.disabled = true;
    }
  });

  document.getElementById("btnValiderPrescription").style.display = "none";
  document.getElementById("postValidationActions").style.display = "block";
}
function telechargerPrescription() {
  genererPrescription(true);
  afficherBulle("üì• PDF t√©l√©charg√©", "success");
}
/* ---------- Notifications (comme Certificat) ---------- */
function afficherBulle(msg, type = 'info') {
  const container = document.getElementById('notification-container');
  if (!container) return;
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.padding = '10px 14px';
  el.style.borderRadius = '8px';
  el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
  el.style.fontSize = '14px';
  el.style.fontWeight = '500';
  el.style.opacity = '0';
  el.style.transform = 'translateY(-8px)';
  el.style.transition = 'opacity 0.25s, transform 0.25s';
  el.style.marginTop = '6px';
  switch (type) {
    case 'success': el.style.background = '#e6ffed'; el.style.color = '#064e22'; break;
    case 'alerte': case 'error': el.style.background = '#ffdede'; el.style.color = '#a00'; break;
    case 'warning': el.style.background = '#fff4e5'; el.style.color = '#663c00'; break;
    default: el.style.background = '#333'; el.style.color = '#fff'; break;
  }
  container.appendChild(el);
  requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(-8px)';
    el.addEventListener('transitionend', () => el.remove());
  }, 3000);
}

/* ---------- G√©n√©ration PDF (style certificat) ---------- */
async function genererPrescription(telecharger = false) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const prenom = document.getElementById("patient-first-name").value.trim();
    const nom = document.getElementById("patient-last-name").value.trim();
    const commentaire = document.getElementById("commentaireExamen").value.trim();

    // ent√™te bleu
    doc.setFillColor(52, 152, 219);
    doc.rect(0, 0, 210, 20, 'F');
    doc.setFontSize(20);
    doc.setTextColor(255,255,255);
    doc.text("Prescription d'examens", 105, 14, { align: "center" });

    doc.setTextColor(0,0,0);
    doc.setFontSize(14);
    doc.text(window.medecinNom || "Dr [Nom]", 20, 30);
    doc.text(window.medecinSpecialite || "[Sp√©cialit√©]", 20, 38);

    const currentDate = new Date().toLocaleDateString("fr-FR");
    doc.text(`Le ${currentDate}`, 150, 30);
    if (window.medecinLieu) doc.text(`√Ä ${window.medecinLieu}`, 150, 38);

    doc.setFontSize(12);
    doc.text(`Je soussign√©(e) ${window.medecinNom || "Dr [Nom]"}, prescris les examens suivants pour ${prenom} ${nom} :`, 20, 55);

    let y = 70;
    const items = Array.from(document.getElementById("prescription-list").children)
      .map(d => d.dataset.exam);

    const examensCommentes = Array.from(document.getElementById("prescription-list").children).map(div => {
  return {
    examen: div.dataset.exam,
    commentaire: div.querySelector(".comment-exam")?.value.trim() || ""
  };
});

examensCommentes.forEach(e => {
  const lines = doc.splitTextToSize(`- ${e.examen}`, 170);
  doc.text(lines, 20, y);
  y += lines.length * 8;

  if (e.commentaire) {
    const cLines = doc.splitTextToSize(`   Commentaire : ${e.commentaire}`, 160);
    doc.text(cLines, 25, y);
    y += cLines.length * 8;
  }
});


    if (commentaire) {
      const comY = y + 6;
      doc.text("Commentaire :", 20, comY);
      const comLines = doc.splitTextToSize(commentaire, 170);
      doc.text(comLines, 20, comY + 8);
      y = comY + comLines.length * 8 + 8;
    }

    doc.text(`Prescription remise en main propre le ${currentDate}.`, 20, y + 18);
    doc.text(`${window.medecinNom || "Dr [Nom]"}`, 150, y + 40);

    const pdfData = doc.output("datauristring");
    const base64 = pdfData.split(",")[1] || "";

    if (telecharger) {
      const fileName = `Prescription - ${prenom || ""} ${nom || ""}.pdf`;
      doc.save(fileName);
    }
    return base64;
  } catch (err) {
    console.error("Erreur g√©n√©ration prescription :", err);
    return "";
  }
}

/* ---------- Validation et enregistrement Firestore ---------- */
async function validerPrescription() {
  const prenom = document.getElementById("patient-first-name").value.trim();
  const nom = document.getElementById("patient-last-name").value.trim();

  if (!prenom || !nom) {
    afficherBulle("Veuillez remplir le nom et pr√©nom du patient", "warning");
    return;
  }
  const nb = document.getElementById("prescription-list").children.length;
  if (nb === 0) {
    afficherBulle("Aucun examen s√©lectionn√©", "warning");
    return;
  }

  afficherBulle("Enregistrement en cours...", "administratif");

  // G√©n√®re PDF base64 (sans t√©l√©chargement)
  const pdfBase64 = await genererPrescription(false);

  // contenu textuel
  const items = Array.from(document.getElementById("prescription-list").children)
    .map(d => d.dataset.exam)
    .join("\n");
  const commentaire = document.getElementById("commentaireExamen").value.trim();
  const contenuFinal = items + (commentaire ? "\nCommentaire : " + commentaire : "");

  try {
    // id unique pour le document (documents)
    const idUniqueDoc = Math.random().toString(36).substring(2, 10);
    const dateCreation = new Date().toLocaleString("fr-FR");

    // patientId est d√©fini plus haut dans ton fichier (const patientId = urlParams.get("id");)
    await db.collection("documents").doc(idUniqueDoc).set({
      patientId: patientId || null,
      dateCreation: dateCreation,
      type: "Prescription d‚Äôexamens",
      contenu: contenuFinal,
      pdfBase64: pdfBase64
    });

    afficherBulle("‚úÖ Prescription enregistr√©e", "success");

  } catch (err) {
    console.error("Erreur enregistrement prescription :", err);
    afficherBulle("‚ùå Erreur enregistrement", "alerte");
    return;
  }

  // verrouillage formulaire (sauf postValidationActions et modal)
  const allInputs = document.querySelectorAll("input, textarea, select, button");
  allInputs.forEach(el => {
    if (!el.closest("#postValidationActions") && !el.closest("#emailSelectModal")) {
      el.disabled = true;
    }
  });

  const btn = document.getElementById("btnValiderPrescription");
  if (btn) btn.style.display = "none";
  document.getElementById("postValidationActions").style.display = "block";
}

/* ---------- T√©l√©chargement apr√®s validation ---------- */
function telechargerPrescription() {
  genererPrescription(true);
  afficherBulle("üì• PDF t√©l√©charg√©", "success");
}

/* ---------- Modal e-mails : ouverture / remplissage / confirmation ---------- */
function openEmailSelectModalWithString(emailsString) {
  const modal = document.getElementById("emailSelectModal");
  const container = document.getElementById("emailCheckboxes");
  container.innerHTML = "";

  const emails = (emailsString || "").split("//").map(e=>e.trim()).filter(e => e.includes("@"));
  if (emails.length === 0) {
    container.innerHTML = "<p style='color:#777;'>Aucune adresse trouv√©e pour ce patient.</p>";
  } else {
    emails.forEach((email, i) => {
      const id = "emailCheck_" + i;
      const label = document.createElement("label");
      label.style.display = 'flex';
      label.style.alignItems = 'center';
      label.style.gap = '8px';
      label.style.padding = '8px 10px';
      label.style.borderRadius = '8px';
      label.style.background = '#f8fafc';
      label.style.border = '1px solid transparent';
      label.innerHTML = `<input type="checkbox" id="${id}" value="${email}" checked style="transform:scale(1.1); margin-right:6px;"> ${email}`;
      container.appendChild(label);
    });
  }

  document.getElementById("otherEmailCheck").checked = false;
  document.getElementById("otherEmailInput").value = "";
  document.getElementById("otherEmailInput").disabled = true;

  modal.style.display = "flex";
}

async function openEmailSelectModal() {
  if (!patientId) {
    openEmailSelectModalWithString("");
    return;
  }
  try {
    const docSnap = await db.collection("patients").doc(patientId).get();
    const emailsField = (docSnap.exists && docSnap.data().email) ? docSnap.data().email : "";
    openEmailSelectModalWithString(emailsField);
  } catch (err) {
    console.error("Erreur r√©cup√©ration emails patient :", err);
    openEmailSelectModalWithString("");
  }
}

function closeEmailSelectModal() {
  const modal = document.getElementById("emailSelectModal");
  if (modal) modal.style.display = "none";
}

/* active/d√©sactive champ "autre email" */
document.addEventListener('change', function(e) {
  if (e.target && e.target.id === 'otherEmailCheck') {
    document.getElementById('otherEmailInput').disabled = !e.target.checked;
  }
});

/* ---------- Envoi par e-mail (multi-compte EmailJS) ---------- */
async function envoyerPrescriptionParEmail(destinataires = []) {
  if (!Array.isArray(destinataires) || destinataires.length === 0) {
    afficherBulle("Aucun destinataire", "alerte"); return;
  }

  try {
    // G√©n√®re le PDF base64
    const pdfBase64 = await genererPrescription(false);

    // Cr√©e id unique pour liens_pdfs (√©vite collision)
    let idUnique, docSnap;
    do {
      idUnique = Math.random().toString(36).substring(2, 10);
      docSnap = await db.collection("liens_pdfs").doc(idUnique).get();
    } while (docSnap.exists);

    const prenom = document.getElementById("patient-first-name").value.trim();
    const nom = document.getElementById("patient-last-name").value.trim();
    const fileName = `Prescription - ${prenom} ${nom}.pdf`;

    // Enregistrement du base64 dans liens_pdfs (utilise nomFichier ici uniquement pour la page monpdf)
    await db.collection("liens_pdfs").doc(idUnique).set({
      base64: pdfBase64,
      nomFichier: fileName,
      dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
    });

    const lienPdf = `https://junior2704.github.io/GestUrg2/monpdf.html?id=${idUnique}`;

    // Template HTML adapt√©
           const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ordonnance m√©dicale</title>
</head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI', Roboto, Arial, sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#1a73e8; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/GestUrg2/logo.png" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>

    <tr>
      <td style="padding:30px;">
        <h2 style="color:#1a73e8; font-weight:600; margin-top:0;">Votre prescription d'examens</h2>

        <p style="font-size:16px; line-height:1.6;">
          Bonjour <strong>{{patient_prenom}} {{patient_nom}}</strong>,
        </p>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          Votre prescription pour un(des) examen(s) vient d‚Äô√™tre valid√©e par le m√©decin responsable et est d√©sormais disponible.
          Elle vous permettra de r√©aliser le ou les examen(s) demand√©(s). Pensez √† communiquer les r√©sultats √† votre m√©decin traitant !
        </p>

        <div style="text-align:center; margin:30px 0;">
          <a href="{{lien_compte_rendu}}" 
             style="background-color:#1a73e8; color:white; padding:14px 32px; text-decoration:none; border-radius:8px; font-weight:500; display:inline-block;">
            ü©ª Voir la prescription
          </a>
        </div>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          ‚ö†Ô∏è Ce lien reste actif 7 jours pour garantir la confidentialit√© de vos donn√©es.
          Au-del√†, le document sera automatiquement supprim√©.
        </p>

        <p style="font-size:14px; color:#777;">
          Pour toute question, merci de contacter le service des Urgences :
          <a href="mailto:urgences.hopj@gmail.com" style="color:#1a73e8;">urgences.hopj@gmail.com</a>
        </p>

        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

    // Multi-comptes EmailJS (fallback)
    const comptesEmailJS = [
      { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
      { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
      { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
    ];

    // Initialise EmailJS si pr√©sent
    if (window.emailjs && emailjs.init) {
      try { emailjs.init("CZapZCcxYfJ8-acLS"); } catch(e) { /* ignore */ }
    }

    for (const email of destinataires) {
      const emailTrim = email.trim();
      if (!emailTrim || !emailTrim.includes("@")) {
        afficherBulle(`Adresse invalide : ${emailTrim}`, "alerte");
        continue;
      }
      let envoye = false;
      for (const compte of comptesEmailJS) {
        try {
          // remplace variables dans template HTML si besoin
        
const htmlFinal = htmlMessage
  .replace(/{{patient_prenom}}/g, prenom)
  .replace(/{{patient_nom}}/g, nom)
  .replace(/{{lien_compte_rendu}}/g, lienPdf);
          // send via EmailJS
          if (!window.emailjs || !emailjs.send) throw new Error("EmailJS non charg√©");

          await emailjs.send(compte.serviceID, compte.templateID, {
            to_email: emailTrim,
            subject: "Votre prescription d'examens est disponible",
            html_message: htmlFinal
          }, compte.publicKey);

          afficherBulle(`üì® Envoy√© : ${emailTrim}`, "administratif");
          envoye = true;
          break;
        } catch (err) {
          console.warn("√âchec envoi via", compte.serviceID, err);
          // si quota, essaie le suivant, sinon arr√™te la boucle interne
          const texteErr = (err && err.text) ? err.text.toLowerCase() : String(err).toLowerCase();
          if (texteErr.includes("quota") || texteErr.includes("quota") || texteErr.includes("exceeded")) {
            continue; // essaie le compte suivant
          } else {
            // erreur fatale : on quitte l'essai de ce destinataire
            break;
          }
        }
      } // end comptes loop

      if (!envoye) {
        afficherBulle(`‚ùå √âchec d'envoi √† ${emailTrim}`, "alerte");
      }
    } // end destinataires loop

    afficherBulle("üì® Envois termin√©s !", "administratif");
  } catch (err) {
    console.error("Erreur envoyerPrescriptionParEmail :", err);
    afficherBulle("Erreur envoi", "alerte");
  }
}

/* ---------- Confirmation modale : collecte destinataires et envoi ---------- */
document.addEventListener('click', async function(e) {
  if (e.target && e.target.id === 'confirmEmails') {
    try {
      const checkedBoxes = document.querySelectorAll("#emailCheckboxes input[type='checkbox']:checked");
      let destinataires = Array.from(checkedBoxes).map(cb => cb.value.trim());

      const otherChecked = document.getElementById("otherEmailCheck").checked;
      const otherEmail = document.getElementById("otherEmailInput").value.trim();
      if (otherChecked && otherEmail) destinataires.push(otherEmail);

      if (destinataires.length === 0) {
        afficherBulle("Veuillez cocher au moins une adresse e-mail.", "warning");
        return;
      }

      closeEmailSelectModal();
      afficherBulle("Envoi en cours...", "administratif");
      await envoyerPrescriptionParEmail(destinataires);
    } catch (err) {
      console.error("Erreur confirmEmails :", err);
      afficherBulle("Erreur lors de l'envoi", "alerte");
    }
  }
});

/* ---------- Bind du bouton ouvrir modal (post-validation) ---------- */
document.addEventListener('click', function(e) {
  if (e.target && e.target.id === 'btnOpenEmailModal') {
    openEmailSelectModal();
  }
});

</script>


</body>
</html>




