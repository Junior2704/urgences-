<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/jpeg" href="logo.png">

<meta charset="UTF-8">
<title>Borne d’accueil – Urgences</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- QR Code JS -->
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>

<style>
:root{
  --blue:#0b5ed7;
  --bg:#f4f7fb;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Inter","Segoe UI",Arial,sans-serif;
  background:var(--bg);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#0b2240;
}

.card{
  background:var(--card);
  width:100%;
  max-width:520px;
  border-radius:20px;
  box-shadow:0 14px 35px rgba(0,0,0,.12);
  padding:30px;
  text-align:center;
}

h1{
  margin-top:0;
  font-size:2rem;
}

.motifs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:25px;
}

button{
  padding:18px;
  font-size:1.1rem;
  font-weight:600;
  border-radius:14px;
  border:none;
  cursor:pointer;
  background:var(--blue);
  color:white;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}


.numero{
  font-size:4rem;
  font-weight:800;
  color:#dc3545;
  margin:20px 0;
}

.footer{
  margin-top:20px;
  font-size:.9rem;
  color:#667;
}
/* ================= TICKET THERMIQUE 58mm ================= */
/* 🔒 Le ticket ne doit JAMAIS être visible à l'écran */
#ticket {
  display: none !important;
  visibility: hidden;
  height: 0;
  overflow: hidden;
}

@media print {



  @page {
    size: 58mm auto;
    margin: 0;
  }

  body {
    margin: 0;
    padding: 0;
  }

  /* Cache tout */
  body * {
    display: none !important;
  }

  /* 🔥 SAUF le ticket */
  #ticket,
  #ticket * {
    display: block !important;
    visibility: visible !important;
  }

  #ticket {
    position: absolute;
    top: 0;
    left: 0;
    width: 58mm;
  }



  .ticket-box {
  padding: 1.5mm 1.5mm;   /* optimal 58mm */
  box-sizing: border-box;
}


  .ticket-header {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .ticket-subheader {
    font-size: 11px;
    margin-bottom: 6px;
  }

  .ticket-numero {
    font-size: 40px;
    font-weight: bold;
    margin: 6px 0;
  }

  .ticket-details {
    font-size: 10px;
    margin-bottom: 6px;
  }

  .ticket-qr {
    width: 28mm;
    height: 28mm;
    margin: 6px auto;
  }

  .ticket-separator {
    font-size: 10px;
    margin: 4px 0;
  }

  .ticket-footer {
  font-size: 10px;   /* PAS moins */
  font-weight: bold;
}
.ticket-line {
  display: flex;
  justify-content: space-between;
  width: 100%;
  text-align: left;
}

.ticket-label {
  font-weight: bold;
  white-space: nowrap;
}

.ticket-value {
  font-weight: 800;
  font-size: 11px;
  text-align: right;
  max-width: 32mm;
  word-break: break-word;
}

}

.qr-container {
  margin-top: 20px;
  display: flex;
  justify-content: center; /* centre horizontalement */
  align-items: center;     /* centre verticalement si besoin */
  flex-direction: column;  /* pour que le bouton Merci reste en dessous */
}

.ticket-qr {
  display: block;
  margin: 10px auto;
  width: 30mm;
  height: 30mm;
}
/* ================= MODALE ATTENTE IMPRESSION ================= */

.modal-wait {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  width: 340px;
  padding: 32px 28px;
  border-radius: 22px;
  text-align: center;
  box-shadow: 0 30px 60px rgba(0,0,0,.35);
}

.modal-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.modal-box h2 {
  margin: 0;
  font-size: 1.5rem;
}

.modal-sub {
  margin: 6px 0 20px;
  color: #64748b;
  font-size: 1rem;
}

.modal-ticket {
  background: #f1f5f9;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 20px;
}

.modal-ticket .label {
  font-size: 0.9rem;
  color: #475569;
}

.modal-numero {
  font-size: 3.8rem;
  font-weight: 900;
  color: #dc2626;
  line-height: 1;
}

.modal-qr-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 18px;
}

#modal-qr {
  width: 140px;
  height: 140px;
}

.qr-text {
  font-size: 0.85rem;
  color: #475569;
  margin-top: 6px;
}

/* Loader moderne */
.loader {
  width: 36px;
  height: 36px;
  border: 4px solid #e5e7eb;
  border-top-color: #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}




</style>
</head>

<body>

<div class="card" id="borne">
  <h1>Bienvenue aux Urgences</h1>
  <p>Veuillez choisir le motif de votre venue</p>

  <div class="motifs">
  <button onclick="prendreTicket('Urgences diverses','general')">🩺 Urgences diverses</button>
  <button onclick="prendreTicket('Traumatologie','traumato')">🦴 Traumatologie</button>
  <button onclick="prendreTicket('Pédiatrie','pediatrie')">👶 Pédiatrie</button>

  <button onclick="prendreTicket('Gynécologie','gyneco')">🤰 Gynécologie</button>
  <button onclick="prendreTicket('Ophtalmologie','ophtalmo')">👁️ Ophtalmologie</button>
    <button onclick="prendreTicket('Administratif','admin')">📝 Administratif</button>
	  <button onclick="prendreTicket('Sortie','sortie')">🚪 Sortie</button>


  <button onclick="prendreTicket('Autres','autres')">❓ Autres</button>
  
</div>



<div class="modal-wait" id="modalWait">
  <div class="modal-box">

    <div class="modal-icon">🖨️</div>

    <h2>Impression en cours</h2>
    <p class="modal-sub">Veuillez patienter quelques instants</p>

    <div class="modal-ticket">
      <span class="label">Votre numéro</span>
      <div class="modal-numero" id="modalNumero">117</div>
    </div>

    <div class="modal-qr-wrapper">
      <canvas id="modal-qr"></canvas>
      <span class="qr-text">Suivre mon attente</span>
    </div>

    <div class="loader"></div>

  </div>
</div>



</div>
<div class="ticket" id="ticket">
  <div class="ticket-box">

    <div class="ticket-header">
      SERVICE DES URGENCES
    </div>

    <div class="ticket-numero" id="ticket-numero"></div>

    <div class="ticket-line">
      <span class="ticket-label">Motif :</span>
      <span class="ticket-value" id="ticketMotif"></span>
    </div>

    <div class="ticket-line">
      <span class="ticket-label">Date :</span>
      <span class="ticket-value" id="ticketDate"></span>
    </div>

    <canvas id="ticket-qr" class="ticket-qr"></canvas>

    <div class="ticket-footer">
      Ticket de passage – Urgences
    </div>

    <div class="ticket-footer">
      Merci de patienter en salle d’attente
    </div>

  </div>
</div>




<script>
// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let verrou = false;

// ================= PRENDRE TICKET =================
async function prendreTicket(motif, circuit){
  if(verrou) return;
  verrou = true;

  // 🔹 Masquer les boutons
  document.querySelector(".motifs").style.display = "none";

  try{
    // 🔢 Dernier numéro
    const snap = await db.collection("accueil-1")
      .orderBy("numero","desc")
      .limit(1)
      .get();

    let numero = 1;
    if(!snap.empty){
      numero = snap.docs[0].data().numero + 1;
    }

    const docRef = await db.collection("accueil-1").add({
      numero,
      motif,
      circuit,
      statut: "attente",
      dateArrivee: firebase.firestore.FieldValue.serverTimestamp(),
      dateArriveeClient: Date.now()
    });

    const idDoc = docRef.id;
    const qrLink = "https://junior2704.github.io/urgences-/mytickets?id=" + idDoc;

    
    // QR code pour le ticket
// QR code pour le ticket (taille réduite)
const qrTicket = new QRious({ 
  element: document.getElementById('ticket-qr'), 
  value: qrLink, 
  size: 120 // <- réduit ici, avant c'était 250
});

    // 🎟️ UI
    
    
    document.getElementById("ticket-numero").innerText = numero;
    document.getElementById("ticketMotif").innerText = motif;
 const now = new Date();
document.getElementById("ticketDate").innerText =
  now.toLocaleDateString("fr-FR") + " " +
  now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });

    // Ajoute le bouton sous le QR code
// ===== MODALE : numéro + QR =====
document.getElementById("modalNumero").innerText = numero;

// QR code pour la modale
new QRious({
  element: document.getElementById("modal-qr"),
  value: qrLink,
  size: 150
});



    // Impression automatique
    // Affiche la modale
document.getElementById("modalWait").style.display = "flex";
document.body.style.pointerEvents = "none";

// Lance l'impression
setTimeout(() => {
  window.print();
}, 500);

    // 🔁 Reset borne après 10s (au cas où le bouton n’est pas cliqué)
    setTimeout(() => location.reload(), 10000);

  } catch(e){
    alert("Erreur : " + e);
    verrou = false;
  }
}

</script>

</body>
</html>
