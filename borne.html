<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/jpeg" href="logo.png">

<meta charset="UTF-8">
<title>Borne d‚Äôaccueil ‚Äì Urgences</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- QR Code JS -->
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>

<style>
:root{
  --blue:#0b5ed7;
  --bg:#f4f7fb;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Inter","Segoe UI",Arial,sans-serif;
  background:var(--bg);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#0b2240;
}

.card{
  background:var(--card);
  width:100%;
  max-width:520px;
  border-radius:20px;
  box-shadow:0 14px 35px rgba(0,0,0,.12);
  padding:30px;
  text-align:center;
}

h1{
  margin-top:0;
  font-size:2rem;
}

.motifs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:25px;
}

button{
  padding:18px;
  font-size:1.1rem;
  font-weight:600;
  border-radius:14px;
  border:none;
  cursor:pointer;
  background:var(--blue);
  color:white;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.ticket{
  display:none;
}

.numero{
  font-size:4rem;
  font-weight:800;
  color:#dc3545;
  margin:20px 0;
}

.footer{
  margin-top:20px;
  font-size:.9rem;
  color:#667;
}
/* ================= TICKET THERMIQUE 58mm ================= */

.ticket {
  display: none;
}

@media print {

  @page {
    size: 58mm auto;
    margin: 0;
  }

  body {
    margin: 0;
    padding: 0;
  }

  body * {
    display: none !important;
  }

  .ticket,
  .ticket * {
    display: block !important;
  }

  .ticket {
    width: 58mm;
    margin: 0 auto;
  }

  .ticket-box {
    width: 58mm;
    padding: 4mm 3mm;
    font-family: "Courier New", monospace;
    text-align: center;
    color: #000;
  }

  .ticket-header {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 6px;
  }

  .ticket-numero {
    font-size: 44px;
    font-weight: bold;
    margin: 8px 0;
  }

  .ticket-details {
    font-size: 11px;
    margin-bottom: 6px;
  }

  .ticket-separator {
    font-size: 10px;
    margin: 6px 0;
  }

  .ticket-footer {
    font-size: 10px;
    margin-top: 6px;
  }
}
.qr-container {
  margin-top: 20px;
  display: flex;
  justify-content: center; /* centre horizontalement */
  align-items: center;     /* centre verticalement si besoin */
  flex-direction: column;  /* pour que le bouton Merci reste en dessous */
}

.ticket-qr {
  display: block;
  margin: 10px auto;
  width: 30mm;
  height: 30mm;
}



</style>
</head>

<body>

<div class="card" id="borne">
  <h1>Bienvenue aux Urgences</h1>
  <p>Veuillez choisir le motif de votre venue</p>

  <div class="motifs">
  <button onclick="prendreTicket('Urgences diverses','general')">ü©∫ Urgences diverses</button>
  <button onclick="prendreTicket('Traumatologie','traumato')">ü¶¥ Traumatologie</button>
  <button onclick="prendreTicket('P√©diatrie','pediatrie')">üë∂ P√©diatrie</button>

  <button onclick="prendreTicket('Gyn√©cologie','gyneco')">ü§∞ Gyn√©cologie</button>
  <button onclick="prendreTicket('Ophtalmologie','ophtalmo')">üëÅÔ∏è Ophtalmologie</button>
    <button onclick="prendreTicket('Administratif','admin')">üìù Administratif</button>
	  <button onclick="prendreTicket('Sortie','sortie')">üö™ Sortie</button>


  <button onclick="prendreTicket('Autres','autres')">‚ùì Autres</button>
  
</div>


  <div class="ticket" id="ticket">
    <h2>Votre num√©ro</h2>
    <div class="numero" id="numero"></div>
    <p>Merci de patienter jusqu‚Äô√† l‚Äôappel de votre num√©ro</p>
  </div>

  <div class="footer">
    Merci de pr√©parer vos documents administratifs
  </div>
  <div class="qr-container">
  <canvas id="qr"></canvas>
</div>
</div>
<div class="ticket" id="ticket">
  <div class="ticket-box">

    <div class="ticket-header">
      üè• SERVICE DES URGENCES
    </div>

    <div class="ticket-subheader">
      Centre Hospitalier
    </div>

    <div class="ticket-numero" id="ticket-numero"></div>

    <div class="ticket-details">
      <div><strong>Motif :</strong> <span id="ticketMotif"></span></div>
      <div><strong>Date & heure :</strong> <span id="ticketDate"></span></div>
    </div>
	<div class="ticket-footer">
      Suivez en temps r√©el votre attente <br>
	  en scannant le qr-code ci-dessous
    </div>
<canvas id="ticket-qr" class="ticket-qr"></canvas>

    <div class="ticket-separator">
      --------------------------------
    </div>

    <div class="ticket-footer">
      Ce ticket confirme votre prise en charge<br>
      par le service des urgences.
    </div>

    <div class="ticket-footer">
      Merci de patienter en salle d‚Äôattente.<br>
      Vous serez appel√©(e) d√®s que possible<br>
      selon le degr√© de priorit√© m√©dicale.
    </div>

    <div class="ticket-signature">
      Service des urgences
    </div>

  </div>
</div>





<script>
// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let verrou = false;

// ================= PRENDRE TICKET =================
async function prendreTicket(motif, circuit){
  if(verrou) return;
  verrou = true;

  // üîπ Masquer les boutons
  document.querySelector(".motifs").style.display = "none";

  try{
    // üî¢ Dernier num√©ro
    const snap = await db.collection("accueil-1")
      .orderBy("numero","desc")
      .limit(1)
      .get();

    let numero = 1;
    if(!snap.empty){
      numero = snap.docs[0].data().numero + 1;
    }

    const docRef = await db.collection("accueil-1").add({
      numero,
      motif,
      circuit,
      statut: "attente",
      dateArrivee: firebase.firestore.FieldValue.serverTimestamp(),
      dateArriveeClient: Date.now()
    });

    const idDoc = docRef.id;
    const qrLink = "https://junior2704.github.io/urgences-/mytickets?id=" + idDoc;

    // QR code pour la borne
    const qr = new QRious({ element: document.getElementById('qr'), value: qrLink, size: 150 });
    // QR code pour le ticket
// QR code pour le ticket (taille r√©duite)
const qrTicket = new QRious({ 
  element: document.getElementById('ticket-qr'), 
  value: qrLink, 
  size: 120 // <- r√©duit ici, avant c'√©tait 250
});

    // üéüÔ∏è UI
    document.getElementById("numero").innerText = numero;
    document.getElementById("ticket-numero").innerText = numero;
    document.getElementById("ticketMotif").innerText = "Motif : " + motif;

    const now = new Date();
    document.getElementById("ticketDate").innerText =
      now.toLocaleDateString("fr-FR") + " " +
      now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });

    document.getElementById("ticket").style.display = "block";

    // Cr√©e le bouton Merci dynamiquement
    const btnMerci = document.createElement("button");
    btnMerci.textContent = "Termin√© !";
    btnMerci.style.marginTop = "20px";
    btnMerci.style.backgroundColor = "#10b981";
    btnMerci.style.color = "white";
    btnMerci.style.padding = "12px 20px";
    btnMerci.style.fontSize = "1rem";
    btnMerci.style.border = "none";
    btnMerci.style.borderRadius = "10px";
    btnMerci.style.cursor = "pointer";

    // Au clic, reload de la page
    btnMerci.onclick = () => location.reload();

    // Ajoute le bouton sous le QR code
    document.querySelector(".qr-container").appendChild(btnMerci);

    // Impression automatique
    setTimeout(() => window.print(), 1000);

    // üîÅ Reset borne apr√®s 10s (au cas o√π le bouton n‚Äôest pas cliqu√©)
    setTimeout(() => location.reload(), 10000);

  } catch(e){
    alert("Erreur : " + e);
    verrou = false;
  }
}

</script>

</body>
</html>
