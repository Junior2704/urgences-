<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/jpeg" href="logo.png">

<meta charset="UTF-8">
<title>Borne d’accueil – Urgences</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- QR Code JS -->
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>

<style>
:root{
  --blue:#0b5ed7;
  --bg:#f4f7fb;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Inter","Segoe UI",Arial,sans-serif;
  background:var(--bg);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#0b2240;
}

.card{
  background:var(--card);
  width:100%;
  max-width:520px;
  border-radius:20px;
  box-shadow:0 14px 35px rgba(0,0,0,.12);
  padding:30px;
  text-align:center;
}

h1{
  margin-top:0;
  font-size:2rem;
}

.motifs{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:25px;
}

button{
  padding:18px;
  font-size:1.1rem;
  font-weight:600;
  border-radius:14px;
  border:none;
  cursor:pointer;
  background:var(--blue);
  color:white;
}

button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.ticket{
  display:none;
}

.numero{
  font-size:4rem;
  font-weight:800;
  color:#dc3545;
  margin:20px 0;
}

.footer{
  margin-top:20px;
  font-size:.9rem;
  color:#667;
}
/* ================= TICKET THERMIQUE 58mm ================= */

.ticket {
  display: none;
}

@media print {

  @page {
    size: 58mm auto;
    margin: 0;
  }

  body {
    margin: 0;
    padding: 0;
  }

  body * {
    display: none !important;
  }

  #ticket,
  #ticket * {
    display: block !important;
  }

  #ticket {
    width: 58mm;
    margin: 0 auto;
  }

  .ticket-box {
    width: 100%;
    padding: 2mm;
    font-family: "Courier New", monospace;
    text-align: center;
    color: #000;
  }

  .ticket-header {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .ticket-subheader {
    font-size: 11px;
    margin-bottom: 6px;
  }

  .ticket-numero {
    font-size: 40px;
    font-weight: bold;
    margin: 6px 0;
  }

  .ticket-details {
    font-size: 10px;
    margin-bottom: 6px;
  }

  .ticket-qr {
    width: 28mm;
    height: 28mm;
    margin: 6px auto;
  }

  .ticket-separator {
    font-size: 10px;
    margin: 4px 0;
  }

  .ticket-footer {
  font-size: 10px;   /* PAS moins */
  font-weight: bold;
}
.ticket-line {
  font-size: 10px;
  margin-bottom: 3px;
}

.ticket-label {
  font-weight: bold;
}

.ticket-value {
  font-weight: 800;      /* TRÈS IMPORTANT */
  font-size: 11px;       /* légèrement plus grand */
  letter-spacing: 0.3px; /* épaissit les chiffres */
}

}

.qr-container {
  margin-top: 20px;
  display: flex;
  justify-content: center; /* centre horizontalement */
  align-items: center;     /* centre verticalement si besoin */
  flex-direction: column;  /* pour que le bouton Merci reste en dessous */
}

.ticket-qr {
  display: block;
  margin: 10px auto;
  width: 30mm;
  height: 30mm;
}
/* ================= MODALE ATTENTE IMPRESSION ================= */

.modal-wait {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-box {
  background: white;
  padding: 30px 40px;
  border-radius: 16px;
  text-align: center;
  max-width: 320px;
  box-shadow: 0 20px 40px rgba(0,0,0,.25);
}

.modal-box h2 {
  margin: 0 0 10px;
  font-size: 1.4rem;
}

.modal-box p {
  font-size: 1rem;
  color: #555;
}

.spinner {
  margin: 20px auto 0;
  width: 40px;
  height: 40px;
  border: 4px solid #ddd;
  border-top: 4px solid #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
.modal-numero {
  font-size: 3.5rem;
  font-weight: 800;
  color: #dc3545;
  margin: 15px 0;
}

#modal-qr {
  width: 140px;
  height: 140px;
  margin: 10px auto;
}

.modal-info {
  font-size: 0.95rem;
  color: #555;
  margin-top: 8px;
}



</style>
</head>

<body>

<div class="card" id="borne">
  <h1>Bienvenue aux Urgences</h1>
  <p>Veuillez choisir le motif de votre venue</p>

  <div class="motifs">
  <button onclick="prendreTicket('Urgences diverses','general')">🩺 Urgences diverses</button>
  <button onclick="prendreTicket('Traumatologie','traumato')">🦴 Traumatologie</button>
  <button onclick="prendreTicket('Pédiatrie','pediatrie')">👶 Pédiatrie</button>

  <button onclick="prendreTicket('Gynécologie','gyneco')">🤰 Gynécologie</button>
  <button onclick="prendreTicket('Ophtalmologie','ophtalmo')">👁️ Ophtalmologie</button>
    <button onclick="prendreTicket('Administratif','admin')">📝 Administratif</button>
	  <button onclick="prendreTicket('Sortie','sortie')">🚪 Sortie</button>


  <button onclick="prendreTicket('Autres','autres')">❓ Autres</button>
  
</div>



<div class="modal-wait" id="modalWait">
  <div class="modal-box">

    <h2>Veuillez patienter</h2>
    <p>Votre ticket est en cours d’impression</p>

    <div class="modal-numero" id="modalNumero">—</div>

    <canvas id="modal-qr"></canvas>

    <p class="modal-info">
      Scannez ce QR code pour suivre votre attente
    </p>

    <div class="spinner"></div>

  </div>
</div>

  <div class="footer">
    Merci de préparer vos documents administratifs
  </div>
  <div class="qr-container">
  <canvas id="qr"></canvas>
</div>
</div>
<div class="ticket" id="ticket">
  <div class="ticket-box">

    <div class="ticket-header">
      SERVICE DES URGENCES
    </div>


    <div class="ticket-numero" id="ticket-numero"></div>

    <div class="ticket-line">
  <span class="ticket-label">Motif :</span>
  <span class="ticket-value" id="ticketMotif"></span>
</div>

<div class="ticket-line">
  <span class="ticket-label">Date :</span>
  <span class="ticket-value" id="ticketDate"></span>
</div>


    <canvas id="ticket-qr" class="ticket-qr"></canvas>

    <div class="ticket-footer">
  Ticket de passage – Urgences
</div>

<div class="ticket-footer">
  Merci de patienter en salle d’attente
</div>


  </div>
</div>




<script>
// ================= FIREBASE =================
const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let verrou = false;

// ================= PRENDRE TICKET =================
async function prendreTicket(motif, circuit){
  if(verrou) return;
  verrou = true;

  // 🔹 Masquer les boutons
  document.querySelector(".motifs").style.display = "none";

  try{
    // 🔢 Dernier numéro
    const snap = await db.collection("accueil-1")
      .orderBy("numero","desc")
      .limit(1)
      .get();

    let numero = 1;
    if(!snap.empty){
      numero = snap.docs[0].data().numero + 1;
    }

    const docRef = await db.collection("accueil-1").add({
      numero,
      motif,
      circuit,
      statut: "attente",
      dateArrivee: firebase.firestore.FieldValue.serverTimestamp(),
      dateArriveeClient: Date.now()
    });

    const idDoc = docRef.id;
    const qrLink = "https://junior2704.github.io/urgences-/mytickets?id=" + idDoc;

    // QR code pour la borne
    const qr = new QRious({ element: document.getElementById('qr'), value: qrLink, size: 150 });
    // QR code pour le ticket
// QR code pour le ticket (taille réduite)
const qrTicket = new QRious({ 
  element: document.getElementById('ticket-qr'), 
  value: qrLink, 
  size: 120 // <- réduit ici, avant c'était 250
});

    // 🎟️ UI
    
    
    document.getElementById("ticket-numero").innerText = numero;
    document.getElementById("ticketMotif").innerText = motif;
 const now = new Date();
document.getElementById("ticketDate").innerText =
  now.toLocaleDateString("fr-FR") + " " +
  now.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });


   
    
    document.getElementById("ticket").style.display = "block";

    // Crée le bouton Merci dynamiquement
    const btnMerci = document.createElement("button");
    btnMerci.textContent = "Terminé !";
    btnMerci.style.marginTop = "20px";
    btnMerci.style.backgroundColor = "#10b981";
    btnMerci.style.color = "white";
    btnMerci.style.padding = "12px 20px";
    btnMerci.style.fontSize = "1rem";
    btnMerci.style.border = "none";
    btnMerci.style.borderRadius = "10px";
    btnMerci.style.cursor = "pointer";

    // Au clic, reload de la page
    btnMerci.onclick = () => location.reload();

    // Ajoute le bouton sous le QR code
    document.querySelector(".qr-container").appendChild(btnMerci);
// ===== MODALE : numéro + QR =====
document.getElementById("modalNumero").innerText = numero;

// QR code pour la modale
new QRious({
  element: document.getElementById("modal-qr"),
  value: qrLink,
  size: 150
});

document.querySelector(".qr-container").style.display = "none";


    // Impression automatique
    // Affiche la modale
document.getElementById("modalWait").style.display = "flex";
document.body.style.pointerEvents = "none";

// Lance l'impression
setTimeout(() => {
  window.print();
}, 500);

    // 🔁 Reset borne après 10s (au cas où le bouton n’est pas cliqué)
    setTimeout(() => location.reload(), 10000);

  } catch(e){
    alert("Erreur : " + e);
    verrou = false;
  }
}

</script>

</body>
</html>
