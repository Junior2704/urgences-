	<!DOCTYPE html>
	<html lang="fr">
	<head>
	<link rel="icon" type="image/jpeg" href="logo.jpg">

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>üíä Ordonnancier</title>
		<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
		<style>
		#new-prescription-btn {
  background-color: #28a745; 
  color: white;              
  border: none;              
  padding: 15px 20px;        
  border-radius: 6px;       
  cursor: pointer;           
  font-size: 16px;           
  transition: background-color 0.3s ease;
}
.modal {
    display: none; /* affich√©e dynamiquement par JS */
    position: fixed;
    z-index: 999;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.45);
    justify-content: center;
    align-items: center;
  }

  /* Bo√Æte centrale */
  .modal-content {
    background: #f8f9fa;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    padding: 30px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    animation: zoomIn 0.25s ease;
  }

  @keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal-content h2 {
    margin-bottom: 10px;
    color: #2c3e50;
  }

  .modal-content p {
    color: #555;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  .modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .btnModal {
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.2s;
  }

  .btnModal.ouvrir {
    background-color: #007bff;
    color: white;
  }

  .btnModal.ouvrir:hover {
    background-color: #0056b3;
  }

  .btnModal.ecraser {
    background-color: #28a745;
    color: white;
  }

  .btnModal.ecraser:hover {
    background-color: #1e7e34;
  }

  .btnModal.fermer {
    background-color: #6c757d;
    color: white;
    margin-top: 10px;
  }

  .btnModal.fermer:hover {
    background-color: #5a6268;
  }
#new-prescription-btn:hover {
  background-color: #218838; 
}
			.button {
				display: inline-block;
				margin: 20px;
				padding: 12px 25px;
				font-size: 16px;
				color: white;
				background-color: #28a745;
				border: none;
				border-radius: 6px;
				text-decoration: none;
				transition: background-color 0.3s;
				cursor: pointer;
			}
			.button:hover {
				background-color: #1e7e34;
			}

			body {
				font-family: 'Poppins', sans-serif;
				background-color: #f2f7fb;
				margin: 0;
				padding: 0;
				color: #333;
			}
			.medicament-item {
			cursor: pointer;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #f9f9f9;
  cursor: pointer;
  margin-bottom: 5px;
  transition: background-color 0.2s;
}
.medicament-item:hover {
  background-color: #e6f7ff;
}
			.container {
				max-width: 800px;
				margin: 30px auto;
				padding: 20px;
				background-color: #fff;
				border-radius: 12px;
				box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
			}
			h1 {
				text-align: center;
				color: #4CAF50;
				font-size: 32px;
				font-weight: 600;
				margin-bottom: 30px;
			}
			.form-group {
				margin-bottom: 20px;
			}
			.form-group label {
				font-weight: 500;
				color: #555;
				margin-bottom: 5px;
				display: block;
			}
			.form-group input, .form-group select {
				width: 100%;
				padding: 12px;
				margin-top: 5px;
				border: 2px solid #ddd;
				border-radius: 8px;
				font-size: 14px;
				transition: border-color 0.3s;
			}
			.form-group input:focus, .form-group select:focus {
				border-color: #4CAF50;
				outline: none;
			}
			.btn {
				background-color: #4CAF50;
				color: white;
				padding: 12px 20px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 16px;
				width: 100%;
				transition: background-color 0.3s;
			}
			.btn:hover {
				background-color: #45a049;
			}
			.search-bar {
				margin-bottom: 15px;
				padding: 10px;
				width: 100%;
				border: 2px solid #ddd;
				border-radius: 8px;
				font-size: 14px;
				transition: border-color 0.3s;
			}
			.search-bar:focus {
				border-color: #4CAF50;
			}
			.ordonnance {
				margin-top: 30px;
				padding: 20px;
				background-color: #fafafa;
				border-radius: 12px;
				box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
			}
			.ordonnance h2 {
				font-size: 28px;
				color: #333;
				margin-bottom: 15px;
				text-align: center;
				font-weight: 600;
			}
			.doctor-info, .patient-info, .date-info {
				margin-bottom: 10px;
				font-size: 16px;
				color: #555;
			}
			.prescription-list {
				margin-top: 15px;
			}
			.prescription-item {
				background-color: #fff;
				border: 1px solid #ddd;
				border-radius: 8px;
				padding: 10px;
				margin-bottom: 10px;
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.prescription-item input[type="text"] {
				flex: 1 1 45%;
				padding: 6px 8px;
				border: 1px solid #ccc;
				border-radius: 6px;
				font-size: 14px;
			}
			.prescription-item span.med-name {
				flex: 2 1 55%;
				font-weight: 500;
				color: #333;
			}
			.btn-delete {
				background-color: #dc3545;
				border: none;
				color: white;
				padding: 6px 10px;
				border-radius: 6px;
				cursor: pointer;
				transition: background-color 0.3s;
			}
			.btn-delete:hover {
				background-color: #b02a37;
			}
			.btn-email {
				background-color: #dc3545;
				border: none;
				color: white;
				padding: 6px 10px;
				border-radius: 6px;
				cursor: pointer;
				transition: background-color 0.3s;
			}
			.btn-email:hover {
				background-color: #b02a37;
			}
			.btn-print, .btn-download {
				width: 48%;
				height: 50px;
				font-size: 16px;
				margin-top: 20px;
				border-radius: 8px;
				cursor: pointer;
				border: none;
				color: white;
				transition: background-color 0.3s;
			}
			.btn-print {
				background-color: #007BFF;
				float: left;
			}
			.btn-print:hover {
				background-color: #0056b3;
			}
			.btn-download {
				background-color: #FFC107;
				float: right;
			}
			.btn-download:hover {
				background-color: #d39e00;
			}
			/* Style pour l'impression */
			@media print {
				body * {
					visibility: hidden;
				}
				.ordonnance, .ordonnance * {
					visibility: visible;
				}
				.ordonnance {
					position: absolute;
					top: 0;
					left: 0;
					width: 100%;
				}
			}
			/* Clear floats after buttons */
			.buttons-wrapper::after {
				content: "";
				display: table;
				clear: both;
			}
#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
  .vidal-search {
    display: flex;
   
    align-items: center;
    margin: 20px 0;
    font-family: Arial, sans-serif;
  }

  /* Input de recherche */
  .vidal-search input[type="text"] {
    padding: 10px;
    font-size: 16px;
    border: 2px solid #d32f2f; /* rouge Vidal */
    border-right: none; /* pour que le bouton soit coll√© */
    border-radius: 4px 0 0 4px; /* coins arrondis c√¥t√© gauche */
    outline: none;
    width: 300px;
  }

  /* Bouton de recherche */
  .vidal-search button {
    padding: 10px 20px;
    background-color: #d32f2f; /* rouge Vidal */
    color: white;
    font-size: 16px;
    border: 2px solid #d32f2f;
    border-radius: 0 4px 4px 0; /* coins arrondis c√¥t√© droit */
    cursor: pointer;
    transition: background-color 0.3s;
  }

  /* Effet au survol */
  .vidal-search button:hover {
    background-color: #b71c1c; /* rouge plus fonc√© au survol */
    border-color: #b71c1c;
  }
#emailSelectModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  justify-content: center;
  align-items: center;
  z-index: 200;
  animation: fadeInModal 0.3s ease-out;
}

#emailSelectModal.show {
  display: flex;
}

#emailSelectModal .modal-content {
  width: 380px;
  max-width: 90%;
  background: linear-gradient(to bottom right, #ffffff, #f9fafc);
  border-radius: 16px;
  padding: 28px 26px 22px;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(0, 0, 0, 0.06);
  animation: slideUpModal 0.35s ease-out;
  transform-origin: center;
}

#emailSelectModal h3 {
  text-align: center;
  margin-top: 0;
  font-size: 1.25rem;
  color: #1e293b;
  font-weight: 700;
  letter-spacing: 0.3px;
}

#emailSelectModal .email-options {
  margin-top: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#emailSelectModal label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  background: #f8fafc;
  transition: background 0.2s ease, transform 0.1s ease;
  border: 1px solid transparent;
}

#emailSelectModal label:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  transform: scale(1.02);
}

#emailSelectModal input[type="checkbox"] {
  accent-color: #2563eb;
  transform: scale(1.15);
}

#emailSelectModal input[type="email"] {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 0.9rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#emailSelectModal input[type="email"]:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  outline: none;
}

#emailSelectModal .modal-actions {
  margin-top: 22px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

#emailSelectModal button {
  flex: 1;
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.25s ease, transform 0.1s ease;
}

#emailSelectModal .btn-cancel {
  background: #e2e8f0;
  color: #1e293b;
}

#emailSelectModal .btn-cancel:hover {
  background: #cbd5e1;
}

#emailSelectModal .btn-confirm {
  background: #2563eb;
  color: #fff;
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.25);
}

#emailSelectModal .btn-confirm:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

/* --- ANIMATIONS --- */
@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUpModal {
  from {
    transform: translateY(30px) scale(0.98);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}
#loadingScreen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: white;
  font-family: 'Inter', sans-serif;
  transition: opacity 0.5s ease;
}

#loadingScreen.hidden {
  opacity: 0;
}

.loader-content {
  text-align: center;
}

.spinner {
  border: 6px solid rgba(255, 255, 255, 0.3);
  border-top: 6px solid white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


		</style>
	</head>
	<body>
	<div class="container">
<img id="logo-img" src="logo.jpg" style="display:none" crossorigin="anonymous" alt="Logo m√©dical">
<!-- üî∑ MODALE DE CHARGEMENT -->
<div id="loadingModal" class="modal">
  <div class="modal-content">
    <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo h√¥pital" class="logo">
    <div class="loader"></div>
    <p>Envoi de l'ordonnance en cours...</p>
  </div>
</div>

<style>
/* --- Arri√®re-plan plein √©cran --- */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  display: none; /* masqu√©e par d√©faut */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* --- Bo√Æte centrale --- */
.modal-content {
  background: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  text-align: center;
  width: 320px;
  animation: fadeIn 0.3s ease;
}

/* --- Logo --- */
.modal-content .logo {
  height: 70px;
  margin-bottom: 20px;
}

/* --- Texte --- */
.modal-content p {
  color: #333;
  font-size: 16px;
  font-weight: 500;
}

/* --- Loader --- */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1a73e8;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  margin: 15px auto;
  animation: spin 1s linear infinite;
}

/* --- Animations --- */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

/* --- √âtats JS --- */
#loadingModal.show {
  display: flex;
}
.hidden-field {
    display: none !important;
}
.modalna {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(5px); /* flou de l'√©cran */
  z-index: 9999;
}

.modalna .card {
  background: #fff;
  padding: 24px 32px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modalna h2 {
  color: #d32f2f; /* rouge pour danger/erreur */
  margin-bottom: 12px;
}

.modalna p {
  font-size: 16px;
  margin-bottom: 20px;
}

.modalna .btn {
  padding: 10px 20px;
  font-size: 14px;
}
#prescription-text {
    width: 100%;              /* pleine largeur */
    min-height: 150px;        /* hauteur confortable */
    padding: 12px;            /* espace int√©rieur */
    border: 1px solid #ccc;   /* bord gris clair */
    border-radius: 10px;      /* bords arrondis */
    font-size: 14px;
    font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    box-sizing: border-box;
    resize: vertical;          /* possibilit√© d'agrandir verticalement */
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  #prescription-text:focus {
    border-color: #1a73e8;    /* bord bleu lors du focus */
    box-shadow: 0 0 5px rgba(26, 115, 232, 0.5);
    outline: none;
  }

  .form-group label {
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
  }
#prescription-text {
  width: 100%;
  border-radius: 8px;
  padding: 10px;
  box-sizing: border-box;
  font-size: 14px;
}

#autocomplete-box {
   width: 300px;
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}


.autocomplete-item {
  padding: 6px 10px;
  cursor: pointer;
}

.autocomplete-item:hover {
  background-color: #f0f0f0;
}
#loadingScreen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: white;
  font-family: 'Inter', sans-serif;
  transition: opacity 0.5s ease;
}

#loadingScreen.hidden {
  opacity: 0;
}

.loader-content {
  text-align: center;
}

.spinner {
  border: 6px solid rgba(255, 255, 255, 0.3);
  border-top: 6px solid white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>


     



		<!-- Formulaire du patient -->
         <div class="form-group hidden-field">
          		<h1>üíä Ordonnancier M√©dical</h1>
		<button id="new-prescription-btn" onclick="resetOrdonnance()">‚ùå R√©initialiser</button>

		<div class="form-group">
			<label for="patient-first-name">Pr√©nom du Patient</label>
			<input type="text" id="patient-first-name" placeholder="Entrez le pr√©nom du patient" required />
		</div>
		<div class="form-group">
			<label for="patient-last-name">Nom du Patient</label>
			<input type="text" id="patient-last-name" placeholder="Entrez le nom du patient" required />
		</div>
		<div class="form-group">
			<label for="patient-birthdate">Date de Naissance</label>
			<input type="date" id="patient-birthdate" requ	ired />
		</div>

		<div class="form-group">
			<label for="patient-age">√Çge du Patient</label>
			<input type="text" id="patient-age" placeholder="L'√¢ge sera calcul√© automatiquement" readonly />
		</div>
		<div class="form-group">
			<label for="sexe">Sexe</label>
			<select id="sexe" name="sexe">
				<option value="M">M</option>
				<option value="Mme">Mme</option>
				<option value="L'enfant">L'enfant</option>
			</select>
		</div>
    </div>
  

		<div id="prescription" class="ordonnance" >
  <h2>Ordonnance</h2>
  <div class="date-info">
    <span>Date : <span id="current-date"></span></span>
  </div>


 <div class="form-group" style="position: relative;">
  <label for="prescription-text">üñäÔ∏è Prescription :</label>
  <textarea id="prescription-text" rows="8" placeholder="Tapez ici votre prescription..."></textarea>
  <div id="autocomplete-box" class="autocomplete-box"></div>
  
</div>
<div class="form-group">
			<form class="vidal-search" action="https://www.vidal.fr/recherche.html" method="get" target="_blank">
  <input type="text" name="query" placeholder="Rechercher sur le Vidal">
  <button type="submit">Rechercher</button>
</form>


  <button id="validate-prescription-btn" class="btn" onclick="validatePrescription()">‚úîÔ∏è Valider la prescription</button>

  <div class="buttons-wrapper" style="display:none;">
    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimer l'Ordonnance</button>
    <button class="btn-download" onclick="genererOrdo(true)">üì• T√©l√©charger Ordonnance</button>
    <button type="button" id="btnEnvoyerMail" style="padding:10px 20px; background-color:#004AAD; color:white; border:none; border-radius:5px; cursor:pointer;">
      Envoyer l'ordonnance par e-mail
    </button>
  </div>
</div>

	</div>
  
<!-- √âcran de chargement -->
<div id="loadingScreen">
  <div class="loader-content">
    <div class="spinner"></div>
    <h2>Chargement des donn√©es...</h2>
    <p>Merci de patienter quelques instants</p>
  </div>
</div>
<!-- Modale de s√©lection des e-mails -->
<div id="emailSelectModal">
  <div class="modal-content">
    <h3>üìß Choisissez les destinataires</h3>
    <form id="emailSelectForm">
      <div id="emailCheckboxes" class="email-options"></div>

      <hr>

      <label>
        <input type="checkbox" id="otherEmailCheck"> Autre destinataire :
      </label>
      <input type="email" id="otherEmailInput" placeholder="exemple@mail.com" disabled>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" onclick="closeEmailSelectModal()">Annuler</button>
        <button type="button" id="confirmEmails" class="btn-confirm">Envoyer</button>
      </div>
    </form>
  </div>
</div>
<!-- √âcran de chargement -->
<div id="loadingScreen">
  <div class="loader-content">
    <div class="spinner"></div>
    <h2>Chargement des donn√©es...</h2>
    <p>Merci de patienter quelques instants</p>
  </div>
</div>
	
<div id="modal-no-access" class="modalna">
  <div class="card">
    <h2>‚õîÔ∏è Acc√®s refus√©</h2>
    <p>Vous n‚Äôavez pas acc√®s √† cette page.</p>
  </div>
</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/textarea-caret@3.1.0/index.js"></script>

<script>
let db;
let patientRef; // ‚úÖ rendu global
let id;         // ‚úÖ global aussi

window.addEventListener("DOMContentLoaded", async () => {
  hideLoadingModal();

  // --- Initialisation Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
  
  emailjs.init("CZapZCcxYfJ8-acLS");
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();

  // --- R√©cup√©ration de l'ID patient ---
  function getIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id");
  }

  id = getIdFromURL();
  if (!id) {
    console.error("‚ùå Aucun ID patient trouv√© dans l‚ÄôURL.");
    afficherBulle("‚ö†Ô∏è Aucun dossier patient trouv√©", "alerte");
    return;
  }

  // ‚úÖ Cr√©ation de la r√©f√©rence Firestore globale
  patientRef = db.collection("patients").doc(id);
  console.log("üìÅ patientRef initialis√© :", patientRef.path);

  // --- Chargement des infos du patient ---
  await remplirInfosPatientDepuisFirestore();


});
const envoyerMailBtn = document.getElementById("btnEnvoyerMail");
  

  async function remplirInfosPatientDepuisFirestore() {
	 afficherLoader();
    if (!id) {
  masquerLoader();
  return;
}

    try {
      const docRef = db.collection("patients").doc(id);
      const docSnap = await docRef.get();
      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("patient-first-name").value = data.prenom || "";
        document.getElementById("patient-last-name").value = data.nom || "";
        document.getElementById("patient-birthdate").value = data.dateNaissance || "";
		
        document.getElementById("sexe").value = data.sexe || "M";
        const age = calculerAge(data.dateNaissance);
        document.getElementById("patient-age").value = age;
        updatePatientDisplay();
        masquerLoader();
      } else {
        console.warn("Aucun patient trouv√© avec cet ID");
      }
    } catch (error) {
      console.error("Erreur de r√©cup√©ration du patient :", error);
    }
  }

  function calculerAge(dateNaissance) {
    const naissance = new Date(dateNaissance);
    const aujourdHui = new Date();
    let age = aujourdHui.getFullYear() - naissance.getFullYear();
    const mois = aujourdHui.getMonth() - naissance.getMonth();
    if (mois < 0 || (mois === 0 && aujourdHui.getDate() < naissance.getDate())) {
      age--;
    }
    return age;
  }

function filterMedicaments() {
  const search = document.getElementById("search-medicaments").value.toLowerCase();
  const filtres = medicaments.filter(m => m.toLowerCase().includes(search));
  afficherMedicaments(filtres);
}



		// Supprime toutes les r√©f√©rences √† la liste de m√©dicaments et prescriptionItems

function updatePatientDisplay() {
  const prenom = document.getElementById("patient-first-name").value.trim();
  const nom = document.getElementById("patient-last-name").value.trim();
  const age = document.getElementById("patient-age").value.trim();

  document.getElementById("patient-name-display").textContent = prenom && nom ? `${prenom} ${nom}` : "Nom du patient";
  document.getElementById("patient-age-display").textContent = age || "--";
}

function displayCurrentDate() {
  const now = new Date();
  const formattedDate = now.toLocaleDateString("fr-FR", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
  document.getElementById("current-date").textContent = formattedDate;
}
displayCurrentDate();

async function validatePrescription() {
  const prescriptionText = document.getElementById("prescription-text").value.trim();

  if (!prescriptionText) {
    afficherBulle("‚õî La prescription est vide !", "alerte");
    return;
  }

  // 1Ô∏è‚É£ Verrouiller la zone de texte
  document.getElementById("prescription-text").setAttribute("readonly", "true");

  // 2Ô∏è‚É£ D√©sactiver le bouton valider
  document.getElementById("validate-prescription-btn").style.display = "none";

  // 3Ô∏è‚É£ Afficher les boutons mails / imprimer / t√©l√©charger
  document.querySelector(".buttons-wrapper").style.display = "block";

  // 4Ô∏è‚É£ Cr√©ation PDF
  const pdfBase64 = await genererOrdo(false); // g√©n√®re le PDF sans le t√©l√©charger

  // 5Ô∏è‚É£ Enregistrement dans Firestore
  const patientId = getIdFromURL();
  if (patientId) {
    try {
      const idUnique = Math.random().toString(36).substring(2, 10);
      const dateFormatted = formatDate(new Date());
console.log("üìÖ Date format√©e envoy√©e :", dateFormatted);

await db.collection("documents").doc(idUnique).set({
  patientId: patientId,
  dateCreation: dateFormatted,
  type: "ordonnance m√©dicale",
  contenu: prescriptionText,
  pdfBase64: pdfBase64
});

      console.log("‚úÖ Ordonnance enregistr√©e avec ID unique :", idUnique);
      afficherBulle("‚úÖ Ordonnance enregistr√©e !", "success");
    } catch (err) {
      console.error("‚ùå Erreur enregistrement Firestore :", err);
      afficherBulle("‚ùå Erreur enregistrement", "alerte");
    }
  }
}

function formatDate(date) {
  const pad = (n) => n.toString().padStart(2, '0');
  const jour = pad(date.getDate());
  const mois = pad(date.getMonth() + 1); // Les mois vont de 0 √† 11
  const annee = date.getFullYear();
  const heures = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  const secondes = pad(date.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}


async function genererOrdo(telecharger = false) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const marginLeft = 20;
  let y = 25;
  const lineHeight = 8;
  const pageHeight = doc.internal.pageSize.height;

  const prescriptionText = document.getElementById("prescription-text")?.value.trim() || "";

  try {
    // Ent√™te
    doc.setFillColor(52, 152, 219);
    doc.rect(0, 0, 210, 20, "F");
    doc.setFontSize(20);
    doc.setTextColor(255, 255, 255);
    doc.text("Ordonnance M√©dicale", 105, 14, { align: "center" });

    // M√©decin
    doc.setFontSize(14);
    doc.setTextColor(0,0,0);
    doc.text(`${window.medecinNom || "Dr Non renseign√©"}`, marginLeft, 35);
    doc.text(`${window.medecinSpecialite || ""}`, marginLeft, 43);

    // Date et lieu
    const currentDate = new Date().toLocaleDateString("fr-FR");
    doc.text(`Le ${currentDate}`, 150, 35);
    doc.text(`√Ä ${window.medecinLieu || "Lyon"}`, 150, 43);

    // Patient
    const firstName = document.getElementById("patient-first-name")?.value.trim() || "";
    const lastName = document.getElementById("patient-last-name")?.value.trim() || "";
    const age = document.getElementById("patient-age")?.value.trim() || "";
    const sexe = document.getElementById("sexe")?.value || "";
    const fullName = `${sexe} ${firstName} ${lastName}, ${age} ans`.trim();
    y = 60;
    doc.text(fullName, marginLeft, y);
    const textWidth = doc.getTextWidth(fullName);
    doc.setLineWidth(0.5);
    doc.line(marginLeft, y + 2, marginLeft + textWidth, y + 2);
    y += 20;

    // Prescription libre
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    const splitText = doc.splitTextToSize(prescriptionText, 160);
    splitText.forEach(line => {
      if (y + lineHeight > pageHeight - 20) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, marginLeft + 5, y);
      y += lineHeight;
    });

    // Signature
    y += 25;
    const signatureText = `${window.medecinNom || "Dr Non renseign√©"}\n${window.medecinSpecialite || ""}`;
    const pageWidth = doc.internal.pageSize.width;
    const splitSignature = doc.splitTextToSize(signatureText, 60);
    doc.text(splitSignature, pageWidth - 75, pageHeight - 30);

    // Export base64
    const pdfData = doc.output("datauristring");
    window.pdfBase64 = pdfData.split(",")[1];

    if (telecharger) {
      const fileName = `Ordonnance - ${firstName || ""} ${lastName || ""}.pdf`;
      doc.save(fileName);
    }

    return window.pdfBase64;

  } catch (error) {
    console.error("‚ùå Erreur g√©n√©ration PDF :", error);
    return "";
  }
}


document.getElementById("new-prescription-btn").addEventListener("click", function () {
	// R√©initialise tous les champs de l'ordonnance
	document.getElementById("prescription-title").value = "";
	document.getElementById("prescription-body").value = "";
	document.getElementById("prescription-date").value = "";
	document.getElementById("prescription-type").value = "ordonnance"; // ou vide "" selon ta logique
	document.getElementById("prescription-language").value = "fr";     // ou vide ""
	document.getElementById("prescription-footer").value = "";
	
	// Si tu veux aussi vider l'aper√ßu
	document.getElementById("prescription-preview").innerHTML = "";

	// Affiche le formulaire si n√©cessaire
	document.getElementById("prescription-form").style.display = "block";
});

	
function savePatientInfo() {
  const patientInfo = {
    firstName: document.getElementById("patient-first-name").value.trim(),
    lastName: document.getElementById("patient-last-name").value.trim(),
    birthdate: document.getElementById("patient-birthdate").value,
    age: document.getElementById("patient-age").value,
    sexe: document.getElementById("sexe").value
  };
  localStorage.setItem("patientInfo", JSON.stringify(patientInfo));
}
["patient-first-name", "patient-last-name", "patient-birthdate", "patient-age", "sexe"]
  .forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", savePatientInfo);
  });
  
		
window.onload = function() {
  const patientInfo = JSON.parse(localStorage.getItem("patientInfo") || "{}");
  if (patientInfo) {
    if (document.getElementById("patient-first-name")) {
      document.getElementById("patient-first-name").value = patientInfo.firstName || "";
    }
    if (document.getElementById("patient-last-name")) {
      document.getElementById("patient-last-name").value = patientInfo.lastName || "";
    }
    if (document.getElementById("patient-birthdate")) {
      document.getElementById("patient-birthdate").value = patientInfo.birthdate || "";
    }
    if (document.getElementById("sexe")) {
      document.getElementById("sexe").value = patientInfo.sexe || "M";
    }
    updatePatientDisplay();
localStorage.removeItem('patientInfo');	
  }
};

document.getElementById("patient-birthdate").addEventListener("change", function() {
  const birthdate = new Date(this.value);
  const today = new Date();
  let age = today.getFullYear() - birthdate.getFullYear();
  const m = today.getMonth() - birthdate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) {
    age--;
  }
  document.getElementById("patient-age").value = age;
  savePatientInfo(); 
  updatePatientDisplay();
});

function resetOrdonnance() {
    prescriptionItems = [];
    updatePrescriptionDisplay();

    document.getElementById("patient-first-name").value = "";
    document.getElementById("patient-last-name").value = "";
    document.getElementById("patient-birthdate").value = "";
    document.getElementById("patient-age").value = "";
    document.getElementById("sexe").selectedIndex = 0;

    document.getElementById("patient-name-display").textContent = "";
    document.getElementById("patient-age-display").textContent = "";

    document.getElementById("prescription").style.display = "none";
    document.querySelector(".buttons-wrapper").style.display = "none";
    document.getElementById("validate-prescription-btn").disabled = false;
}
document.getElementById("patient-birthdate").addEventListener("change", function () {
	const dateNaissance = this.value;
	if (dateNaissance) {
		const age = calculerAge(dateNaissance);
		document.getElementById("patient-age").value = age;
	}
});


document.getElementById("patient-birthdate").addEventListener("input", function () {
    const birthdate = new Date(this.value);
    const ageInput = document.getElementById("patient-age");

    if (!isNaN(birthdate)) {
        const today = new Date();
        let age = today.getFullYear() - birthdate.getFullYear();
        const m = today.getMonth() - birthdate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) {
            age--;
        }
        ageInput.value = age;
    } else {
        ageInput.value = "";
    }
});

  function getIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  async function remplirInfosPatientDepuisFirestore() {
    const id = getIdFromURL();
    if (!id) return;

    try {
      const docRef = db.collection("patients").doc(id);
      const docSnap = await docRef.get();

      if (docSnap.exists) {
        const data = docSnap.data();
        document.getElementById("patient-first-name").value = data.prenom || "";
        document.getElementById("patient-last-name").value = data.nom || "";
        document.getElementById("patient-birthdate").value = data.dateNaissance || "";
        document.getElementById("sexe").value = data.sexe || "M";

        calculerAge(); 
        updatePatientDisplay(); 
        console.warn("Aucun patient trouv√© avec cet ID");
      }
    } catch (error) {
      console.error("Erreur de r√©cup√©ration du patient :", error);
    }
  }

  function calculerAge() {
    const birthdate = document.getElementById("patient-birthdate").value;
    if (!birthdate) return;

    const birth = new Date(birthdate);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    const m = now.getMonth() - birth.getMonth();

    if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) {
      age--;
    }

    document.getElementById("patient-age").value = age;
  }
function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }
  window.addEventListener("DOMContentLoaded", () => {
    remplirInfosPatientDepuisFirestore();
    document.getElementById("patient-birthdate").addEventListener("change", calculerAge);
  });
  function base64ToBlob(base64, type = "application/pdf") {
  const binary = atob(base64);
  const len = binary.length;
  const buffer = new ArrayBuffer(len);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < len; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return new Blob([view], { type });
}
function showLoadingModal() {
  document.getElementById("loadingModal").classList.add("show");
}

function hideLoadingModal() {
  document.getElementById("loadingModal").classList.remove("show");
}
function openEmailSelectModal(emailsString) {
  const modal = document.getElementById("emailSelectModal");
  const container = document.getElementById("emailCheckboxes");
  container.innerHTML = "";

  const emails = (emailsString || "").split("//").filter(e => e.includes("@"));
  if (emails.length === 0) {
    container.innerHTML = "<p style='color:#777;'>Aucune adresse trouv√©e pour ce patient.</p>";
  } else {
    emails.forEach((email, i) => {
      const id = "emailCheck_" + i;
      container.innerHTML += `
        <label style="display:flex; align-items:center; gap:6px; margin:6px 0;">
          <input type="checkbox" id="${id}" value="${email}" checked>
          ${email}
        </label>`;
    });
  }

  modal.style.display = "flex";
}
function closeEmailSelectModal() {
  document.getElementById("emailSelectModal").style.display = "none";
}

document.getElementById("otherEmailCheck").addEventListener("change", (e) => {
  document.getElementById("otherEmailInput").disabled = !e.target.checked;
});
document.getElementById("btnEnvoyerMail").addEventListener("click", async () => {
  // pas de pdfBase64 pr√©existant dans cette page ‚Äî on g√©n√©rera le PDF au moment de l'envoi
  const doc = await patientRef.get();
  if (!doc.exists) {
    afficherBulle("‚ùå Patient introuvable", "alerte");
    return;
  }
  const data = doc.data();
  const emails = data.email || ""; // cha√Æne format√©e "a@x.com//b@y.fr"
  console.log("üìß Emails trouv√©s (dossier) :", emails);
  openEmailSelectModal(emails);
});
document.getElementById("confirmEmails").addEventListener("click", async function () {
  try {
    // R√©cup√®re les adresses s√©lectionn√©es dans la modale
    const checkedBoxes = document.querySelectorAll("#emailCheckboxes input[type='checkbox']:checked");
    let destinataires = Array.from(checkedBoxes).map(cb => cb.value.trim());

    const otherChecked = document.getElementById("otherEmailCheck").checked;
    const otherEmail = document.getElementById("otherEmailInput").value.trim();
    if (otherChecked && otherEmail) destinataires.push(otherEmail);

    if (destinataires.length === 0) {
      alert("Veuillez cocher au moins une adresse e-mail.");
      return;
    }

    closeEmailSelectModal();
    showLoadingModal();

    // --- 1) G√©n√©ration du PDF via ta fonction existante creerPDF()
    console.log("üìÑ G√©n√©ration du PDF via genererordo()...");
    const pdfBase64 = await genererOrdo(false); // renvoie le base64
    console.log("‚úÖ PDF g√©n√©r√©, taille base64:", pdfBase64.length);

    // --- 2) Cr√©ation d'un ID unique pour Firestore
    let idUnique, docSnap;
    do {
      idUnique = Math.random().toString(36).substring(2, 10);
      docSnap = await db.collection("liens_pdfs").doc(idUnique).get();
    } while (docSnap.exists);

    // --- 3) R√©cup√©ration des infos patient pour nommer le fichier
    const doc = await patientRef.get();
    if (!doc.exists) {
      hideLoadingModal();
      afficherBulle("‚ùå Patient non trouv√©", "alerte");
      return;
    }
    const data = doc.data();
    const firstName = data.prenom || "";
    const lastName = data.nom || "";
    const fileName =  `Ordonnance - ${firstName} ${lastName}.pdf`;

    // --- 4) Enregistrement dans Firestore
    await db.collection("liens_pdfs").doc(idUnique).set({
      base64: pdfBase64,
      nomFichier: fileName,
      dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
    });

    const lienPdf = `https://junior2704.github.io/urgences-/monpdf.html?id=${idUnique}`;
    console.log("‚úÖ Lien Firestore :", lienPdf);

    // --- 5) Pr√©pare le corps du mail (template HTML comme avant)
    const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ordonnance m√©dicale</title>
</head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI', Roboto, Arial, sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#1a73e8; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>

    <tr>
      <td style="padding:30px;">
        <h2 style="color:#1a73e8; font-weight:600; margin-top:0;">Votre ordonnance m√©dicale</h2>

        <p style="font-size:16px; line-height:1.6;">
          Bonjour <strong>{{patient_prenom}} {{patient_nom}}</strong>,
        </p>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          Votre ordonnance vient d‚Äô√™tre valid√©e par le m√©decin responsable et est d√©sormais disponible.
          Elle vous permettra d‚Äôobtenir les m√©dicaments prescrits en pharmacie ou en √©tablissement agr√©√©.
        </p>

        <div style="text-align:center; margin:30px 0;">
          <a href="{{lien_compte_rendu}}" 
             style="background-color:#1a73e8; color:white; padding:14px 32px; text-decoration:none; border-radius:8px; font-weight:500; display:inline-block;">
            ü©∫ Voir l'ordonnance
          </a>
        </div>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          ‚ö†Ô∏è Ce lien reste actif 7 jours pour garantir la confidentialit√© de vos donn√©es.
          Au-del√†, le document sera automatiquement supprim√©.
        </p>

        <p style="font-size:14px; color:#777;">
          Pour toute question, merci de contacter le service des Urgences :
          <a href="mailto:urgences.hopj@gmail.com" style="color:#1a73e8;">urgences.hopj@gmail.com</a>
        </p>

        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

    // --- 6) Multi-compte EmailJS (fallback)
    const comptesEmailJS = [
      { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
      { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
      { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
    ];

    // --- 7) Envoi pour chaque destinataire (une requ√™te EmailJS par adresse)
    for (const email of destinataires) {
      const emailTrim = email.trim();
      if (!emailTrim || !emailTrim.includes("@")) {
        afficherBulle(`Adresse invalide : ${emailTrim}`, "alerte");
        continue;
      }

      let envoye = false;
      let derniereErreur = "";
      for (const compte of comptesEmailJS) {
        try {
          console.log(`üì® Envoi √† ${emailTrim} via ${compte.serviceID}...`);
		  // Remplacement manuel des balises {{‚Ä¶}}
const htmlFinal = htmlMessage
  .replace(/{{patient_prenom}}/g, firstName)
  .replace(/{{patient_nom}}/g, lastName)
  .replace(/{{lien_compte_rendu}}/g, lienPdf);

          await emailjs.send(compte.serviceID, compte.templateID, {
            to_email: emailTrim,
            subject: "Votre ordonnance est disponible !",
            html_message: htmlFinal
          }, compte.publicKey);

          afficherBulle(`üì® Envoy√© : ${emailTrim}`, "administratif");
          envoye = true;
          break;
        } catch (err) {
          console.warn(`‚ö†Ô∏è √âchec ${compte.serviceID} -> ${err && err.text ? err.text : err}`);
          derniereErreur = err && err.text ? err.text : String(err);
          // si erreur de quota, on essaye le compte suivant, sinon on sort de la boucle comptes
          if (derniereErreur.toLowerCase().includes("quota")) continue;
          else break;
        }
      }

      if (!envoye) afficherBulle(`‚ùå √âchec d'envoi √† ${emailTrim}`, "alerte");
    }

    hideLoadingModal();
    afficherBulle("üì® Envois termin√©s !", "administratif");
    // recharge la page pour r√©initialiser l'UI (optionnel)
    setTimeout(() => location.reload(true), 2000);

  } catch (err) {
    hideLoadingModal();
    console.error("Erreur confirmEmails :", err);
    alert("Erreur lors de l'envoi : " + (err.message || err));
  }
});


function getCaretCoordinates(textarea, position) {
    const div = document.createElement('div');
    const style = getComputedStyle(textarea);

    // Copier les styles essentiels
    div.style.position = 'absolute';
    div.style.visibility = 'hidden';
    div.style.whiteSpace = 'pre-wrap';
    div.style.wordWrap = 'break-word';
    div.style.font = style.font;
    div.style.fontSize = style.fontSize;
    div.style.padding = style.padding;
    div.style.border = style.border;
    div.style.overflow = 'auto';
    div.style.width = textarea.offsetWidth + 'px';
    div.style.lineHeight = style.lineHeight;

    // Texte jusqu‚Äôau curseur
    div.textContent = textarea.value.substring(0, position);

    // Span pour la position exacte du curseur
    const span = document.createElement('span');
    span.textContent = textarea.value.substring(position) || '.';
    div.appendChild(span);

    document.body.appendChild(div);

    // Calcul de la position relative au textarea
    const spanRect = span.getBoundingClientRect();
    const textareaRect = textarea.getBoundingClientRect();

    const scrollTop = textarea.scrollTop;
    const scrollLeft = textarea.scrollLeft;
    const paddingTop = parseInt(style.paddingTop);
    const paddingLeft = parseInt(style.paddingLeft);

    const top = spanRect.top - div.getBoundingClientRect().top + textareaRect.top + window.scrollY - scrollTop + paddingTop;
    const left = spanRect.left - div.getBoundingClientRect().left + textareaRect.left + window.scrollX - scrollLeft + paddingLeft;

    document.body.removeChild(div);
    return { top, left };
}



let medicaments = [];
fetch('medicaments.json')
  .then(res => res.json())
  .then(data => {
    medicaments = data;
    console.log("‚úÖ M√©dicaments charg√©s :", medicaments.length);
  })
  .catch(err => console.error("‚ùå Erreur chargement JSON :", err));

const textarea = document.getElementById("prescription-text");
const autoBox = document.getElementById("autocomplete-box");

textarea.addEventListener("input", function() {
  const text = this.value;
  const words = text.split(/\s+/);
  const lastWord = words.pop(); // mot en cours

  if (lastWord.length < 3) {
    autoBox.style.display = "none";
    return;
  }

  const matches = medicaments.filter(med => med.toLowerCase().includes(lastWord.toLowerCase()));
  if (matches.length === 0) {
    autoBox.style.display = "none";
    return;
  }

  autoBox.innerHTML = "";
  matches.forEach(med => {
    const div = document.createElement("div");
    div.className = "autocomplete-item";
    div.textContent = med;
    div.addEventListener("click", () => {
      words.push(med); // remplace le mot en cours
      textarea.value = words.join(" ") + " ";
      autoBox.style.display = "none";
      textarea.focus();
    });
    autoBox.appendChild(div);
  });

 const coords = window.getCaretCoordinates(textarea, textarea.selectionEnd);
autoBox.style.top = (coords.top + coords.height + textarea.offsetTop) + "px"; // sous le curseur
autoBox.style.left = (coords.left + textarea.offsetLeft) + "px";
autoBox.style.width = textarea.offsetWidth + "px";
autoBox.style.display = "block";

  const textareaRect = textarea.getBoundingClientRect();
  autoBox.style.top = (top + window.scrollY + 20) + "px"; // 20px offset pour la ligne
  autoBox.style.left = textareaRect.left + window.scrollX + "px";

  // largeur max = largeur du textarea
  autoBox.style.width = textarea.offsetWidth + "px";

  autoBox.style.display = "block";
});

// fermer si clic ailleurs
document.addEventListener("click", e => {
  if (!autoBox.contains(e.target) && e.target !== textarea) {
    autoBox.style.display = "none";
  }
});


window.afficherLoader = function() {
  let loader = document.getElementById("loadingScreen");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loadingScreen";
    loader.innerHTML = `
      <div class="loader-content">
        <div class="spinner"></div>
        <h2>Chargement...</h2>
      </div>
    `;
    document.body.appendChild(loader);
  }
  loader.style.display = "flex";
  loader.classList.remove("hidden");
};

// --- Masque l‚Äô√©cran de chargement ---
window.masquerLoader = function() {
  const loader = document.getElementById("loadingScreen");
  if (loader) {
    loader.classList.add("hidden");
    setTimeout(() => {
      loader.style.display = "none";
    }, 500); // d√©lai pour l‚Äôanimation
  }
};


	</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "accueil.html";
    return;
  }

  try {
    const docRef = doc(db, "medecins", user.uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
      window.location.href = "accueil.html";
      return;
    }

    const data = docSnap.data();
    const medecinNom = data.nom || "";
    const medecinSpecialite = data.specialite || "";
    const medecinLieu = data.lieu || "";

    // variables globales
    window.medecinNom = medecinNom;
    window.medecinSpecialite = medecinSpecialite;
    window.medecinLieu = medecinLieu;

   
const pages = data.pages || {};
    const currentPath = window.location.pathname;
const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

// Mapping pour Firestore
const pageMapping = {
  "Ordonnancierf": "Ordonnancier" // Ordonnancierf.html utilise les droits de Ordonnancier
};

const pageKey = pageMapping[currentPage] || currentPage;
console.log("Page actuelle :", currentPage);
console.log("Page Firestore :", pageKey);
if (!pages[pageKey]) {
  const modal = document.getElementById("modal-no-access");
  if (modal) modal.style.display = "flex";
  console.warn("Acc√®s refus√© √†", currentPage);
  return; // Stoppe l'ex√©cution pour ceux qui n'ont pas acc√®s
} else {
  console.log("Acc√®s autoris√© √†", currentPage);
  // Ici tu peux mettre tout le code sp√©cifique √† cette page
}

  } catch (error) {
    console.error("Erreur chargement m√©decin :", error);
    alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
  }
});
</script>

	</body>
	</html>
