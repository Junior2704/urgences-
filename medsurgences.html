<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/jpeg" href="logo.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
   body{
    font-family: Inter, Arial, Helvetica, sans-serif;
    margin: 12px;
    background:#eef3f9;
    color:#1d2d50;
  }

  h1{
    font-size:22px;
    font-weight:700;
    color:#0b5ed7;
    margin-bottom:14px;
  }

  .container{max-width:1200px;margin:0 auto}

  .row{display:flex;gap:16px}

  .col{
    background:#ffffff;
    border-radius:12px;
    padding:16px;
    box-shadow:0 3px 10px rgba(0,0,0,0.08);
    border:1px solid #e3e9f2;
  }

  .col.small{flex:0 0 360px}
  .col.big{flex:1}

  #search{
width: 100%;
    box-sizing: border-box;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccd6e0;
    background:#f8fbff;
   

}


  #medicaments-list{
    max-height:520px;
    overflow:auto;
    margin-top:8px;
    padding:4px;
  }

  .medicament-item{
    padding:10px;
    border-radius:8px;
    border:1px solid #e0e6ef;
    margin-bottom:8px;
    background:white;
    cursor:pointer;
    transition:0.15s;
  }
  .medicament-item:hover{
    background:#eaf3ff;
    border-color:#bcd4ff;
  }

  /* --- HISTORIQUE --- */
  .history-list{max-height:520px;overflow:auto;margin-top:12px;}

  .history-item{
    padding:12px;
    border-radius:10px;
    margin-bottom:10px;
    background:#f7f9fc;
    border-left:5px solid #b8c7e8;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }

  /* couleurs selon statut */
  .history-item[data-status="a-donner"]{
    border-left-color:#0d6efd;
  }
  .history-item[data-status="en-retard"]{
    border-left-color:#ff6b6b;
    background:#ffecec;
  }
  .history-item[data-status="pris"]{
    border-left-color:#32c671;
    background:#e8fff1;
  }

  .badge{
    padding:4px 8px;
    border-radius:6px;
    font-size:12px;
    font-weight:600;
  }

  /* couleur badge statut */
  .badge[data-status="a-donner"]{
    background:#dceaff;
    color:#0d6efd;
  }
  .badge[data-status="en-retard"]{
    background:#ffdada;
    color:#c62828;
  }
  .badge[data-status="pris"]{
    background:#cbf7d5;
    color:#146c2e;
  }

  .btn{
    padding:6px 12px;
    border-radius:6px;
    border:1px solid #aac2dd;
    background:#f4f8ff;
    cursor:pointer;
    font-size:13px;
  }
  .btn:hover{
    background:#e2ecff;
  }
  .btn.primary{
    background:#0b5ed7;
    color:white;
    border-color:#0b5ed7;
  }
  .btn.primary:hover{
    background:#0948a8;
  }

  /* --- MODALES --- */
  .modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
  }
  .modal .card{
    background:white;
    padding:20px;
    border-radius:12px;
    min-width:360px;
    max-width:720px;
    box-shadow:0 4px 16px rgba(0,0,0,0.2);
    border:1px solid #e3e9f2;
  }

  label{
    margin-top:10px;
    font-size:14px;
    font-weight:600;
    color:#1d2d50;
  }

  input[type=text],textarea,select,
  input[type=datetime-local],input[type=number]{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccd6e0;
    background:#f8fbff;
    margin-top:4px;
  }

  .flex{display:flex;gap:12px;align-items:center}
  .muted{color:#627089;font-size:13px;margin-top:4px}
/* Badge d'√©tat du m√©dicament */
.badge {
    font-size: 1.1rem;          /* plus gros */
    font-weight: 700;           /* bien visible */
    padding: 6px 10px;
    border-radius: 8px;
    background: #dceaff;        /* bleu clair lisible */
    color: #0d47a1;             /* bleu fonc√© m√©dical */
    display: inline-block;
}
.modal {
    position: absolute;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(5px); /* flou de l'√©cran */
  z-index: 9999;
}

.modal .card {
  background: #fff;
  padding: 24px 32px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modal h2 {
  color: #d32f2f; /* rouge pour danger/erreur */
  margin-bottom: 12px;
}

.modal p {
  font-size: 16px;
  margin-bottom: 20px;
}

.modal .btn {
  padding: 10px 20px;
  font-size: 14px;
}
.history-item {
    display: grid;
    grid-template-columns: 1fr 100px 40px 110px 110px; 
    align-items: center;
    gap: 10px;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    background: #f7f9fc;
    border-left: 5px solid #b8c7e8;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.history-center {
    justify-self: center;
}

.history-right {
    justify-self: end;
}

.container {
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}




</style>

</head>
<body>
  <div class="container">
    
    <div class="row">
      <div class="col small">
        <input id="search" placeholder="Rechercher un m√©dicament..." />
        <div id="medicaments-list"> <!-- list fournie par l'utilisateur; placeholder remplie via JS -->
        </div>
      </div>

      <div class="col big">
        <h3>Historique & demandes</h3>
        <div class="muted">Liste des prescriptions / demandes enregistr√©es pour le patient (tri√©es par date de cr√©ation).</div>
        <div id="history" class="history-list"></div>
      </div>
    </div>
  </div>

  <!-- Modal pour cr√©er demande -->
  <div id="modal-prescription" class="modal">
    <div class="card">
      <h3 id="modal-title">Nouvelle demande</h3>
      <label>Produit</label>
      <input type="text" id="pres-name" readonly />
      <label>Commentaires</label>
      <textarea id="pres-comment" rows="3"></textarea>

      <label>Moment</label>
      <div class="flex">
        <label><input type="radio" name="when" value="now" checked/> Maintenant</label>
        <label><input type="radio" name="when" value="at"/> A une date/heure</label>
      </div>
      <input type="datetime-local" id="pres-datetime" style="margin-top:6px;" />

      <label>Fr√©quence (optionnelle)</label>
      <div class="flex">
        <input type="number" id="pres-every-hours" placeholder="toutes les X heures" min="1"/>
        <input type="number" id="pres-repeat-count" placeholder="N r√©p√©titions (ex:6)" min="1"/>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="pres-cancel">Annuler</button>
        <button class="btn primary" id="pres-save">Valider & enregistrer</button>
      </div>
    </div>
  </div>
<div id="modal-details" class="modal">
  <div class="card" style="max-width:500px">
    <h3>D√©tails du m√©dicament</h3>
    <div id="detail-content"></div>

    <div style="display:flex; justify-content:space-between; margin-top:18px;">
      <button class="btn" id="btnDeleteDetail" style="background:#ffdddd; color:#a00; border-color:#ffb3b3;">
        Supprimer
      </button>
      <button class="btn primary" onclick="closeDetails()">Fermer</button>
    </div>
  </div>
</div>


  <!-- Modal prise -->
  <div id="modal-take" class="modal">
    <div class="card">
      <h3>Prise du m√©dicament</h3>
      <label>Produit</label>
      <input type="text" id="take-name" readonly />
      <label>Commentaire prise</label>
      <textarea id="take-comment" rows="3"></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="take-cancel">Annuler</button>
        <button class="btn primary" id="take-save">Valider prise</button>
      </div>
    </div>
  </div>
<!-- Modale d'acc√®s refus√© -->
<div id="modal-no-access" class="modal">
  <div class="card">
    <h2>‚õîÔ∏è Acc√®s refus√©</h2>
    <p>Vous n‚Äôavez pas acc√®s √† cette page.</p>
  </div>
</div>

  <!-- Firebase + logique JS -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // --- Configuration fournie par l'utilisateur ---
    const firebaseConfig = {
      apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
      authDomain: "urgences-a8ed4.firebaseapp.com",
      projectId: "urgences-a8ed4",
      storageBucket: "urgences-a8ed4.appspot.com",
      messagingSenderId: "392921498200",
      appId: "1:392921498200:web:7ccce767332c67c697c02d",
      measurementId: "G-C74MK2KYDL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // R√©cup√©rer l'ID du patient depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const patientId = urlParams.get("id");
    const patientRef = db.collection("patients").doc(patientId);
document.addEventListener("DOMContentLoaded", () => {
    const selectNow = document.getElementById("moment-now");
    const selectOther = document.getElementById("moment-other");
    const dateField = document.getElementById("date-time-field");
	
    const radios = document.querySelectorAll('input[name="when"]');
    const dateInput = document.getElementById("pres-datetime");

    function updateDateVisibility() {
        const selected = document.querySelector('input[name="when"]:checked').value;
        if (selected === "at") {
            dateInput.style.display = "block";
        } else {
            dateInput.style.display = "none";
        }
    }

    radios.forEach(r => r.addEventListener("change", updateDateVisibility));

    updateDateVisibility();
});

    // --- insertion de la liste fournie par l'utilisateur ---
   let medicaments = [];

async function loadMedicaments() {
  try {
    const res = await fetch("medicament.json");
    medicaments = await res.json();
    renderMedicaments(medicaments);
  } catch (e) {
    console.error("Erreur chargement medicament.json", e);
  }
}

function renderMedicaments(list) {
  const container = document.getElementById("medicaments-list");
  container.innerHTML = "";

  // Prescription libre (comme avant)
  const free = document.createElement("div");
  free.className = "medicament-item";
  free.textContent = "-- Prescription libre --";
  free.ondblclick = () => addMedicamentToPrescription(" ");
  container.appendChild(free);

  // M√©dicaments depuis le JSON
  list.forEach(med => {
    const div = document.createElement("div");
    div.className = "medicament-item";
    div.textContent = med;
    div.ondblclick = () => addMedicamentToPrescription(med);
    container.appendChild(div);
  });
}

// Recherche instantan√©e (ton input #search existe d√©j√†)
document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  renderMedicaments(
    medicaments.filter(m => m.toLowerCase().includes(q))
  );
});

document.addEventListener("DOMContentLoaded", loadMedicaments);
function formatDate(d) {
  const pad = n => n.toString().padStart(2, '0');
  const jour = pad(d.getDate());
  const mois = pad(d.getMonth() + 1);
  const annee = d.getFullYear();
  const heures = pad(d.getHours());
  const minutes = pad(d.getMinutes());
  const secondes = pad(d.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}

    // --- recherche ---
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('#medicaments-list .medicament-item').forEach(el=>{
        el.style.display = el.textContent.toLowerCase().includes(q) ? 'block' : 'none';
      })
    });

    // --- modals handling ---
    const modalPres = document.getElementById('modal-prescription');
    const presName = document.getElementById('pres-name');
    const presComment = document.getElementById('pres-comment');
    const presNowRadio = () => document.querySelector('input[name="when"]:checked').value;
    const presDatetime = document.getElementById('pres-datetime');
    const presEvery = document.getElementById('pres-every-hours');
    const presRepeat = document.getElementById('pres-repeat-count');

    window.addMedicamentToPrescription = function(name){
      presName.value = name;
      presComment.value = '';
      presEvery.value = '';
      presRepeat.value = '';
      presDatetime.value = '';
      modalPres.style.display = 'flex';
    }
    document.getElementById('pres-cancel').onclick = ()=> modalPres.style.display='none';

    document.getElementById('pres-save').onclick = async ()=>{
      modalPres.style.display='none';
      const name = presName.value;
      const comment = presComment.value || '';
      const whenChoice = presNowRadio();
      const everyHours = parseInt(presEvery.value) || null;
      const repeatCount = parseInt(presRepeat.value) || 1;

      const now = new Date();
      const scheduled = (whenChoice==='now') ? now : (presDatetime.value ? new Date(presDatetime.value) : now);

      // prepare multiple events depending on frequency
      const events = [];
for (let i = 0; i < repeatCount; i++) {

  const d = new Date(scheduled.getTime() + (everyHours ? i * everyHours * 3600 * 1000 : 0));
  const formattedDueAt = formatDate(d);
  const formattedCreatedAt = formatDate(new Date());

  events.push({
    product: name,
    comment: comment,
    createdAt: formattedCreatedAt,  // format JJ/MM/AAAA HH:MM:SS
    dueAt: formattedDueAt,         // format JJ/MM/AAAA HH:MM:SS
    status: 'a-donner',
    takenAt: null,
    takeComment: null
  });
}


      try {
  // üîπ R√©cup√©rer le patient
  const patientSnap = await patientRef.get();
  if (!patientSnap.exists) { 
    alert('Patient introuvable'); 
    return; 
  }
  const patientData = patientSnap.data();

  // üîπ R√©cup√©rer l'hospitalisation active
  const hospiId = patientData.hospitalisationActiveId;
  if (!hospiId) {
    alert('Aucune hospitalisation active trouv√©e');
    return;
  }

  const hospiRef = db.collection('hospitalisations').doc(hospiId);
  const hospiSnap = await hospiRef.get();
  if (!hospiSnap.exists) {
    alert('Hospitalisation introuvable');
    return;
  }

  const hospiData = hospiSnap.data();
  hospiData.meds = Array.isArray(hospiData.meds) ? hospiData.meds : [];

  // üîπ Ajouter les √©v√©nements
  events.forEach(ev => hospiData.meds.push(ev));

  // üîπ Mettre √† jour l'hospitalisation
  await hospiRef.update({ meds: hospiData.meds });

  afficherBulle('‚úîÔ∏è Demande enregistr√©e', 'success');
  loadHistory();
      }catch(err){
        console.error(err);alert('Erreur enregistrement: '+err.message)
      }
    };

  async function loadHistory() {
  const container = document.getElementById("history");
  container.innerHTML = "<div class='muted'>Chargement...</div>";
  console.log("‚û°Ô∏è loadHistory() lanc√©");

  try {
    // üîπ R√©cup√©rer le patient
    const patientRef = db.collection("patients").doc(patientId);
    const patientSnap = await patientRef.get();

    if (!patientSnap.exists) {
      console.error("‚ùå Patient introuvable");
      container.innerHTML = "<div class='muted'>Patient introuvable</div>";
      return;
    }

    const patientData = patientSnap.data();
    console.log("üìå Donn√©es patient :", patientData);

    // üîπ R√©cup√©rer l'hospitalisation active
    const hospiId = patientData.hospitalisationActiveId;
    if (!hospiId) {
      console.error("‚ùå Aucune hospitalisation active");
      container.innerHTML = "<div class='muted'>Aucune hospitalisation active</div>";
      return;
    }

    const hospiRef = db.collection("hospitalisations").doc(hospiId);
    const hospiSnap = await hospiRef.get();

    if (!hospiSnap.exists) {
      console.error("‚ùå Hospitalisation introuvable");
      container.innerHTML = "<div class='muted'>Hospitalisation introuvable</div>";
      return;
    }

    const hosp = hospiSnap.data();
    const meds = hosp.meds || [];

    if (meds.length === 0) {
      console.log("‚ÑπÔ∏è Aucun m√©dicament enregistr√©");
      container.innerHTML = "<div class='muted'>Aucune demande</div>";
      return;
    }

    console.log("üíä M√©dicaments trouv√©s:", meds);

    // üîπ Fonction utilitaire parseDate
    const parseDate = (str) => {
      if (!str) return null;
      try {
        const [d, h] = str.split(" ");
        const [jj, mm, aaaa] = d.split("/");
        const [HH, MM, SS] = h.split(":");
        return new Date(aaaa, mm - 1, jj, HH, MM, SS);
      } catch (e) {
        console.error("‚ùå Erreur parseDate:", e, str);
        return null;
      }
    };

    // üîπ Trier par createdAt d√©croissant
    const sorted = meds
      .map((m, originalIndex) => ({ ...m, originalIndex }))
      .sort((a, b) => parseDate(b.createdAt) - parseDate(a.createdAt));

    container.innerHTML = "";

    sorted.forEach((d, i) => {
      const item = document.createElement("div");
      item.className = "history-item";

      // Calcul du statut
      let status = d.status;
      if (status !== "pris") {
        const now = new Date();
        const due = parseDate(d.dueAt);
        if (due) {
          const diff = (now - due) / 60000;
          if (Math.abs(diff) <= 10) status = "a-donner";
          else if (diff < -10) status = "prevu";
          else status = "en-retard";
        }
      }
      d.status = status;
      item.dataset.status = status;

      const badge = `<span class="badge" data-status="${status}">${status}</span>`;
      const loupe = `<button class="btn" onclick="showDetails(${d.originalIndex})">üîé</button>`;
      const takeBtn = status !== "pris"
        ? `<button class="btn" onclick="openTakeModal(${d.originalIndex}, '${d.product}')">Administrer</button>`
        : "";

      item.innerHTML = `
        <div><strong>${d.product}</strong></div>
        <div class="history-center">${loupe}</div>
        <div class="history-center">${badge}</div>
        <div class="history-right">${takeBtn}</div>
      `;

      container.appendChild(item);
    });

  } catch (err) {
    console.error("‚ùå ERREUR loadHistory():", err);
    container.innerHTML = "<div class='muted'>Erreur chargement</div>";
  }
}


let currentDetailId = null;

async function showDetails(medIndex) {
  currentDetailId = medIndex;

  try {
    // üîπ R√©cup√©rer le patient
    const patientRef = db.collection("patients").doc(patientId);
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const patientData = snap.data();

    // üîπ R√©cup√©rer l'hospitalisation active
    const hospiId = patientData.hospitalisationActiveId;
    if (!hospiId) return;

    const hospiRef = db.collection("hospitalisations").doc(hospiId);
    const hospiSnap = await hospiRef.get();
    if (!hospiSnap.exists) return;

    const hosp = hospiSnap.data();
    const meds = hosp.meds || [];

    const d = meds[medIndex];
    if (!d) return;

    // üîπ Convertisseur "JJ/MM/AAAA HH:MM:SS" ‚Üí Date
    const parseDate = (str) => {
      if (!str) return null;
      try {
        const [datePart, timePart] = str.split(" ");
        const [dd, mm, yyyy] = datePart.split("/");
        const [h, m, s] = timePart.split(":");
        return new Date(yyyy, mm - 1, dd, h, m, s);
      } catch (e) {
        console.error("Erreur parseDate:", str, e);
        return null;
      }
    };

    const created = d.createdAt ? parseDate(d.createdAt).toLocaleString() : "‚Äî";
    const due = d.dueAt ? parseDate(d.dueAt).toLocaleString() : "‚Äî";
    const taken = d.takenAt ? parseDate(d.takenAt).toLocaleString() : "‚Äî";

    const html = `
      <p><strong>Nom :</strong> ${d.product}</p>
      <p><strong>Commentaire demande :</strong><br>${d.comment || "‚Äî"}</p>
      <p><strong>Cr√©√© le :</strong> ${created}</p>
      <p><strong>Pour le :</strong> ${due}</p>
      <p><strong>Statut :</strong> ${d.status}</p>
      <p><strong>Commentaire prise :</strong><br>${d.takeComment || "‚Äî"}</p>
      <p><strong>Prise le :</strong> ${taken}</p>
    `;

    document.getElementById("detail-content").innerHTML = html;
    document.getElementById("modal-details").style.display = "flex";

    document.getElementById("btnDeleteDetail").onclick = deleteFromModal;

  } catch (err) {
    console.error("Erreur showDetails():", err);
  }
}


function closeDetails() {
    document.getElementById("modal-details").style.display = "none";
}
async function deleteFromModal() {
  if (currentDetailId == null) return;

  if (!confirm("Supprimer cette demande ?")) return;

  try {
    // üîπ R√©cup√©rer le patient
    const patientRef = db.collection("patients").doc(patientId);
    const snap = await patientRef.get();
    if (!snap.exists) {
      alert("Patient introuvable.");
      return;
    }

    const patientData = snap.data();
    const hospiId = patientData.hospitalisationActiveId;
    if (!hospiId) {
      alert("Aucune hospitalisation active.");
      return;
    }

    // üîπ R√©cup√©rer l'hospitalisation active
    const hospiRef = db.collection("hospitalisations").doc(hospiId);
    const hospiSnap = await hospiRef.get();
    if (!hospiSnap.exists) {
      alert("Hospitalisation introuvable.");
      return;
    }

    const hospData = hospiSnap.data();
    const meds = hospData.meds || [];

    if (currentDetailId >= meds.length) {
      alert("Demande introuvable.");
      return;
    }

    // üîπ Supprimer la demande
    meds.splice(currentDetailId, 1);

    // üîπ Mettre √† jour Firestore
    await hospiRef.update({ meds });

    afficherBulle("‚úîÔ∏è Demande supprim√©e", "success");

    closeDetails();
    loadHistory();

  } catch (err) {
    console.error(err);
    alert("Erreur : " + err.message);
  }
}



    // --- modal prise ---
    const modalTake = document.getElementById('modal-take');
    const takeName = document.getElementById('take-name');
    const takeComment = document.getElementById('take-comment');
    let currentTakingDocId = null;

    function openTakeModal(docId, name){ currentTakingDocId = docId; takeName.value = name; takeComment.value=''; modalTake.style.display='flex'; }
    document.getElementById('take-cancel').onclick = ()=> modalTake.style.display='none';

    document.getElementById('take-save').onclick = async () => {
  modalTake.style.display = 'none';

  if (currentTakingDocId == null) return;

  try {
    const takeAt = new Date();

    // üîπ R√©cup√©rer le patient
    const patientRef = db.collection("patients").doc(patientId);
    const snap = await patientRef.get();
    if (!snap.exists) {
      alert("Patient introuvable.");
      return;
    }

    const patientData = snap.data();
    const hospiId = patientData.hospitalisationActiveId;
    if (!hospiId) {
      alert("Aucune hospitalisation active.");
      return;
    }

    // üîπ R√©cup√©rer le document hospitalisation
    const hospiRef = db.collection("hospitalisations").doc(hospiId);
    const hospiSnap = await hospiRef.get();
    if (!hospiSnap.exists) {
      alert("Hospitalisation introuvable.");
      return;
    }

    const hospData = hospiSnap.data();
    const meds = hospData.meds || [];

    if (currentTakingDocId >= meds.length) {
      alert("Entr√©e introuvable.");
      return;
    }

    // üîπ Mettre √† jour la m√©dication
    meds[currentTakingDocId] = {
      ...meds[currentTakingDocId],
      status: "pris",
      takenAt: takeAt.toLocaleString("fr-FR"),
      takeComment: takeComment.value || ""
    };

    await hospiRef.update({ meds });

    afficherBulle("‚úîÔ∏è Administration enregistr√©e");
    loadHistory();

  } catch (err) {
    console.error(err);
    alert("Erreur: " + err.message);
  }
};


    // --- helper pour notifications simples ---
// Conteneur global pour les bulles
let notificationContainer = document.getElementById('notification-container');
if (!notificationContainer) {
  notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  notificationContainer.style.position = 'fixed';
  notificationContainer.style.top = '12px';
  notificationContainer.style.right = '12px'; // EN HAUT √Ä DROITE
  notificationContainer.style.display = 'flex';
  notificationContainer.style.flexDirection = 'column';
  notificationContainer.style.gap = '8px'; // espace vertical entre bulles
  notificationContainer.style.zIndex = 9999;
  document.body.appendChild(notificationContainer);
}

// Fonction pour afficher une bulle
function afficherBulle(msg, type = 'info') {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.padding = '10px 14px';
  el.style.borderRadius = '8px';
  el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
  el.style.fontSize = '14px';
  el.style.fontWeight = '500';
  el.style.opacity = '0';
  el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  el.style.transform = 'translateY(-10px)';

  // --- Code couleur selon type ---
  switch (type) {
    case 'success':
      el.style.background = '#e6ffed'; // vert clair
      el.style.color = '#064e22';      // texte vert fonc√©
      break;
    case 'error':
      el.style.background = '#ffdede'; // rouge clair
      el.style.color = '#a00';         // texte rouge fonc√©
      break;
    case 'warning':
      el.style.background = '#fff4e5'; // orange clair
      el.style.color = '#663c00';      // texte orange fonc√©
      break;
    default: // info ou autre
      el.style.background = '#333';    // gris fonc√©
      el.style.color = '#fff';         // texte blanc
      break;
  }

  notificationContainer.appendChild(el);

  // Animation d'entr√©e
  requestAnimationFrame(() => {
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';
  });

  // Suppression automatique apr√®s 3 secondes
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(-10px)';
    el.addEventListener('transitionend', () => el.remove());
  }, 3000);
}


    // --- initial load ---
    if(!patientId){ alert('Aucun id patient trouv√© dans l\'URL. Ajoutez ?id=<patientId>'); }
    else loadHistory();

    // fermer modals si on clique en dehors
    window.addEventListener('click', (e)=>{
      if(e.target===modalPres) modalPres.style.display='none';
      if(e.target===modalTake) modalTake.style.display='none';
    });
  </script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    //window.location.href = "accueil.html";
    return;
  }

  try {
    const docRef = doc(db, "medecins", user.uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
      window.location.href = "index.html";
      return;
    }

    const data = docSnap.data();
    const medecinNom = data.nom || "";
    const medecinSpecialite = data.specialite || "";
    const medecinLieu = data.lieu || "";

    // variables globales
    window.medecinNom = medecinNom;
    window.medecinSpecialite = medecinSpecialite;
    window.medecinLieu = medecinLieu;

   

    // V√©rification acc√®s page
    const pages = data.pages || {};
    const currentPath = window.location.pathname;
    const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

    if (!pages[currentPage]) {
      const modal = document.getElementById("modal-no-access");
      modal.style.display = "flex";

      

      return; // Stoppe le reste du script
    }

  } catch (error) {
    console.error("Erreur chargement m√©decin :", error);
    alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
  }
});

</script>
</body>
</html>
