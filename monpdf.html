<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Téléchargement du rapport</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <p>Téléchargement en cours...</p>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
      authDomain: "urgences-a8ed4.firebaseapp.com",
      projectId: "urgences-a8ed4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function telechargerPDF() {
      const id = new URLSearchParams(window.location.search).get("id");
      if (!id) {
        document.body.innerHTML = "<p>❌ Lien invalide.</p>";
        return;
      }

      const doc = await db.collection("liens_pdfs").doc(id).get();
      if (!doc.exists) {
        document.body.innerHTML = "<p>⏳ Ce lien a expiré ou est invalide.</p>";
        return;
      }

      const base64 = doc.data().base64;
      const blob = base64ToBlob(base64, "application/pdf");
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rapport_hospitalisation.pdf";
      a.click();

      // Optionnel : fermer après 3 secondes
      setTimeout(() => window.close(), 3000);
    }

    function base64ToBlob(base64, type) {
      const binary = atob(base64);
      const len = binary.length;
      const buffer = new ArrayBuffer(len);
      const view = new Uint8Array(buffer);
      for (let i = 0; i < len; i++) {
        view[i] = binary.charCodeAt(i);
      }
      return new Blob([view], { type });
    }

    telechargerPDF();
  </script>
</body>
</html>
