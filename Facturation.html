<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" type="image/jpeg" href="logo.jpg">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üí∞ Facturation - Urgences</title>
  <link rel="icon" type="image/jpeg" href="logo.jpg" />

  <!-- Librairies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- EmailJS (m√™me version que dans ton rapport) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --primary:#007bff; --accent:#17a2b8; --success:#28a745; --danger:#dc3545; --muted:#6c757d; --card:#ffffff;
    }
    body{ font-family:"Segoe UI", Roboto, Arial, sans-serif; background: linear-gradient(90deg,#f4f6f8,#e9ecef); margin:0; padding:24px; color:#222;}
    h1{ text-align:center; margin:6px 0 18px; }
    form{ max-width:1000px; margin:0 auto; background:var(--card); padding:22px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.08); }
    label{ display:block; margin-top:12px; font-weight:700; color:#333; }
    input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #d3d7db; box-sizing:border-box; font-size:15px; }
    input:disabled, select:disabled{ background:#f7f7f7; color:#777; }
    .btn-container{ display:flex; gap:10px; margin-top:18px; flex-wrap:wrap; }
    .button{ background:var(--success); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .button.secondary{ background:var(--accent); }
    .button.danger{ background:var(--danger); }
    .button.warning{ background:#ffc107; color:#111; }
    .button[disabled]{ opacity:0.6; cursor:not-allowed; }
    table{ width:100%; border-collapse:collapse; margin-top:18px; }
    th,td{ border:1px solid #e6e9ec; padding:10px; text-align:center; font-size:14px; }
    th{ background:#f7f9fb; font-weight:700; color:#333; }
    .price, .lineTotal{ font-weight:700; color:#111; }
    #grandTotal{ font-size:16px; font-weight:800; color:var(--primary); }
    .muted{ color:var(--muted); font-size:13px; }
    .flex{ display:flex; gap:10px; align-items:center; }
    .right{ margin-left:auto; }
    #processingPopup{ display:none; position:fixed; left:50%; transform:translateX(-50%); top:18px; background:var(--primary); color:#fff; padding:14px 20px; border-radius:10px; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,0.12); }
    #progressBar{ height:8px; width:0%; background:#fff; border-radius:6px; transition:width 2.2s linear; margin-top:10px; }
    #vitaleModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:10000; justify-content:center; align-items:center; }
    #vitaleModal .box{ background:#fff; padding:28px; border-radius:12px; text-align:center; width:320px; box-shadow:0 12px 32px rgba(0,0,0,0.18); }
    .spinner{ width:48px; height:48px; border-radius:50%; border:6px solid #eee; border-top-color:var(--primary); margin:0 auto 12px; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    #bubble-container{ position:fixed; top:20px; right:20px; display:flex; flex-direction:column; gap:10px; z-index:11000; }
    .bubble{ padding:10px 14px; border-radius:8px; color:#fff; box-shadow:0 6px 20px rgba(0,0,0,0.12); max-width:320px; }
    .administratif{ background:#2196F3; } .alerte{ background:#f44336; }
    /* modal email (copi√© du rapport) */
    #emailSelectModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px); justify-content:center; align-items:center; z-index:200; }
    #emailSelectModal .modal-content{ width:340px; text-align:left; padding:20px; border-radius:12px; background:#fff; box-shadow:0 8px 30px rgba(0,0,0,0.12);}
    #emailSelectModal h3{ text-align:center; margin-top:0; }
    @media (max-width:720px){ form{ padding:16px; } .btn-container{ flex-direction:column; align-items:stretch; } .flex{ flex-direction:column; align-items:flex-start; gap:6px; } }
  </style>
</head>
<body>

<h1>üí∞ Facturation - Urgences</h1>

<form id="invoiceForm">
  <div class="btn-container">
    <a href="urgences.html" class="button" style="text-decoration:none; display:inline-flex; align-items:center;">‚Ü©Ô∏è Retour Urgences</a>
    <button type="button" id="resetBtn" class="button danger">‚ùå R√©initialiser</button>
    <button type="button" id="readVitaleBtn" class="button">üÜî Lecture Carte Vitale</button>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
    <div>
      <label for="lastName">Nom :</label>
      <input id="lastName" type="text" required>
    </div>
    <div>
      <label for="firstName">Pr√©nom :</label>
      <input id="firstName" type="text" required>
    </div>
    <div>
      <label for="birthDate">Date de naissance :</label>
      <input id="birthDate" type="date" required>
      <div id="ageDisplay" class="muted"></div>
    </div>
    
  </div>

  <h2 style="margin-top:18px;">ü©∫ Prestations</h2>

  <table id="itemsTable">
    <thead>
      <tr>
        <th style="text-align:left; padding-left:12px;">Prestation</th>
        <th>Quantit√©</th>
        <th>Prix Unitaire (‚Ç¨)</th>
        <th>Total (‚Ç¨)</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align:left; padding-left:12px;">
          <select class="serviceSelect" required>
            <option value="" data-price="0">-- Choisir --</option>
            <option value="Forfait urgences" data-price="29">Forfait urgences - 29‚Ç¨</option>
            <option value="Forfait urgences mineur" data-price="19">Forfait urgences mineur - 19‚Ç¨</option>
            <option value="Analyse sanguine" data-price="45">Analyse sanguine - 45‚Ç¨</option>
            <option value="Radiographie" data-price="10">Radiographie - 10‚Ç¨</option>
          </select>
        </td>
        <td><input class="qty" type="number" min="1" value="1"></td>
        <td class="price">0.00</td>
        <td class="lineTotal">0.00</td>
        <td><button type="button" class="button warning removeBtn">üóëÔ∏è</button></td>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="text-align:left; padding-left:12px;" class="muted">Remerciements: Merci de votre confiance</td>
        <td style="text-align:right; font-weight:700;">Total TTC</td>
        <td id="grandTotal">0.00</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div style="display:flex; gap:10px; margin-top:14px; align-items:center; flex-wrap:wrap;">
    <button type="button" id="addItemBtn" class="button">‚ûï Ajouter une prestation</button>
    <div class="right muted" style="margin-left:auto;">(Les champs deviennent non modifiables apr√®s validation)</div>
  </div>
<div>
      <label for="paymentMode">Mode de paiement :</label>
      <select id="paymentMode" required>
        <option value="">-- Choisir --</option>
        <option>üí∂ Esp√®ces</option>
        <option>üí≥ Carte bancaire</option>
        <option>‚úçÔ∏è Ch√®que</option>
        <option>üÜî Carte Vitale</option>
        <option>üè• Hospitalisation</option>
      </select>
    </div>
  <div class="btn-container" style="margin-top:18px;">
    <button type="button" id="validateBtn" class="button secondary">‚úÖ Valider le paiement</button>
    <button type="button" id="downloadPdfBtn" class="button" style="display:none;">üìÑ T√©l√©charger la facture (PDF)</button>
    <!-- bouton d'envoi email : apparait en m√™me temps que t√©l√©chargement -->
    <button type="button" id="sendEmailBtn" class="button" style="display:none; background:#004AAD;">üìß Envoyer par e-mail</button>
  </div>
</form>

<!-- Processing popup -->
<div id="processingPopup">
  <div style="font-weight:700;">Validation en cours...</div>
  <div style="background:rgba(255,255,255,0.2); padding:6px; border-radius:6px; margin-top:8px;">
    <div id="progressBar"></div>
  </div>
</div>

<!-- Carte Vitale modal -->
<div id="vitaleModal">
  <div class="box">
    <div class="spinner"></div>
    <div style="font-weight:700; margin-top:6px;">Lecture Carte Vitale en cours...</div>
  </div>
</div>

<!-- Modale de s√©lection des e-mails -->
<div id="emailSelectModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px); justify-content:center; align-items:center; z-index:200;">
  <div class="modal-content" style="width:340px; text-align:left;">
    <h3 style="text-align:center;">üìß Choisissez les destinataires</h3>
    <form id="emailSelectForm">
      <div id="emailCheckboxes"></div>
      <hr style="margin:15px 0;">
      <label style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="otherEmailCheck"> Autre destinataire :
      </label>
      <input type="email" id="otherEmailInput" placeholder="exemple@mail.com"
             style="margin-top:5px; padding:6px; width:100%; border:1px solid #ccc; border-radius:6px;" disabled>
      <br><br>
      
      <button type="button" onclick="closeEmailSelectModal()" style="background:#ccc;">Annuler</button>
      <button type="button" id="confirmEmails">Envoyer</button>
    </form>
  </div>
</div>

<!-- üî∑ MODALE DE CHARGEMENT -->
<div id="loadingModal" class="loadingModal">
  <div class="modal-content">
    <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo h√¥pital" class="logo">
    <div class="loader"></div>
    <p>Envoi du compte-rendu en cours...</p>
  </div>
</div>

<style>
/* --- Arri√®re-plan plein √©cran --- */
.loadingModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  display: none; /* masqu√©e par d√©faut */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* --- Bo√Æte centrale --- */
.loadingModal-content {
  background: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  text-align: center;
  width: 320px;
  animation: fadeIn 0.3s ease;
}

/* --- Logo --- */
.loadingModal-content .logo {
  height: 70px;
  margin-bottom: 20px;
}

/* --- Texte --- */
.loadingModal-content p {
  color: #333;
  font-size: 16px;
  font-weight: 500;
}

/* --- Loader --- */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1a73e8;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  margin: 15px auto;
  animation: spin 1s linear infinite;
}

/* --- Animations --- */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

/* --- √âtats JS --- */
#loadingModal.show {
  display: flex;
}
<!-- notification bubbles -->
<div id="bubble-container"></div>

<script>
  // -------- EmailJS init (comme dans rapport) ----------
  emailjs.init("CZapZCcxYfJ8-acLS"); // m√™me cl√© publique que dans rapport

  // -------- Firebase config (inchang√©) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- UI helpers & variables ----------
  const itemsTable = document.querySelector('#itemsTable tbody');
  const grandTotalElem = document.getElementById('grandTotal');
  const addItemBtn = document.getElementById('addItemBtn');
  const ageDisplay = document.getElementById('ageDisplay');
  const birthDateInput = document.getElementById('birthDate');
  let currentFactureId = null; // id Firestore apr√®s validation

  function calculateAge(birthDate){
    if(!birthDate) return '';
    const today=new Date();
    const b=new Date(birthDate);
    let age=today.getFullYear()-b.getFullYear();
    const m=today.getMonth()-b.getMonth();
    if(m<0||(m===0 && today.getDate() < b.getDate())) age--;
    return age;
  }
  birthDateInput.addEventListener('change', ()=> {
    ageDisplay.textContent = birthDateInput.value ? `√Çge : ${calculateAge(birthDateInput.value)} ans` : '';
  });

  function updateLine(row){
    const select = row.querySelector('.serviceSelect');
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const price = parseFloat(select.selectedOptions[0].dataset.price) || 0;
    row.querySelector('.price').textContent = price.toFixed(2);
    row.querySelector('.lineTotal').textContent = (qty * price).toFixed(2);
  }

  function updateTotals(){
    let total = 0;
    itemsTable.querySelectorAll('tr').forEach(row => {
      updateLine(row);
      total += parseFloat(row.querySelector('.lineTotal').textContent) || 0;
    });
    grandTotalElem.textContent = total.toFixed(2);
  }

  function addListeners(row){
    row.querySelector('.serviceSelect').addEventListener('change', updateTotals);
    row.querySelector('.qty').addEventListener('input', updateTotals);
    row.querySelector('.removeBtn').addEventListener('click', () => { row.remove(); updateTotals(); });
  }
  itemsTable.querySelectorAll('tr').forEach(addListeners);
  addItemBtn.addEventListener('click', () => {
    const row = itemsTable.insertRow();
    row.innerHTML = `
      <td style="text-align:left; padding-left:12px;">
        <select class="serviceSelect">
          <option value="" data-price="0">-- Choisir --</option>
          <option value="Forfait urgences" data-price="29">Forfait urgences - 29‚Ç¨</option>
          <option value="Analyse sanguine" data-price="45">Analyse sanguine - 45‚Ç¨</option>
          <option value="Radiographie" data-price="10">Radiographie - 10‚Ç¨</option>
        </select>
      </td>
      <td><input class="qty" type="number" min="1" value="1"></td>
      <td class="price">0.00</td>
      <td class="lineTotal">0.00</td>
      <td><button type="button" class="button warning removeBtn">üóëÔ∏è</button></td>`;
    addListeners(row);
    updateTotals();
  });

  // ---------- Chargement patient depuis l'URL (collection "patients") ----------
  window.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(window.location.search);
    const id = params.get('id');
    if (id) {
      try {
        const doc = await db.collection('patients').doc(id).get();
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('lastName').value = data.nom || '';
          document.getElementById('firstName').value = data.prenom || '';
          if (data.dateNaissance) {
            const d = data.dateNaissance.toDate ? data.dateNaissance.toDate() : new Date(data.dateNaissance);
            document.getElementById('birthDate').value = d.toISOString().split('T')[0];
            ageDisplay.textContent = `√Çge : ${calculateAge(d.toISOString().split('T')[0])} ans`;
          }
          // stocke patient data global pour utiliser les emails
          window.patientData = data;
          afficherBulle(`üë§ Patient charg√© : ${data.prenom || ''} ${data.nom || ''}`, 'administratif');
        } else {
          afficherBulle('‚ùå Patient introuvable (id:'+id+')','alerte');
        }
      } catch (err) {
        console.error('Erreur chargement patient', err);
        afficherBulle('‚ö†Ô∏è Erreur de chargement patient','alerte');
      }
    }
  });

  // ---------- Lecture Carte Vitale simul√©e ----------
  document.getElementById('readVitaleBtn').addEventListener('click', () => {
    const modal = document.getElementById('vitaleModal');
    modal.style.display = 'flex';
    const duration = 3000 + Math.random() * 4000; // 3-7s
    setTimeout(() => {
      modal.style.display = 'none';
      const success = Math.random() < 0.8; // 80% r√©ussite
      if (success) afficherBulle('‚úÖ Lecture Carte Vitale r√©ussie !', 'administratif');
      else afficherBulle('‚ùå Erreur lecture Carte Vitale - r√©essayez', 'alerte');
    }, duration);
  });

  function afficherBulle(message, type='administratif'){
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const div = document.createElement('div');
    div.className = 'bubble ' + (type || 'administratif');
    div.textContent = message;
    container.appendChild(div);
    setTimeout(()=> div.remove(), 3000);
  }

  // ---------- Valider paiement ----------
  document.getElementById('validateBtn').addEventListener('click', async () => {
    updateTotals();
    const nom = document.getElementById('lastName').value.trim();
    const prenom = document.getElementById('firstName').value.trim();
    const naissance = document.getElementById('birthDate').value;
    const paiement = document.getElementById('paymentMode').value;

    if(!nom || !prenom || !naissance || !paiement) {
      alert('Veuillez compl√©ter tous les champs obligatoires.');
      return;
    }

    const prestations = [...itemsTable.querySelectorAll('tr')].map(row => {
      const desc = row.querySelector('.serviceSelect').value;
      return {
        description: desc,
        quantity: parseInt(row.querySelector('.qty').value) || 0,
        unitPrice: parseFloat(row.querySelector('.price').textContent) || 0,
        lineTotal: parseFloat(row.querySelector('.lineTotal').textContent) || 0
      };
    }).filter(p => p.description);

    if(prestations.length === 0) {
      alert('Veuillez ajouter au moins une prestation.');
      return;
    }

    const factureData = {
      patient: { nom, prenom, naissance },
      prestations,
      modePaiement: paiement,
      totalTTC: parseFloat(grandTotalElem.textContent || '0'),
      statut: 'acquittee',
      createdAt: new Date().toISOString()
    };

    // Affiche animation
    const popup = document.getElementById('processingPopup');
    popup.style.display = 'block';
    const bar = document.getElementById('progressBar');
    bar.style.width = '0%';
    setTimeout(()=> bar.style.width = '100%', 100);

    try {
      // Enregistrement Firestore
      const ref = await db.collection('factures').add(factureData);
      currentFactureId = ref.id;

      // fin animation & lock
      setTimeout(()=> {
        popup.style.display = 'none';
        afficherBulle('‚úÖ Paiement valid√© (ID: ' + currentFactureId + ')', 'administratif');
        verrouillerFormulaire();
        // afficher boutons PDF et envoi email
        document.getElementById('downloadPdfBtn').style.display = 'inline-block';
        document.getElementById('sendEmailBtn').style.display = 'inline-block';
      }, 1200);
    } catch (err) {
      console.error('Erreur enregistrement facture', err);
      popup.style.display = 'none';
      afficherBulle('‚ùå Erreur enregistrement facture', 'alerte');
    }
  });

  function verrouillerFormulaire(){
    // D√©sactive tous les inputs/selects et boutons (sauf downloadPdfBtn & sendEmailBtn)
    document.querySelectorAll('#invoiceForm input, #invoiceForm select, #invoiceForm button').forEach(el => {
      if(el.id === 'downloadPdfBtn' || el.id === 'sendEmailBtn') return;
      el.disabled = true;
    });
    // Hide remove buttons visually
    document.querySelectorAll('.removeBtn').forEach(b => b.style.display = 'none');
    document.getElementById('addItemBtn').style.display = 'none';
    document.getElementById('validateBtn').style.display = 'none';
  }

  async function creerFacture(telecharger = false) {
  const nom = document.getElementById('lastName').value || '';
  const prenom = document.getElementById('firstName').value || '';
  const naissance = document.getElementById('birthDate').value || '';
  const paiement = document.getElementById('paymentMode').value || '';
  const dateStr = new Date().toLocaleDateString('fr-FR');
  const factureNum = currentFactureId || ('temp-' + Date.now());
  const prestations = [...itemsTable.querySelectorAll('tr')].map(row => {
    const service = row.querySelector('.serviceSelect').value || '';
    const qty = row.querySelector('.qty').value || '0';
    const pu = row.querySelector('.price').textContent || '0';
    const total = row.querySelector('.lineTotal').textContent || '0';
    return { service, qty, pu, total };
  }).filter(p => p.service);

  const totalTTC = parseFloat(grandTotalElem.textContent || '0').toFixed(2);
  const dateFact = new Date().toLocaleDateString('fr-FR');

  const invoiceHtml = `
    <div style="font-family:Arial,Helvetica,sans-serif;color:#222; padding:24px; max-width:800px; margin:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid #007bff; padding-bottom:12px;">
        <div style="display:flex; gap:12px; align-items:center;">
          <img src="logo.jpg" alt="Logo" style="height:70px; object-fit:contain;">
          <div>
            <div style="font-size:18px; font-weight:800; color:#111;">Centre Hospitalier - Service des Urgences</div>
            <div style="font-size:13px; color:#555; margin-top:6px;">Adresse clinique ‚Ä¢ 00 00 00 00 00 ‚Ä¢ contact@clinique.example</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:14px; font-weight:700;">FACTURE</div>
          <div style="font-size:13px; color:#555; margin-top:6px;">N¬∞: <strong>${factureNum}</strong></div>
          <div style="font-size:13px; color:#555;">Date: <strong>${dateStr}</strong></div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:18px; gap:12px;">
        <div style="flex:1;">
          <div style="font-weight:700; color:#333;">Factur√© √† :</div>
          <div style="margin-top:8px; font-size:14px;">${prenom} ${nom}</div>
          <div style="font-size:13px; color:#555;">N√©(e) le : ${naissance || '-'}</div>
          <div style="font-size:13px; color:#555; margin-top:6px;">Mode paiement : ${paiement}</div>
        </div>
        <div style="flex:1; text-align:right;">
          <div style="font-weight:700; color:#333;">centre Hospitalier</div>
          <div style="margin-top:8px; font-size:14px;">Service des Uregnces</div>
        
        </div>
      </div>

      <table style="width:100%; border-collapse:collapse; margin-top:18px;">
        <thead>
          <tr style="background:#f6f8fb;">
            <th style="padding:10px; text-align:left;">Prestation</th>
            <th style="padding:10px;">Quantit√©</th>
            <th style="padding:10px;">Prix Unitaire</th>
            <th style="padding:10px;">Total</th>
          </tr>
        </thead>
        <tbody>
          ${prestations.map(p => `
            <tr>
              <td style="padding:10px; text-align:left;">${p.service}</td>
              <td style="padding:10px; text-align:center;">${p.qty}</td>
              <td style="padding:10px; text-align:center;">${parseFloat(p.pu).toFixed(2)} ‚Ç¨</td>
              <td style="padding:10px; text-align:center;">${parseFloat(p.total).toFixed(2)} ‚Ç¨</td>
            </tr>
          `).join('')}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" style="padding:12px; border-top:2px solid #eee;"></td>
            <td style="padding:12px; text-align:right; font-weight:800;">TOTAL TTC</td>
            <td style="padding:12px; text-align:center; font-weight:800;">${totalTTC} ‚Ç¨</td>
          </tr>
        </tfoot>
      </table>

      <div style="margin-top:22px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-size:13px; color:#555; max-width:60%;">Mentions : Paiement re√ßu et facture acquitt√©e. Conservez ce document comme preuve.</div>
        <div style="font-weight:900; color:#2e7d32; font-size:22px; transform:rotate(-6deg); border:2px solid rgba(46,125,50,0.12); padding:8px 12px; border-radius:6px; background:rgba(46,125,50,0.06);">FACTURE ACQUITTEE</div>
      </div>

      <div style="margin-top:28px; border-top:1px dashed #e6e9ec; padding-top:10px; font-size:12px; color:#777;">
        Centre Hospitalier ‚Ä¢ Service des urgences ‚Ä¢ urgences.hopj@gamil.com
      </div>
    </div>
  `;

  const container = document.createElement('div');
  container.innerHTML = invoiceHtml;
  document.body.appendChild(container);

  const opt = {
    margin: 0.5,
    filename: `Facture - ${prenom} ${nom} - ${dateFact}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  try {
    if (telecharger) {
      await html2pdf().set(opt).from(container).save();
      container.remove();
      return null;
    } else {
      // retourne le blob
      const pdfBlob = await html2pdf().set(opt).from(container).outputPdf('blob');
      container.remove();
      return pdfBlob;
    }
  } catch (err) {
    console.error('Erreur g√©n√©ration PDF', err);
    afficherBulle('‚ùå Erreur g√©n√©ration PDF', 'alerte');
    container.remove();
    return null;
  }
}


  // Download PDF button (uses html2pdf and cleans up)
  document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
  await creerFacture(true);
});


  // ---------- Email sending system (copi√©/adapt√© du rapport) ----------
  // comptes EmailJS multi-comptes (identiques au rapport)
  const comptesEmailJS = [
    { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
    { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },//secours urg
    { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }//secours llb09
  ];

  function openEmailSelectModal(emailsString) {
    const modal = document.getElementById("emailSelectModal");
    const container = document.getElementById("emailCheckboxes");
    container.innerHTML = "";

    const emails = (emailsString || "").split("//").filter(e => e.includes("@"));
    if (emails.length === 0) {
      container.innerHTML = "<p style='color:#777;'>Aucune adresse trouv√©e pour ce patient.</p>";
    } else {
      emails.forEach((email, i) => {
        const id = "emailCheck_" + i;
        container.innerHTML += `
          <label style="display:flex; align-items:center; gap:6px; margin:6px 0;">
            <input type="checkbox" id="${id}" value="${email}" checked>
            ${email}
          </label>`;
      });
    }

    modal.style.display = "flex";
  }

  function closeEmailSelectModal() {
    document.getElementById("emailSelectModal").style.display = "none";
  }

  document.getElementById("otherEmailCheck").addEventListener("change", (e) => {
    document.getElementById("otherEmailInput").disabled = !e.target.checked;
  });

  // Click on "Envoyer par e-mail" opens modal prefilled with patient emails (if any)
  document.getElementById('sendEmailBtn').addEventListener('click', async () => {
    // get patient stored emails (string like "a@x.com//b@y.fr") from patientData if present
    const patientData = window.patientData || {};
    const emails = patientData.email || ""; // same format as in rapport
    openEmailSelectModal(emails);
  });

  // confirmEmails handler (copied/adapted)
  document.getElementById('confirmEmails').addEventListener('click', async function () {
    try {
      // R√©cup√®re les adresses s√©lectionn√©es dans la modale
      const checkedBoxes = document.querySelectorAll("#emailCheckboxes input[type='checkbox']:checked");
      let destinataires = Array.from(checkedBoxes).map(cb => cb.value.trim());

      const otherChecked = document.getElementById("otherEmailCheck").checked;
      const otherEmail = document.getElementById("otherEmailInput").value.trim();
      if (otherChecked && otherEmail) destinataires.push(otherEmail);

      if (destinataires.length === 0) {
        alert("Veuillez cocher au moins une adresse e-mail.");
        return;
      }

      closeEmailSelectModal();
      showLoadingModal()
      
// --- 1) G√©n√©ration du PDF via creerFacture(false) ---
const pdfBlob = await creerFacture(false);
if (!pdfBlob) throw new Error("Erreur lors de la g√©n√©ration du PDF.");
      

      const pdfBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = reader.result;
          const base64 = dataUrl.split(',')[1];
          resolve(base64);
        };
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(pdfBlob);
      });

      // --- 2) Cr√©ation d'un ID unique et enregistrement dans Firestore (collection 'liens_pdfs') ---
      let idUnique, docSnap;
      do {
        idUnique = Math.random().toString(36).substring(2, 10);
        docSnap = await db.collection("liens_pdfs").doc(idUnique).get();
      } while (docSnap.exists);

      // Get patient name for filename
      const patientDocId = new URLSearchParams(window.location.search).get('id');
      let firstName = document.getElementById('firstName').value || '';
      let lastName = document.getElementById('lastName').value || '';
      if (patientDocId) {
        try {
          const pd = await db.collection('patients').doc(patientDocId).get();
          if (pd.exists) {
            const pdata = pd.data();
            firstName = pdata.prenom || firstName;
            lastName = pdata.nom || lastName;
          }
        } catch (e) { /* ignore */ }
      }

      const dateFact = new Date().toLocaleDateString('fr-FR');
      const fileName = `Facture - ${firstName} ${lastName} - ${dateFact}.pdf`;

      await db.collection("liens_pdfs").doc(idUnique).set({
        base64: pdfBase64,
        nomFichier: fileName,
        dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
      });

      const lienPdf = `https://junior2704.github.io/urgences-/monpdf.html?id=${idUnique}`;

      // --- 3) Pr√©parer le message HTML (template similaire au rapport, adapt√© pour facture) ---
      const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="utf-8"></head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI', Roboto, Arial, sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#0057a4; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>
    <tr>
      <td style="padding:30px;">
        <h2 style="color:#0057a4; font-weight:600; margin-top:0;">Votre facture est disponible</h2>

        <p style="font-size:16px; line-height:1.6;">
          Bonjour <strong>${firstName} ${lastName}</strong>,
        </p>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          La facture (d'un montant de <strong>${parseFloat(grandTotalElem.textContent || '0').toFixed(2)} ‚Ç¨</strong>) relative √† votre prise en charge est disponible.
          Vous pouvez la cosulter et la t√©l√©charger en cliquant sur le lien ci-dessous.
        </p>

        <div style="text-align:center; margin:30px 0;">
          <a href="${lienPdf}" 
             style="background-color:#0057a4; color:white; padding:14px 32px; text-decoration:none; border-radius:8px; font-weight:500; display:inline-block;">
            üîó Voir la facture
          </a>
        </div>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          ‚ö†Ô∏è Ce lien reste actif 7 jours. Pour des raisons de confidentialit√©, la facture ne sera plus accessible apr√®s ce d√©lai.
        </p>

        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

      // --- 4) Envoi vers chaque destinataire via multi comptes EmailJS (template_general) ---
      for (const email of destinataires) {
        const emailTrim = email.trim();
        if (!emailTrim || !emailTrim.includes("@")) {
          afficherBulle(`Adresse invalide : ${emailTrim}`, "alerte");
          continue;
        }

        let envoye = false;
        let derniereErreur = "";
        for (const compte of comptesEmailJS) {
          try {
            console.log(`üì® Envoi √† ${emailTrim} via ${compte.serviceID}...`);
            await emailjs.send(compte.serviceID, compte.templateID, {
              to_email: emailTrim,
              subject: `Votre facture - ${firstName} ${lastName}`,
              html_message: htmlMessage
            }, compte.publicKey);

            afficherBulle(`üì® Envoy√© : ${emailTrim}`, "administratif");
            envoye = true;
            break;
          } catch (err) {
            console.warn(`‚ö†Ô∏è √âchec ${compte.serviceID} -> ${err && err.text ? err.text : err}`);
            derniereErreur = err && err.text ? err.text : String(err);
            // si erreur de quota, on essaye le compte suivant
            if (derniereErreur.toLowerCase().includes("quota")) continue;
            else break;
          }
        }

        if (!envoye) afficherBulle(`‚ùå √âchec d'envoi √† ${emailTrim}`, "alerte");
      }

      // --- 5) Fin & UI updates ---
      hideLoadingModal()
      afficherBulle("üì® Envois termin√©s !", "administratif");
      // reload to reset UI (optionnel)
     // setTimeout(() => location.reload(true), 1500);

    } catch (err) {
      hideLoadingModal()
      console.error("Erreur confirmEmails :", err);
      alert("Erreur lors de l'envoi : " + (err.message || err));
    }
  });

  // ---------- Utilities ----------
  function convertirDateEnFrancais(dateISO) {
    if (!dateISO) return '';
    const [annee, mois, jour] = dateISO.split("-");
    return `${jour}/${mois}/${annee}`;
  }

  // Reset button
  document.getElementById('resetBtn').addEventListener('click', () => {
    if(!confirm('R√©initialiser le formulaire ? Toutes les modifications non enregistr√©es seront perdues.')) return;
    window.location.href = window.location.pathname; // recharge sans params
  });

  // auto totals recalc
  document.getElementById('invoiceForm').addEventListener('input', updateTotals);
  updateTotals();

  // hide loading modal helper if needed
  function showLoadingModal() {
  document.getElementById("loadingModal").classList.add("show");
}

function hideLoadingModal() {
  document.getElementById("loadingModal").classList.remove("show");
}
  </script>
</body>
</html>
