<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üí∞ Facturation</title>
  <link rel="icon" type="image/jpeg" href="logo.jpg" />

  <!-- Librairies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #f4f6f8, #e9ecef);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    form {
      background: #fff;
      border-radius: 12px;
      padding: 25px 30px;
      max-width: 900px;
      margin: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    label { font-weight: 600; margin-top: 15px; display: block; }
    input, select {
      width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;
      margin-top: 5px; box-sizing: border-box;
    }
    input:disabled, select:disabled {
      background-color: #f7f7f7; color: #666;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: center;
    }
    th { background-color: #f1f1f1; }
    .button {
      background-color: #28a745; color: white; border: none; border-radius: 6px;
      padding: 10px 20px; cursor: pointer; font-weight: 600;
      transition: background 0.3s ease;
    }
    .button:hover { background-color: #218838; }
    .danger { background-color: #dc3545; }
    .danger:hover { background-color: #a71d2a; }
    .warning { background-color: #ffc107; color: #000; }
    .warning:hover { background-color: #e0a800; }
    .secondary { background-color: #17a2b8; }
    .secondary:hover { background-color: #138496; }
    .btn-container {
      display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap;
    }
    #bubble-container {
      position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999;
    }
    .bubble {
      max-width: 300px; padding: 10px 15px; border-radius: 8px;
      color: white; font-family: sans-serif;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      animation: fadeout 0.5s ease-in-out 1.5s forwards;
    }
    .administratif { background-color: #2196F3; }
    .alerte { background-color: #f44336; }
    @keyframes fadeout { to { opacity: 0; transform: translateX(-20px); } }

    #processingPopup {
      display:none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background-color: #007bff; color: white; padding: 20px 30px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 9999; text-align: center;
    }
    #progressBar {
      height: 8px; width: 0%; background: white; transition: width 2.5s linear;
      margin-top: 10px; border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>üí∞ Facturation des Patients</h1>

<form id="invoiceForm">
  <div class="btn-container">
    <a href="urgences.html" class="button">‚Ü©Ô∏è Retour Urgences</a>
    <button type="button" id="resetBtn" class="button danger">‚ùå R√©initialiser</button>
  </div>

  <label>Nom :</label>
  <input type="text" id="lastName" required>

  <label>Pr√©nom :</label>
  <input type="text" id="firstName" required>

  <label>Date de naissance :</label>
  <input type="date" id="birthDate" required>
  <div id="ageDisplay" style="font-size:14px;color:#666;"></div>

  <h2 style="margin-top:25px;">ü©∫ Prestations</h2>
  <table id="itemsTable">
    <thead>
      <tr><th>Prestation</th><th>Quantit√©</th><th>Prix (‚Ç¨)</th><th>Total (‚Ç¨)</th><th></th></tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <select class="serviceSelect" required>
            <option value="" data-price="0">-- Choisir --</option>
            <option value="Forfait urgences" data-price="29">Forfait urgences - 29‚Ç¨</option>
            <option value="Forfait urgences mineur" data-price="19">Forfait urgences mineur - 19‚Ç¨</option>
            <option value="Analyse sanguine" data-price="45">Analyse sanguine - 45‚Ç¨</option>
            <option value="Radiographie" data-price="10">Radiographie - 10‚Ç¨</option>
          </select>
        </td>
        <td><input type="number" class="qty" min="1" value="1"></td>
        <td class="price">0.00</td>
        <td class="lineTotal">0.00</td>
        <td><button type="button" class="button warning removeBtn">üóëÔ∏è</button></td>
      </tr>
    </tbody>
    <tfoot>
      <tr><td colspan="3" style="text-align:right;font-weight:bold;">Total (‚Ç¨)</td><td id="grandTotal">0.00</td><td></td></tr>
    </tfoot>
  </table>

  <button type="button" id="addItemBtn" class="button">‚ûï Ajouter</button>

  <label>Mode de paiement :</label>
  <select id="paymentMode" required>
    <option value="">-- Choisir --</option>
    <option value="Esp√®ces">üí∂ Esp√®ces</option>
    <option value="Carte bancaire">üí≥ Carte bancaire</option>
    <option value="Ch√®que">‚úçÔ∏è Ch√®que</option>
    <option value="Carte Vitale">üÜî Carte Vitale</option>
    <option value="Hospitalisation">üè• Hospitalisation</option>
  </select>

  <div class="btn-container">
    <button type="button" id="validateBtn" class="button secondary">‚úÖ Valider Paiement</button>
    <button type="button" id="downloadPdfBtn" class="button" style="display:none;">üìÑ T√©l√©charger PDF</button>
  </div>
</form>

<!-- Popup animation -->
<div id="processingPopup">
  <div>üí∏ Validation en cours...</div>
  <div style="background:rgba(255,255,255,0.3); height:8px; border-radius:4px; overflow:hidden;">
    <div id="progressBar"></div>
  </div>
</div>

<script>
  // Firebase (inchang√©)
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Gestion dynamique des prestations
  const itemsTable = document.querySelector('#itemsTable tbody');
  const grandTotalElem = document.getElementById('grandTotal');
  const addItemBtn = document.getElementById('addItemBtn');

  function updateLine(row) {
    const select = row.querySelector('.serviceSelect');
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const price = parseFloat(select.selectedOptions[0].dataset.price) || 0;
    row.querySelector('.price').textContent = price.toFixed(2);
    row.querySelector('.lineTotal').textContent = (qty * price).toFixed(2);
  }

  function updateTotals() {
    let total = 0;
    itemsTable.querySelectorAll('tr').forEach(row => {
      updateLine(row);
      total += parseFloat(row.querySelector('.lineTotal').textContent) || 0;
    });
    grandTotalElem.textContent = total.toFixed(2);
  }

  function addListeners(row) {
    row.querySelector('.serviceSelect').addEventListener('change', updateTotals);
    row.querySelector('.qty').addEventListener('input', updateTotals);
    row.querySelector('.removeBtn').addEventListener('click', () => { row.remove(); updateTotals(); });
  }
  itemsTable.querySelectorAll('tr').forEach(addListeners);
  addItemBtn.addEventListener('click', () => {
    const row = itemsTable.insertRow();
    row.innerHTML = `
      <td>
        <select class="serviceSelect">
          <option value="" data-price="0">-- Choisir --</option>
          <option value="Forfait urgences" data-price="29">Forfait urgences - 29‚Ç¨</option>
          <option value="Analyse sanguine" data-price="45">Analyse sanguine - 45‚Ç¨</option>
          <option value="Radiographie" data-price="10">Radiographie - 10‚Ç¨</option>
        </select>
      </td>
      <td><input type="number" class="qty" min="1" value="1"></td>
      <td class="price">0.00</td>
      <td class="lineTotal">0.00</td>
      <td><button type="button" class="button warning removeBtn">üóëÔ∏è</button></td>`;
    addListeners(row);
    updateTotals();
  });

  // Valider paiement
  document.getElementById('validateBtn').addEventListener('click', async () => {
    updateTotals();
    const nom = document.getElementById('lastName').value.trim();
    const prenom = document.getElementById('firstName').value.trim();
    const dateNaiss = document.getElementById('birthDate').value;
    const paiement = document.getElementById('paymentMode').value;

    if (!nom || !prenom || !dateNaiss || !paiement) {
      alert("‚ö†Ô∏è Veuillez remplir tous les champs.");
      return;
    }

    const prestations = [...itemsTable.querySelectorAll('tr')].map(row => ({
      description: row.querySelector('.serviceSelect').value,
      quantite: parseInt(row.querySelector('.qty').value),
      prix: parseFloat(row.querySelector('.price').textContent),
      total: parseFloat(row.querySelector('.lineTotal').textContent)
    })).filter(p => p.description);

    if (prestations.length === 0) {
      alert("‚ö†Ô∏è Aucune prestation s√©lectionn√©e.");
      return;
    }

    const facture = {
      nom, prenom, dateNaiss, paiement,
      prestations, total: parseFloat(grandTotalElem.textContent),
      date: new Date().toISOString()
    };

    // Animation validation
    const popup = document.getElementById('processingPopup');
    popup.style.display = 'block';
    const bar = document.getElementById('progressBar');
    bar.style.width = '0%';
    setTimeout(() => bar.style.width = '100%', 100);

    // Enregistrement Firestore
    const ref = await db.collection('factures').add(facture);
    const factureId = ref.id;

    setTimeout(() => {
      popup.style.display = 'none';
      alert(`‚úÖ Facture valid√©e (ID: ${factureId})`);
      verrouillerFormulaire();
      document.getElementById('downloadPdfBtn').style.display = 'inline-block';
    }, 2500);
  });

  function verrouillerFormulaire() {
    document.querySelectorAll('input, select, button').forEach(el => {
      if (!el.id.includes("downloadPdf")) el.disabled = true;
    });
  }

  // T√©l√©chargement PDF
  document.getElementById('downloadPdfBtn').addEventListener('click', () => {
    const element = document.getElementById('invoiceForm');
    const opt = {
      margin: 0.5,
      filename: `facture_${document.getElementById('lastName').value}_${Date.now()}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  });

  // R√©initialisation
  document.getElementById('resetBtn').addEventListener('click', () => window.location.reload());
</script>
</body>
</html>
