<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/jpeg" href="logo.jpg">

  <title>‚öôÔ∏è Param√®tres</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 40px;
      background: #f7f9fc;
      color: #2c3e50;
    }
    h1 {
      text-align: center;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
    }
    input[type="text"] {
      padding: 8px;
      margin: 5px 0 10px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 8px;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-add {
      background: #2ecc71;
      color: white;
    }
    .btn-del {
      background: #e74c3c;
      color: white;
      margin-left: 8px;
    }

    /* Modale */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      min-width: 300px;
      max-width: 90%;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-actions {
      text-align: right;
      margin-top: 20px;
    }
    .modal-actions button {
      margin-left: 10px;
    }
	#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
.blur {
  filter: blur(10px);
  pointer-events: none;
  user-select: none;
}

#passwordModal {
  display: flex;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

#passwordModal .modal-content {
  max-width: 400px;
}
/* ‚úèÔ∏è Boutons d‚Äô√©dition */
.btn-edit {
  background: transparent;
  border: none;
  font-size: 18px;
  margin-left: 8px;
  cursor: pointer;
  color: #0078d4;
  transition: transform 0.2s, color 0.2s;
}
.btn-edit:hover {
  color: #005ea2;
  transform: scale(1.2);
}

/* üîí Modale de code */
#modalCode {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.55);
  z-index: 99999; /* üß© priorit√© max */
  justify-content: center;
  align-items: center;
}

#modalCode .modal-content {
  background: #ffffff;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  animation: popIn 0.25s ease;
  border-top: 5px solid #0078d4;
  text-align: center;
}

#modalCode input[type="text"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #ccd6e0;
  font-size: 1rem;
  margin-top: 10px;
}

#modalCode input:focus {
  border-color: #0078d4;
  box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25);
  outline: none;
}

@keyframes popIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

  </style>
</head>
<body>
<div id="passwordModal">
  <div class="modal-content">
    <h3>üîí Mot de passe requis</h3>
    <input type="password" id="passwordInput" placeholder="Entrez le mot de passe" />
    <div class="modal-actions">
      <button class="btn btn-add" id="validerMotDePasse">‚úÖ Valider</button>
    </div>
  </div>
</div>
<div id="content" class="blur">

  <h1>‚öôÔ∏è Param√®tres</h1>
<button style="padding: 10px 20px; font-size: 16px; cursor: pointer;" onclick="window.location.href='admin.html'">
  Gestion des comptes
</button>
<div id="nom-medecin"></div>
<div id="specialite"></div>
<div id="lieu-medecin"></div>

  <div class="section">
    <h2>ü©∫ Actes <button class="btn btn-add" onclick="openModal('actes')">‚ûï Ajouter</button></h2>
    <ul id="actesList"></ul>
  </div>

  <div class="section">
    <h2>üë®‚Äç‚öïÔ∏è Personnel <button class="btn btn-add" onclick="openModal('personnel')">‚ûï Ajouter</button></h2>
    <ul id="personnelList"></ul>
  </div>
<div class="section">
    <h2>Services <button class="btn btn-add" onclick="openModal('sp√©cialit√©s')">‚ûï Ajouter</button></h2>
    <ul id="sp√©cialit√©sList"></ul>
  </div>
<!-- üîê Codes d‚Äôacc√®s -->
<div class="section">
  <h2>üîí Codes d‚Äôacc√®s</h2>

  <p>
    <strong>üßæ Code de Cl√¥ture d‚ÄôHospitalisation (CCH) :</strong>
    <span id="afficheCCH">.......</span>
    <button class="btn-edit" id="btnEditCCH" title="Modifier le CCH">‚úèÔ∏è</button>
  </p>

  <p>
    <strong>‚öôÔ∏è Code d‚ÄôAcc√®s Administratif (CAA) :</strong>
    <span id="afficheCAA">.......</span>
    <button class="btn-edit" id="btnEditCAA" title="Modifier le CAA">‚úèÔ∏è</button>
  </p>
</div>

<!-- ü™ü Modale pour modifier un code -->
<div class="modal" id="modalCode">
  <div class="modal-content">
    <h3 id="titreCode">Modifier le code</h3>
    <input type="text" id="inputCode" placeholder="Nouveau code..." />
    <div class="modal-actions">
      <button class="btn" id="btnAnnulerCode">‚ùå Annuler</button>
      <button class="btn btn-add" id="btnValiderCode">‚úÖ Valider</button>
    </div>
  </div>
</div>


  <section id="nettoyage-section" 
         style="background: #f8fafc; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
                padding: 24px; margin: 20px auto; max-width: 700px;">

  <h2 style="font-size: 22px; color: #1a73e8; font-weight: 600; margin-bottom: 10px;">
    üßπ Nettoyage et maintenance
  </h2>

  <p style="font-size: 15px; color: #555; line-height: 1.6;">
    Cette section vous permet de g√©rer le nettoyage automatique des anciens rapports et documents stock√©s sur le serveur. 
    Le nettoyage se fait normalement automatiquement.
    Pour relancer un netttoyage (supression des acc√®s aux pdf de plus de 7 jours), cliquez ci-dessous :
    
  </p>

  <div style="text-align: center; margin-top: 20px;">
    <button id="btnNettoyage"
            style="background-color: #1a73e8; color: white; border: none; 
                   padding: 12px 28px; border-radius: 8px; font-size: 16px; 
                   font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
      üîó Ouvrir l‚Äôoutil de nettoyage
    </button>
  </div>
</section>
 <section id="nettoyage-section" 
         style="background: #f8fafc; border-radius: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
                padding: 24px; margin: 20px auto; max-width: 700px;">

  <h2 style="font-size: 22px; color: #1a73e8; font-weight: 600; margin-bottom: 10px;">
    Afficheur salle-attente
  </h2>

  <p style="font-size: 15px; color: #555; line-height: 1.6;">
    Cliquez sur le lien ci-dessous pour ouvrir l'afficheur patient : 
    IL permet d'afficher le nombre de patients en salle d'attente, en prise ne charge, en urgences vitales,... en fonction des donn√©es saisies dans les fiches patients
    
  </p>

  <div style="text-align: center; margin-top: 20px;">
    <button id="btnAfficheur"
            style="background-color: #1a73e8; color: white; border: none; 
                   padding: 12px 28px; border-radius: 8px; font-size: 16px; 
                   font-weight: 500; cursor: pointer; transition: all 0.3s ease;">
      üîó Ouvrir l‚Äôafficheur
    </button>
  </div>
</section>
  <!-- MODALE -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle">‚ûïAjouter</h3>
      <input type="text" id="modalInput" placeholder="Nom..." />
      <div class="modal-actions">
        <button class="btn" onclick="cancelModal()">‚ùå Annuler</button>
        <button class="btn btn-add" onclick="confirmModal()">‚úÖ Valider</button>
      </div>
    </div>
  </div>
</div>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Configuration Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
  };

  // --- Initialisation unique ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  console.log("‚úÖ Firebase initialis√© :", app.name);


onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "connexionadmin.html";
    return;
  }

  const ref = doc(db, "medecins", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  if (!data?.pages?.admin) {
    alert("Acc√®s r√©serv√© aux administrateurs.");
    window.location.href = "index.html";
  }
});

async function verifyPassword() {
  try {
    const docRef = doc(db, "patients", "QhwMJ0mjmUnS8MTNBCFU");
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const truePassword = docSnap.data()["CAA"];
      if (passwordInput.value === truePassword) {
        content.classList.remove("blur");
        passwordModal.style.display = "none";
		afficherBulle("‚úÖ Mot de passe correct !","administratif")
      } else {
        afficherBulle("‚ùå Mot de passe incorrect", "alerte");
      }
    } else {
      afficherBulle("‚ùå Mot de passe introuvable", "alerte");
    }
  } catch (error) {
    console.error("Erreur r√©cup√©ration mot de passe:", error);
    afficherBulle("‚ùå Erreur de v√©rification", "alerte");
  }
}

const actesListEl = document.getElementById('actesList');
const personnelListEl = document.getElementById('personnelList');
let actes = [];
let personnel = [];
let sp√©cialit√©s = [];
let currentType = null;

async function saveToFirestore() {
  try {

    await setDoc(doc(db, "r√©f√©rentiels", "actes"), { liste: actes });
    await setDoc(doc(db, "r√©f√©rentiels", "personnel"), { liste: personnel });
    await setDoc(doc(db, "r√©f√©rentiels", "sp√©cialit√©s"), { sp√©cialit√©s });


    afficherBulle("‚úÖ Donn√©es enregistr√©es avec succ√®s", "administratif");
  } catch (error) {
    console.error("Erreur lors de l'enregistrement :", error);
    afficherBulle("‚ùå √âchec de l'enregistrement", "alerte");
  }
}

async function loadData() {
  

  const actesSnap = await getDoc(doc(db, "r√©f√©rentiels", "actes"));
  actes = actesSnap.exists() ? actesSnap.data().liste || [] : [];
  renderList("actes", actes);

  const persSnap = await getDoc(doc(db, "r√©f√©rentiels", "personnel"));
  personnel = persSnap.exists() ? persSnap.data().liste || [] : [];
  renderList("personnel", personnel);
  
  const sp√©cialit√©sSnap = await getDoc(doc(db, "r√©f√©rentiels", "sp√©cialit√©s"));
sp√©cialit√©s = sp√©cialit√©sSnap.exists() ? sp√©cialit√©sSnap.data().sp√©cialit√©s || [] : [];
  renderList("sp√©cialit√©s", sp√©cialit√©s);
}

function renderList(type, array) {
const container = type === "actes" ? actesListEl : type === "sp√©cialit√©s" ? document.getElementById("sp√©cialit√©sList") : personnelListEl;
  container.innerHTML = "";
  array.forEach((item, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<input value="${item.replace(/"/g, '&quot;')}" onchange="updateItem('${type}', ${index}, this.value)" />
                    <button class="btn btn-del" onclick="removeItem('${type}', ${index})">‚ùå</button>`;
    container.appendChild(li);
  });
}
 document.getElementById("btnNettoyage").addEventListener("click", () => {
    window.location.href = "nettoyage.html";
  });
   document.getElementById("btnAfficheur").addEventListener("click", () => {
    window.location.href = "afficheur-patient.html";
  });
window.updateItem = async (type, index, newValue) => {
  if (type === "actes") actes[index] = newValue;
  if (type === "personnel") personnel[index] = newValue;
  if (type === "sp√©cialit√©s") sp√©cialit√©s[index] = newValue;

  await saveToFirestore();
};

window.removeItem = async (type, index) => {
  if (type === "actes") actes.splice(index, 1);
  if (type === "personnel") personnel.splice(index, 1);
  if (type === "sp√©cialit√©s") sp√©cialit√©s.splice(index, 1);
  renderList(type, type === "actes" ? actes : type === "sp√©cialit√©s" ? sp√©cialit√©s : personnel);
  await saveToFirestore();
};

window.openModal = (type) => {
  currentType = type;
  document.getElementById("modalTitle").textContent = `‚ûï Ajouter √† ${type}`;
  document.getElementById("modalInput").value = "";
  document.getElementById("modal").style.display = "flex";
};

window.confirmModal = async () => {
  const val = document.getElementById("modalInput").value.trim();
  if (!val) return;
  if (currentType === "actes") actes.push(val);
  if (currentType === "personnel") personnel.push(val);
    if (currentType === "sp√©cialit√©s") sp√©cialit√©s.push(val);
  renderList(currentType, currentType === "actes" ? actes : currentType === "sp√©cialit√©s" ? sp√©cialit√©s : personnel);
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

window.cancelModal = async () => {
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

function afficherBulle(texte, type) {
  let container = document.getElementById('bubble-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'bubble-container';
    container.style.position = "fixed";
    container.style.top = "20px";
    container.style.right = "20px";
    container.style.zIndex = "9999";
    document.body.appendChild(container);
  }
  const bulle = document.createElement('div');
  bulle.className = `bubble ${type}`;
  bulle.textContent = texte;
  bulle.style.backgroundColor = type === "administratif" ? "#3498db" : "#e74c3c";
  bulle.style.color = "white";
  bulle.style.padding = "10px 15px";
  bulle.style.marginBottom = "10px";
  bulle.style.borderRadius = "6px";
  bulle.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  bulle.style.transition = "opacity 0.4s ease";
  container.appendChild(bulle);
  setTimeout(() => {
    bulle.style.opacity = "0";
    setTimeout(() => bulle.remove(), 400);
  }, 2500);
}
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    cancelModal();
  }
});

loadData();
document.getElementById("validerMotDePasse").addEventListener("click", verifyPassword);

  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "accueil.html";
    } else {
      const docSnap = await getDoc(doc(db, "medecins", user.uid));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nom-medecin").textContent = data.nom || "M√©decin";
        document.getElementById("specialite").textContent = data.specialite || "";
      }
    }
  });
  
let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "accueil.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        const medecinNom = data.nom || "";
        const medecinSpecialite = data.specialite || "";
        const medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});
// --- GESTION CCH & CAA ---
const docPatientRef = doc(db, "patients", "QhwMJ0mjmUnS8MTNBCFU");
const spanCCH = document.getElementById("afficheCCH");
const spanCAA = document.getElementById("afficheCAA");
const modalCode = document.getElementById("modalCode");
const titreCode = document.getElementById("titreCode");
const inputCode = document.getElementById("inputCode");
const btnAnnulerCode = document.getElementById("btnAnnulerCode");
const btnValiderCode = document.getElementById("btnValiderCode");

let codeType = null;

// üîπ Charger les codes
async function chargerCodes() {
  const snap = await getDoc(docPatientRef);
  if (snap.exists()) {
    const data = snap.data();
    spanCCH.textContent = data.CCH ? "......." : "Non d√©fini";
    spanCAA.textContent = data.CAA ? "......." : "Non d√©fini";
  }
}
chargerCodes();

// üîπ Ouvrir la modale
document.getElementById("btnEditCCH").addEventListener("click", () => {
  codeType = "CCH";
  titreCode.textContent = "Modifier le CCH";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

document.getElementById("btnEditCAA").addEventListener("click", () => {
  codeType = "CAA";
  titreCode.textContent = "Modifier le CAA";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

// üîπ Fermer la modale
btnAnnulerCode.addEventListener("click", () => {
  modalCode.style.display = "none";
});

// üîπ Valider la modification
btnValiderCode.addEventListener("click", async () => {
  const newCode = inputCode.value.trim();
  if (!newCode) {
    afficherBulle("‚ö†Ô∏è Entrez un code valide", "alerte");
    return;
  }
  try {
    await setDoc(docPatientRef, { [codeType]: newCode }, { merge: true });
    afficherBulle(`‚úÖ ${codeType} mis √† jour`, "administratif");
    modalCode.style.display = "none";
    chargerCodes();
  } catch (e) {
    console.error("Erreur mise √† jour code :", e);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
});


</script>
</body>
</html>

