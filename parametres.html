<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/jpeg" href="logo.png">

  <title>âš™ï¸ ParamÃ¨tres</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 40px;
      background: #f7f9fc;
      color: #2c3e50;
    }
    h1 {
      text-align: center;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
    }
    input[type="text"] {
      padding: 8px;
      margin: 5px 0 10px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 8px;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-add {
      background: #2ecc71;
      color: white;
    }
    .btn-del {
      background: #e74c3c;
      color: white;
      margin-left: 8px;
    }

    /* Modale */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      min-width: 300px;
      max-width: 90%;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-actions {
      text-align: right;
      margin-top: 20px;
    }
    .modal-actions button {
      margin-left: 10px;
    }
	#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
.blur {
  filter: blur(10px);
  pointer-events: none;
  user-select: none;
}

#passwordModal {
  display: flex;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

#passwordModal .modal-content {
  max-width: 400px;
}
/* âœï¸ Boutons dâ€™Ã©dition */
.btn-edit {
  background: transparent;
  border: none;
  font-size: 18px;
  margin-left: 8px;
  cursor: pointer;
  color: #0078d4;
  transition: transform 0.2s, color 0.2s;
}
.btn-edit:hover {
  color: #005ea2;
  transform: scale(1.2);
}

/* ğŸ”’ Modale de code */
#modalCode {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.55);
  z-index: 99999; /* ğŸ§© prioritÃ© max */
  justify-content: center;
  align-items: center;
}

#modalCode .modal-content {
  background: #ffffff;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  animation: popIn 0.25s ease;
  border-top: 5px solid #0078d4;
  text-align: center;
}

#modalCode input[type="text"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #ccd6e0;
  font-size: 1rem;
  margin-top: 10px;
}

#modalCode input:focus {
  border-color: #0078d4;
  box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25);
  outline: none;
}

@keyframes popIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
/* ğŸ”½ AccordÃ©on */
.section-title {
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-title::after {
  content: "â–¾";
  font-size: 18px;
  transition: transform 0.25s ease;
}

.section.collapsed .section-title::after {
  transform: rotate(-90deg);
}

.section-content {
  margin-top: 15px;
}

.section.collapsed .section-content {
  display: none;
}

  </style>
</head>
<body>

<div id="content">


  <h1>âš™ï¸ ParamÃ¨tres</h1>
<button style="padding: 10px 20px; font-size: 16px; cursor: pointer;" onclick="window.location.href='admin.html'">
  Gestion des comptes
</button>
<button style="padding: 10px 20px; font-size: 16px; cursor: pointer;" onclick="window.location.href='index.html'">
  Deconnexion administrateurs
</button>
<div id="nom-medecin"></div>
<div id="specialite"></div>
<div id="lieu-medecin"></div>

  <div class="section collapsed">
  <h2 class="section-title">
    ğŸ©º Actes
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('actes')">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="actesList"></ul>
  </div>
</div>


 <div class="section collapsed">
  <h2 class="section-title">
    ğŸ‘¨â€âš•ï¸ Personnel
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('personnel')">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="personnelList"></ul>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">
    ğŸ¥ Services
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('spÃ©cialitÃ©s')">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="spÃ©cialitÃ©sList"></ul>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">
    ğŸ’¶ Facturables
    <button class="btn btn-add" onclick="event.stopPropagation(); openFacturableModal()">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="facturablesList"></ul>
  </div>
</div>
<div class="section collapsed">
  <h2 class="section-title">
    ğŸš‘ Moyens
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('moyens')">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="moyensList"></ul>
  </div>
</div>

<!-- Modale spÃ©cifique pour les facturables -->
<div class="modal" id="modalFacturable">
  <div class="modal-content">
    <h3>â• Ajouter un Facturable</h3>
    <input type="text" id="facturableName" placeholder="Nom du facturable..." />
    <input type="number" id="facturablePrice" placeholder="Prix (sans â‚¬)" style="margin-top: 10px;" />
    <div class="modal-actions">
      <button class="btn" onclick="cancelFacturableModal()">âŒ Annuler</button>
      <button class="btn btn-add" onclick="confirmFacturable()">âœ… Valider</button>
    </div>
  </div>
</div>

<!-- ğŸ” Codes dâ€™accÃ¨s -->
<div class="section collapsed">
  <h2 class="section-title">ğŸ”’ Codes dâ€™accÃ¨s</h2>

  <div class="section-content">
    <p>
      <strong>ğŸ§¾ Code de ClÃ´ture dâ€™Hospitalisation (CCH) :</strong>
      <span id="afficheCCH">.......</span>
      <button class="btn-edit" id="btnEditCCH">âœï¸</button>
    </p>

    <p>
      <strong>âš™ï¸ Code dâ€™AccÃ¨s Administratif (CAA) :</strong>
      <span id="afficheCAA">.......</span>
      <button class="btn-edit" id="btnEditCAA">âœï¸</button>
    </p>
  </div>
</div>


<!-- ğŸªŸ Modale pour modifier un code -->
<div class="modal" id="modalCode">
  <div class="modal-content">
    <h3 id="titreCode">Modifier le code</h3>
    <input type="text" id="inputCode" placeholder="Nouveau code..." />
    <div class="modal-actions">
      <button class="btn" id="btnAnnulerCode">âŒ Annuler</button>
      <button class="btn btn-add" id="btnValiderCode">âœ… Valider</button>
    </div>
  </div>
</div>
<div class="section collapsed">
  <h2 class="section-title">
    ğŸ’¬ Messages dâ€™accueil
    <button class="btn btn-add" onclick="event.stopPropagation(); openAddMessageModal()">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="messagesAccueilList"></ul>
  </div>
</div>


<!-- MODALE AJOUT -->
<div class="modal" id="modalAddMessage">
  <div class="modal-content">
    <h3>â• Ajouter un message dâ€™accueil</h3>
    <input type="text" id="newMessageTitle" placeholder="Titre..." />
    <select id="newMessageType" style="margin-top:10px;">
      <option value="info">Info</option>
      <option value="alerte_grave">Alerte grave</option>
      <option value="alerte_moyenne">Alerte moyenne</option>
      <option value="remerciement">Remerciement</option>
    </select>
    <input type="text" id="newMessageText1" placeholder="Texte 1..." />
    <input type="text" id="newMessageText2" placeholder="Texte 2..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelAddMessageModal()">âŒ Annuler</button>
      <button class="btn btn-add" onclick="confirmAddMessage()">âœ… Valider</button>
    </div>
  </div>
</div>

<!-- MODALE EDIT -->
<div class="modal" id="modalEditMessage">
  <div class="modal-content">
    <h3>âœï¸ Modifier le message</h3>
    <input type="text" id="editMessageTitle" placeholder="Titre..." />
    <select id="editMessageType" style="margin-top:10px;">
      <option value="info">Info</option>
      <option value="alerte_grave">Alerte grave</option>
      <option value="alerte_moyenne">Alerte moyenne</option>
      <option value="remerciement">Remerciement</option>
    </select>
    <input type="text" id="editMessageText1" placeholder="Texte 1..." />
    <input type="text" id="editMessageText2" placeholder="Texte 2..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelEditMessageModal()">âŒ Annuler</button>
      <button class="btn btn-add" onclick="confirmEditMessage()">âœ… Valider</button>
    </div>
  </div>
</div>
<div class="section collapsed" id="sectionBureaux" style="display:none;">
  <h2 class="section-title">
    ğŸ¢ Bureaux
    <button class="btn btn-add" onclick="event.stopPropagation(); openModalBureau()">â• Ajouter</button>
  </h2>
  <div class="section-content">
    <ul id="bureauxList"></ul>
  </div>
</div>

</section>

 <div class="section collapsed">
  <h2 class="section-title">ğŸ§¹ Nettoyage et maintenance</h2>

  <div class="section-content">
    <p>
      Cette section vous permet de gÃ©rer le nettoyage automatique des anciens rapports
      et documents stockÃ©s sur le serveur.
    </p>

    <div style="text-align:center; margin-top:20px;">
      <button id="btnNettoyage">ğŸ”— Ouvrir lâ€™outil de nettoyage</button>
    </div>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">ğŸ“º Afficheur salle dâ€™attente</h2>

  <div class="section-content">
    <p>
      Ouvre lâ€™afficheur patient avec les donnÃ©es issues des fiches patients
      (salle dâ€™attente, urgences vitales, etc.).
    </p>

    <div style="text-align:center; margin-top:20px;">
      <button id="btnAfficheur">ğŸ”— Ouvrir lâ€™afficheur</button>
    </div>
  </div>
</div>



<!-- Modale spÃ©cifique pour crÃ©er/modifier un bureau -->
<div class="modal" id="modalBureau">
  <div class="modal-content">
    <h3>â• Ajouter un Bureau</h3>
    <input type="text" id="bureauNameInput" placeholder="Nom du bureau..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelModalBureau()">âŒ Annuler</button>
      <button class="btn btn-add" onclick="confirmModalBureau()">âœ… Valider</button>
    </div>
  </div>
</div>

  <!-- MODALE -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle">â•Ajouter</h3>
      <input type="text" id="modalInput" placeholder="Nom..." />
      <div class="modal-actions">
        <button class="btn" onclick="cancelModal()">âŒ Annuler</button>
        <button class="btn btn-add" onclick="confirmModal()">âœ… Valider</button>
      </div>
    </div>
  </div>
</div>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Configuration Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
  };

  // --- Initialisation unique ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  console.log("âœ… Firebase initialisÃ© :", app.name);


onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "connexionadmin.html";
    return;
  }

  const ref = doc(db, "medecins", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  if (!data?.pages?.admin) {
    alert("AccÃ¨s rÃ©servÃ© aux administrateurs.");
    window.location.href = "index.html";
  }
});



const actesListEl = document.getElementById('actesList');
const moyensListEl = document.getElementById('moyensList');

const personnelListEl = document.getElementById('personnelList');
let actes = [];
let moyens = [];
let personnel = [];
let spÃ©cialitÃ©s = [];
let currentType = null;

async function saveToFirestore() {
  try {

    await setDoc(doc(db, "rÃ©fÃ©rentiels", "actes"), { liste: actes });
    await setDoc(doc(db, "rÃ©fÃ©rentiels", "personnel"), { liste: personnel });
    await setDoc(doc(db, "rÃ©fÃ©rentiels", "spÃ©cialitÃ©s"), { spÃ©cialitÃ©s });


    afficherBulle("âœ… DonnÃ©es enregistrÃ©es avec succÃ¨s", "administratif");
  } catch (error) {
    console.error("Erreur lors de l'enregistrement :", error);
    afficherBulle("âŒ Ã‰chec de l'enregistrement", "alerte");
  }
}

async function loadData() {
  

  const actesSnap = await getDoc(doc(db, "rÃ©fÃ©rentiels", "actes"));
  actes = actesSnap.exists() ? actesSnap.data().liste || [] : [];
  renderList("actes", actes);

  const persSnap = await getDoc(doc(db, "rÃ©fÃ©rentiels", "personnel"));
  personnel = persSnap.exists() ? persSnap.data().liste || [] : [];
  renderList("personnel", personnel);
  
  const spÃ©cialitÃ©sSnap = await getDoc(doc(db, "rÃ©fÃ©rentiels", "spÃ©cialitÃ©s"));
spÃ©cialitÃ©s = spÃ©cialitÃ©sSnap.exists() ? spÃ©cialitÃ©sSnap.data().spÃ©cialitÃ©s || [] : [];
  renderList("spÃ©cialitÃ©s", spÃ©cialitÃ©s);
}

function renderList(type, array) {
const container = type === "actes" ? actesListEl : type === "moyens" ? moyensListEl : type === "spÃ©cialitÃ©s" ? document.getElementById("spÃ©cialitÃ©sList") : personnelListEl;
  container.innerHTML = "";
  array.forEach((item, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<input value="${item.replace(/"/g, '&quot;')}" onchange="updateItem('${type}', ${index}, this.value)" />
                    <button class="btn btn-del" onclick="removeItem('${type}', ${index})">âŒ</button>`;
    container.appendChild(li);
  });
}
 document.getElementById("btnNettoyage").addEventListener("click", () => {
    window.location.href = "nettoyage.html";
  });
   document.getElementById("btnAfficheur").addEventListener("click", () => {
    window.location.href = "afficheur-patient.html";
  });
window.updateItem = async (type, index, newValue) => {
    if (type === "moyens") moyens[index] = newValue;
  if (type === "actes") actes[index] = newValue;
  if (type === "personnel") personnel[index] = newValue;
  if (type === "spÃ©cialitÃ©s") spÃ©cialitÃ©s[index] = newValue;
 
  await saveToFirestore();
};

window.removeItem = async (type, index) => {
    if (type === "moyens") moyens.splice(index, 1);
  if (type === "actes") actes.splice(index, 1);
  if (type === "personnel") personnel.splice(index, 1);
  if (type === "spÃ©cialitÃ©s") spÃ©cialitÃ©s.splice(index, 1);
  renderList(type, type === "actes" ? actes : type === "spÃ©cialitÃ©s" ? spÃ©cialitÃ©s : personnel);
  await saveToFirestore();
};

window.openModal = (type) => {
  currentType = type;
  document.getElementById("modalTitle").textContent = `â• Ajouter Ã  ${type}`;
  document.getElementById("modalInput").value = "";
  document.getElementById("modal").style.display = "flex";
};

window.confirmModal = async () => {
  const val = document.getElementById("modalInput").value.trim();
  if (!val) return;
    if (currentType === "moyens") moyens.push(val);
  if (currentType === "actes") actes.push(val);
  if (currentType === "personnel") personnel.push(val);
    if (currentType === "spÃ©cialitÃ©s") spÃ©cialitÃ©s.push(val);
  renderList(currentType, currentType === "actes" ? actes : currentType === "spÃ©cialitÃ©s" ? spÃ©cialitÃ©s : personnel);
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

window.cancelModal = async () => {
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

/* ---------------- FACTURABLES ---------------- */
const facturablesListEl = document.getElementById("facturablesList");
let facturables = {}; // objet { nom: prix }

async function loadFacturables() {
  try {
    const snap = await getDoc(doc(db, "rÃ©fÃ©rentiels", "Facturables"));
    facturables = snap.exists() ? snap.data() : {};
    renderFacturables();
  } catch (err) {
    console.error("Erreur chargement facturables :", err);
  }
}

function renderFacturables() {
  facturablesListEl.innerHTML = "";
  const entries = Object.entries(facturables);
  if (entries.length === 0) {
    facturablesListEl.innerHTML = "<li>Aucun facturable pour le moment</li>";
    return;
  }

  entries.forEach(([nom, prix]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${nom}</strong> â€” <input type="number" value="${prix}" 
        onchange="updateFacturablePrice('${nom}', this.value)" style="width:80px;" /> â‚¬
      <button class="btn btn-del" onclick="deleteFacturable('${nom}')">âŒ</button>
    `;
    facturablesListEl.appendChild(li);
  });
}

window.openFacturableModal = () => {
  document.getElementById("modalFacturable").style.display = "flex";
  document.getElementById("facturableName").value = "";
  document.getElementById("facturablePrice").value = "";
};

window.cancelFacturableModal = () => {
  document.getElementById("modalFacturable").style.display = "none";
};

window.confirmFacturable = async () => {
  const name = document.getElementById("facturableName").value.trim();
  const price = parseFloat(document.getElementById("facturablePrice").value.trim());
  if (!name || isNaN(price)) {
    afficherBulle("âš ï¸ Nom ou prix invalide", "alerte");
    return;
  }

  facturables[name] = price;
  await saveFacturables();
  renderFacturables();
  document.getElementById("modalFacturable").style.display = "none";
};

window.updateFacturablePrice = async (nom, newPrice) => {
  facturables[nom] = parseFloat(newPrice) || 0;
  await saveFacturables();
};

window.deleteFacturable = async (nom) => {
  delete facturables[nom];
  await saveFacturables();
  renderFacturables();
};

async function saveFacturables() {
  try {
    await setDoc(doc(db, "rÃ©fÃ©rentiels", "Facturables"), facturables);
    afficherBulle("âœ… Facturables enregistrÃ©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement facturables :", err);
    afficherBulle("âŒ Erreur dâ€™enregistrement", "alerte");
  }
}

// Charger les facturables au dÃ©marrage
loadFacturables();
const sectionBureaux = document.getElementById("sectionBureaux");
const bureauxListEl = document.getElementById("bureauxList");
let bureaux = {}; // objet { nomBureau: {agentEmail:null, agentUid:null, connecte:false, connexionAt:null} }
let editingBureau = null;

// ğŸ”¹ Charger l'Ã©tat gÃ©nÃ©ral et les bureaux
async function loadBureaux() {
  const ref = doc(db, "rÃ©fÃ©rentiels", "bureau");
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    const generalActive = data.general?.active ?? false;
    sectionBureaux.style.display = generalActive ? "block" : "none";
    
    bureaux = {...data};
    delete bureaux.general; // enlever le champ general pour ne garder que les bureaux
    renderBureaux();
  }
}

function renderBureaux() {
  bureauxListEl.innerHTML = "";
  Object.entries(bureaux).forEach(([nom, info]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <input value="${nom.replace(/"/g,'&quot;')}" onchange="updateBureauName('${nom}', this.value)" />
      <button class="btn btn-del" onclick="deleteBureau('${nom}')">âŒ</button>
    `;
    bureauxListEl.appendChild(li);
  });
}

// --- Ajouter un nouveau bureau ---
window.openModalBureau = () => {
  editingBureau = null;
  document.getElementById("bureauNameInput").value = "";
  document.getElementById("modalBureau").style.display = "flex";
};

window.cancelModalBureau = () => {
  document.getElementById("modalBureau").style.display = "none";
};

window.confirmModalBureau = async () => {
  const name = document.getElementById("bureauNameInput").value.trim();
  if (!name) return;

  if (!bureaux[name]) {
    bureaux[name] = { agentEmail: null, agentUid: null, connecte: false, connexionAt: null };
  }

  await saveBureaux();
  renderBureaux();
  document.getElementById("modalBureau").style.display = "none";
};

// --- Modifier le nom d'un bureau ---
window.updateBureauName = async (oldName, newName) => {
  if (!newName || oldName === newName) return;
  bureaux[newName] = bureaux[oldName];
  delete bureaux[oldName];
  await saveBureaux();
  renderBureaux();
};

// --- Supprimer un bureau ---
window.deleteBureau = async (name) => {
  delete bureaux[name];
  await saveBureaux();
  renderBureaux();
};

// --- Sauvegarde Firestore ---
async function saveBureaux() {
  try {
    await setDoc(doc(db, "rÃ©fÃ©rentiels", "bureau"), { ...bureaux, general: { active: true } });
    afficherBulle("âœ… Bureaux enregistrÃ©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement bureaux :", err);
    afficherBulle("âŒ Erreur dâ€™enregistrement", "alerte");
  }
}

// Charger au dÃ©marrage
loadBureaux();


function afficherBulle(texte, type) {
  let container = document.getElementById('bubble-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'bubble-container';
    container.style.position = "fixed";
    container.style.top = "20px";
    container.style.right = "20px";
    container.style.zIndex = "9999";
    document.body.appendChild(container);
  }
  const bulle = document.createElement('div');
  bulle.className = `bubble ${type}`;
  bulle.textContent = texte;
  bulle.style.backgroundColor = type === "administratif" ? "#3498db" : "#e74c3c";
  bulle.style.color = "white";
  bulle.style.padding = "10px 15px";
  bulle.style.marginBottom = "10px";
  bulle.style.borderRadius = "6px";
  bulle.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  bulle.style.transition = "opacity 0.4s ease";
  container.appendChild(bulle);
  setTimeout(() => {
    bulle.style.opacity = "0";
    setTimeout(() => bulle.remove(), 400);
  }, 2500);
}
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    cancelModal();
  }
});

loadData();


  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "accueil.html";
    } else {
      const docSnap = await getDoc(doc(db, "medecins", user.uid));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nom-medecin").textContent = data.nom || "MÃ©decin";
        document.getElementById("specialite").textContent = data.specialite || "";
      }
    }
  });
  
let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        const medecinNom = data.nom || "";
        const medecinSpecialite = data.specialite || "";
        const medecinLieu = data.lieu || "";

        // Met Ã  jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise Ã  jour des Ã©lÃ©ments HTML si prÃ©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- VÃ©rification d'accÃ¨s Ã  la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("â›”ï¸ Vous nâ€™avez pas accÃ¨s Ã  cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant â€” redirection
        alert("Utilisateur non trouvÃ©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement mÃ©decin :", error);
      alert("Une erreur est survenue, veuillez rÃ©essayer plus tard.");
    }
  }
});
// --- GESTION CCH & CAA ---
const docPatientRef = doc(db, "patients", "QhwMJ0mjmUnS8MTNBCFU");
const spanCCH = document.getElementById("afficheCCH");
const spanCAA = document.getElementById("afficheCAA");
const modalCode = document.getElementById("modalCode");
const titreCode = document.getElementById("titreCode");
const inputCode = document.getElementById("inputCode");
const btnAnnulerCode = document.getElementById("btnAnnulerCode");
const btnValiderCode = document.getElementById("btnValiderCode");

let codeType = null;

// ğŸ”¹ Charger les codes
async function chargerCodes() {
  const snap = await getDoc(docPatientRef);
  if (snap.exists()) {
    const data = snap.data();
    spanCCH.textContent = data.CCH ? "......." : "Non dÃ©fini";
    spanCAA.textContent = data.CAA ? "......." : "Non dÃ©fini";
  }
}
chargerCodes();

// ğŸ”¹ Ouvrir la modale
document.getElementById("btnEditCCH").addEventListener("click", () => {
  codeType = "CCH";
  titreCode.textContent = "Modifier le CCH";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

document.getElementById("btnEditCAA").addEventListener("click", () => {
  codeType = "CAA";
  titreCode.textContent = "Modifier le CAA";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

// ğŸ”¹ Fermer la modale
btnAnnulerCode.addEventListener("click", () => {
  modalCode.style.display = "none";
});

// ğŸ”¹ Valider la modification
btnValiderCode.addEventListener("click", async () => {
  const newCode = inputCode.value.trim();
  if (!newCode) {
    afficherBulle("âš ï¸ Entrez un code valide", "alerte");
    return;
  }
  try {
    await setDoc(docPatientRef, { [codeType]: newCode }, { merge: true });
    afficherBulle(`âœ… ${codeType} mis Ã  jour`, "administratif");
    modalCode.style.display = "none";
    chargerCodes();
  } catch (e) {
    console.error("Erreur mise Ã  jour code :", e);
    afficherBulle("âŒ Erreur dâ€™enregistrement", "alerte");
  }
});
// ---------------- MESSAGES D'ACCUEIL ----------------
const messagesAccueilListEl = document.getElementById("messagesAccueilList");
let messagesAccueil = [];
let editingIndex = null;

async function loadMessagesAccueil() {
  try {
    const snap = await getDoc(doc(db, "rÃ©fÃ©rentiels", "messages_accueil"));
    messagesAccueil = snap.exists() ? snap.data().liste || [] : [];
    renderMessagesAccueil();
  } catch (err) {
    console.error("Erreur chargement messages accueil :", err);
  }
}

function renderMessagesAccueil() {
  messagesAccueilListEl.innerHTML = "";
  messagesAccueil.forEach((msg, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${msg.titre}</strong> [${msg.type}]<br/>
      ${msg.texte1}<br/>
      ${msg.texte2}<br/>
      <button class="btn btn-edit" onclick="openEditMessageModal(${index})">âœï¸</button>
      <button class="btn btn-del" onclick="deleteMessage(${index})">âŒ</button>
    `;
    messagesAccueilListEl.appendChild(li);
  });
}

// --- Ajouter message ---
window.openAddMessageModal = () => {
  document.getElementById("newMessageTitle").value = "";
  document.getElementById("newMessageType").value = "info";
  document.getElementById("newMessageText1").value = "";
  document.getElementById("newMessageText2").value = "";
  document.getElementById("modalAddMessage").style.display = "flex";
};

window.cancelAddMessageModal = () => {
  document.getElementById("modalAddMessage").style.display = "none";
};

window.confirmAddMessage = async () => {
  const titre = document.getElementById("newMessageTitle").value.trim();
  const type = document.getElementById("newMessageType").value;
  const texte1 = document.getElementById("newMessageText1").value.trim();
  const texte2 = document.getElementById("newMessageText2").value.trim();
  if (!titre) { afficherBulle("âš ï¸ Le titre est requis", "alerte"); return; }
  messagesAccueil.push({ titre, type, texte1, texte2 });
  await saveMessagesAccueil();
  renderMessagesAccueil();
  cancelAddMessageModal();
};

// --- Ã‰diter message ---
window.openEditMessageModal = (index) => {
  editingIndex = index;
  const msg = messagesAccueil[index];
  document.getElementById("editMessageTitle").value = msg.titre;
  document.getElementById("editMessageType").value = msg.type;
  document.getElementById("editMessageText1").value = msg.texte1;
  document.getElementById("editMessageText2").value = msg.texte2;
  document.getElementById("modalEditMessage").style.display = "flex";
};

window.cancelEditMessageModal = () => {
  document.getElementById("modalEditMessage").style.display = "none";
};

window.confirmEditMessage = async () => {
  const titre = document.getElementById("editMessageTitle").value.trim();
  const type = document.getElementById("editMessageType").value;
  const texte1 = document.getElementById("editMessageText1").value.trim();
  const texte2 = document.getElementById("editMessageText2").value.trim();
  if (!titre) { afficherBulle("âš ï¸ Le titre est requis", "alerte"); return; }
  messagesAccueil[editingIndex] = { titre, type, texte1, texte2 };
  await saveMessagesAccueil();
  renderMessagesAccueil();
  cancelEditMessageModal();
};

// --- Supprimer message ---
window.deleteMessage = async (index) => {
  messagesAccueil.splice(index, 1);
  await saveMessagesAccueil();
  renderMessagesAccueil();
};

// --- Sauvegarde Firestore ---
async function saveMessagesAccueil() {
  try {
    await setDoc(doc(db, "rÃ©fÃ©rentiels", "messages_accueil"), { liste: messagesAccueil });
    afficherBulle("âœ… Messages dâ€™accueil enregistrÃ©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement messages :", err);
    afficherBulle("âŒ Erreur dâ€™enregistrement", "alerte");
  }
}
<script>
document.querySelectorAll(".section-title").forEach(title => {
  title.addEventListener("click", () => {
    title.parentElement.classList.toggle("collapsed");
  });
});
</script>

// Charger les messages au dÃ©marrage
loadMessagesAccueil();



</script>
</body>
</html>

