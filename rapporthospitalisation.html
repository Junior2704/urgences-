<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Rapport d'hospitalisation</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
<link rel="icon" type="image/jpeg" href="logo.jpg">
  <style>
    /* --- MODALE D'ENVOI EMAIL --- */
#emailSelectModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  justify-content: center;
  align-items: center;
  z-index: 200;
  animation: fadeInModal 0.3s ease-out;
}

#emailSelectModal.show {
  display: flex;
}

#emailSelectModal .modal-content {
  width: 380px;
  max-width: 90%;
  background: linear-gradient(to bottom right, #ffffff, #f9fafc);
  border-radius: 16px;
  padding: 28px 26px 22px;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(0, 0, 0, 0.06);
  animation: slideUpModal 0.35s ease-out;
  transform-origin: center;
}

#emailSelectModal h3 {
  text-align: center;
  margin-top: 0;
  font-size: 1.25rem;
  color: #1e293b;
  font-weight: 700;
  letter-spacing: 0.3px;
}

#emailSelectModal .email-options {
  margin-top: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#emailSelectModal label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  background: #f8fafc;
  transition: background 0.2s ease, transform 0.1s ease;
  border: 1px solid transparent;
}

#emailSelectModal label:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  transform: scale(1.02);
}

#emailSelectModal input[type="checkbox"] {
  accent-color: #2563eb;
  transform: scale(1.15);
}

#emailSelectModal input[type="email"] {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 0.9rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#emailSelectModal input[type="email"]:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  outline: none;
}

#emailSelectModal .modal-actions {
  margin-top: 22px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

#emailSelectModal button {
  flex: 1;
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.25s ease, transform 0.1s ease;
}

#emailSelectModal .btn-cancel {
  background: #e2e8f0;
  color: #1e293b;
}

#emailSelectModal .btn-cancel:hover {
  background: #cbd5e1;
}

#emailSelectModal .btn-confirm {
  background: #2563eb;
  color: #fff;
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.25);
}

#emailSelectModal .btn-confirm:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

/* --- ANIMATIONS --- */
@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUpModal {
  from {
    transform: translateY(30px) scale(0.98);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #eef2f3, #ffffff);
      padding: 40px;
    }
    h1 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
      color: #333;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      font-size: 1rem;
      padding: 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: border-color 0.3s;
    }
    textarea:focus {
      border-color: #1a73e8;
    }
    textarea[readonly] {
      background-color: #e8e8e8;
      color: #555;
    }
    .button-group {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
    }
	    .modal {
    display: none; /* affich√©e dynamiquement par JS */
    position: fixed;
    z-index: 999;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.45);
    justify-content: center;
    align-items: center;
  }

  /* Bo√Æte centrale */
  .modal-content {
    background: #f8f9fa;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    padding: 30px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    animation: zoomIn 0.25s ease;
  }

  @keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal-content h2 {
    margin-bottom: 10px;
    color: #2c3e50;
  }

  .modal-content p {
    color: #555;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  .modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .btnModal {
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.2s;
  }

  .btnModal.ouvrir {
    background-color: #007bff;
    color: white;
  }

  .btnModal.ouvrir:hover {
    background-color: #0056b3;
  }

  .btnModal.ecraser {
    background-color: #28a745;
    color: white;
  }

  .btnModal.ecraser:hover {
    background-color: #1e7e34;
  }

  .btnModal.fermer {
    background-color: #6c757d;
    color: white;
    margin-top: 10px;
  }

  .btnModal.fermer:hover {
    background-color: #5a6268;
  }
    #validerBtn {
      background-color: #28a745;
      color: white;
    }
    #telechargerBtn, #imprimerBtn {
      background-color: #1a73e8;
      color: white;
      display: none;
    }
	#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
#emailSelectModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  justify-content: center;
  align-items: center;
  z-index: 200;
  animation: fadeInModal 0.3s ease-out;
}

#emailSelectModal.show {
  display: flex;
}

#emailSelectModal .modal-content {
  width: 380px;
  max-width: 90%;
  background: linear-gradient(to bottom right, #ffffff, #f9fafc);
  border-radius: 16px;
  padding: 28px 26px 22px;
  box-shadow: 0 8px 40px rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(0, 0, 0, 0.06);
  animation: slideUpModal 0.35s ease-out;
  transform-origin: center;
}

#emailSelectModal h3 {
  text-align: center;
  margin-top: 0;
  font-size: 1.25rem;
  color: #1e293b;
  font-weight: 700;
  letter-spacing: 0.3px;
}

#emailSelectModal .email-options {
  margin-top: 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#emailSelectModal label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  background: #f8fafc;
  transition: background 0.2s ease, transform 0.1s ease;
  border: 1px solid transparent;
}

#emailSelectModal label:hover {
  background: #eff6ff;
  border-color: #bfdbfe;
  transform: scale(1.02);
}

#emailSelectModal input[type="checkbox"] {
  accent-color: #2563eb;
  transform: scale(1.15);
}

#emailSelectModal input[type="email"] {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 0.9rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#emailSelectModal input[type="email"]:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  outline: none;
}

#emailSelectModal .modal-actions {
  margin-top: 22px;
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

#emailSelectModal button {
  flex: 1;
  padding: 10px 14px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.25s ease, transform 0.1s ease;
}

#emailSelectModal .btn-cancel {
  background: #e2e8f0;
  color: #1e293b;
}

#emailSelectModal .btn-cancel:hover {
  background: #cbd5e1;
}

#emailSelectModal .btn-confirm {
  background: #2563eb;
  color: #fff;
  box-shadow: 0 3px 10px rgba(37, 99, 235, 0.25);
}

#emailSelectModal .btn-confirm:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

/* --- ANIMATIONS --- */
@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUpModal {
  from {
    transform: translateY(30px) scale(0.98);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

  </style>
</head>
<body>

<h1>üìã Rapport d'hospitalisation</h1>

<div id="choixRapportModal" class="modal">
  <div class="modal-content">
    <h2>Un rapport existe d√©j√†, </h2>
    <p>Souhaitez-vous :</p>

    <div class="modal-buttons">
      <button id="btnOuvrir" class="btnModal ouvrir">üìÇ l'ouvrir</button>
      <button id="btnEcraser" class="btnModal ecraser">üìù en cr√©er un nouveau</button>
    </div>

    <button id="btnFermerModal" class="btnModal fermer">‚ùå Fermer</button>
  </div>
</div>

<div id="emailSelectModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md animate-fade-in">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 text-center">
      ‚úâÔ∏è S√©lectionner les destinataires
    </h2>

    <!-- Liste des adresses connues -->
    <div id="emailCheckboxes"
         class="max-h-48 overflow-y-auto border rounded-md p-3 space-y-2 text-gray-700 text-sm mb-4">
      <!-- Les adresses seront ajout√©es ici dynamiquement -->
    </div>

    <!-- Ajout d‚Äôune autre adresse -->
    <label class="flex items-center gap-2 mb-2 text-sm text-gray-600">
      <input type="checkbox" id="otherEmailCheck">
      Ajouter une autre adresse e-mail
    </label>

    <input type="email" id="otherEmailInput" placeholder="Nouvelle adresse e-mail"
           class="w-full border rounded-md p-2 text-sm focus:ring focus:ring-blue-200 mb-4" disabled>

    <!-- Boutons -->
    <div class="flex justify-end gap-3">
      <button onclick="closeEmailSelectModal()"
              class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-sm font-medium">
        Annuler
      </button>
      <button id="confirmEmails"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium">
        Confirmer
      </button>
    </div>
  </div>
</div>

<!-- üîπ Modale de chargement -->
<div id="loadingModal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm z-[2000]">
  <div class="bg-white rounded-2xl shadow-lg p-8 text-center w-80 animate-fade-in">
    <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo h√¥pital" class="h-16 mx-auto mb-4">
    <div class="loader mx-auto mb-4"></div>
    <p class="text-gray-700 font-medium">Envoi du compte-rendu en cours...</p>
  </div>
</div>

<style>
.hidden { display: none !important; }
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1a73e8;
  border-radius: 50%;
  width: 40px; height: 40px;
  animation: spin 1s linear infinite;
}
@keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
.animate-fade-in { animation: fade-in 0.3s ease-out; }
@keyframes fade-in { from {opacity:0;transform:scale(0.95);} to {opacity:1;transform:scale(1);} }
</style>


<form id="formRapport">
  <label for="identite">Identit√©</label>
  <textarea id="identite"></textarea>

<label for="hospitalisation">Hospitalisation</label>
  <textarea id="hospitalisation"></textarea>

  <label for="medical">Dossier M√©dical</label>
  <textarea id="medical"></textarea>

  <label for="evolution">√âvolution aux urgences</label>
  <textarea id="evolution"></textarea>

  <label for="constantes">Constantes Vitales</label>
  <textarea id="constantes"></textarea>

  <label for="examens">Examens Compl√©mentaires</label>
  <textarea id="examens"></textarea>

  <label for="actes">Actes r√©alis√©s</label>
  <textarea id="actes"></textarea>

  <label for="sortie">Sortie</label>
  <textarea id="sortie"></textarea>

  <div class="button-group">
    <button type="button" id="validerBtn">‚úÖ Valider</button>
    <button type="button" id="telechargerBtn">üì• T√©l√©charger PDF</button>
    <button type="button" id="imprimerBtn">üñ®Ô∏è Imprimer</button>
	  <button id="btnEnvoyerMail" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
  üìß Envoyer le compte-rendu par e-mail
</button>

</div>

  
</form>

<script>

// Champs du rapport
const champs = ["identite", "hospitalisation", "medical", "evolution", "constantes", "examens", "actes", "sortie"];
const patientId = new URLSearchParams(window.location.search).get("id");

if (!patientId) {
  afficherBulle("‚ùåID patient manquant dans l'URL", "alerte");
  throw new Error("ID manquant");
}

const firebaseConfig = {
   apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
  authDomain: "urgences-a8ed4.firebaseapp.com",
  projectId: "urgences-a8ed4",
storageBucket: "urgences-a8ed4.appspot.com",
  messagingSenderId: "392921498200",
  appId: "1:392921498200:web:7ccce767332c67c697c02d",
  measurementId: "G-C74MK2KYDL"
};
emailjs.init("CZapZCcxYfJ8-acLS"); // √† remplacer par ton ID EmailJS
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const patientRef = db.collection("patients").doc(patientId);

let rapportValide = true; // flag validation

// Calcul √¢ge simple
function calculerAge(dateStr) {
  const diffMs = Date.now() - new Date(dateStr).getTime();
  const ageDt = new Date(diffMs);
  return Math.abs(ageDt.getUTCFullYear() - 1970);
}


// Adaptation hauteur textarea au contenu
function autoResizeTextarea(el) {
  el.style.height = "auto";
  el.style.height = (el.scrollHeight) + "px";
}

let pdfBase64 = "";

// Charger donn√©es depuis Firestore
async function chargerDepuisFirestore() {
  const doc = await patientRef.get();
  if (!doc.exists) {
    afficherBulle("‚ùåPatient non trouv√©","alerte");
    return;
  }
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospi = data.hospitalisations?.[index] || {};



const patientEmail = data.email || "";


  const sexe = data.sexe || '';
  const nom = data.nom || '';
  const prenom = data.prenom || '';
  const dateNaissance = data.dateNaissance || '';
  const dateNaissance2 = convertirDateEnFrancais(dateNaissance)
  const age = dateNaissance ? `${calculerAge(dateNaissance)} ans` : '';
  const dateDebut=hospi.dateDebut || '';
  const motif = hospi.motif || '';
  const moyen = hospi.moyen || '';
  const adresse = data.adresse || '';
window.patientData = data;

  document.getElementById("identite").value =
    `${sexe} ${prenom} ${nom}, \nN√©(e) le ${dateNaissance2}, ${age} \n${adresse}\nCIP (Code d'Identification Patient) : ${patientId}`;
document.getElementById("hospitalisation").value = 
  `Ouverture du dossier : ${hospi.dateDebut} \nMotif d'entr√©e : ${hospi.motif} \nMoyen d'entr√©e : ${hospi.moyen}\nCl√¥ture du dossier : ${hospi.sortie?.date || "‚Äî"}`;
  document.getElementById("medical").value = `   Questionnaitre IAO :\n${hospi.dossierMedical?.questionnaire || ''}\n\n
   Ant√©c√©dents m√©dicaux:\n${hospi.dossierMedical?.antecedents || ''}\n\n
   Traitements en cours :\n${hospi.dossierMedical?.traitements || ''}\n\n
   Histoire de la maladie :\n${hospi.dossierMedical?.histoire || ''}\n\n
   Auscultation initiale :\n${hospi.dossierMedical?.auscultation || ''}`;
  document.getElementById("evolution").value = hospi.evolution || '';
  document.getElementById("constantes").value = `Temp√©rature : ${hospi.constantes?.temperature || ''}¬∞C\nFC : ${hospi.constantes?.fc || ''} bpm\nTA : ${hospi.constantes?.ta || ''}\nSaturation : ${hospi.constantes?.saturation || ''}%\nFR : ${hospi.constantes?.fr || ''}\nDouleur : ${hospi.constantes?.douleur || ''}/10`;
document.getElementById("examens").value = (hospi.examens || []).map(e => {
  const commentaire = e.commentaire || ''; 
  const typeAvecCommentaire = commentaire.trim() !== '' ? `${e.type} (${commentaire})` : e.type;
  return `‚Ä¢ ${typeAvecCommentaire} : demand√© le ${e.dateDemande}, r√©alis√© le ${e.dateRealisation}\n   R√©sultat :${e.compteRendu || 'en attente'}`;
}).join('\n');
document.getElementById("actes").value = (hospi.actes_realises || []).map(a => {
  const remarques = a.remarques ? ` : ${a.remarques}` : '';
  return `‚Ä¢ ${a.date} : ${a.type} par ${a.realisateur || 'inconnu'}${remarques}`;
}).join('\n');
if (!hospi.sortie) {
  document.getElementById("sortie").value = '';
} else {
  const sortie = hospi.sortie;
  let texte = '';

  if (sortie.type) texte += `Type : ${sortie.type}\n`;
  if (sortie.options && sortie.options.length > 0) texte += `Options : ${sortie.options.join(', ')}\n\n`;
  if (sortie.destinationTransfert) texte += `Destination : ${sortie.destinationTransfert}\n\n`;
  if (sortie.serviceHospitalisation) texte += `Service : ${sortie.serviceHospitalisation}\n\n`;
  if (sortie.avisSpecialiste) texte += `Avis : ${sortie.avisSpecialiste}\n\n`;
  if (sortie.traitementSortie) texte += `Traitement sortie : \n${sortie.traitementSortie}\n`;

  document.getElementById("sortie").value = texte.trim();
}

  // Si rapport existant, on le charge pour modification ou affichage readonly
if (hospi.rapport) {
  const modal = document.getElementById("choixRapportModal");
if (modal) modal.style.display = "flex";


  // Bouton "ouvrir rapport existant"
  document.getElementById("btnOuvrir").onclick = () => {
    champs.forEach(c => {
      document.getElementById(c).value = hospi.rapport[c] || "";
    });
    setRapportValide(false);
    modal.style.display = "none";
	  afficherBulle("‚úÖRapport existant charg√© !", "administratif");
  };

  // Bouton "√©craser et cr√©er un nouveau"
  document.getElementById("btnEcraser").onclick = () => {
    afficherBulle("‚úèÔ∏è Nouveau rapport initialis√©", "administratif");
    setRapportValide(false);
    modal.style.display = "none";
  };

  return; // attend que l'utilisateur choisisse
}

  // Ajuste hauteur textarea
  champs.forEach(id => autoResizeTextarea(document.getElementById(id)));
}

// Enregistrer dans Firestore
async function enregistrerDansFirestore() {
  const values = {};
  champs.forEach(id => values[id] = document.getElementById(id).value);
  values.valide = true; // marque le rapport comme valid√©

  const doc = await patientRef.get();
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  hospitalisations[index] = {
    ...hospitalisations[index],
    rapport: values
  };
  await patientRef.update({ hospitalisations });
}



// Rendre les champs readonly et adapter style
function setRapportValide(val) {
  rapportValide = val;
  champs.forEach(id => {
    const el = document.getElementById(id);
    if(val){
      el.setAttribute("readonly", true);
      // Adaptation hauteur, plus d'ascenseur
      autoResizeTextarea(el);
      el.style.overflow = "hidden";
    } else {
      el.removeAttribute("readonly");
      el.style.overflow = "auto";
    }
  });
  // Affiche ou cache les boutons t√©l√©chargement / impression
  document.getElementById("telechargerBtn").style.display = val ? "inline-block" : "none";
  document.getElementById("imprimerBtn").style.display = val ? "inline-block" : "none";
  document.getElementById("validerBtn").style.display = val ? "none" : "inline-block";
	btnEnvoyerMail.style.display = val ? "inline-block" : "none";
}
async function creerPDF(telecharger = false) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const marginLeft = 15;
  let y = 15;
  const lineHeight = 7;
  const pageHeight = doc.internal.pageSize.height;

  const logoUrl = "https://junior2704.github.io/urgences-/logo.jpg";
  const img = new Image();
  img.src = logoUrl;

  return new Promise((resolve, reject) => {
    img.onload = () => {
      try {
        // üîπ Logo
        doc.addImage(img, "JPEG", marginLeft, y, 40, 40);
        y += 30;

        // üîπ Titre
        doc.setFontSize(18);
        doc.setTextColor("#1a73e8");
        doc.text("Compte-rendu de passage aux Urgences", marginLeft + 50, y);
        y += 15;

        // üîπ Ligne bleue
        doc.setDrawColor(26, 115, 232);
        doc.setLineWidth(0.8);
        doc.line(marginLeft, y, 195, y);
        y += 10;

        // üîπ Fonction utilitaire
        function addBlock(titre, contenu) {
          doc.setFontSize(14);
          doc.setTextColor("#1a73e8");
          doc.text(titre, marginLeft, y);
          y += lineHeight;

          doc.setFontSize(11);
          doc.setTextColor("#000000");

          const splitText = doc.splitTextToSize(contenu || "‚Äî", 180);
          for (let i = 0; i < splitText.length; i++) {
            if (y > pageHeight - 20) {
              doc.addPage();
              y = 15;
            }
            doc.text(splitText[i], marginLeft, y);
            y += lineHeight;
          }

          y += lineHeight;
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.6);
          doc.line(marginLeft, y, 195, y);
          y += 10;
        }

        // üîπ Ajouter les blocs depuis le formulaire
        addBlock("Identit√© du patient", document.getElementById("identite")?.value?.trim());
        addBlock("Hospitalisation", document.getElementById("hospitalisation")?.value?.trim());
        addBlock("Dossier M√©dical", document.getElementById("medical")?.value?.trim());
        addBlock("√âvolution aux urgences", document.getElementById("evolution")?.value?.trim());
        addBlock("Constantes Vitales", document.getElementById("constantes")?.value?.trim());
        addBlock("Examens Compl√©mentaires", document.getElementById("examens")?.value?.trim());
        addBlock("Actes r√©alis√©s", document.getElementById("actes")?.value?.trim());
        addBlock("Sortie", document.getElementById("sortie")?.value?.trim());

        // üîπ Signature
        const signatureText = `${window.medecinNom || "Dr Non renseign√©"}\n${window.medecinSpecialite || ""}`;
        const pageWidth = doc.internal.pageSize.width;
        const splitSignature = doc.splitTextToSize(signatureText, 60);
        doc.text(splitSignature, pageWidth - 75, pageHeight - 30);

        // üîπ G√©n√©ration du PDF
        const pdfData = doc.output("datauristring");
        window.pdfBase64 = pdfData.split(",")[1];
        console.log("‚úÖ PDF g√©n√©r√©, taille base64:", window.pdfBase64.length);

        // üì• Si t√©l√©chargement demand√©
        if (telecharger) {
          doc.save("rapport_hospitalisation.pdf");
          console.log("üìÑ T√©l√©chargement lanc√©");
        }

        resolve(window.pdfBase64);
      } catch (error) {
        reject(error);
      }
    };

    img.onerror = () => reject(new Error("Erreur de chargement du logo."));
  });
}



function base64ToBlob(base64, type = "application/pdf") {
  const binary = atob(base64);
  const len = binary.length;
  const buffer = new ArrayBuffer(len);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < len; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return new Blob([view], { type });
}









// Gestion du bouton valider
document.getElementById("validerBtn").addEventListener("click", async () => {
  if(confirm("Confirmez-vous la validation et figer ce rapport ?")){
    await enregistrerDansFirestore();
    setRapportValide(true);
    afficherBulle("‚úÖRapport valid√© et enregistr√© !", "administratif");
  }
});

document.getElementById("telechargerBtn").addEventListener("click", () => creerPDF(true));

	document.getElementById("imprimerBtn").addEventListener("click", () => window.print());

// Au chargement
window.onload = () => {
  chargerDepuisFirestore();
  setRapportValide(false);
  // Ajuste les textarea au contenu
  champs.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", () => autoResizeTextarea(el));
  });
};
function showLoadingModal() { document.getElementById("loadingModal").classList.remove("hidden"); }
function hideLoadingModal() { document.getElementById("loadingModal").classList.add("hidden"); }
function openEmailSelectModal(emailsString) {
    const modal = document.getElementById("emailSelectModal");
    const container = document.getElementById("emailCheckboxes");

    if (!modal) {
      console.error("‚ùå Modale emailSelectModal introuvable dans le DOM !");
      return;
    }

    container.innerHTML = "";
    const emails = (emailsString || "").split("//").filter(e => e.includes("@"));

    if (emails.length === 0) {
      container.innerHTML = "<p class='text-gray-500'>Aucune adresse trouv√©e pour ce patient.</p>";
    } else {
      emails.forEach((email, i) => {
        const id = "emailCheck_" + i;
        container.innerHTML += `
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" id="${id}" value="${email}" checked>
            <span>${email}</span>
          </label>`;
      });
    }

    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden"; // bloque le scroll
  }

  // ‚úÖ Ferme la modale
  function closeEmailSelectModal() {
    const modal = document.getElementById("emailSelectModal");
    if (modal) modal.classList.add("hidden");
    document.body.style.overflow = "auto";
  }

  // ‚úÖ Active/d√©sactive le champ "autre email"
  document.addEventListener("DOMContentLoaded", () => {
    const otherCheck = document.getElementById("otherEmailCheck");
    const otherInput = document.getElementById("otherEmailInput");

    if (otherCheck && otherInput) {
      otherCheck.addEventListener("change", (e) => {
        otherInput.disabled = !e.target.checked;
        if (!e.target.checked) otherInput.value = "";
      });
    }
    document.getElementById("cancelModal").addEventListener("click", closeEmailSelectModal);
  });


/* --- bouton principal --- */
window.addEventListener("DOMContentLoaded", () => {

  const btnEnvoyer = document.getElementById("btnEnvoyerMail");
  if (!btnEnvoyer) {
    console.warn("‚ö†Ô∏è Bouton #btnEnvoyerMail introuvable dans le DOM !");
    return;
  }

  btnEnvoyer.addEventListener("click", async () => {
    console.log("üìß Bouton 'Envoyer par email' cliqu√© !");
    showLoadingModal();

    try {
      const doc = await patientRef.get();
      if (!doc.exists) {
        hideLoadingModal();
        afficherBulle("‚ùå Patient introuvable", "alerte");
        return;
      }

      const data = doc.data();
      const emails = data.email || "";
      console.log("üìß Emails du patient :", emails);

      openEmailSelectModal(emails); // Ouvre la modale de choix des adresses
      hideLoadingModal();

    } catch (err) {
      hideLoadingModal();
      console.error("‚ùå Erreur :", err);
      alert("Erreur : " + err.message);
    }
  });
});


/* --- envoi --- */
document.getElementById("confirmEmails").addEventListener("click", async () => {
  try {
    const boxes = document.querySelectorAll("#emailCheckboxes input[type='checkbox']:checked");
    let destinataires = Array.from(boxes).map(cb => cb.value.trim());
    if (document.getElementById("otherEmailCheck").checked) {
      const extra = document.getElementById("otherEmailInput").value.trim();
      if (extra) destinataires.push(extra);
    }
    if (!destinataires.length) return alert("S√©lectionnez au moins une adresse.");

    closeEmailSelectModal();
    showLoadingModal();

    // 1Ô∏è‚É£ G√©n√©ration du PDF
    const pdfBase64 = await creerPDF(false);

    // 2Ô∏è‚É£ Cr√©ation d‚Äôun ID unique Firestore
    let idUnique, docSnap;
    do {
      idUnique = Math.random().toString(36).substring(2, 10);
      docSnap = await db.collection("liens_pdfs").doc(idUnique).get();
    } while (docSnap.exists);

    // 3Ô∏è‚É£ R√©cup√©ration infos patient
    const doc = await patientRef.get();
    if (!doc.exists) {
      hideLoadingModal();
      afficherBulle("‚ùå Patient non trouv√©", "alerte");
      return;
    }

    const data = doc.data();
    const firstName = data.prenom || "";
    const lastName = data.nom || "";
    const fileName = `Rapport d'hospitalisation - ${firstName} ${lastName}.pdf`;

    // 4Ô∏è‚É£ Sauvegarde du PDF dans Firestore
    await db.collection("liens_pdfs").doc(idUnique).set({
      base64: pdfBase64,
      nomFichier: fileName,
      dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
    });

    const lienPdf = `https://junior2704.github.io/urgences-/monpdf.html?id=${idUnique}`;
    console.log("‚úÖ Lien g√©n√©r√© :", lienPdf);

    // 5Ô∏è‚É£ Mod√®le HTML du mail
    const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Compte-rendu d‚Äôhospitalisation</title></head>
<body style="margin:0;padding:0;background-color:#f4f6f9;font-family:'Segoe UI',Roboto,Arial,sans-serif;color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px;margin:auto;background:white;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.08);overflow:hidden;">
    <tr>
      <td style="background-color:#0057a4;padding:24px;text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.jpg" style="height:60px;margin:0 auto 10px auto;display:block;">
        <h1 style="color:white;font-size:22px;margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3;margin:6px 0 0;font-size:14px;">Service des Urgences</p>
      </td>
    </tr>
    <tr>
      <td style="padding:30px;">
        <h2 style="color:#0057a4;font-weight:600;margin-top:0;">Votre compte-rendu d‚Äôhospitalisation</h2>
        <p>Bonjour <strong>${firstName} ${lastName}</strong>,</p>
        <p>Le compte-rendu de votre hospitalisation est d√©sormais disponible.</p>
        <div style="text-align:center;margin:30px 0;">
          <a href="${lienPdf}" style="background-color:#0057a4;color:white;padding:14px 32px;text-decoration:none;border-radius:8px;font-weight:500;display:inline-block;">
            üîó T√©l√©charger le compte-rendu
          </a>
        </div>
        <p style="color:#555;">‚ö†Ô∏è Ce lien est valable 7 jours pour des raisons de confidentialit√©.</p>
        <hr style="border:none;border-top:1px solid #e0e0e0;margin:30px 0;">
        <p style="font-size:13px;color:#999;text-align:center;">Service des Urgences<br>
        <em>Cet e-mail est automatique, merci de ne pas y r√©pondre.</em></p>
      </td>
    </tr>
  </table>
</body></html>`;

    // 6Ô∏è‚É£ Multi-comptes EmailJS
    const comptesEmailJS = [
      { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
      { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
      { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
    ];

    // 7Ô∏è‚É£ Envoi √† chaque destinataire
    for (const email of destinataires) {
      let envoye = false;
      let derniereErreur = "";

      for (const compte of comptesEmailJS) {
        try {
          await emailjs.send(compte.serviceID, compte.templateID, {
            to_email: email,
            subject: "Votre compte-rendu d'hospitalisation est disponible",
            html_message: htmlMessage
          }, compte.publicKey);

          afficherBulle(`üì® Envoy√© : ${email}`, "administratif");
          envoye = true;
          break;
        } catch (err) {
          console.warn(`‚ö†Ô∏è √âchec via ${compte.serviceID}:`, err);
          derniereErreur = err.text || err.message || String(err);
          if (derniereErreur.toLowerCase().includes("quota")) continue;
          else break;
        }
      }

      if (!envoye) afficherBulle(`‚ùå √âchec d'envoi √† ${email}`, "alerte");
    }

    hideLoadingModal();
    afficherBulle("üì® Envoi termin√©.", "administratif");
  } catch (err) {
    hideLoadingModal();
    console.error(err);
    alert("Erreur : " + err.message);
  }
});


function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }
function convertirDateEnFrancais(dateISO) {
  const [annee, mois, jour] = dateISO.split("-");
  return `${jour}/${mois}/${annee}`;
}
hideLoadingModal()
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "accueil.html";
    } else {
      const docSnap = await getDoc(doc(db, "medecins", user.uid));
      if (docSnap.exists()) {
  const data = docSnap.data();
  const nomElem = document.getElementById("nom-medecin");
  if (nomElem) nomElem.textContent = data.nom || "M√©decin";

  const specElem = document.getElementById("specialite");
  if (specElem) specElem.textContent = data.specialite || "";
}

    }
  });

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "accueil.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
         medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
         medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});

</script>

</body>
</html>























