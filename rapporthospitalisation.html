<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Rapport d'hospitalisation</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
<link rel="icon" type="image/jpeg" href="logo.jpg">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #eef2f3, #ffffff);
      padding: 40px;
    }
    h1 {
      text-align: center;
      color: #1a73e8;
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
      color: #333;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      font-size: 1rem;
      padding: 12px;
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: border-color 0.3s;
    }
    textarea:focus {
      border-color: #1a73e8;
    }
    textarea[readonly] {
      background-color: #e8e8e8;
      color: #555;
    }
    .button-group {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
    }
	    .modal {
    display: none; /* affich√©e dynamiquement par JS */
    position: fixed;
    z-index: 999;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.45);
    justify-content: center;
    align-items: center;
  }

  /* Bo√Æte centrale */
  .modal-content {
    background: #f8f9fa;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    padding: 30px;
    width: 90%;
    max-width: 500px;
    text-align: center;
    animation: zoomIn 0.25s ease;
  }

  @keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal-content h2 {
    margin-bottom: 10px;
    color: #2c3e50;
  }

  .modal-content p {
    color: #555;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  .modal-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .btnModal {
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: 0.2s;
  }

  .btnModal.ouvrir {
    background-color: #007bff;
    color: white;
  }

  .btnModal.ouvrir:hover {
    background-color: #0056b3;
  }

  .btnModal.ecraser {
    background-color: #28a745;
    color: white;
  }

  .btnModal.ecraser:hover {
    background-color: #1e7e34;
  }

  .btnModal.fermer {
    background-color: #6c757d;
    color: white;
    margin-top: 10px;
  }

  .btnModal.fermer:hover {
    background-color: #5a6268;
  }
    #validerBtn {
      background-color: #28a745;
      color: white;
    }
    #telechargerBtn, #imprimerBtn {
      background-color: #1a73e8;
      color: white;
      display: none;
    }
	#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
  </style>
</head>
<body>

<h1>üìã Rapport d'hospitalisation</h1>

<div id="choixRapportModal" class="modal">
  <div class="modal-content">
    <h2>Un rapport existe d√©j√†, </h2>
    <p>Souhaitez-vous :</p>

    <div class="modal-buttons">
      <button id="btnOuvrir" class="btnModal ouvrir">üìÇ l'ouvrir</button>
      <button id="btnEcraser" class="btnModal ecraser">üìù en cr√©er un nouveau</button>
    </div>

    <button id="btnFermerModal" class="btnModal fermer">‚ùå Fermer</button>
  </div>
</div>
<!-- üî∑ MODALE DE CHARGEMENT -->
<div id="loadingModal" class="loadingModal">
  <div class="modal-content">
    <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo h√¥pital" class="logo">
    <div class="loader"></div>
    <p>Envoi du compte-rendu en cours...</p>
  </div>
</div>

<style>
/* --- Arri√®re-plan plein √©cran --- */
.loadingModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(6px);
  display: none; /* masqu√©e par d√©faut */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

/* --- Bo√Æte centrale --- */
.loadingModal-content {
  background: #fff;
  padding: 30px 40px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  text-align: center;
  width: 320px;
  animation: fadeIn 0.3s ease;
}

/* --- Logo --- */
.loadingModal-content .logo {
  height: 70px;
  margin-bottom: 20px;
}

/* --- Texte --- */
.loadingModal-content p {
  color: #333;
  font-size: 16px;
  font-weight: 500;
}

/* --- Loader --- */
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1a73e8;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  margin: 15px auto;
  animation: spin 1s linear infinite;
}

/* --- Animations --- */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

/* --- √âtats JS --- */
#loadingModal.show {
  display: flex;
}
</style>


<form id="formRapport">
  <label for="identite">Identit√©</label>
  <textarea id="identite"></textarea>

<label for="hospitalisation">Hospitalisation</label>
  <textarea id="hospitalisation"></textarea>

  <label for="medical">Dossier M√©dical</label>
  <textarea id="medical"></textarea>

  <label for="evolution">√âvolution aux urgences</label>
  <textarea id="evolution"></textarea>

  <label for="constantes">Constantes Vitales</label>
  <textarea id="constantes"></textarea>

  <label for="examens">Examens Compl√©mentaires</label>
  <textarea id="examens"></textarea>

  <label for="actes">Actes r√©alis√©s</label>
  <textarea id="actes"></textarea>

  <label for="sortie">Sortie</label>
  <textarea id="sortie"></textarea>

  <div class="button-group">
    <button type="button" id="validerBtn">‚úÖ Valider</button>
    <button type="button" id="telechargerBtn">üì• T√©l√©charger PDF</button>
    <button type="button" id="imprimerBtn">üñ®Ô∏è Imprimer</button>
	  <button type="button" id="btnEnvoyerMail" style="padding:10px 20px; background-color:#004AAD; color:white; border:none; border-radius:5px; cursor:pointer;">
  Envoyer le compte-rendu par e-mail
</button>
</div>

  
</form>
<!-- Modale de s√©lection des e-mails -->
<div id="emailSelectModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px); justify-content:center; align-items:center; z-index:200;">
  <div class="modal-content" style="width:340px; text-align:left;">
    <h3 style="text-align:center;">üìß Choisissez les destinataires</h3>
    <form id="emailSelectForm">
      <div id="emailCheckboxes"></div>
      <hr style="margin:15px 0;">
      <label style="display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="otherEmailCheck"> Autre destinataire :
      </label>
      <input type="email" id="otherEmailInput" placeholder="exemple@mail.com"
             style="margin-top:5px; padding:6px; width:100%; border:1px solid #ccc; border-radius:6px;" disabled>
      <br><br>
      
      <button type="button" onclick="closeEmailSelectModal()" style="background:#ccc;">Annuler</button>
      <button type="button" id="confirmEmails">Envoyer</button>
    </form>
  </div>
</div>
<script>
const envoyerMailBtn = document.getElementById("btnEnvoyerMail");
// Champs du rapport
const champs = ["identite", "hospitalisation", "medical", "evolution", "constantes", "examens", "actes", "sortie"];
const patientId = new URLSearchParams(window.location.search).get("id");

if (!patientId) {
  afficherBulle("‚ùåID patient manquant dans l'URL", "alerte");
  throw new Error("ID manquant");
}

const firebaseConfig = {
   apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
  authDomain: "urgences-a8ed4.firebaseapp.com",
  projectId: "urgences-a8ed4",
storageBucket: "urgences-a8ed4.appspot.com",
  messagingSenderId: "392921498200",
  appId: "1:392921498200:web:7ccce767332c67c697c02d",
  measurementId: "G-C74MK2KYDL"
};
emailjs.init("CZapZCcxYfJ8-acLS"); // √† remplacer par ton ID EmailJS
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const patientRef = db.collection("patients").doc(patientId);

let rapportValide = true; // flag validation

// Calcul √¢ge simple
function calculerAge(dateStr) {
  const diffMs = Date.now() - new Date(dateStr).getTime();
  const ageDt = new Date(diffMs);
  return Math.abs(ageDt.getUTCFullYear() - 1970);
}


// Adaptation hauteur textarea au contenu
function autoResizeTextarea(el) {
  el.style.height = "auto";
  el.style.height = (el.scrollHeight) + "px";
}

let pdfBase64 = "";

// Charger donn√©es depuis Firestore
async function chargerDepuisFirestore() {
  const doc = await patientRef.get();
  if (!doc.exists) {
    afficherBulle("‚ùåPatient non trouv√©","alerte");
    return;
  }
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospi = data.hospitalisations?.[index] || {};



const patientEmail = data.email || "";


  const sexe = data.sexe || '';
  const nom = data.nom || '';
  const prenom = data.prenom || '';
  const dateNaissance = data.dateNaissance || '';
  const dateNaissance2 = convertirDateEnFrancais(dateNaissance)
  const age = dateNaissance ? `${calculerAge(dateNaissance)} ans` : '';
  const dateDebut=hospi.dateDebut || '';
  const motif = hospi.motif || '';
  const moyen = hospi.moyen || '';
  const adresse = data.adresse || '';
window.patientData = data;

  document.getElementById("identite").value =
    `${sexe} ${prenom} ${nom}, \nN√©(e) le ${dateNaissance2}, ${age} \n${adresse}\nCIP (Code d'Identification Patient) : ${patientId}`;
document.getElementById("hospitalisation").value = 
  `Ouverture du dossier : ${hospi.dateDebut} \nMotif d'entr√©e : ${hospi.motif} \nMoyen d'entr√©e : ${hospi.moyen}\nCl√¥ture du dossier : ${hospi.sortie?.date || "‚Äî"}`;
  document.getElementById("medical").value = `   Questionnaitre IAO :\n${hospi.dossierMedical?.questionnaire || ''}\n\n
   Ant√©c√©dents m√©dicaux:\n${hospi.dossierMedical?.antecedents || ''}\n\n
   Traitements en cours :\n${hospi.dossierMedical?.traitements || ''}\n\n
   Histoire de la maladie :\n${hospi.dossierMedical?.histoire || ''}\n\n
   Auscultation initiale :\n${hospi.dossierMedical?.auscultation || ''}`;
  document.getElementById("evolution").value = hospi.evolution || '';
  document.getElementById("constantes").value = `Temp√©rature : ${hospi.constantes?.temperature || ''}¬∞C\nFC : ${hospi.constantes?.fc || ''} bpm\nTA : ${hospi.constantes?.ta || ''}\nSaturation : ${hospi.constantes?.saturation || ''}%\nFR : ${hospi.constantes?.fr || ''}\nDouleur : ${hospi.constantes?.douleur || ''}/10`;
document.getElementById("examens").value = (hospi.examens || []).map(e => {
  const commentaire = e.commentaire || ''; 
  const typeAvecCommentaire = commentaire.trim() !== '' ? `${e.type} (${commentaire})` : e.type;
  return `‚Ä¢ ${typeAvecCommentaire} : demand√© le ${e.dateDemande}, r√©alis√© le ${e.dateRealisation}\n   R√©sultat :${e.compteRendu || 'en attente'}`;
}).join('\n');
document.getElementById("actes").value = (hospi.actes_realises || []).map(a => {
  const remarques = a.remarques ? ` : ${a.remarques}` : '';
  return `‚Ä¢ ${a.date} : ${a.type} par ${a.realisateur || 'inconnu'}${remarques}`;
}).join('\n');
if (!hospi.sortie) {
  document.getElementById("sortie").value = '';
} else {
  const sortie = hospi.sortie;
  let texte = '';

  if (sortie.type) texte += `Type : ${sortie.type}\n`;
  if (sortie.options && sortie.options.length > 0) texte += `Options : ${sortie.options.join(', ')}\n\n`;
  if (sortie.destinationTransfert) texte += `Destination : ${sortie.destinationTransfert}\n\n`;
  if (sortie.serviceHospitalisation) texte += `Service : ${sortie.serviceHospitalisation}\n\n`;
  if (sortie.avisSpecialiste) texte += `Avis : ${sortie.avisSpecialiste}\n\n`;
  if (sortie.traitementSortie) texte += `Traitement sortie : \n${sortie.traitementSortie}\n`;

  document.getElementById("sortie").value = texte.trim();
}

  // Si rapport existant, on le charge pour modification ou affichage readonly
if (hospi.rapport) {
  const modal = document.getElementById("choixRapportModal");
if (modal) modal.style.display = "flex";


  // Bouton "ouvrir rapport existant"
  document.getElementById("btnOuvrir").onclick = () => {
    champs.forEach(c => {
      document.getElementById(c).value = hospi.rapport[c] || "";
    });
    setRapportValide(false);
    modal.style.display = "none";
	  afficherBulle("‚úÖRapport existant charg√© !", "administratif");
  };

  // Bouton "√©craser et cr√©er un nouveau"
  document.getElementById("btnEcraser").onclick = () => {
    afficherBulle("‚úèÔ∏è Nouveau rapport initialis√©", "administratif");
    setRapportValide(false);
    modal.style.display = "none";
  };

  return; // attend que l'utilisateur choisisse
}

  // Ajuste hauteur textarea
  champs.forEach(id => autoResizeTextarea(document.getElementById(id)));
}

// Enregistrer dans Firestore
async function enregistrerDansFirestore() {
  const values = {};
  champs.forEach(id => values[id] = document.getElementById(id).value);
  values.valide = true; // marque le rapport comme valid√©

  const doc = await patientRef.get();
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  hospitalisations[index] = {
    ...hospitalisations[index],
    rapport: values
  };
  await patientRef.update({ hospitalisations });
}
function showLoadingModal() {
  document.getElementById("loadingModal").classList.add("show");
}

function hideLoadingModal() {
  document.getElementById("loadingModal").classList.remove("show");
}


// Rendre les champs readonly et adapter style
function setRapportValide(val) {
  rapportValide = val;
  champs.forEach(id => {
    const el = document.getElementById(id);
    if(val){
      el.setAttribute("readonly", true);
      // Adaptation hauteur, plus d'ascenseur
      autoResizeTextarea(el);
      el.style.overflow = "hidden";
    } else {
      el.removeAttribute("readonly");
      el.style.overflow = "auto";
    }
  });
  // Affiche ou cache les boutons t√©l√©chargement / impression
  document.getElementById("telechargerBtn").style.display = val ? "inline-block" : "none";
  document.getElementById("imprimerBtn").style.display = val ? "inline-block" : "none";
  document.getElementById("validerBtn").style.display = val ? "none" : "inline-block";
	envoyerMailBtn.style.display = val ? "inline-block" : "none";
}
async function creerPDF(telecharger = false) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const marginLeft = 15;
  let y = 15;
  const lineHeight = 7;
  const pageHeight = doc.internal.pageSize.height;

  const logoUrl = "https://junior2704.github.io/urgences-/logo.jpg";
  const img = new Image();
  img.src = logoUrl;

  return new Promise((resolve, reject) => {
    img.onload = () => {
      try {
        // üîπ Logo
        doc.addImage(img, "JPEG", marginLeft, y, 40, 40);
        y += 30;

        // üîπ Titre
        doc.setFontSize(18);
        doc.setTextColor("#1a73e8");
        doc.text("Compte-rendu de passage aux Urgences", marginLeft + 50, y);
        y += 15;

        // üîπ Ligne bleue
        doc.setDrawColor(26, 115, 232);
        doc.setLineWidth(0.8);
        doc.line(marginLeft, y, 195, y);
        y += 10;

        // üîπ Fonction utilitaire
        function addBlock(titre, contenu) {
          doc.setFontSize(14);
          doc.setTextColor("#1a73e8");
          doc.text(titre, marginLeft, y);
          y += lineHeight;

          doc.setFontSize(11);
          doc.setTextColor("#000000");

          const splitText = doc.splitTextToSize(contenu || "‚Äî", 180);
          for (let i = 0; i < splitText.length; i++) {
            if (y > pageHeight - 20) {
              doc.addPage();
              y = 15;
            }
            doc.text(splitText[i], marginLeft, y);
            y += lineHeight;
          }

          y += lineHeight;
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.6);
          doc.line(marginLeft, y, 195, y);
          y += 10;
        }

        // üîπ Ajouter les blocs depuis le formulaire
        addBlock("Identit√© du patient", document.getElementById("identite")?.value?.trim());
        addBlock("Hospitalisation", document.getElementById("hospitalisation")?.value?.trim());
        addBlock("Dossier M√©dical", document.getElementById("medical")?.value?.trim());
        addBlock("√âvolution aux urgences", document.getElementById("evolution")?.value?.trim());
        addBlock("Constantes Vitales", document.getElementById("constantes")?.value?.trim());
        addBlock("Examens Compl√©mentaires", document.getElementById("examens")?.value?.trim());
        addBlock("Actes r√©alis√©s", document.getElementById("actes")?.value?.trim());
        addBlock("Sortie", document.getElementById("sortie")?.value?.trim());

        // üîπ Signature
        const signatureText = `${window.medecinNom || "Dr Non renseign√©"}\n${window.medecinSpecialite || ""}`;
        const pageWidth = doc.internal.pageSize.width;
        const splitSignature = doc.splitTextToSize(signatureText, 60);
        doc.text(splitSignature, pageWidth - 75, pageHeight - 30);

        // üîπ G√©n√©ration du PDF
        const pdfData = doc.output("datauristring");
        window.pdfBase64 = pdfData.split(",")[1];
        console.log("‚úÖ PDF g√©n√©r√©, taille base64:", window.pdfBase64.length);

        // üì• Si t√©l√©chargement demand√©
        if (telecharger) {
          doc.save("rapport_hospitalisation.pdf");
          console.log("üìÑ T√©l√©chargement lanc√©");
        }

        resolve(window.pdfBase64);
      } catch (error) {
        reject(error);
      }
    };

    img.onerror = () => reject(new Error("Erreur de chargement du logo."));
  });
}



function base64ToBlob(base64, type = "application/pdf") {
  const binary = atob(base64);
  const len = binary.length;
  const buffer = new ArrayBuffer(len);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < len; i++) {
    view[i] = binary.charCodeAt(i);
  }
  return new Blob([view], { type });
}









// Gestion du bouton valider
document.getElementById("validerBtn").addEventListener("click", async () => {
  if(confirm("Confirmez-vous la validation et figer ce rapport ?")){
    await enregistrerDansFirestore();
    setRapportValide(true);
    afficherBulle("‚úÖRapport valid√© et enregistr√© !", "administratif");
  }
});

document.getElementById("telechargerBtn").addEventListener("click", () => creerPDF(true));

	document.getElementById("imprimerBtn").addEventListener("click", () => window.print());

// Au chargement
window.onload = () => {
  chargerDepuisFirestore();
  setRapportValide(false);
  // Ajuste les textarea au contenu
  champs.forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener("input", () => autoResizeTextarea(el));
  });
};
function openEmailSelectModal(emailsString) {
  const modal = document.getElementById("emailSelectModal");
  const container = document.getElementById("emailCheckboxes");
  container.innerHTML = "";

  const emails = (emailsString || "").split("//").filter(e => e.includes("@"));
  if (emails.length === 0) {
    container.innerHTML = "<p style='color:#777;'>Aucune adresse trouv√©e pour ce patient.</p>";
  } else {
    emails.forEach((email, i) => {
      const id = "emailCheck_" + i;
      container.innerHTML += `
        <label style="display:flex; align-items:center; gap:6px; margin:6px 0;">
          <input type="checkbox" id="${id}" value="${email}" checked>
          ${email}
        </label>`;
    });
  }

  modal.style.display = "flex";
}

function closeEmailSelectModal() {
  document.getElementById("emailSelectModal").style.display = "none";
}

document.getElementById("otherEmailCheck").addEventListener("change", (e) => {
  document.getElementById("otherEmailInput").disabled = !e.target.checked;
});
// Ouvre la modale de s√©lection d'emails (ne g√©n√®re pas encore le PDF)
document.getElementById("btnEnvoyerMail").addEventListener("click", async () => {
  // pas de pdfBase64 pr√©existant dans cette page ‚Äî on g√©n√©rera le PDF au moment de l'envoi
  const doc = await patientRef.get();
  if (!doc.exists) {
    afficherBulle("‚ùå Patient introuvable", "alerte");
    return;
  }
  const data = doc.data();
  const emails = data.email || ""; // cha√Æne format√©e "a@x.com//b@y.fr"
  console.log("üìß Emails trouv√©s (dossier) :", emails);
  openEmailSelectModal(emails);
});

document.getElementById("confirmEmails").addEventListener("click", async function () {
  try {
    // R√©cup√®re les adresses s√©lectionn√©es dans la modale
    const checkedBoxes = document.querySelectorAll("#emailCheckboxes input[type='checkbox']:checked");
    let destinataires = Array.from(checkedBoxes).map(cb => cb.value.trim());

    const otherChecked = document.getElementById("otherEmailCheck").checked;
    const otherEmail = document.getElementById("otherEmailInput").value.trim();
    if (otherChecked && otherEmail) destinataires.push(otherEmail);

    if (destinataires.length === 0) {
      alert("Veuillez cocher au moins une adresse e-mail.");
      return;
    }

    closeEmailSelectModal();
    showLoadingModal();

    // --- 1) G√©n√©ration du PDF via ta fonction existante creerPDF()
    console.log("üìÑ G√©n√©ration du PDF via creerPDF()...");
    const pdfBase64 = await creerPDF(false); // renvoie le base64
    console.log("‚úÖ PDF g√©n√©r√©, taille base64:", pdfBase64.length);

    // --- 2) Cr√©ation d'un ID unique pour Firestore
    let idUnique, docSnap;
    do {
      idUnique = Math.random().toString(36).substring(2, 10);
      docSnap = await db.collection("liens_pdfs").doc(idUnique).get();
    } while (docSnap.exists);

    // --- 3) R√©cup√©ration des infos patient pour nommer le fichier
    const doc = await patientRef.get();
    if (!doc.exists) {
      hideLoadingModal();
      afficherBulle("‚ùå Patient non trouv√©", "alerte");
      return;
    }
    const data = doc.data();
    const firstName = data.prenom || "";
    const lastName = data.nom || "";
    const fileName =  `Rapport d'hospitalisation - ${firstName} ${lastName}.pdf`;

    // --- 4) Enregistrement dans Firestore
    await db.collection("liens_pdfs").doc(idUnique).set({
      base64: pdfBase64,
      nomFichier: fileName,
      dateCreation: firebase.firestore.FieldValue.serverTimestamp(),
    });

    const lienPdf = `https://junior2704.github.io/urgences-/monpdf.html?id=${idUnique}`;
    console.log("‚úÖ Lien Firestore :", lienPdf);

    // --- 5) Pr√©pare le corps du mail (template HTML comme avant)
    const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Compte-rendu d‚Äôhospitalisation</title>
</head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI', Roboto, Arial, sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#0057a4; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>
    <tr>
      <td style="padding:30px;">
        <h2 style="color:#0057a4; font-weight:600; margin-top:0;">Votre compte-rendu d‚Äôhospitalisation</h2>

        <p style="font-size:16px; line-height:1.6;">
          Bonjour <strong>${firstName} ${lastName}</strong>,
        </p>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          Le compte-rendu de votre hospitalisation a √©t√© valid√© par le m√©decin responsable et est d√©sormais disponible.
          Ce document r√©capitule votre prise en charge, les examens effectu√©s, ainsi que les recommandations m√©dicales √† suivre.
          Pour toute question relative √† votre compte-rendu, n'h√©sitez pas √† nous contacter le service des Urgences par e-mail : 
          <a href="mailto:urgences.hopj@gmail.com" style="color:#0057a4;">urgences.hopj@gmail.com</a>
        </p>

        <div style="text-align:center; margin:30px 0;">
          <a href="${lienPdf}" 
             style="background-color:#0057a4; color:white; padding:14px 32px; text-decoration:none; border-radius:8px; font-weight:500; display:inline-block;">
            üîó Voir le compte-rendu
          </a>
        </div>

        <p style="font-size:15px; line-height:1.6; color:#555;">
          ‚ö†Ô∏è Ce lien reste actif 7 jours. Au-del√† de ce d√©lai, il ne sera plus accessible pour des raisons de confidentialit√© et l'h√¥pital ne sera pas en mesure de vous en fournir une copie.
        </p>

        <p style="font-size:14px; color:#777;">
          Si vous rencontrez des difficult√©s, merci de contacter le service des Urgences :
          <a href="mailto:urgences.hopj@gmail.com" style="color:#0057a4;">urgences.hopj@gmail.com</a>
        </p>

        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

    // --- 6) Multi-compte EmailJS (fallback)
    const comptesEmailJS = [
      { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
      { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
      { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
    ];

    // --- 7) Envoi pour chaque destinataire (une requ√™te EmailJS par adresse)
    for (const email of destinataires) {
      const emailTrim = email.trim();
      if (!emailTrim || !emailTrim.includes("@")) {
        afficherBulle(`Adresse invalide : ${emailTrim}`, "alerte");
        continue;
      }

      let envoye = false;
      let derniereErreur = "";
      for (const compte of comptesEmailJS) {
        try {
          console.log(`üì® Envoi √† ${emailTrim} via ${compte.serviceID}...`);
          const htmlFinal = htmlMessage
  .replace(/{{patient_prenom}}/g, firstName)
  .replace(/{{patient_nom}}/g, lastName)
  .replace(/{{lien_compte_rendu}}/g, lienPdf);

          await emailjs.send(compte.serviceID, compte.templateID, {
            to_email: emailTrim,
            subject: "Votre compte-rendu d'hospitalisation est disponible",
            html_message: htmlMessage
          }, compte.publicKey);

          afficherBulle(`üì® Envoy√© : ${emailTrim}`, "administratif");
          envoye = true;
          break;
        } catch (err) {
          console.warn(`‚ö†Ô∏è √âchec ${compte.serviceID} -> ${err && err.text ? err.text : err}`);
          derniereErreur = err && err.text ? err.text : String(err);
          // si erreur de quota, on essaye le compte suivant, sinon on sort de la boucle comptes
          if (derniereErreur.toLowerCase().includes("quota")) continue;
          else break;
        }
      }

      if (!envoye) afficherBulle(`‚ùå √âchec d'envoi √† ${emailTrim}`, "alerte");
    }

    hideLoadingModal();
    afficherBulle("üì® Envois termin√©s !", "administratif");
    // recharge la page pour r√©initialiser l'UI (optionnel)
    setTimeout(() => location.reload(true), 2000);

  } catch (err) {
    hideLoadingModal();
    console.error("Erreur confirmEmails :", err);
    alert("Erreur lors de l'envoi : " + (err.message || err));
  }
});


function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }
function convertirDateEnFrancais(dateISO) {
  const [annee, mois, jour] = dateISO.split("-");
  return `${jour}/${mois}/${annee}`;
}
hideLoadingModal()
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "accueil.html";
    } else {
      const docSnap = await getDoc(doc(db, "medecins", user.uid));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nom-medecin") = data.nom || "M√©decin";
        document.getElementById("specialite") = data.specialite || "";
      }
    }
  });

let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "accueil.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
         medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
         medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});

</script>

</body>
</html>























