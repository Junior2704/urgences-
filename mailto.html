<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Mail-To</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f6f9;
      padding: 40px;
    }
    h2 { color: #1a237e; }

    .search-container {
      max-width: 500px;
      margin: auto;
      text-align: center;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    ul#results {
      list-style: none;
      padding: 0;
      margin: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    ul#results li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    ul#results li:hover { background: #f0f0f0; }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.3s;
    }
    button:hover { background-color: #1d4ed8; }

    /* Modales */
    #emailSelectModal, #messageModal, #loadingModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      justify-content: center;
      align-items: center;
      z-index: 200;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .email-options label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
    }

    input[type="email"], textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 8px;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .btn-cancel {
      background: #ccc;
      color: black;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #bubble-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
      align-items: flex-end;
    }

    .bubble {
      max-width: 300px;
      padding: 10px 15px;
      border-radius: 8px;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .administratif { background: #2196F3; }
    .alerte { background: #f44336; }
  </style>
</head>
<body>
  <div class="search-container" id="searchContainer">
    <h2>üîç Rechercher un patient</h2>
    <input type="text" id="searchInput" placeholder="Nom ou pr√©nom..." />
    <ul id="results"></ul>
  </div>

  <!-- Modale emails -->
  <div id="emailSelectModal">
    <div class="modal-content">
      <h3>Choisissez les destinataires</h3>
      <div id="emailCheckboxes" class="email-options"></div>
      <label><input type="checkbox" id="otherEmailCheck"> Autre :</label>
      <input type="email" id="otherEmailInput" placeholder="exemple@mail.com" disabled>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeEmailSelectModal()">Annuler</button>
        <button id="confirmEmails">Continuer</button>
      </div>
    </div>
  </div>

  <!-- Modale message -->
  <div id="messageModal">
    <div class="modal-content">
      <h3>‚úâÔ∏è R√©digez votre message</h3>
      <textarea id="messageText" rows="6" placeholder="Entrez ici le contenu du message..."></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeMessageModal()">Annuler</button>
        <button id="btnEnvoyerMail">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- Modale chargement -->
  <div id="loadingModal">
    <div class="modal-content">
      <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo" style="height:60px; margin-bottom:10px;">
      <div class="loader"></div>
      <p>Envoi en cours...</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
      authDomain: "urgences-a8ed4.firebaseapp.com",
      projectId: "urgences-a8ed4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const patientId = new URLSearchParams(window.location.search).get("id");
    let currentPatient = null;
    let destinataires = [];

    // --- UI helpers ---
    const show = id => document.getElementById(id).style.display = "flex";
    const hide = id => document.getElementById(id).style.display = "none";
    const afficherBulle = (texte, type) => {
      let c = document.getElementById("bubble-container");
      if (!c) { c = document.createElement("div"); c.id = "bubble-container"; document.body.appendChild(c); }
      const b = document.createElement("div");
      b.className = "bubble " + type;
      b.textContent = texte;
      c.appendChild(b);
      setTimeout(() => b.remove(), 3000);
    };

    // --- Email select modal ---
    function openEmailSelectModal(emailsString) {
      const modal = document.getElementById("emailSelectModal");
      const container = document.getElementById("emailCheckboxes");
      container.innerHTML = "";

      const emails = (emailsString || "").split("//").filter(e => e.includes("@"));
      if (emails.length === 0) {
        container.innerHTML = "<p style='color:#777;'>Aucune adresse trouv√©e pour ce patient.</p>";
      } else {
        emails.forEach((email, i) => {
          container.innerHTML += `<label><input type="checkbox" value="${email}" checked> ${email}</label>`;
        });
      }
      modal.style.display = "flex";
    }

    function closeEmailSelectModal() { hide("emailSelectModal"); }
    function closeMessageModal() { hide("messageModal"); }

    // --- Recherche patients (nom OU pr√©nom) ---
async function searchPatients(query) {
  const resultsContainer = document.getElementById("results");
  resultsContainer.innerHTML = "<li style='padding:8px;color:#555;'>‚è≥ Recherche en cours...</li>";

  try {
    // 1Ô∏è‚É£ Requ√™te par nom
    const byNomSnap = await db.collection("patients")
      .where("nom", ">=", query)
      .where("nom", "<=", query + "\uf8ff")
      .get();

    // 2Ô∏è‚É£ Requ√™te par pr√©nom
    const byPrenomSnap = await db.collection("patients")
      .where("prenom", ">=", query)
      .where("prenom", "<=", query + "\uf8ff")
      .get();

    // 3Ô∏è‚É£ Fusion des r√©sultats (suppression des doublons)
    const patientsMap = new Map();
    [...byNomSnap.docs, ...byPrenomSnap.docs].forEach(doc => {
      patientsMap.set(doc.id, doc.data());
    });

    const patients = Array.from(patientsMap.entries());

    // 4Ô∏è‚É£ Affichage
    resultsContainer.innerHTML = "";
    if (patients.length === 0) {
      resultsContainer.innerHTML = "<li style='padding:8px;color:#777;'>Aucun patient trouv√©.</li>";
      return;
    }

    patients.forEach(([id, data]) => {
      const li = document.createElement("li");
      li.textContent = `${data.prenom || ""} ${data.nom || ""}`;
      li.style.cursor = "pointer";
      li.onclick = () => {
        currentPatient = { id, data };
        openEmailSelectModal(data.email || "");
      };
      resultsContainer.appendChild(li);
    });
  } catch (err) {
    console.error("Erreur de recherche Firestore :", err);
    resultsContainer.innerHTML = "<li style='padding:8px;color:#f00;'>Erreur de recherche.</li>";
  }
}


    document.getElementById("searchInput").addEventListener("input", e => {
      const val = e.target.value.trim();
      if (val.length >= 2) searchPatients(val);
    });

    // --- Initial load: open modal if id present ---
    if (patientId) {
      db.collection("patients").doc(patientId).get().then(doc => {
        if (doc.exists) {
          currentPatient = doc;
          openEmailSelectModal(doc.data().email || "");
        } else {
          afficherBulle("‚ùå Patient introuvable", "alerte");
        }
      });
    }

    // --- Confirm emails ---
    document.getElementById("confirmEmails").addEventListener("click", () => {
      const checked = document.querySelectorAll("#emailCheckboxes input:checked");
      destinataires = Array.from(checked).map(cb => cb.value.trim());
      const other = document.getElementById("otherEmailCheck").checked ? document.getElementById("otherEmailInput").value.trim() : "";
      if (other) destinataires.push(other);
      if (destinataires.length === 0) return alert("S√©lectionnez au moins une adresse.");
      hide("emailSelectModal");
      show("messageModal");
    });

    // --- Send Email ---
    document.getElementById("btnEnvoyerMail").addEventListener("click", async () => {
      const message = document.getElementById("messageText").value.trim();
      if (!message) return alert("Veuillez r√©diger un message.");
      show("loadingModal");

      const comptesEmailJS = [
        { serviceID: "service_o07vuso", templateID: "template_vj03i4u", publicKey: "CZapZCcxYfJ8-acLS" },
        { serviceID: "service_o3i8ac9", templateID: "template_0wbzbwe", publicKey: "j5G-06rjQm0P6wriE" },
        { serviceID: "service_qij0y5a", templateID: "template_3qdes3p", publicKey: "nh2zkdRVJcGcE-Jwe" }
      ];

      const htmlMessage = `
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Message du Service des Urgences</title>
</head>
<body style="margin:0; padding:0; background-color:#f4f6f9; font-family:'Segoe UI',Roboto,Arial,sans-serif; color:#333;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width:640px; margin:auto; background:white; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); overflow:hidden;">
    <tr>
      <td style="background-color:#0057a4; padding:24px; text-align:center;">
        <img src="https://junior2704.github.io/urgences-/logo.jpg" alt="Logo H√¥pital" style="height:60px; display:block; margin:0 auto 10px auto;">
        <h1 style="color:white; font-size:22px; margin:0;">Centre Hospitalier</h1>
        <p style="color:#dce6f3; margin:6px 0 0; font-size:14px;">Service des Urgences</p>
      </td>
    </tr>
    <tr>
      <td style="padding:30px;">
        <div style="font-size:15px; line-height:1.6; color:#555;">${message.replace(/\n/g,"<br>")}</div>
        <hr style="border:none; border-top:1px solid #e0e0e0; margin:30px 0;">
        <p style="font-size:13px; color:#999; text-align:center;">
          Service des Urgences<br>
          <em>Cet e-mail a √©t√© g√©n√©r√© automatiquement, merci de ne pas y r√©pondre.</em>
        </p>
      </td>
    </tr>
  </table>
</body>
</html>`;

      for (const email of destinataires) {
        let envoy√© = false;
        for (const compte of comptesEmailJS) {
          try {
            await emailjs.send(compte.serviceID, compte.templateID, {
              to_email: email,
              html_message: htmlMessage,
              subject: "Message du Service des Urgences"
            }, compte.publicKey);
            afficherBulle(`üì® Message envoy√© √† ${email}`, "administratif");
            envoy√© = true;
            break;
          } catch (err) {
            console.warn("√âchec avec", compte.serviceID, err.text || err);
          }
        }
        if (!envoy√©) afficherBulle(`‚ùå √âchec d'envoi √† ${email}`, "alerte");
      }

      hide("loadingModal");
      hide("messageModal");
    });
  </script>
</body>
</html>
