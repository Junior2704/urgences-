<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/jpeg" href="logo.png">
<title>üöë GestUrg2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Inter,Arial,sans-serif;background:#f0f4f8;height:100vh;display:flex;flex-direction:column}

/* ===== BARRE TOP FIXE ===== */
#shell-topbar{
  position:fixed;top:0;left:0;right:0;height:64px;
  background:#ffffff;display:flex;flex-direction:column;
  padding:6px 14px;z-index:10000;box-shadow:0 4px 16px rgba(0,0,0,.12)
}

#actions{
  display:flex;gap:10px;align-items:center
}

.action-btn{
  background:#e6f0fc;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.action-btn:hover{background:#0078d4;color:white}

/* ===== ONGLET TYPE CHROME ===== */
#tabs{
  display:flex;gap:4px;overflow-x:auto;margin-top:6px
}
.tab{
  background:#e5e7eb;border-radius:10px 10px 0 0;
  padding:6px 12px;cursor:pointer;white-space:nowrap;
  display:flex;align-items:center;gap:6px;font-size:14px
}
.tab.active{background:#0078d4;color:#fff}
.tab span.close{cursor:pointer;font-weight:bold}

/* ===== CONTENU ===== */
#content{
  flex:1;margin-top:64px;display:flex;flex-direction:column
}
iframe{
  border:none;width:100%;height:100%;background:white;display:none
}
#home{
  display:flex;align-items:center;justify-content:center;
  height:100%;color:#6b7280;font-size:20px
}
#shell-topbar {
  display: flex;
  flex-direction: column;
  padding: 6px 14px;
}

#topbar-left, #topbar-right {
  display: flex;
  align-items: center;
}

#topbar-left {
  position: absolute;
  left: 14px;
  top: 10px;
  font-weight: bold;
  font-size: 20px;
}

#topbar-right {
  position: absolute;
  right: 14px;
  top: 10px;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}
#shell-topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 64px;
  background: #ffffff;
  padding: 6px 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,.12);
  display: flex;
  flex-direction: column;
  z-index: 10000;
}

#topbar-main {
  display: flex;
  align-items: center;
  justify-content: space-between; /* Titre √† gauche, actions au centre, date √† droite */
  gap: 10px;
}

#app-title {
  font-weight: bold;
  font-size: 20px;
}

#actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap; /* pour les √©crans plus petits */
  justify-content: center; /* centre les boutons */
}

#datetime {
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}
/* ===== DROPDOWN OUTILS ===== */
.dropdown {
  position: relative;
}

.dropdown-content {
  position: absolute;
  top: 100%;           /* coll√© au bouton */
  left: 0;
  margin-top: 2px;     /* optionnel */
  background: white;
  min-width: 320px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,.15);
  padding: 6px;
  z-index: 10001;
  display: none;
}

.dropdown:hover .dropdown-content {
  display: block;
}

.dropdown-content.open {
  display: block;
}



.dropdown-item {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  border-radius: 8px;
  font-size: 14px;
  cursor: default;
}

.dropdown-item:hover {
  background: #e6f0fc;
}

.dropdown-item span {
  background: #0078d4;
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
}

.dropdown-item span:hover {
  background: #005fa3;
}

/* ===== TOOLTIP DESCRIPTION ===== */
.dropdown-item::after {
  content: attr(data-desc);
  position: absolute;
  left: 105%;
  top: 50%;
  transform: translateY(-50%);
  background: #111827;
  color: white;
  padding: 8px 10px;
  border-radius: 8px;
  width: 260px;
  font-size: 13px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s;
}

.dropdown-item:hover::after {
  opacity: 1;
}
.dropdown-content {
  display: none;
}

/* OUVERTURE AU SURVOL */
.dropdown:hover .dropdown-content {
  display: block;
}

/* OUVERTURE PERSISTANTE AU CLIC */
.dropdown-content.open {
  display: block;
}
/* Conteneur messages sous le SVG */
/* Conteneur messages sous le SVG */
#home-messages-container {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-family: Inter, Arial, sans-serif;
}

/* Carte unique visible */
.home-message {
  width: 100%;
  border-radius: 16px;
  padding: 20px;
  color: white;
  display: none;
  flex-direction: column;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  text-align: left;
  transition: opacity 0.6s;
}

.home-message.active {
  display: flex;
  opacity: 1;
}

.home-message h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 700;
}

.home-message p.text1 {
  margin: 0 0 4px 0;
  font-size: 16px;
}

.home-message p.text2 {
  margin: 0;
  font-size: 14px;
  opacity: 0.85;
}

/* Couleurs selon type */
.home-message.info { background-color: #3498db; }           /* bleu */
.home-message.alerte_moyenne { background-color: #f39c12; } /* orange */
.home-message.alerte_grave { background-color: #e74c3c; }   /* rouge */
.home-message.remerciement { background-color: #d4af37; }    /* dor√© */

/* Barre pagination + fl√®ches */
#home-messages-controls {
  display: flex;
  align-items: center;
  margin-top: 12px;
  gap: 12px;
}

.home-arrow {
  font-size: 20px;
  cursor: pointer;
  user-select: none;
  color: #374151;
}

#home-messages-pagination {
  display: flex;
  gap: 6px;
}

.home-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #cbd5e1;
  cursor: pointer;
}

.home-dot.active {
  background: #0078d4;
}

.tab {
  user-select: none;
}

.tab.dragging {
  opacity: 0.4;
}

.tab.drag-over {
  border-left: 3px solid #0078d4;
}
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 20000;
}

.modal {
  background: white;
  border-radius: 16px;
  padding: 22px;
  width: 420px;
  box-shadow: 0 20px 40px rgba(0,0,0,.25);
  text-align: center;
}

.modal h3 {
  margin-top: 0;
}

.modal-actions {
  margin-top: 18px;
}

.modal-actions button {
  background: #0078d4;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 10px 18px;
  font-weight: 600;
  cursor: pointer;
}
.modal-actions button:hover {
  background: #005fa3;
}

#tabs {
  overflow: hidden;
}
#window-controls {
  position: absolute;
  top: 10px;
  right: 14px;
  display: flex;
  gap: 6px;
}

#window-controls button {
  background: #e6f0fc;
  border: none;
  border-radius: 6px;
  width: 28px;
  height: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

#window-controls button:hover {
  background: #0078d4;
  color: white;
}

#window-controls button.close:hover {
  background: #e74c3c;
  color: white;
}
#window-controls {
  position: absolute;
  top: 4px; /* plus haut que l'heure */
  right: 14px;
  display: flex;
  gap: 6px;
  z-index: 10001;
}

#datetime {
  position: absolute;
  top: 36px; /* sous les boutons */
  right: 14px;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}
</style>
</head>
<body>

<div id="shell-topbar">
  <div id="topbar-main">
    <span id="app-title">üöë GestUrg2</span>

    <div id="actions">
      <button class="action-btn" onclick="openTab('Urgences','urgences.html')">üöë Urgences</button>
      <button class="action-btn" onclick="openTab('Tableau','regulation.html')">üìä Tableau</button>
<div class="dropdown" id="dropdownOutils">
  <button class="action-btn" id="btnOutils">üß∞ Outils ‚ñæ</button>

  <div class="dropdown-content" id="menuOutils">

    <div class="dropdown-item" data-desc="Acc√©der aux dossiers et comptes rendus des patients.">
       üë• Patients
     <span onclick="openTab('Patients','patients.html')">Ouvrir</span>
    </div>
<div class="dropdown-item" data-desc="Gestion des appels des tickets patients.">
       üéüÔ∏è Tickets
     <span onclick="openTab('Tickets','bureau.html')">Ouvrir</span>
    </div>
    <div class="dropdown-item" data-desc="Cr√©er les ordonnances m√©dicales des patients. Pr√©-remplissage possible via la fiche patient.">
      üìÑ Ordonnancier
      <span onclick="openTab('Ordonnancier','Ordonnancier.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="√âtablir les factures patients. Pr√©-remplissage possible via la fiche patient.">
      üí≥ Facturation
      <span onclick="openTab('Facturation','Facturation.html')">Ouvrir</span>
    </div>
<div class="dropdown-item" data-desc="R√©diger rapidement des certificats m√©dicaux. Pr√©-remplissage possible via la fiche patient.">
      üßæ Certificats m√©dicaux
      <span onclick="openTab('Certificats','Certificatmedical.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="Imprimer des fiches conseils de sortie adapt√©es √† la pathologie.">
      üìã Fiches conseils
      <span onclick="openTab('Fiches conseils','fichesconseilf.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="Visualiser les examens, r√©diger les comptes rendus et g√©rer l‚Äôimagerie.">
      ü©ª Gestionnaire imagerie
      <span onclick="openTab('Imagerie','gestionnaireradiologie.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="√âcrire un email √† un patient. Pr√©-remplissage possible via la fiche patient.">
      ‚úâÔ∏è Mail To
      <span onclick="openTab('Mail','mailtof.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="Cr√©er un acc√®s patient pour un PDF et/ou l‚Äôenvoyer par email. Pr√©-remplissage possible via la fiche patient.">
      üìé Acc√®s PDF patient
      <span onclick="openTab('PDF Patient','uploadpdff.html')">Ouvrir</span>
    </div>

    <div class="dropdown-item" data-desc="Voir les donn√©es de votre compte (non modifiables).">
      üë§ Mon compte
      <span onclick="openTab('Mon compte','viewacountf.html')">Ouvrir</span>
    </div>

  </div>
</div>
	  <button class="action-btn" onclick="closeAllTabs()">üßπ Tout fermer</button>

      <button class ="action-btn" id="btnLogout">üîì D√©connexion</button>

    </div>


    
    <div id="window-controls" style="display:none;">
  <button onclick="electronMinimize()">‚Äî</button>
  <button onclick="electronMaximize()">‚òê</button>
  <button class="close" onclick="electronClose()">‚úï</button>
</div>
<span id="datetime"></span>
  </div>

  <div id="tabs"></div>
</div>


<div id="content">
<div id="home">
  <div id="home-messages-container">
  <div id="home-messages-carousel"></div>
  <div id="home-messages-controls">
    <span class="home-arrow" id="prev-msg">‚óÄ</span>
    <div id="home-messages-pagination"></div>
    <span class="home-arrow" id="next-msg">‚ñ∂</span>
  </div>
</div>
  
  
  <div id="home-text">S√©lectionnez un module pour commencer</div>




</div>
<div id="tabOverflowModal" class="modal-overlay">
  <div class="modal">
    <h3>‚ö†Ô∏è Trop d‚Äôonglets ouverts</h3>
    <p>
      La largeur disponible ne permet plus d‚Äôafficher de nouveaux onglets.<br>
      Veuillez fermer un ou plusieurs onglets pour continuer.
    </p>

    <div class="modal-actions">
      <button onclick="closeOverflowModal()">Compris</button>
    </div>
  </div>
</div>


<style>
#home {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100%;
  background: linear-gradient(to bottom,#f0f4f8,#e0e7ef);
  overflow:hidden;
  position:relative;
  font-family:Inter, Arial, sans-serif;
}

#home-text {
  margin-top:20px;
  font-size:22px;
  font-weight:500;
  color:#374151;
  opacity:0;
  animation: fadeText 2s forwards 1s;
}

/* ECG animation */
#ecg {
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: drawECG 2s linear infinite;
}


/* Ambulance qui avance continuellement vers la droite */
#ambulance {
  animation: drive 3s linear infinite;
}

@keyframes drawECG {
  0% { stroke-dashoffset: 1000; }
  100% { stroke-dashoffset: 0; }
}



@keyframes drive {
  0% { transform: translateX(-60px) scale(-1,1); }
  100% { transform: translateX(660px) scale(-1,1); } /* d√©filement continu */
}

@keyframes fadeText {
  to { opacity:1; }
}
</style>
</div>


<script>
let tabs = [];
let activeTab = null;

function openTab(title, url){
 let existing = tabs.find(t=>t.url===url);
  if(existing){
    setActive(existing.id);
    return;
  }

  // üîç Test de place AVANT ouverture
  const tempTab = document.createElement("div");
  tempTab.className = "tab";
  tempTab.style.visibility = "hidden";
  tempTab.innerHTML = title;
  document.getElementById("tabs").appendChild(tempTab);

  const overflow = tabsOverflow();
  tempTab.remove();

  if (overflow) {
    showOverflowModal();
    return;
  }
  const id = Date.now();
  tabs.push({id,title,url});

  const tab = document.createElement('div');
  tab.className='tab';tab.dataset.id=id;
  tab.innerHTML=`${title} <span class="close">‚úï</span>`;
  tab.onclick=()=>setActive(id);
  tab.querySelector('.close').onclick=(e)=>{e.stopPropagation();closeTab(id)};
  enableTabDrag(tab);
  document.getElementById('tabs').appendChild(tab);

  const iframe=document.createElement('iframe');
  iframe.src=url;iframe.dataset.id=id;
  document.getElementById('content').appendChild(iframe);

  document.getElementById('home').style.display='none';
  setActive(id);
}

function setActive(id){
  activeTab=id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.id==id));
  document.querySelectorAll('iframe').forEach(f=>f.style.display=f.dataset.id==id?'block':'none');
}
document.getElementById("btnLogout").addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        window.location.href = "index.html";
      })
      .catch((error) => {
        afficherBulle("Erreur de d√©connexion" ,"error");
      });
  });
function closeTab(id){
  tabs=tabs.filter(t=>t.id!==id);
  document.querySelector(`.tab[data-id='${id}']`)?.remove();
  document.querySelector(`iframe[data-id='${id}']`)?.remove();

  if(!tabs.length){
    document.getElementById('home').style.display='flex';
    activeTab=null;return;
  }
  if(activeTab===id) setActive(tabs[tabs.length-1].id);
}
window.addEventListener("resize", () => {
  if (tabsOverflow()) showOverflowModal();
});

/* === API pour ouvrir depuis urgences.html === */
window.openInShell = function(title, url){
  openTab(title, url);
};
window.addEventListener("message", (event) => {
  if (!event.data) return;

  if (event.data.type === "OPEN_TAB") {
    openTab(event.data.title, event.data.url);
  }
});
function updateDateTime() {
  const now = new Date();
  const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
  const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('datetime').textContent = now.toLocaleDateString('fr-FR', options) + ' ' + time;
}
const btnOutils = document.getElementById("btnOutils");
const menuOutils = document.getElementById("menuOutils");
const dropdownOutils = document.getElementById("dropdownOutils");

// Clic = ouverture persistante
btnOutils.addEventListener("click", (e) => {
  e.stopPropagation();
  menuOutils.classList.toggle("open");
});

// Emp√™cher fermeture quand on clique dans le menu
menuOutils.addEventListener("click", (e) => {
  e.stopPropagation();
});
function closeAllTabs() {
  tabs = [];
  document.querySelectorAll(".tab").forEach(t => t.remove());
  document.querySelectorAll("iframe").forEach(f => f.remove());

  activeTab = null;
  document.getElementById('home').style.display = 'flex';
}
// Fermer seulement si clic ailleurs
document.addEventListener("click", () => {
  menuOutils.classList.remove("open");
});

let draggedTab = null;

function enableTabDrag(tabEl) {
  tabEl.draggable = true;

  tabEl.addEventListener("dragstart", (e) => {
    draggedTab = tabEl;
    tabEl.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });

  tabEl.addEventListener("dragend", () => {
    tabEl.classList.remove("dragging");
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("drag-over"));
    draggedTab = null;
  });

  tabEl.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (tabEl !== draggedTab) {
      tabEl.classList.add("drag-over");
    }
  });

  tabEl.addEventListener("dragleave", () => {
    tabEl.classList.remove("drag-over");
  });

  tabEl.addEventListener("drop", (e) => {
    e.preventDefault();
    tabEl.classList.remove("drag-over");

    if (!draggedTab || draggedTab === tabEl) return;

    const tabsContainer = document.getElementById("tabs");
    const draggedId = draggedTab.dataset.id;
    const targetId = tabEl.dataset.id;

    const draggedIndex = tabs.findIndex(t => t.id == draggedId);
    const targetIndex = tabs.findIndex(t => t.id == targetId);

    // R√©organisation DOM
    if (draggedIndex < targetIndex) {
      tabsContainer.insertBefore(draggedTab, tabEl.nextSibling);
    } else {
      tabsContainer.insertBefore(draggedTab, tabEl);
    }

    // R√©organisation tableau logique
    const [moved] = tabs.splice(draggedIndex, 1);
    tabs.splice(targetIndex, 0, moved);
  });
}
function tabsOverflow() {
  const container = document.getElementById("tabs");
  let totalWidth = 0;

  container.querySelectorAll(".tab").forEach(tab => {
    totalWidth += tab.offsetWidth + 4; // gap
  });

  return totalWidth > container.offsetWidth;
}
function showOverflowModal() {
  document.getElementById("tabOverflowModal").style.display = "flex";
}

function closeOverflowModal() {
  document.getElementById("tabOverflowModal").style.display = "none";
}


// Mise √† jour toutes les secondes
setInterval(updateDateTime, 1000);
updateDateTime();

</script>
<script type="module">
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // D√©connexion
  document.getElementById("btnLogout").addEventListener("click", () => {
    signOut(auth)
      .then(() => {
        window.location.href = "index.html";
      })
      .catch((error) => {
        afficherBulle("Erreur de d√©connexion" ,"error");
      });
  });

  // Auth state + r√©cup√©ration du m√©decin
 onAuthStateChanged(auth, async (user) => {
  if (!user) {
    console.log("Aucun utilisateur connect√©");
   window.location.href = "index.html";
    return;
  }

  // Parcours des iframes ouvertes
  document.querySelectorAll('iframe').forEach(iframe => {
    iframe.contentWindow.postMessage({
      type: "USER_CONNECTED",
      user: {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName
      }
    }, "*");
  });
});
 async function loadHomeMessages() {
  const carousel = document.getElementById("home-messages-carousel");
  const pagination = document.getElementById("home-messages-pagination");

  try {
    const snap = await getDoc(doc(db, "r√©f√©rentiels", "messages_accueil"));
    const data = snap.exists() ? snap.data() : null;
    if (!data || !data.liste || !data.liste.length) return;

    const messages = data.liste; // tableau d'objets {titre,type,texte1,texte2}

    messages.forEach((msg, i) => {
      const div = document.createElement("div");
      div.className = "home-message " + msg.type.replace(/ /g,"-");
      div.innerHTML = `
        <h3>${msg.titre}</h3>
        <p class="text1">${msg.texte1}</p>
        <p class="text2">${msg.texte2}</p>
      `;
      carousel.appendChild(div);

      const dot = document.createElement("div");
      dot.className = "home-dot";
      dot.addEventListener("click", () => showMessage(i));
      pagination.appendChild(dot);
    });

    let currentIndex = 0;
    const cards = Array.from(carousel.children);
    const dots = Array.from(pagination.children);

    function showMessage(index) {
      cards.forEach((c,i)=>c.classList.toggle("active",i===index));
      dots.forEach((d,i)=>d.classList.toggle("active",i===index));
      currentIndex = index;
    }

    // Navigation fl√®ches
    document.getElementById("prev-msg").addEventListener("click", ()=>{
      showMessage((currentIndex-1+cards.length)%cards.length);
      resetAutoSlide();
    });
    document.getElementById("next-msg").addEventListener("click", ()=>{
      showMessage((currentIndex+1)%cards.length);
      resetAutoSlide();
    });

    showMessage(0);

    // D√©filement automatique toutes les 5 secondes
    let autoSlide = setInterval(()=>{
      showMessage((currentIndex+1)%cards.length);
    },5000);

    function resetAutoSlide() {
      clearInterval(autoSlide);
      autoSlide = setInterval(()=>{
        showMessage((currentIndex+1)%cards.length);
      },5000);
    }

  } catch (err) {
    console.error("Erreur chargement messages accueil :", err);
  }
}


// Appel au chargement de la page
loadHomeMessages();


</script>
<script>
function isElectron() {
  return !!window.electronAPI;
}

// Affiche les boutons seulement si Electron
const controls = document.getElementById('window-controls');
if (controls && isElectron()) {
  controls.style.display = 'flex';
}

// Fonctions Electron
function electronMinimize() {
  if (!isElectron()) return;
  window.electronAPI.minimize();
}
function electronMaximize() {
  if (!isElectron()) return;
  window.electronAPI.maximize();
}
function electronClose() {
  if (!isElectron()) return;
  window.electronAPI.close();
}

</script>

</body>
</html>
