<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des documents</title>
<style>
    :root {
        --primary-color: #007bff; /* Bleu hôpital moderne */
        --secondary-color: #f0f4f8; /* Fond clair */
        --text-color: #333;
        --hover-color: #e6f0ff;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--secondary-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
    }

    h1 {
        color: var(--primary-color);
        font-size: 2em;
        text-align: center;
        margin-bottom: 30px;
    }

    #documentList {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    li {
        background-color: #fff;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        margin-bottom: 15px;
        transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    li:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        background-color: var(--hover-color);
    }

    .doc-type {
        font-weight: 600;
        font-size: 1.1em;
        color: var(--primary-color);
    }

    .doc-date {
        font-size: 0.9em;
        color: #555;
    }

    @media (max-width: 600px) {
        li {
            flex-direction: column;
            align-items: flex-start;
        }
        .doc-date {
            margin-top: 5px;
        }
    }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Historique des documents</h1>
    <ul id="documentList"></ul>

    <script>
        // --- Configuration Firebase ---
        const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Récupérer l'ID patient depuis l'URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const idPatient = urlParams.get('id');
        if (!idPatient) {
            alert("Aucun ID patient trouvé dans l'URL !");
            throw new Error("Aucun ID patient dans l'URL");
        }

        const documentList = document.getElementById('documentList');

        // --- Fonction utilitaire pour convertir base64 en Blob ---
        function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: contentType });
        }

        // --- Fonction pour afficher les documents ---
        function afficherDocuments() {
            db.collection('ordonnances')
              .where('idPatient', '==', idPatient)
              .get()
              .then(querySnapshot => {
                  if (querySnapshot.empty) {
                      documentList.innerHTML = "<li>Aucun document trouvé pour ce patient.</li>";
                      return;
                  }

                  // Mettre les documents dans un tableau
                  const docsArray = [];
                  querySnapshot.forEach(doc => {
                      docsArray.push(doc.data());
                  });

                  // Trier par dateCreation descendante côté client
                  docsArray.sort((a, b) => b.dateCreation.seconds - a.dateCreation.seconds);

                  // Affichage
                  docsArray.forEach(data => {
                      const li = document.createElement('li');
                      li.innerHTML = `<span class="doc-type">${data.type}</span>
                                      <span class="doc-date">${new Date(data.dateCreation.seconds * 1000).toLocaleString()}</span>`;
                      
                      li.addEventListener('dblclick', () => {
                          const blob = b64toBlob(data.pdfBase64, 'application/pdf');
                          const url = URL.createObjectURL(blob);
                          window.open(url, '_blank');
                      });

                      documentList.appendChild(li);
                  });
              })
              .catch(error => {
                  console.error("Erreur lors de la récupération des documents:", error);
                  documentList.innerHTML = "<li>Erreur lors du chargement des documents.</li>";
              });
        }

        // --- Charger les documents ---
        afficherDocuments();
    </script>
</body>
</html>
