<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique des documents</title>
<style>
    :root {
        --primary-color: #007bff;
        --secondary-color: #f0f4f8;
        --text-color: #333;
        --hover-color: #e6f0ff;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--secondary-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
    }

    h1 {
        color: var(--primary-color);
        font-size: 2em;
        text-align: center;
        margin-bottom: 30px;
    }

    #documentList {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    li {
        background-color: #fff;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    li:hover {
        background-color: var(--hover-color);
    }

    .doc-type {
        font-weight: 600;
        font-size: 1.1em;
        color: var(--primary-color);
    }

    .doc-date {
        font-size: 0.9em;
        color: #555;
        margin-left: 15px;
    }

  .btn-loupe {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.3em;
    color: #444;
    padding: 4px;
}

.btn-loupe:hover {
    color: var(--primary-color);
}
.doc-contenu {
    font-size: 0.85em;
    color: #666;
    margin-left: 15px;
    font-style: italic;
    max-width: 40%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


    /* === MODALE === */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0,0,0,0.6);
    }

    .modal-content {
        background-color: #fff;
        margin: 40px auto;
        padding: 20px;
        border-radius: 10px;
        width: 80%;
        height: 80%;
        display: flex;
        flex-direction: column;
    }

    iframe {
        flex: 1;
        width: 100%;
        border: none;
    }

    .close {
        background: red;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 10px;
        align-self: flex-end;
    }
	
}
/* ===== MODALE DE CONFIRMATION (version compacte) ===== */
#confirmDeleteModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

/* Petite bo√Æte centr√©e */
#confirmDeleteModal .modal-content {
    width: 360px;
    background: #ffffff;
    border-radius: 14px;
    padding: 24px 26px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    text-align: center;
    animation: fadeInScale 0.25s ease-out;

    /* hauteur r√©duite */
    height: auto;
    max-height: 220px;
}

@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.90); }
    to   { opacity: 1; transform: scale(1); }
}

/* Titre */
#confirmDeleteModal h3 {
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
}

/* Texte */
#confirmDeleteModal p {
    margin: 0 0 20px 0;
    color: #475569;
    font-size: 0.95rem;
}

/* Boutons */
.confirm-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
}

#btnConfirmDelete,
#btnCancelDelete {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
}

#btnConfirmDelete {
    background: #dc3545;
    color: white;
}

#btnConfirmDelete:hover {
    background: #b02a37;
}

#btnCancelDelete {
    background: #e2e8f0;
    color: #1e293b;
}

#btnCancelDelete:hover {
    background: #cbd5e1;
}
.btn-delete {
    cursor: pointer;
    background: none;
    border: none;
    font-size: 1.3em;
    color: #c62828; /* rouge neutre */
    padding: 4px;
}

.btn-delete:hover {
    color: #dc3545; /* rouge vif au hover */
}

.modalna {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(5px); /* flou de l'√©cran */
  z-index: 9999;
}

.modalna .card {
  background: #fff;
  padding: 24px 32px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
}

.modalna h2 {
  color: #d32f2f; /* rouge pour danger/erreur */
  margin-bottom: 12px;
}

.modalna p {
  font-size: 16px;
  margin-bottom: 20px;
}

.modalna .btn {
  padding: 10px 20px;
  font-size: 14px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Historique des documents</h1>
    <ul id="documentList"></ul>

    <!-- ===== MODALE POUR AFFICHER LE PDF ===== -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <button class="close" onclick="fermerModal()">Fermer</button>
            <iframe id="pdfViewer"></iframe>
        </div>
    </div>
<div id="confirmDeleteModal">
    <div class="modal-content">
        <h3>Supprimer ce document ?</h3>
        <p>Cette action est irr√©versible.</p>

        <div class="confirm-buttons">
            <button id="btnConfirmDelete">Oui, supprimer</button>
            <button id="btnCancelDelete">Annuler</button>
        </div>
    </div>
</div>
<div id="modal-no-access" class="modalna">
  <div class="card">
    <h2>‚õîÔ∏è Acc√®s refus√©</h2>
    <p>Vous n‚Äôavez pas acc√®s √† cette page.</p>
  </div>
</div>

<script>
// Conteneur global pour les bulles
let notificationContainer = document.getElementById('notification-container');
if (!notificationContainer) {
  notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  notificationContainer.style.position = 'fixed';
  notificationContainer.style.top = '12px';
  notificationContainer.style.right = '12px'; // EN HAUT √Ä DROITE
  notificationContainer.style.display = 'flex';
  notificationContainer.style.flexDirection = 'column';
  notificationContainer.style.gap = '8px'; // espace vertical entre bulles
  notificationContainer.style.zIndex = 9999;
  document.body.appendChild(notificationContainer);
}

// Fonction pour afficher une bulle
function afficherBulle(msg, type = 'info') {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.padding = '10px 14px';
  el.style.borderRadius = '8px';
  el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
  el.style.fontSize = '14px';
  el.style.fontWeight = '500';
  el.style.opacity = '0';
  el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  el.style.transform = 'translateY(-10px)';

  // --- Code couleur selon type ---
  switch (type) {
    case 'success':
      el.style.background = '#e6ffed'; // vert clair
      el.style.color = '#064e22';      // texte vert fonc√©
      break;
    case 'error':
      el.style.background = '#ffdede'; // rouge clair
      el.style.color = '#a00';         // texte rouge fonc√©
      break;
    case 'warning':
      el.style.background = '#fff4e5'; // orange clair
      el.style.color = '#663c00';      // texte orange fonc√©
      break;
    default: // info ou autre
      el.style.background = '#333';    // gris fonc√©
      el.style.color = '#fff';         // texte blanc
      break;
  }

  notificationContainer.appendChild(el);

  // Animation d'entr√©e
  requestAnimationFrame(() => {
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';
  });

  // Suppression automatique apr√®s 3 secondes
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(-10px)';
    el.addEventListener('transitionend', () => el.remove());
  }, 3000);
}
/* --- Initialisation compat Firebase (inchang√©e) --- */
const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const urlParams = new URLSearchParams(window.location.search);
const idPatient = urlParams.get('id');
if (!idPatient) {
    afficherBulle("Aucun ID patient trouv√© !", "warning");
    throw new Error("Aucun ID patient");
}

const documentList = document.getElementById('documentList');
const modal = document.getElementById('pdfModal');
const pdfViewer = document.getElementById('pdfViewer');

function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        byteArrays.push(new Uint8Array(byteNumbers));
    }
    return new Blob(byteArrays, { type: contentType });
}

function ouvrirModal(blob) {
    const url = URL.createObjectURL(blob);
    pdfViewer.src = url;
    modal.style.display = "block";
}

function fermerModal() {
    modal.style.display = "none";
    pdfViewer.src = "";
}

/* --- Fonction d'affichage des documents (corrig√©e) --- */
function afficherDocuments() {
    db.collection('documents')
      .where('patientId', '==', idPatient)
      .get()
      .then(querySnapshot => {
          if (querySnapshot.empty) {
              documentList.innerHTML = "<li>Aucun document trouv√©.</li>";
              return;
          }

          const docsArray = [];
          querySnapshot.forEach(doc => {
              docsArray.push({
                  id: doc.id,
                  ...doc.data()
              });
          });

          docsArray.sort((a, b) => {
              // robustesse : v√©rifier l'existence de dateCreation
              const aSec = a.dateCreation?.seconds || 0;
              const bSec = b.dateCreation?.seconds || 0;
              return bSec - aSec;
          });

          documentList.innerHTML = ""; // clear list avant ajout

          docsArray.forEach(data => {
              const extrait = data.contenu ? data.contenu.substring(0, 50) + "‚Ä¶" : "(pas de contenu)";
              const li = document.createElement('li');

              // construit l'html des boutons ‚Äî on utilise window.peutSupprimer
              let boutonsHTML = `<button class="btn-loupe" type="button">üîé</button>`;
              if (window.peutSupprimer) {
                  boutonsHTML += `<button class="btn-delete" type="button" data-doc-id="${data.id}">üóëÔ∏è</button>`;
              }

              li.innerHTML = `
                  <div style="display:flex; align-items:center; gap:12px;">
                    <span class="doc-type">${data.type || ""}</span>
                    <span class="doc-date">${data.dateCreation ? new Date((data.dateCreation.seconds||0)*1000).toLocaleString() : ""}</span>
                    <span class="doc-contenu">${extrait}</span>
                  </div>
                  <div style="display:flex; gap:10px;">
                      ${boutonsHTML}
                  </div>
              `;

              // √©couteurs ‚Äî ajout apr√®s innerHTML (important)
              const btnLoupe = li.querySelector('.btn-loupe');
              if (btnLoupe) {
                  btnLoupe.addEventListener('click', () => {
                      const blob = b64toBlob(data.pdfBase64, "application/pdf");
                      ouvrirModal(blob);
                  });
              }

              const btnDelete = li.querySelector('.btn-delete');
              if (btnDelete) {
                  btnDelete.addEventListener('click', (e) => {
                      const idDoc = e.currentTarget.getAttribute("data-doc-id");
                      console.log("clic supprimer doc:", idDoc);
                      ouvrirConfirmDeleteModal(idDoc);
                  });
              }

              documentList.appendChild(li);
          });
      })
      .catch(err => {
          console.error(err);
          documentList.innerHTML = "<li>Erreur lors du chargement.</li>";
      });
}

/* --- Suppression ‚Äî modales et boutons --- */
let documentToDelete = null;

function ouvrirConfirmDeleteModal(docId) {
    documentToDelete = docId;
    document.getElementById("confirmDeleteModal").style.display = "flex";
}

function fermerConfirmDeleteModal() {
    document.getElementById("confirmDeleteModal").style.display = "none";
    documentToDelete = null;
}

document.getElementById("btnCancelDelete").onclick = fermerConfirmDeleteModal;

document.getElementById("btnConfirmDelete").onclick = async function() {
    if (!documentToDelete) return;

    try {
        await db.collection("documents").doc(documentToDelete).delete();
        fermerConfirmDeleteModal();
        afficherDocuments(); // recharge la liste
        afficherBulle("Document supprim√© !", "success");
    } catch (err) {
        console.error(err);
        afficherBulle("Erreur lors de la suppression.", "error");
    }
};

document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("confirmDeleteModal").style.display = "none";
});
</script>

<script type="module">
  /* --- Module Firebase (modulaire) : on l'utilise seulement pour l'auth et la r√©cup√©ration du doc "medecins" --- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfigMod = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfigMod);
  const auth = getAuth(app);
  const fdb = getFirestore(app);

  // IMPORTANT : ne pas d√©clarer `let peutSupprimer` dans la port√©e du module.
  // On d√©finit la variable globale window.peutSupprimer pour que le script non-modulaire l'utilise.
  window.peutSupprimer = false;

  onAuthStateChanged(auth, async (user) => {
      if (!user) {
          window.location.href = "index.html";
          return;
      }

      try {
          const docRef = doc(fdb, "medecins", user.uid);
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
              const data = docSnap.data();

              // D√©finit la variable globale (accessible depuis le script non-module)
              window.peutSupprimer = !!(data.pages?.suprdocs);

              // infos m√©decin (stock√©es globalement si besoin)
              window.medecinNom = data.nom || "";
              window.medecinSpecialite = data.specialite || "";
              window.medecinLieu = data.lieu || "";

              // V√©rification d'acc√®s √† la page
              const pages = data.pages || {};
              const currentPage = window.location.pathname.split("/").pop().replace(".html", "");
              if (!pages[currentPage]) {
                  const modal = document.getElementById("modal-no-access");
                  if (modal) modal.style.display = "flex";
                  console.warn("Acc√®s refus√© √†", currentPage);
                  return;
              }

              // Appelle l'affichage apr√®s avoir d√©fini window.peutSupprimer
              afficherDocuments();

          } else {
              const modal = document.getElementById("modal-no-access");
              if (modal) modal.style.display = "flex";
              console.warn("M√©decin non trouv√©");
              return;
          }

      }   catch (error) {
          console.error("Erreur lors de la r√©cup√©ration du m√©decin :", error);
          const modal = document.getElementById("modal-no-access");
          if (modal) modal.style.display = "flex";
      }

  });
</script>


</body>
</html>
