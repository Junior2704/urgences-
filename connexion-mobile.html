<!-- accueil.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion</title>
  <link rel="icon" type="image/jpeg" href="logo.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1565c0">

  <style>
    body {
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #f4f4f4;
    }
    #loginBox {
      background:white;
      padding:25px;
      border-radius:12px;
      width:350px;
      margin:auto;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      text-align:center;
    }
    input {
      width:90%;
      padding:10px;
      margin:8px 0;
      border:1px solid #ccc;
      border-radius:8px;
    }
    button {
      background:#0078d4;
      color:white;
      border:none;
      padding:10px 20px;
      margin-top:10px;
      border-radius:8px;
      cursor:pointer;
      width:90%;
      font-size:16px;
    }
    button:hover {
      opacity: 0.85;
      transform: scale(1.05);
      transition: all 0.2s ease-in-out;
    }
    #message {
      color:red;
      margin-top:10px;
    }
  </style>

</head>
<body>

<div id="loginBox">
  <h2>ğŸ” Connexion</h2>

  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Mot de passe">
  
  <button onclick="seConnecter()">ğŸ‘¤ Se connecter</button>

  
  <div id="message"></div>
  <img src="logo.png" alt="Logo" width="200" style="margin-top:15px;">
</div>


<!-- Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js')
    .then(() => console.log("Service Worker enregistrÃ© !"));
}
</script>


<!-- SCRIPT PRINCIPAL -->
<script type="module">
/* -------------------------------------
   ğŸ”¥ Import Firebase
--------------------------------------*/
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* -------------------------------------
   âš™ï¸ Config Firebase
--------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
  authDomain: "urgences-a8ed4.firebaseapp.com",
  projectId: "urgences-a8ed4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* -------------------------------------
   ğŸ§  PERSISTENCE : rester connectÃ© !
--------------------------------------*/
await setPersistence(auth, browserLocalPersistence);

/* -------------------------------------
   ğŸš€ AUTO-CONNEXION SI DÃ‰JÃ€ AUTH
--------------------------------------*/
onAuthStateChanged(auth, async (user) => {
  if (!user) return; // â›” pas connectÃ© â†’ rester sur login

  console.log("Session dÃ©tectÃ©e â†’ vÃ©rification des droits...");

  const ref = doc(db, "medecins", user.uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) return;

  const data = snap.data();

  // ğŸ”„ Doit changer mot de passe ?
  if (data.doitChangerMDP === true) {
    window.location.href = "changer_mot_passe.html";
    return;
  }

  // ğŸ”‘ AccÃ¨s mobile
  if (data.pages && data.pages["fiche-mobile"] === true) {
    window.location.href = `fiche-mobile.html?uid=${user.uid}`;
    return;
  }

  console.log("Utilisateur connectÃ© mais pas de droits mobile.");
});

/* -------------------------------------
   ğŸ‘¤ Connexion manuelle
--------------------------------------*/
window.seConnecter = async function () {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const msg = document.getElementById("message");

  msg.textContent = "";

  try {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const user = cred.user;

    const ref = doc(db, "medecins", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      msg.textContent = "âŒ Compte introuvable dans Firestore.";
      return;
    }

    const data = snap.data();

    if (data.doitChangerMDP === true) {
      window.location.href = "changer_mot_passe.html";
      return;
    }

    if (!data.pages || data.pages["fichemobile"] !== true) {
      msg.textContent = "ğŸš« AccÃ¨s refusÃ© pour l'app mobile.";
      return;
    }

    window.location.href = `fiche-mobile.html?uid=${user.uid}`;

  } catch (e) {
    msg.textContent = "âŒ Email ou mot de passe incorrect.";
  }
};


</script>

</body>
</html>
