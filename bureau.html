<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/jpeg" href="logo.png">

<meta charset="UTF-8">
<title>Accueil ‚Äì Service des Urgences</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
:root{
  --blue:#0b5ed7;
  --green:#198754;
  --red:#dc3545;
  --bg:#f4f7fb;
  --card:#ffffff;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Segoe UI,Arial,sans-serif;
  background:var(--bg);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.card{
  background:var(--card);
  width:100%;
  max-width:460px;
  border-radius:18px;
  box-shadow:0 12px 30px rgba(0,0,0,.12);
  padding:28px;
  display:none;
}
.card.active{display:block}
h1{text-align:center}
input,select,button{
  width:100%;
  padding:12px;
  margin:8px 0 14px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{font-weight:600;cursor:pointer}
.btn-primary{background:#0b5ed7;color:white;border:none}
.btn-success{background:#198754;color:white;border:none;font-size:1.3rem}
.btn-danger{background:#dc3545;color:white;border:none}
.numero{text-align:center;font-size:4rem;font-weight:800;color:#dc3545}
.status{text-align:center;font-weight:600;min-height:24px}
.ok{color:#198754}
.err{color:#dc3545}
.footer{text-align:center;font-size:.85rem;color:#667;margin-top:10px}
#infosPatient div{
  font-size:1.05rem;
  margin-top:4px;
  font-weight:500;
  color:#0b2240;
}
/* Overlay */
.modal-overlay {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content:center;
  align-items:center;
  z-index: 1000;
}

/* Contenu modale */
.modal-content {
  background: #fff;
  padding: 24px;
  border-radius: 16px;
  max-width: 450px;
  width: 90%;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  font-family: Inter, sans-serif;
}

.modal-content h2 {
  text-align: center;
  margin-bottom: 16px;
}

.filter-section h3 {
  margin-bottom: 8px;
}

/* Grid des cases */
.checkbox-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

/* Style des cases comme boutons */
.checkbox-card {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
}

.checkbox-card input {
  margin-right: 8px;
}

.checkbox-card:hover {
  background-color: #f0f4ff;
  border-color: #0b5ed7;
}

.checkbox-card input:checked + span {
  font-weight: 600;
  color: #0b5ed7;
}

/* Boutons modale */
.modal-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 18px;
}

.modal-buttons .btn-danger {
  flex: 1;
  margin-right: 8px;
}

.modal-buttons .btn-success {
  flex: 1;
  margin-left: 8px;
  font-size: 1.1rem;
}



</style>
</head>

<body>

<!-- LOGIN -->
<div class="card active" id="cardLogin">
  <h1>üîê Connexion accueil</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Mot de passe">
  <select id="bureauSelect"></select>
  <button class="btn-primary" onclick="connexion()">Se connecter</button>
  <div class="status err" id="loginStatus"></div>
</div>

<!-- POSTE -->
<div class="card" id="cardAccueil">
  <h1>üßæ Poste d‚Äôaccueil</h1>
  <div class="numero" id="numeroAffiche">‚Äî</div>
  

<div id="infosPatient" style="text-align:center; margin-bottom:14px; display:none">
  <div id="infoMotif"></div>
  <div id="infoCircuit"></div>
  <div id="infoAttente"></div>
</div>
  <button class="btn-success" onclick="appelerTicket()">üì£ Appeler le ticket suivant</button>
  <div class="status" id="appelStatus"></div>

<button style="margin-top:10px;" onclick="openParams()">‚öôÔ∏è Param√®tres</button>

  <button class="btn-danger" onclick="deconnexion()">D√©connexion</button>
  <div class="footer">
    <strong id="bureauLabel"></strong> ‚Äî
    <span id="agentEmail"></span>
  </div>
</div>
<!-- MODALE PARAMETRES -->
<div id="modalParams" style="display:none;">
  <div class="modal-overlay">
    <div class="modal-content">
      <h2>‚öôÔ∏è Param√®tres d‚Äôaffichage</h2>
      
      <div class="filter-section">
        <h3>Motifs :</h3>
        <div class="checkbox-grid">
          <label class="checkbox-card"><input type="checkbox" value="Consultation" class="filterMotif"><span>Consultation</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Administratif" class="filterMotif"><span>Administratif</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Traumatologie" class="filterMotif"><span>Traumatologie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="P√©diatrie" class="filterMotif"><span>P√©diatrie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Sortie" class="filterMotif"><span>Sortie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Gyn√©cologie" class="filterMotif"><span>Gyn√©cologie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Ophtalmologie" class="filterMotif"><span>Ophtalmologie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Psychiatrie" class="filterMotif"><span>Psychiatrie</span></label>
          <label class="checkbox-card"><input type="checkbox" value="Autres" class="filterMotif"><span>Autres</span></label>
        </div>
      </div>
      
      <div class="modal-buttons">
        <button class="btn-danger" onclick="closeParams()">Annuler</button>
        <button class="btn-success" onclick="applyParams()">Appliquer</button>
      </div>
    </div>
  </div>
</div>


<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
  authDomain: "urgences-a8ed4.firebaseapp.com",
  projectId: "urgences-a8ed4"
});

const auth = firebase.auth();
const db = firebase.firestore();

let bureauActuel = null;

// ================= DOM =================
const emailInput   = document.getElementById("email");
const passwordInput = document.getElementById("password");
const bureauSelect  = document.getElementById("bureauSelect");

const loginStatus   = document.getElementById("loginStatus");
const appelStatus   = document.getElementById("appelStatus");

const numeroAffiche = document.getElementById("numeroAffiche");
const bureauLabel   = document.getElementById("bureauLabel");
const agentEmail    = document.getElementById("agentEmail");
const infosPatient = document.getElementById("infosPatient");
const infoMotif   = document.getElementById("infoMotif");
const infoCircuit = document.getElementById("infoCircuit");
const infoAttente = document.getElementById("infoAttente");

// ================= UTILS =================
function showLogin(){
  document.getElementById("cardLogin").classList.add("active");
  document.getElementById("cardAccueil").classList.remove("active");
}

function showAccueil(){
  document.getElementById("cardLogin").classList.remove("active");
  document.getElementById("cardAccueil").classList.add("active");
}

// ================= CHARGER BUREAUX =================
function initBureauxListener(){
  db.collection("r√©f√©rentiels")
    .doc("bureau")
    .onSnapshot(docSnap=>{
      bureauSelect.innerHTML = "";
      if(!docSnap.exists) return;

      const data = docSnap.data();

      for(const bureauId in data){
        const bureau = data[bureauId];

        // ‚úÖ ignorer "general" et tout champ non-bureau
        if(
          !bureau ||
          typeof bureau !== "object" ||
          bureau.connecte === undefined
        ) continue;

        const opt = document.createElement("option");
        opt.value = bureauId;
        opt.textContent = bureauId + (bureau.connecte ? " üîí" : "");
        bureauSelect.appendChild(opt);
      }
    });
}



// ================= CONNEXION =================
async function connexion(){
  try{
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    const bureauId = bureauSelect.value;

    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const ref = db.collection("r√©f√©rentiels").doc("bureau");

await db.runTransaction(async tx => {
  const snap = await tx.get(ref);
  if (!snap.exists) throw "R√©f√©rentiel bureaux introuvable";

  const data = snap.data();
  const b = data[bureauId];

  if (!b) throw "Bureau inexistant";

  if (b.connecte && b.agentUid !== cred.user.uid)
    throw "Bureau d√©j√† occup√©";

  tx.update(ref, {
    [`${bureauId}.connecte`]: true,
    [`${bureauId}.agentUid`]: cred.user.uid,
    [`${bureauId}.agentEmail`]: cred.user.email,
    [`${bureauId}.connexionAt`]: firebase.firestore.FieldValue.serverTimestamp()
  });
});


    bureauActuel = bureauId;
    bureauLabel.innerText = bureauId;
    agentEmail.innerText = email;
    showAccueil();

  }catch(e){
    loginStatus.innerText = e;
  }
}

// ================= APPEL =================
async function appelerTicket(){
  const snap = await db.collection("accueil-1")
    .where("statut","==","attente")
    .orderBy("dateArriveeClient")
    .limit(1)
    .get();

  if(snap.empty){
    afficher("Aucun patient en attente",false);
    return;
  }

  const doc = snap.docs[0];

  const anciens = await db.collection("accueil-1")
    .where("statut","==","appele")
    .where("bureau","==",bureauActuel)
    .get();

  anciens.forEach(d=>d.ref.update({statut:"termine"}));
const data = doc.data();

const motif = data.motif || "";
const circuit = data.circuit || "";
const dateArrivee = data.dateArrivee || null;
const dateArriveeClient = data.dateArriveeClient || null;

await doc.ref.update({
  statut: "appele",
  bureau: bureauActuel,
  dateAppel: firebase.firestore.FieldValue.serverTimestamp(),
  afficheDepuis: firebase.firestore.FieldValue.serverTimestamp(),

  motif: motif,
  circuit: circuit,
  dateArriveeClient: dateArrivee
});


  numeroAffiche.innerText = "N¬∞ "+doc.data().numero;
  // üîπ affichage infos agent d'accueil
infosPatient.style.display = "block";

infoMotif.innerText =
  motif ? "üìù Motif : " + motif : "üìù Motif : ‚Äî";

infoCircuit.innerText =
  circuit ? "üß≠ Circuit : " + circuit : "üß≠ Circuit : ‚Äî";

// ‚è±Ô∏è dur√©e d'attente
let attenteMs = null;

if (dateArriveeClient !== undefined && dateArriveeClient !== null) {
  if (typeof dateArriveeClient === "number") {
    // timestamp en ms
    attenteMs = Date.now() - dateArriveeClient;
  } else if (typeof dateArriveeClient.toMillis === "function") {
    // Firestore Timestamp
    attenteMs = Date.now() - dateArriveeClient.toMillis();
  } else {
    // Date ou string
    attenteMs = Date.now() - new Date(dateArriveeClient).getTime();
  }
}

infoAttente.innerText = attenteMs !== null ? "‚è±Ô∏è Attente : " + formatDuree(attenteMs) : "‚è±Ô∏è Attente : ‚Äî";



  afficher("Ticket appel√©",true);
}

function afficher(msg,ok){
  appelStatus.innerText = msg;
  appelStatus.className = "status " + (ok?"ok":"err");
}

// ================= DECONNEXION =================
async function deconnexion(){
  if(bureauActuel){
   const ref = db.collection("r√©f√©rentiels").doc("bureau");
await ref.update({
  [`${bureauActuel}.connecte`]: false,
  [`${bureauActuel}.agentUid`]: null,
  [`${bureauActuel}.agentEmail`]: null,
  [`${bureauActuel}.connexionAt`]: null
});

  }
  estConnecte = false; 
  await auth.signOut();
  
}
let estConnecte = false;

auth.onAuthStateChanged(user => {
  if (user) {
    estConnecte = true;
  } else {
    estConnecte = false;
  }
});
window.addEventListener("beforeunload", (e) => {
  if (estConnecte) {
    e.preventDefault();
    e.returnValue = "‚ö†Ô∏è Veuillez vous d√©connecter avant de fermer cette fen√™tre.";
    return e.returnValue;
  }
});

// ================= SESSION =================
auth.onAuthStateChanged(user=>{
  if(!user){
    showLogin();
    initBureauxListener();
    return;
  }

  db.collection("r√©f√©rentiels").doc("bureau").collection("bureaux")
    .where("agentUid","==",user.uid)
    .get()
    .then(snapshot=>{
      if(!snapshot.empty){
        const doc = snapshot.docs[0];
        bureauActuel = doc.id;
        bureauLabel.innerText = doc.data().agentEmail ? doc.id : "";
        agentEmail.innerText = user.email;
        showAccueil();
      }else{
        showLogin();
        initBureauxListener();
      }
    });
});
function formatDuree(ms) {
  const min = Math.floor(ms / 60000);
  if (min < 1) return "moins d‚Äô1 min";
  if (min < 60) return `${min} min`;
  const h = Math.floor(min / 60);
  const r = min % 60;
  return r ? `${h}h ${r}min` : `${h}h`;
}
// ================= PARAMETRES =================
let filterMotifs = new Set();
let filterCircuits = new Set();

function openParams(){
  document.getElementById("modalParams").style.display = "flex";
  
  // cocher les cases selon l'√©tat actuel
  document.querySelectorAll(".filterMotif").forEach(cb=>{
    cb.checked = filterMotifs.has(cb.value);
  });
  document.querySelectorAll(".filterCircuit").forEach(cb=>{
    cb.checked = filterCircuits.has(cb.value);
  });
}

function closeParams(){
  document.getElementById("modalParams").style.display = "none";
}

function applyParams(){
  filterMotifs.clear();
  filterCircuits.clear();
  
  document.querySelectorAll(".filterMotif:checked").forEach(cb=>filterMotifs.add(cb.value));
  document.querySelectorAll(".filterCircuit:checked").forEach(cb=>filterCircuits.add(cb.value));
  
  closeParams();
}

// ================= FILTRAGE DANS APPELER TICKET =================
async function appelerTicket(){
  const snap = await db.collection("accueil-1")
    .where("statut","==","attente")
    .orderBy("dateArriveeClient")
    .get(); // on prend tous les tickets en attente

  if(snap.empty){
    afficher("Aucun patient en attente",false);
    return;
  }

  // Filtrer selon param√®tres
  let doc = null;
  for(const d of snap.docs){
    const data = d.data();
    const motif = data.motif || "";
    const circuit = data.circuit || "";
    
    const motifOk = filterMotifs.size === 0 || filterMotifs.has(motif);
    const circuitOk = filterCircuits.size === 0 || filterCircuits.has(circuit);
    
    if(motifOk && circuitOk){
      doc = d;
      break;
    }
  }

  if(!doc){
    afficher("Aucun patient correspondant aux filtres", false);
    return;
  }

  // Suite de l'appel du ticket (inchang√©)
  const anciens = await db.collection("accueil-1")
    .where("statut","==","appele")
    .where("bureau","==",bureauActuel)
    .get();
  anciens.forEach(d=>d.ref.update({statut:"termine"}));

  const data = doc.data();
  await doc.ref.update({
    statut: "appele",
    bureau: bureauActuel,
    dateAppel: firebase.firestore.FieldValue.serverTimestamp(),
    afficheDepuis: firebase.firestore.FieldValue.serverTimestamp(),
    motif: data.motif,
    circuit: data.circuit,
    dateArriveeClient: data.dateArrivee
  });

  numeroAffiche.innerText = "N¬∞ "+data.numero;
  infosPatient.style.display = "block";
  infoMotif.innerText = data.motif ? "üìù Motif : " + data.motif : "üìù Motif : ‚Äî";
  infoCircuit.innerText = data.circuit ? "üß≠ Circuit : " + data.circuit : "üß≠ Circuit : ‚Äî";

  let attenteMs = null;
  const dateArriveeClient = data.dateArriveeClient;
  if(dateArriveeClient){
    if(typeof dateArriveeClient.toMillis === "function") attenteMs = Date.now() - dateArriveeClient.toMillis();
    else attenteMs = Date.now() - new Date(dateArriveeClient).getTime();
  }
  infoAttente.innerText = attenteMs !== null ? "‚è±Ô∏è Attente : " + formatDuree(attenteMs) : "‚è±Ô∏è Attente : ‚Äî";

  afficher("Ticket appel√©",true);
}


// ================= INITIALISATION =================
initBureauxListener();
</script>

</body>
</html>
