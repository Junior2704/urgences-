<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patients</title>
<link rel="icon" type="image/jpeg" href="logo.png">
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: "Segoe UI", Tahoma, sans-serif;
  background-color: #f4f6f8;
  margin: 0;
  padding: 40px 20px;
}

h1 {
  color: #0078d4;
  text-align: center;
  margin-bottom: 30px;
}

/* üîç Barre de recherche centr√©e */
.search-container {
  display: flex;
  justify-content: center;
  margin-bottom: 25px;
}

.search-container input {
  width: 60%;
  padding: 12px 18px;
  border-radius: 8px;
  border: 2px solid #0078d4;
  font-size: 16px;
  outline: none;
  transition: box-shadow 0.3s;
}
.search-container input:focus {
  box-shadow: 0 0 8px rgba(0,120,212,0.3);
}

/* üìã Liste des patients */
#listePatients {
  max-width: 700px;
  margin: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 0;
  overflow: hidden;
}

#listePatients li {
  list-style: none;
  padding: 15px 20px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}
#listePatients li:hover {
  background: #e9f3fc;
}
#listePatients li strong {
  color: #0078d4;
}

/* ü™ü Modale patient */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}



.modal h3 {
  color: #0078d4;
  margin-top: 0;
}
label {
  font-weight: 600;
  margin-top: 10px;
  display: block;
}
input, textarea, select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

/* üìú Historique d√©taill√© identique √† fiche.html */
#hospitalisationsContent {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
#hospitalisationsContent .card {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  border-left: 8px solid #0078d4;
}
#hospitalisationsContent h2 {
  color: #0078d4;
  border-bottom: 3px solid #0078d4;
  padding-bottom: 5px;
  margin-top: 0;
  margin-bottom: 15px;
}
#hospitalisationsContent h3 {
  color: #0078d4;
  margin-top: 10px;
  margin-bottom: 8px;
}
#hospitalisationsContent p {
  margin: 5px 0;
  line-height: 1.5;
  white-space: pre-wrap;
  color: #333;
}
#hospitalisationsContent .entry {
  border-left: 4px solid #0078d4;
  padding-left: 10px;
  margin-bottom: 10px;
  font-size: 14px;
}

button {
  all: unset;
  display: inline-block;
  padding: 10px 16px;
  border-radius: 8px;
  background-color: #0078d4;
  color: white;
  cursor: pointer;
  font-weight: 500;
  margin-top: 15px;
}
button:hover { background-color: #005ea2; }
button.secondary { background-color: #6c757d; }
button.secondary:hover { background-color: #5a6268; }


.modal {
  position: relative; /* permet de positionner les √©l√©ments internes */
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

/* ‚ùå Bouton de fermeture ‚Äî en haut √† droite */
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px; /* ‚úÖ c‚Äôest cette ligne qui le met √† droite */
  left: auto !important; /* au cas o√π une r√®gle pr√©c√©dente l'aurait plac√© √† gauche */
  background: none;
  border: none;
  font-size: 22px;
  color: #666;
  cursor: pointer;
  transition: color 0.2s, transform 0.1s;
}
.close-btn:hover {
  color: #0078d4;
  transform: scale(1.2);
}

footer {
  margin-top: auto;
  padding: 15px;
  text-align: center;
  color: #777;
  font-size: 0.9rem;
}
.topbar {
  position: sticky;
  top: 0;
  z-index: 9999;
  background: #ffffff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  margin-bottom: 15px;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  font-weight: 700;
  font-size: 1.1rem;
  color: #005ea2;
}

.tabs {
  display: flex;
  gap: 8px;
}

.tab {
  background: transparent;
  color: #005ea2;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.tab.active,
.tab:hover {
  background: #e6f0fc;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.icon-btn {
  background: #f0f4f8;
  color: #333;
  border: none;
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 1.1rem;
  cursor: pointer;
}

.icon-btn:hover {
  background: #dbe9ff;
}

/* üîΩ Menu hover */
.hover-menu {
  position: relative;
}

.hover-panel {
  position: absolute;
  top: 120%;
  right: 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  min-width: 180px;
  overflow: hidden;
}

.hover-panel button {
  background: none;
  border: none;
  padding: 10px 14px;
  text-align: left;
  cursor: pointer;
}

.hover-panel button:hover {
  background: #f0f8ff;
}

.hover-menu:hover .hover-panel {
  display: flex;
}
/* üîß Correctif lisibilit√© topbar */
.topbar button,
.topbar .tab,
.topbar .icon-btn {
  color: #1f2937; /* gris fonc√© lisible */
}
.hover-panel button {
  color: #1f2937;
  background: white;
}

.hover-panel button:hover {
  background: #e6f0fc;
  color: #005ea2;
}
.tab.active {
  background: #0078d4;
  color: white;
}
.menu-wrapper {
  position: relative;
}

.menu-panel {
  position: absolute;
  top: 120%;
  right: 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  min-width: 180px;
  z-index: 9999;
  overflow: hidden;
}

.menu-panel button {
  background: none;
  border: none;
  padding: 10px 14px;
  text-align: left;
  cursor: pointer;
  color: #1f2937;
}

.menu-panel button:hover {
  background: #e6f0fc;
  color: #005ea2;
}

/* √©tat ouvert */
.menu-wrapper.open .menu-panel {
  display: flex;
}
.search-wrapper {
  position: relative;
}

.search-results {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  width: 100%;
  max-height: 320px;
  overflow-y: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
  z-index: 10000;
}

.search-results.hidden {
  display: none;
}

.resultat-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.resultat-item:hover {
  background: #e6f0fc;
}

.topbar,
.search-container {
  position: relative;
}
#recherchePatient {
  display: none;
}
 body  {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 20px;
      background: #f0f4f8;
      color: #222;
    }
</style>
</head>

<body>

<div id="mainContent">



<ul id="listePatients"></ul>

<!-- ü™ü Modale patient -->
<div class="modal-overlay" id="modalPatient">
  <div class="modal">
  <button class="close-btn" id="closeModalBtn">‚úñ</button>

    <h3>üë§ Informations administratives</h3>
    <input type="hidden" id="modalId">

    <label>Nom</label><input id="modalNom" type="text">
    <label>Pr√©nom</label><input id="modalPrenom" type="text">
    <label>Sexe</label>
    <select id="modalSexe">
      <option value="">--</option>
      <option value="M">M</option>
      <option value="Mme">Mme</option>
      <option value="L'enfant">L'enfant</option>
    </select>
    <label>Date de naissance</label><input id="modalNaissance" type="date">
    <label>Adresse</label><input id="modalAdresse" type="text">
    <label>T√©l√©phone</label><input id="modalTelephone" type="text">
    <label>Email</label><input id="modalEmail" type="text">
<div style="text-align:right;">
  
      <button id="btnEnregistrer">üíæ Enregistrer</button>
    </div>

	<br>
  <button id="btnVersFiche">üìÑ Ordonnancier</button>
	<br>
  <button id="btnVersExs">üìÑ Prescripteur d'examens</button>
	<br>
  <button id="btnVersSynthese">üìÑ Certificat m√©dical</button>
	<br>
  <button id="btnVersFiches">üìÑ Fiches Conseils</button>
	<br>
  <button id="btnVersPdf">üìÑ Cr√©ation d'acc√®s PDF patient</button>
<br>
  <button id="btnVersEti">üìÑ Etiquettes patient</button>
  <br>
<button id="btnmailto">üìß Mailto - patient</button>
 <br><br>
    <h3>üìú Historique des hospitalisations</h3>
    <div id="hospitalisationsContent"></div>

    
  </div>
</div>
</div>
<footer> ¬© 2025 ‚Äî GestUrg2 | Patients  </footer>
<script>
// === CONFIG FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
  authDomain: "urgences-a8ed4.firebaseapp.com",
  projectId: "urgences-a8ed4",
  storageBucket: "urgences-a8ed4.appspot.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// === VARIABLES ===
const liste = document.getElementById("listePatients");
const searchInput = document.getElementById("searchInput");
let patients = [];

// === CHARGEMENT ===
async function chargerPatients() {
  const snap = await db.collection("patients").orderBy("nom").get();
  patients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  afficherPatients(patients);
}

function afficherPatients(data) {
  liste.innerHTML = "";
  if (data.length === 0) {
    liste.innerHTML = "<li>Aucun patient trouv√©.</li>";
    return;
  }
 data.forEach(p => {
  const li = document.createElement("li");

  li.innerHTML = `
    <strong>${p.nom || "?"} ${p.prenom || ""}</strong><br>
    Sexe : ${p.sexe || "-"} &nbsp; | &nbsp; üìÖ ${p.dateNaissance || "?"}
  `;

  li.ondblclick = () => {
    window.location.href = `fiche-patient.html?id=${p.id}`;
  };

  liste.appendChild(li);
});

}

document.getElementById("btnVersFiche").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `Ordonnancier.html?id=${patientId}`;
});

document.getElementById("btnVersExs").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `prescriptionexamens.html?id=${patientId}`;
});

document.getElementById("btnVersSynthese").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `Certificatmedical.html?id=${patientId}`;
});

document.getElementById("btnVersFiches").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `fichesconseil.html?id=${patientId}`;
});

document.getElementById("btnVersPdf").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `uploadpdf.html?id=${patientId}`;
});

document.getElementById("btnVersEti").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `etiquettes.html?id=${patientId}`;
});

document.getElementById("btnmailto").addEventListener("click", () => {
    const patientId = document.getElementById("modalId").value;
    window.location.href = `mailto.html?id=${patientId}`;
});

  

document.getElementById("closeModalBtn").onclick = () => modal.style.display = "none";

// === MODALE ===
const modal = document.getElementById("modalPatient");

async function ouvrirModale(id) {
  const doc = await db.collection("patients").doc(id).get();
  if (!doc.exists) return alert("Patient introuvable");
  const data = doc.data();

  document.getElementById("modalId").value = id;
  document.getElementById("modalNom").value = data.nom || "";
  document.getElementById("modalPrenom").value = data.prenom || "";
  document.getElementById("modalSexe").value = data.sexe || "";
  document.getElementById("modalNaissance").value = data.dateNaissance || "";
  document.getElementById("modalAdresse").value = data.adresse || "";
  document.getElementById("modalTelephone").value = data.telephone || "";
  document.getElementById("modalEmail").value = data.email || "";

  await chargerHistoriqueComplet(id);
  modal.style.display = "flex";
}


document.getElementById("btnEnregistrer").onclick = async () => {
  const id = document.getElementById("modalId").value;
  const maj = {
    nom: document.getElementById("modalNom").value.trim(),
    prenom: document.getElementById("modalPrenom").value.trim(),
    sexe: document.getElementById("modalSexe").value,
    dateNaissance: document.getElementById("modalNaissance").value,
    adresse: document.getElementById("modalAdresse").value.trim(),
    telephone: document.getElementById("modalTelephone").value.trim(),
    email: document.getElementById("modalEmail").value.trim(),
  };
  await db.collection("patients").doc(id).update(maj);
  alert("‚úÖ Donn√©es mises √† jour !");
  modal.style.display = "none";
  chargerPatients();
};

// === HISTORIQUE (identique √† fiche.html) ===
async function chargerHistoriqueComplet(patientId) {
  const contenu = document.getElementById("hospitalisationsContent");
  contenu.innerHTML = "<p>‚è≥ Chargement...</p>";

  try {
    const patientDoc = await db.collection("patients").doc(patientId).get();
    if (!patientDoc.exists) {
      contenu.innerHTML = "<p>‚ùå Patient introuvable</p>";
      return;
    }

    const data = patientDoc.data();
    let hospitalisations = Array.isArray(data.hospitalisations) ? data.hospitalisations : [];

    if (hospitalisations.length > 1) {
      hospitalisations = hospitalisations.slice(0, -1);
    } else {
      hospitalisations = [];
    }

    if (hospitalisations.length === 0) {
      contenu.innerHTML = "<p>Aucune hospitalisation ant√©rieure.</p>";
      return;
    }

    contenu.innerHTML = "";

    hospitalisations.slice().reverse().forEach((hospi, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      const numero = hospitalisations.length - idx;

      const titre = document.createElement("h2");
      titre.textContent = `üè• Hospitalisation n¬∞${numero}`;
      card.appendChild(titre);

      const date = hospi.dateDebut || "Date inconnue";
      const datef = hospi.dateFin || "Date inconnue";
      const motif = hospi.motif || "‚Äî";
      const gravite = hospi.gravite || "‚Äî";
      const evolution = hospi.evolution || "Aucune √©volution enregistr√©e.";
      const dossier = hospi.dossierMedical || {};
      const sortie = hospi.sortie || null;
      const rapport = hospi.rapport || "Pas de rapport d'hospitalisation valid√©";

      const html = [];
      html.push(`<div class="entry"><strong>üìÖ Admission :</strong> ${date}</div>`);
      html.push(`<div class="entry"><strong>üìÖ Sortie :</strong> ${datef}</div>`);
      html.push(`<div class="entry"><strong>Motif :</strong> ${motif}</div>`);
      html.push(`<div class="entry"><strong>Gravit√© :</strong> ${gravite}</div>`);
      html.push(`<hr>`);
      html.push(`<h3>üìã Dossier m√©dical</h3>`);
      html.push(`<p><strong>Questionnaire IAO :</strong><br>${dossier.questionnaire || "‚Äî"}</p>`);
      html.push(`<p><strong>Ant√©c√©dents :</strong><br>${dossier.antecedents || "‚Äî"}</p>`);
      html.push(`<p><strong>Traitements :</strong><br>${dossier.traitements || "‚Äî"}</p>`);
      html.push(`<p><strong>Histoire de la maladie :</strong><br>${dossier.histoire || "‚Äî"}</p>`);
      html.push(`<p><strong>CR Auscultation :</strong><br>${dossier.auscultation || "‚Äî"}</p>`);
      html.push(`<hr>`);
      html.push(`<h3>üìà √âvolution aux urgences</h3>`);
      html.push(`<p>${evolution}</p>`);

      if (sortie) {
        html.push(`<hr><h3>üö™ Sortie</h3>`);
        html.push(`<p><strong>Type :</strong> ${sortie.type || "‚Äî"}</p>`);
        if (sortie.serviceHospitalisation)
          html.push(`<p><strong>üè• Service hospitalisation :</strong> ${sortie.serviceHospitalisation}</p>`);
        if (sortie.destinationTransfert)
          html.push(`<p><strong>‚ÜîÔ∏è Destination transfert :</strong> ${sortie.destinationTransfert}</p>`);
        if (sortie.avisSpecialiste)
          html.push(`<p><strong>üë©‚Äç‚öïÔ∏è Avis sp√©cialiste :</strong> ${sortie.avisSpecialiste}</p>`);
        if (Array.isArray(sortie.options) && sortie.options.length > 0)
          html.push(`<p><strong>üìã Options :</strong> ${sortie.options.join(", ")}</p>`);
        if (sortie.traitementSortie)
          html.push(`<p><strong>üíä Traitement de sortie :</strong><br>${sortie.traitementSortie}</p>`);
        if (sortie.autreSortieTexte)
          html.push(`<p><strong>üî§ Autre :</strong> ${sortie.autreSortieTexte}</p>`);
        if (sortie.autreOptionTexte)
          html.push(`<p><strong>üî§ Autre option :</strong> ${sortie.autreOptionTexte}</p>`);
      }

      html.push(`<p>${rapport}</p>`);
      card.innerHTML += html.join("\n");
      contenu.appendChild(card);
    });
  } catch (err) {
    console.error("Erreur chargement historique :", err);
    contenu.innerHTML = "<p>‚ùå Erreur lors du chargement de l'historique.</p>";
  }
}
const toggleSearch = document.getElementById("toggleSearch");
const rechercheInput = document.getElementById("recherchePatient");

toggleSearch.addEventListener("click", () => {
  rechercheInput.style.display =
    rechercheInput.style.display === "block" ? "none" : "block";
  rechercheInput.focus();
});
rechercheInput.addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  const resultats = patients.filter(p =>
    (p.nom && p.nom.toLowerCase().includes(val)) ||
    (p.prenom && p.prenom.toLowerCase().includes(val))
  );
  afficherPatients(resultats);
});
document.querySelectorAll(".menu-toggle").forEach(btn => {
  btn.addEventListener("click", e => {
    e.stopPropagation();
    btn.parentElement.classList.toggle("open");
  });
});

document.addEventListener("click", () => {
  document.querySelectorAll(".menu-wrapper").forEach(m => m.classList.remove("open"));
});

// Init
chargerPatients();
</script>
</body>
</html>
