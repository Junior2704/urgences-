<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="icon" type="image/jpeg" href="logo.jpg">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche Patient</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <style>
	  .tabs {
  display: flex;
  border-bottom: 2px solid #ccc;
  margin-bottom: 15px;
}
.tablink {
  background: #f5f5f5;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  font-weight: bold;
  transition: background 0.3s;
}
.tablink:hover {
  background: #e0e0e0;
}
.tablink.active {
  background: #0078d4;
  color: white;
}
.tab-content {
  display: none;
}

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
	.bouton-horloge {
  all: unset;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  margin-left: 5px;
  color: #555;
}
.bouton-horloge:hover,
.bouton-horloge:focus {
  outline: none;
  box-shadow: none;
  background-color: transparent; 
}

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h2 {
      margin: 0;
      color: #0078d4;
    }
    button, select, input[type="text"], input[type="number"] {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s ease;
    }
    button {
      background-color: #0078d4;
      color: white;
      cursor: pointer;
      border: none;
      margin-right: 10px;
    }
    button:hover {
      background-color: #005ea2;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 25px;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    .field-group {
      margin-bottom: 15px;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .inline-fields > div {
      flex: 1;
      min-width: 150px;
    }
    .corps {
      max-width: 320px;
      margin-top: 10px;
      position: relative;
      user-select: none;
    }
    #corps-img {
      width: 100%;
      border-radius: 12px;
      cursor: crosshair;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .annotation {
      position: absolute;
      background: #0078d4cc;
      color: white;
      padding: 3px 6px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      user-select: none;
      transform: translate(-50%, -120%);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    #historique {
      max-width: 600px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 15px;
      max-height: 250px;
      overflow: visible;
    }
    .entry {
      border-left: 4px solid #0078d4;
      padding-left: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      color: #444;
    }
    .entry strong {
      display: block;
      font-weight: 700;
      margin-bottom: 3px;
      color: #0078d4;
    }
    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.35);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
  background: white;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;         /* Limite la hauteur à 90% de la fenêtre */
  overflow-y: auto;         /* Affiche un ascenseur vertical si besoin */
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
}

    .modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #0078d4;
    }
    .modal label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .modal input[type="text"], .modal select, .modal textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
    }
    .modal textarea {
      min-height: 80px;
    }
    .modal-buttons {
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 10px;
      min-width: 90px;
    }
button {
  all: unset;
  display: inline-block;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  min-width: 120px;
  text-align: center;
  font-weight: 500;
  background-color: #0078d4;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Boutons secondaires */
button.secondary {
  background-color: #6c757d;
}

button.secondary:hover {
  background-color: #5a6268;
}

/* Boutons de validation */
button.success {
  background-color: #28a745;
}

button.success:hover {
  background-color: #218838;
}

/* Boutons d’alerte / suppression */
button.danger {
  background-color: #dc3545;
}

button.danger:hover {
  background-color: #c82333;
}
#closeRawData {
  font-size: 20px;
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  color: #c62828;
  cursor: pointer;
  line-height: 1;
  box-shadow: none;
  outline: none;
}


#closeRawData:hover,
#closeRawData:focus,
#closeRawData:active {
  background: transparent !important;
  color: #c62828 !important;
  transform: none !important;
  box-shadow: none !important;
}


/* Pour groupes de boutons côte à côte */
.button-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.inline-fields {
  display: flex;
  gap: 20px; /* espace entre les champs */
  flex-wrap: wrap; /* pour que ça passe à la ligne si trop étroit */
}

.field-group {
  display: flex;
  flex-direction: column;
  min-width: 150px; /* largeur mini des champs */
}
.bouton-supprimer {
  background-color: #e0e0e0;
  color: #555;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  margin-left: 4px;
}
.bouton-supprimer:hover {
  background-color: #ccc;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100vh;

}

body {
  display: block;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

main {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  overflow: auto;
  flex: 1;
  justify-content: flex-start;
  align-content: flex-start;
}

.card {
  flex: 1 1 300px;
  max-height: 300px;
  overflow: auto;
  box-sizing: border-box;
  padding: 10px;
  margin: 0;
}
#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}

.exam-button {
  background-color: #007BFF;
  color: white;
  padding: 12px;
  width: 100%;
  border: none;
  border-radius: 6px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 16px;
}
.exam-button:hover {
  background-color: #0056b3;
}
.sub-list {
  display: none;
  margin-top: 10px;
  padding-left: 10px;
}
.sub-list label {
  display: block;
  margin: 5px 0;
  cursor: pointer;
}
.prescription-item {
  background: #eef;
  padding: 10px;
  margin: 5px 0;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
}
.btn-delete {
  background-color: red;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 5px 10px;
  cursor: pointer;
}

/* Modale Gestion Administrative plein écran */
#modalAdmin.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

#modalAdmin .modal {
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.btn-admin {
  background-color: #5cb85c; 
  color: white;
  border: none;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.btn-admin:hover {
  background-color: #218838;
  transform: translateY(-1px);
}
#modalCloture.modal-overlay {
  z-index: 3000; /* plus haut que #modalAdmin */
}
#modalActe.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 3000;
  display: none;
  justify-content: center;
  align-items: center;
}

#modalActe .modal {
  width: 95%;
  max-width: none;
  max-height: 95vh;
  height: 95vh;
  overflow-y: auto;
  border-radius: 12px;
  background: white;
  padding: 25px;
}
#loadingOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  flex-direction: column;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  font-size: 1.2rem;
  pointer-events: all;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}
#dossierMedical {
  max-height: 300px;
  overflow-y: auto;
}

#dossierMedical .contenu-dossier-medical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
#dossierMedical textarea {
  resize: vertical;
  min-height: 60px;
}
#evolutionTexte {
width: 100%;
  box-sizing: border-box;
  min-height: 500px;
  resize: vertical;
}
input[type="text"],
input[type="date"],
select {
  width: 100%;
  padding: 8px 12px;
  margin: 6px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
  font-size: 16px;
  font-family: inherit;
  appearance: none; /* pour uniformiser certains navigateurs */
  background-color: #fff;
}

input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.5); /* optionnel : améliore l'intégration dans les thèmes clairs/foncés */
}

label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #f5f5f5; /* optionnel, pour une meilleure lisibilité */
  border-bottom: 1px solid #ccc;
}

.left-header h2 {
  margin: 0;
}

.right-header {
  font-size: 0.9em;
  color: #333;
}
.tabs {
  display: flex;
  overflow-x: auto;
  border-bottom: 2px solid #ccc;
  background: #f5f5f5;
}
.tablink {
  flex-shrink: 0;
  background: transparent;
  border: none;
  padding: 14px 24px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1rem;
  transition: background 0.3s;
}
.tablink:hover {
  background: #e0e0e0;
}
.tablink.active {
  background: #0078d4;
  color: white;
}
.tab-content {
  display: none;
  padding: 20px;
  background: white;
  border-radius: 0 0 12px 12px;
  margin-top: 0;
  min-height: calc(100vh - 120px); /* occupe l’espace sous la barre */
  box-sizing: border-box;
}
.tab-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.tab-header h3 {
  margin: 0;
  font-size: 1.4rem;
  color: #0078d4;
}
.close-tab {
  background: transparent;
  border: none;
  font-size: 1.6rem;
  color: #c0392b;
  cursor: pointer;
}
.close-tab:hover {
  color: #e74c3c;
}


  </style>
</head>
<body>

<div id="loadingOverlay">
<div>Chargement du patient en cours...</div>
  <div class="spinner"></div>
  
</div>

<header>
  <div class="left-header">
    <h2>Fiche Patient</h2>
  </div>
  <div class="right-header">
    Connecté en tant que <b><span id="nom-medecin"></span></b> (<span id="specialite"></span>)
  </div>
</header>

<main>
<div id="contenu"></div>
<div class="tabs">
  <button class="tablink active" onclick="openTab('tab-patient', event)">👤 Patient</button>
  <button class="tablink" onclick="openTab('tab-constantes', event)">🩺 Constantes</button>
  <button class="tablink" onclick="openTab('tab-historique', event)">📜 Historique</button>
  <button class="tablink" onclick="openTab('tab-dossier', event)">📋 Dossier Médical</button>
  <button class="tablink" onclick="openTab('tab-exam-actes', event)">💉 Actes / Examens</button>
  <button class="tablink" onclick="openTab('tab-sortie-docs', event)">🚪 Sortie / Documents</button>
</div>

	
<div id="tab-patient" class="tab-content" style="display:block;">
  <div class="tab-header">
    <h3>👤 Patient</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
  
  <div>
    <label>Nom</label>
    <span id="nom"></span>
  </div>
  <div>
    <label>Prénom</label>
    <span id="prenom"></span>
  </div>
  <div>
    <label>Sexe</label>
    <span id="sexe"></span>
  </div>
  <div>
    <label>Âge</label>
    <span id="age"></span>
  </div>

  <label for="gravite">🚨 Gravité</label>
  <select id="gravite">
    <option value="P0">P0</option>
    <option value="P1">P1</option>
    <option value="P2">P2</option>
    <option value="P3">P3</option>
    <option value="Urgences_Vitales">Urgences Vitales</option>
    <option value="Administratif">Administratif</option>
  </select>

  <label for="service">🏥 Service idéal</label>
  <select id="service"><option value="">Chargement...</option></select>

  <label for="motif">🤕 Motif d'entrée</label>
  <input type="text" id="motif" placeholder="Motif d'entrée" />

  <label for="moyen">🚑 Moyen d'entrée</label>
  <input type="text" id="moyen" placeholder="Moyen d'entrée" />

  <br><br>
  <button id="btnAdmin" class="btn-admin">🛠 Gestion Administrative</button>
  <button id="btnVoirRawData">🧾 Données brutes</button>
</div>


<div id="tab-constantes" class="tab-content">
  <div class="tab-header">
    <h3>🩺 Constantes</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
  <div class="card">
    <label for="temperature">🌡 Température (°C)</label>
    <input type="number" id="temperature" step="0.1" />
    <label for="fc">❤️ Fréquence cardiaque (bpm)</label>
    <input type="number" id="fc" />
    <label for="ta">💓 Tension artérielle</label>
    <input type="text" id="ta" />
    <label for="saturation">💨 Saturation (%)</label>
    <input type="number" id="saturation" min="0" max="100" step="1" />
    <label for="fr">😮💨 FR</label>
    <input type="number" id="fr" min="0" max="100" step="1" />
    <label for="douleur">😖 Douleur /10</label>
    <input type="number" id="douleur" min="0" max="10" step="1" />
    <button id="btnGlasgow" style="margin-top:10px; background-color:#9b59b6;">🧠 Score de Glasgow</button>
    <br><br>
    <button id="btnSaveConst">💾 Enregistrer constantes</button>
  </div>
  <div class="card">
    <h3>Poids / Taille / IMC</h3>
    <div class="inline-fields">
      <div class="field-group">
        <label for="poids">Poids (kg)</label>
        <input type="number" id="poids" step="0.1" />
      </div>
      <div class="field-group">
        <label for="taille">Taille (cm)</label>
        <input type="number" id="taille" step="1" />
      </div>
      <div class="field-group">
        <label>IMC</label>
        <span id="imc"></span>
      </div>
    </div>
    <button id="btnSavePoids">💾 Enregistrer poids/taille</button>
  </div>
</div>


<div id="tab-historique" class="tab-content">
  <div class="tab-header">
    <h3>📜 Historique</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
  <div class="card">
    <h3>Historique de l'hospitalisation en cours</h3>
    <div id="historique"></div>
  </div>
</div>



<div id="tab-dossier" class="tab-content">
  <div class="tab-header">
    <h3>📋 Dossier Médical</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
  <div class="card" id="dossierMedical">
    <div class="contenu-dossier-medical">
      <label>Questionnaire IAO <button class="bouton-horloge" onclick="ajouterHorodatageDans('questionnaire')">⏰</button></label>
      <textarea id="questionnaire" style="height:80px;"></textarea>
      <label>Antécédents <button class="bouton-horloge" onclick="ajouterHorodatageDans('antecedents')">⏰</button></label>
      <textarea id="antecedents" style="height:80px;"></textarea>
      <label>Traitements en cours <button class="bouton-horloge" onclick="ajouterHorodatageDans('traitements')">⏰</button></label>
      <textarea id="traitements" style="height:80px;"></textarea>
      <label>Histoire de la maladie <button class="bouton-horloge" onclick="ajouterHorodatageDans('histoire')">⏰</button></label>
      <textarea id="histoire" style="height:150px;"></textarea>
      <label>CR Auscultation <button class="bouton-horloge" onclick="ajouterHorodatageDans('auscultation')">⏰</button></label>
      <textarea id="auscultation" style="height:300px;"></textarea>
      <button onclick="enregistrerDossierMedical()">💾 Enregistrer</button>
    </div>
  </div>
  <div class="card" id="evolutionUrgences">
    <h3>📈 Évolution aux urgences <button class="bouton-horloge" onclick="ajouterHorodatageDans('evolutionTexte')">⏰</button></h3>
    <textarea id="evolutionTexte"></textarea>
    <br>
    <button onclick="enregistrerEvolution()">💾 Enregistrer</button>
  </div>
</div>


<div id="tab-exam-actes" class="tab-content">
  <div class="tab-header">
    <h3>☢️ Examens & 💉 Actes</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
  <h4>📋 Examens</h4>
  <div id="listeExamens"></div>
  <button id="btnOuvrirModaleDemande" style="margin-top:10px;">➕ Nouvelle demande d’examen</button>
  <h4>Examens sélectionnés :</h4>
  <div id="examensSelectionnes" style="margin-bottom: 10px;"></div>
  <label for="commentaireExamen">💬 Commentaire</label>
  <textarea id="commentaireExamen"></textarea>
  <div class="modal-buttons">
    <button id="btnCancelExamen">❌ Annuler</button>
    <button id="btnSaveExamen">✅ Valider</button>
  </div>
  <hr>
  <h4>💉 Actes</h4>
  <label>Type d’acte</label>
  <input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" />
  <ul id="suggestionsActes"></ul>
  <label>👨‍⚕️ Réalisé par</label>
  <select id="selectRealisateur"><option>⏳Chargement...</option></select>
  <label>💬 Remarques</label>
  <textarea id="remarqueActe"></textarea>
  <h4>Actes réalisés :</h4>
  <input type="text" id="rechercheActe" placeholder="🔍 Rechercher un acte..." />
  <div id="listeActesRealises"></div>
  <div class="modal-buttons">
    <button id="btnFermerActe">❌ Fermer</button>
    <button id="btnEnregistrerActe" class="success">✔️ Enregistrer</button>
  </div>
</div>



<div class="modal-overlay" id="modalExamen" style="display:none;">
  <div class="modal">
    <h3>Demande d’examen</h3>
    <button class="exam-button" onclick="toggleSublist('prise-sang-list')">🩸 Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (Numération Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Calcémie"> Calcémie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan hépatique"> Bilan hépatique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan rénal"> Bilan rénal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Hémoglobine glyquée (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Sérologies virales (VIH, VHB, VHC)"> Sérologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Mesure taux alcoolémie dans le sang"> Mesure taux alcoolémie</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
  </div>
<button class="exam-button" onclick="toggleSublist('urine-list')">🧪 Examens urinaires</button>
<div class="sub-list" id="urine-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobactériologique des urines)"> ECBU</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Protéinurie des 24h"> Protéinurie 24h</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage créatinine urinaire"> Créatinine urinaire</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
  <button class="exam-button" onclick="toggleSublist('radio-list')">📸 Radiologie</button>
<div class="sub-list" id="radio-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du crâne"> Crâne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>

</div>

<button class="exam-button" onclick="toggleSublist('irm-list')">🧲 IRM</button>
<div class="sub-list" id="irm-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM cérébrale"> Cérébrale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM épaule"> Épaule</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('scanner-list')">🖥️ Scanner</button>
<div class="sub-list" id="scanner-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner cérébral"> Cérébral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner cérébral"> Angioscanner cérébral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('echo-list')">🧭 Échographie</button>
<div class="sub-list" id="echo-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie rénale"> Rénale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie hépatique"> Hépatique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie thyroïdienne"> Thyroïdienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie mammaire"> Mammaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie testiculaire"> Testiculaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Échographie cardiaque (ETT)"> Cardiaque (ETT)</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres inférieurs"> Doppler veineux MI</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler artériel des membres inférieurs"> Doppler artériel MI</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('eos-list')">🦴 EOS</button>
<div class="sub-list" id="eos-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres inférieurs"> Membres inférieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres supérieurs"> Membres supérieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<h4>Examens sélectionnés :</h4>
<div id="examensSelectionnes" style="margin-bottom: 10px;"></div>

    <label for="commentaireExamen">💬 Commentaire</label>
    <textarea id="commentaireExamen" placeholder="Détails supplémentaires..."></textarea>
    
      <button id="btnSaveExamen">✅ Valider</button>
    </div>
</div>
<div id="tab-sortie-docs" class="tab-content">
  <div class="tab-header">
    <h3>🚪 Sortie & 📄 Documents</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">❌</button>
  </div>
<h3>Type de sortie</h3>
    <label><input type="radio" name="typeSortie" value="Retour à domicile" /> 🏡 Domicile</label><br/>
    <label><input type="radio" name="typeSortie" value="Hospitalisation" /> 🏥 Hospitalisation</label><br/>
    <label><input type="radio" name="typeSortie" value="Transfert" /> ↔️ Transfert</label><br/>
	    <label><input type="radio" name="typeSortie" value="Décès" />⚰️ Décès</label><br/>
    <label>
      <input type="radio" name="typeSortie" value="autre" /> 🔤 Autre
      <input type="text" id="champAutreSortie" placeholder="Précisez..." style="margin-top: 8px; display:none;" />
    </label>

    <hr/>

    <h3>Options supplémentaires</h3>
    <label><input type="checkbox" name="optionsSortie" value="Suivi a domicile" /> 📋 Suivi à domicile</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Avis specialiste" /> 👩‍⚕️ Avis spécialiste</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Transport  en ambulance" /> 🚑 Transport ambulance</label><br/>
    <label>
      <input type="checkbox" name="optionsSortie" value="autreOption" /> 🔤 Autre option
      <input type="text" id="champAutreOption" placeholder="Précisez..." style="margin-top: 8px; display:none;" />
    </label>
	<hr/>
<h3>💊 Traitement de sortie</h3>
<textarea id="champTraitementSortie"	 rows="3" style="width:100%; margin-bottom: 10px;"></textarea>

    <hr/>

    <div id="sortieListe"></div> 
    <div class="modal-buttons">
      <button id="btnAnnulerSortie">❌ Annuler</button>
      <button id="btnValiderSortie">✅ Valider</button>
    </div>
  <hr>
  <h4>📄 Documents</h4>
  <button id="btnRapportHospi">📃 Rapport d'hospitalisation</button>
  <button id="btnVersFiche">📄 Ordonnancier</button>
  <button id="btnVersExs">📄 Prescripteur d'examens</button>
  <button id="btnVersSynthese">📄 Certificat médical</button>
  <button id="btnVersFiches">📄 Fiches Conseils</button>
</div>


<!-- Fenêtre modale cachée au départ -->
<div id="popupNavigation" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  ">
    <h2>Liste des documents disponibles</h2>
	<button id="btnRapportHospi" style="margin:10px; padding:10px 20px;">📃 Rapport d'hospitalisation</button>
    <button id="btnVersFiche" style="margin:10px; padding:10px 20px;">📄 Ordonnancier</button>
	<button id="btnVersExs" style="margin:10px; padding:10px 20px;">📄 Prescripteur d'examens</button>
    <button id="btnVersSynthese" style="margin:10px; padding:10px 20px;">📄 Certificat médical</button><br/>
	<button id="btnVersFiches" style="margin:10px; padding:10px 20px;">📄 Fiches Conseils</button><br/>
	<button style="margin:10px; padding:10px 20px;" onclick="window.open('https://eduscol.education.fr/1207/poursuite-de-la-scolarite-avec-des-traitements-medicaux-particuliers', '_blank')">
  📄 PAI (lien externe)
</button><br/>
    <button onclick="document.getElementById('popupNavigation').style.display='none'" style="margin-top:20px;">❌ Fermer</button>
  </div>
</div>


<!-- Modal Clôture -->
<div class="modal-overlay" id="modalCloture">
  <div class="modal" style="text-align: center;">
    <h3>⏳Clôture en cours...</h3>
    <div style="background:#eee; border-radius: 10px; overflow:hidden; margin-top: 15px;">
      <div id="clotureBar" style="height: 12px; background-color: #0078d4; width: 0%; transition: width 0.3s;"></div>
    </div>
    <p style="margin-top:10px; color:#666;">Merci de patienter</p>
  </div>
</div>

</main>
<!-- Modal Gestion Administrative -->
<div class="modal-overlay" id="modalAdmin" style="display:none;">
  <div class="modal">
    <h3>🛠 Gestion Administrative</h3>
    
    <label for="adminId">ID Patient</label>
    <input type="text" id="adminId" disabled />
	
	<label for="adminNom">Nom</label>
    <input type="text" id="adminNom" />
	<label for="adminPrenom">Prénom</label>
<input type="text" id="adminPrenom" />

	
	
	<label for="adminSexe">Sexe</label>
	<select id="adminSexe" >
  <option value="">-- Sélectionnez --</option>
  <option value="M">M</option>
  <option value="Mme">Mme</option>
  <option value="L'enfant">L'enfant</option>
</select>

	<label for="adminNaissance">Date de naissance</label>
<input type="date" id="adminNaissance"  />

	
    <label for="adminAdresse">Adresse</label>
    <input type="text" id="adminAdresse" />

    <label for="adminTelephone">Téléphone</label>
    <input type="text" id="adminTelephone" />

    <label for="adminEmail">Email</label>
    <input type="text" id="adminEmail" />

    <div class="modal-buttons">
	    <button type="button" id="readVitaleBtn" class="button" style="background-color: #28a745; color: white;">🆔 Lecture Carte Vitale</button>
      <button id="btnFacturer" class="success">💶 Facturer</button>
	    <button id="btnCloturer" style="flex:1; background-color:#d9534f;">✅ Clôturer hospitalisation</button>
            <br><br>
			<button id="btnFermerAdmin" class="danger">❌Fermer</button>
	  <button id="btnEnregistrerAdmin" class="primary">💾Enregistrer</button>

    </div>
  </div>
</div>
<div class="modal-overlay" id="modalActe">
  <div class="modal">
    <h3>➕Ajouter un acte</h3>
<label>💉Type d’acte</label>
<input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" />
<ul id="suggestionsActes" style="list-style:none; padding:0; margin-top:5px; border:1px solid #ccc; border-radius:6px; max-height:150px; overflow-y:auto; display:none; background:white; position:relative; z-index:100;"></ul>


    <label>👨‍⚕️Réalisé par</label>
    <select id="selectRealisateur"><option>⏳Chargement...</option></select>

    <label>💬Remarques</label>
    <textarea id="remarqueActe" placeholder="Remarques sur l’acte..."></textarea>

<h4>Actes réalisés :</h4>
<input type="text" id="rechercheActe" placeholder="🔍 Rechercher un acte..." style="width:100%; padding:8px; margin-bottom:12px; border-radius:8px; border:1px solid #ccc;" />
<div id="listeActesRealises" style="max-height:150px; overflow-y:auto; font-size:0.9em;"></div>

    <div class="modal-buttons">
      <button id="btnFermerActe">❌Fermer</button>
      <button id="btnEnregistrerActe" class="success">✔️Enregistrer</button>
    </div>
  </div>
  </div>
 

<div id="vitaleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">⏳Lecture Carte Vitale en cours...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="facturationModale" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">⏳Chargement des informations...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="modal-overlay" id="modalGlasgow">
  <div class="modal">
    <h3>🧠 Score de Glasgow</h3>
    <img src="glasgow.jpg" alt="Échelle de Glasgow" style="width:100%; margin-bottom:15px; border-radius:8px;" />
    
    <label>👁 Ouverture des yeux (max 4)</label>
    <input type="number" id="glasgowYeux" min="1" max="4" />

    <label>🗣 Réponse verbale (max 5)</label>
    <input type="number" id="glasgowVerbal" min="1" max="5" />

    <label>💪 Réponse motrice (max 6)</label>
    <input type="number" id="glasgowMoteur" min="1" max="6" />

    <label>🎯 Score total</label>
    <input type="number" id="glasgowTotal" disabled />

<div id="glasgowPronostic" style="margin: 10px 0; font-style: italic;"></div>
<div id="glasgowPronostic2" style="margin: 10px 0; font-style: italic;"></div>
    <div class="modal-buttons">
      <button id="btnFermerGlasgow" class="secondary">❌ Fermer</button>
      <button id="btnEnregistrerGlasgow" class="success">💾 Enregistrer</button>
    </div>
  </div>
</div>

<script>
   const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
	 firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }

  function calculerAge(dateNaissance) {
    const birth = new Date(dateNaissance);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    if (
      now.getMonth() < birth.getMonth() ||
      (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age;
  }
// --- Références aux éléments ---
const sortieListe = document.getElementById("sortieListe");
const champAutreSortie = document.getElementById("champAutreSortie");
const champAutreOption = document.getElementById("champAutreOption");
const champTraitementSortie = document.getElementById("champTraitementSortie");

// Container dynamique pour les champs spécifiques
let containerDynamique = document.getElementById("optionsSpecifiques");
if (!containerDynamique) {
  containerDynamique = document.createElement("div");
  containerDynamique.id = "optionsSpecifiques";
  document.querySelector("#tab-sortie-docs").insertBefore(containerDynamique, sortieListe);
}

// --- Rafraîchissement des champs dynamiques ---
function rafraichirChampsSortie() {
  const typeSortie = document.querySelector('input[name="typeSortie"]:checked')?.value;
  const optionsSortie = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  containerDynamique.innerHTML = "";

  if (typeSortie === "Transfert") {
    const label = document.createElement("label");
    label.textContent = "Destination du transfert";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champDestinationTransfert";
    input.placeholder = "Ex: CHU Lyon";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  if (typeSortie === "Hospitalisation") {
    const label = document.createElement("label");
    label.textContent = "Service hospitalisation";
    const select = document.createElement("select");
    select.id = "champServiceHospitalisation";

    // Récupération dynamique depuis Firestore
    db.collection("référentiels").doc("spécialités").get().then(doc => {
      const data = doc.data();
      (data?.spécialités || []).forEach(service => {
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });
    });

    containerDynamique.appendChild(label);
    containerDynamique.appendChild(select);
  }

  if (optionsSortie.includes("Avis specialiste")) {
    const label = document.createElement("label");
    label.textContent = "Spécialiste consulté";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champAvisSpecialiste";
    input.placeholder = "Ex: Dr Dupont (Cardio)";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  // Affichage du champ "autre option"
  champAutreOption.style.display = optionsSortie.includes("autreOption") ? "block" : "none";
}

// --- Gestion champ "autre sortie" ---
document.querySelectorAll('input[name="typeSortie"]').forEach(radio => {
  radio.addEventListener("change", () => {
    champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
    rafraichirChampsSortie();
  });
});

document.querySelectorAll('input[name="optionsSortie"]').forEach(cb => {
  cb.addEventListener("change", rafraichirChampsSortie);
});

// --- Affichage sortie ---
function afficherSortieListe(sortie) {
  if (!sortie || !sortie.type) {
    sortieListe.innerHTML = "<p>Aucune sortie enregistrée.</p>";
    return;
  }

  let html = `
    <p><strong>Type de sortie :</strong> ${sortie.type}</p>
    <p><strong>Options :</strong> ${sortie.options?.join(", ") || "Aucune"}</p>
  `;

  if (sortie.destinationTransfert) html += `<p><strong>↔️ Destination :</strong> ${sortie.destinationTransfert}</p>`;
  if (sortie.serviceHospitalisation) html += `<p><strong>🏥 Service :</strong> ${sortie.serviceHospitalisation}</p>`;
  if (sortie.avisSpecialiste) html += `<p><strong>👨‍⚕️ Spécialiste :</strong> ${sortie.avisSpecialiste}</p>`;
  if (sortie.autreOptionTexte) html += `<p><strong>🔤 Autre option :</strong> ${sortie.autreOptionTexte}</p>`;
  if (sortie.traitementSortie) html += `<p><strong>💊 Traitement de sortie :</strong> ${sortie.traitementSortie}</p>`;

  html += `<button id="btnSupprimerSortie" class="danger" style="margin-top:10px;">🗑 Supprimer</button>`;
  sortieListe.innerHTML = html;

  document.getElementById("btnSupprimerSortie").addEventListener("click", async () => {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    delete hospitalisations[index].sortie;
    if (hospitalisations[index].traitementSortie) hospitalisations[index].traitementSortie = "";

    await patientRef.update({ hospitalisations });
    sortieListe.innerHTML = "<p>Sortie supprimée.</p>";
    afficherBulle("🗑️ Sortie supprimée", "administratif");
  });
}

// --- Initialisation au chargement de l'onglet ---
document.addEventListener("DOMContentLoaded", () => {
  // Détecte le type déjà sélectionné et met à jour dynamiquement
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
});


function formaterDate(dateStr) {
  if (!dateStr) return "";
  const match = dateStr.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (match) {
    const [_, jj, mm, aaaa] = match;
    return `${aaaa}-${mm}-${jj}`;
  }
  if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return dateStr;
  }
  return "";
}





    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    // 🔹 Informations patient
    document.getElementById("nom").textContent = data.nom || "";
    document.getElementById("prenom").textContent = data.prenom || "";
    document.getElementById("sexe").textContent = data.sexe || "";
    document.getElementById("poids").value = data.poids || "";
    document.getElementById("taille").value = data.taille || "";

    // 🔹 Calcul IMC
    const elImc = document.getElementById("imc");
    const poids = parseFloat(data.poids);
    const taille = parseFloat(data.taille);
    if (!isNaN(poids) && !isNaN(taille) && taille > 0) {
      const imc = poids / ((taille / 100) ** 2);
      elImc.textContent = imc.toFixed(1);
    } else {
      elImc.textContent = "–";
    }

    // 🔹 Calcul âge
    const elAge = document.getElementById("age");
    if (elAge && data.dateNaissance) {
      const age = calculerAge(data.dateNaissance);
      elAge.textContent = !isNaN(age) ? `${age} ans` : "Inconnu";
    }

    if (hospi) {
      // 🔹 Informations d’hospitalisation
      document.getElementById("gravite").value = hospi.gravite || "";
      document.getElementById("motif").value = hospi.motif || "";
      document.getElementById("moyen").value = hospi.moyen || "";

      // 🔹 Constantes vitales
      document.getElementById("temperature").value = hospi.constantes?.temperature || "";
      document.getElementById("fc").value = hospi.constantes?.fc || "";
      document.getElementById("ta").value = hospi.constantes?.ta || "";
      document.getElementById("saturation").value = hospi.constantes?.saturation || "";
	  document.getElementById("fr").value = hospi.constantes?.fr || "";
      document.getElementById("douleur").value = hospi.constantes?.douleur || "";

      // 🔹 Dossier médical (nouvelle section)
      const dm = hospi.dossierMedical || {};
	  document.getElementById("questionnaire").value = dm.questionnaire || "";
      document.getElementById("antecedents").value = dm.antecedents || "";
      document.getElementById("traitements").value = dm.traitements || "";
      document.getElementById("histoire").value = dm.histoire || "";
      document.getElementById("auscultation").value = dm.auscultation || "";

      // 🔹 Évolution aux urgences
      document.getElementById("evolutionTexte").value = hospi.evolution || "";

      // 🔹 Services / historique
      chargerServices();
      clearHistorique();
      await chargerHistorique();
    }

  } catch (error) {
    console.error("Erreur chargement patient :", error);
    afficherBulle("❌ Erreur de chargement", "alerte");
  } finally {
    if (overlay) overlay.style.display = "none"; // 👈 Très important pour débloquer l'écran
  }
}

    


	document.getElementById("gravite").addEventListener("change", async (e) => {
  const gravite = e.target.value;
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    if (!hospitalisations[index]) return;
    hospitalisations[index] = {
      ...hospitalisations[index],
      gravite
    };
    await patientRef.update({
      hospitalisations,
    });
    ajouterEntreeHistorique(`Changement de gravité à ${gravite}`);
  } catch (err) {
    console.error("Erreur mise à jour gravité :", err);
  }
  document.getElementById("loadingOverlay").style.display = "none";

});

async function ajouterEntreeHistorique(texte) {
  const date = new Date().toLocaleString();
  const entree = { date, texte };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    const hospitalisations = data.hospitalisations || [];
    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].historique = hospitalisations[index].historique || [];

    hospitalisations[index].historique.push(entree);

    await patientRef.update({ hospitalisations });

    afficherHistorique(entree);
  } catch (error) {
    console.error("Erreur ajout historique :", error);
  }
}

document.getElementById("motif").addEventListener("blur", async (e) => {
  const motif = e.target.value.trim();
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    if (!hospitalisations[index]) return;
    hospitalisations[index] = {
      ...hospitalisations[index],
      motif
    };
    await patientRef.update({
      hospitalisations,
    });
    ajouterEntreeHistorique(`Modification du motif d'entrée : ${motif}`);
  } catch (err) {
    console.error("Erreur mise à jour motif :", err);
  }
});


  document.getElementById("btnSavePoids").addEventListener("click", async () => {
    const poids = parseFloat(document.getElementById("poids").value);
    const taille = parseFloat(document.getElementById("taille").value);
    if (!poids || !taille) {
      afficherBulle("❌Veuillez entrer un poids et une taille valide", "alerte");
      return;
    }
    await patientRef.update({ poids, taille });
    ajouterEntreeHistorique(`Poids/Taille/IMC enregistrés: ${poids}kg / ${taille}cm`);
    afficherBulle("✔️Poids et taille enregistrée", "administratif");
  });
document.getElementById("gravite").addEventListener("change", async e => {
  const gravite = e.target.value;

  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];

    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].gravite = gravite;

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Changement de gravité à ${gravite}`);
  } catch (error) {
    console.error("Erreur lors de la mise à jour de la gravité :", error);
  }
});

document.getElementById("motif").addEventListener("blur", async e => {
  const motif = e.target.value;

  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];

    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].motif = motif;

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Modification du motif d'entrée : ${motif}`);
  } catch (error) {
    console.error("Erreur lors de la mise à jour du motif :", error);
  }
});

document.getElementById("btnSaveConst").addEventListener("click", async () => {
  const constantes = {
    temperature: document.getElementById("temperature").value.trim() || "",
    fc: document.getElementById("fc").value.trim() || "",
    ta: document.getElementById("ta").value.trim() || "",
    saturation: document.getElementById("saturation").value.trim() || "",
	fr: document.getElementById("fr").value.trim() || "",
    douleur: document.getElementById("douleur").value.trim() || ""
  };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index] = {
      ...hospitalisations[index],
      constantes
    };

    await patientRef.update({ hospitalisations });

    ajouterEntreeHistorique(`Constantes enregistrées: Temp ${constantes.temperature}, FC ${constantes.fc}, TA ${constantes.ta}, Sat ${constantes.saturation} %, FR ${constantes.fr}, Douleur ${constantes.douleur} /10`);
    afficherBulle("✔️Constantes enregistrées", "administratif");
  } catch (e) {
    console.error("Erreur enregistrement constantes :", e);
    afficherBulle("❌ Erreur enregistrement", "alerte");
  }
});

 

  const historiqueContainer = document.getElementById("historique");

// Fonction pour charger tout l'historique de l'hospitalisation en cours
async function chargerHistorique() {
  try {
    const doc = await patientRef.get();
    const data = doc.data();

    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    if (!hospi || !hospi.historique || hospi.historique.length === 0) {
      historiqueContainer.innerHTML = "<p>Aucune entrée dans l'historique.</p>";
      return;
    }

    historiqueContainer.innerHTML = ""; // on vide avant d'afficher

    hospi.historique.forEach(entry => {
      afficherHistorique(entry);
    });
  } catch (error) {
    console.error("Erreur chargement historique :", error);
  }
}

// Fonction d'affichage d'une seule entrée dans le DOM
function afficherHistorique(entry) {
  if (!historiqueContainer) return;
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = `<strong>${entry.date}</strong><br>${entry.texte}`;
  historiqueContainer.appendChild(div);
}

  function afficherHistoriqueAncienne(hospitalisation, index) {
    if (!historiqueAncienContainer) return;
    const titre = document.createElement("div");
    titre.innerHTML = `<strong style="color:#d9534f">Hospitalisation ${index + 1} (${hospitalisation.dateDebut} - ${hospitalisation.dateFin || "en cours"})</strong>`;
    historiqueAncienContainer.appendChild(titre);
    hospitalisation.historique?.forEach(entry => afficherHistorique(entry, "ancien"));
  }
  function clearHistoriqueAnciennes() {
    if(historiqueAncienContainer) historiqueAncienContainer.innerHTML = "";
  }
  function clearHistorique() {
    if(historiqueContainer) historiqueContainer.innerHTML = "";
  }
  const btnDemandeExamen = document.getElementById("btnDemandeExamen");
const fenetreExamens = document.getElementById("fenetreExamens");
const listeExamens = document.getElementById("listeExamens");
const btnOuvrirModaleDemande = document.getElementById("btnOuvrirModaleDemande");
const btnFermerFenetreExamens = document.getElementById("btnFermerFenetreExamens");

const modalExamen = document.getElementById("modalExamen");
const typeExamen = document.getElementById("typeExamen");
const commentaireExamen = document.getElementById("commentaireExamen");
const btnSaveExamen = document.getElementById("btnSaveExamen");
const btnCancelExamen = document.getElementById("btnCancelExamen");

btnDemandeExamen.addEventListener("click", async () => {
  listeExamens.innerHTML = "<em>Chargement...</em>";
  fenetreExamens.style.display = "flex";

  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const examens = data.hospitalisations?.[index]?.examens || [];

    if (examens.length === 0) {
      listeExamens.innerHTML = "<p>Aucun examen demandé.</p>";
      return;
    }

    listeExamens.innerHTML = examens
      .map((examen, i) => `
        <div style="border:1px solid #ccc; padding:5px; margin-bottom:5px;">
          <strong>${examen.type.toUpperCase()}</strong> - demandé le ${examen.dateDemande}
          <br>
          ${examen.commentaire ? "💬 " + examen.commentaire + "<br>" : ""}
          ${examen.realise ? `✅ Réalisé le ${examen.dateRealisation}<br>📝 CR : ${examen.compteRendu}` : "⏳ En attente de réalisation"}
        </div>
      `)
      .join("");
  } catch (e) {
    console.error("Erreur récupération examens :", e);
    listeExamens.innerHTML = "<p style='color:red;'>Erreur de chargement</p>";
  }
});

btnFermerFenetreExamens.addEventListener("click", () => {
  fenetreExamens.style.display = "none";
});

btnOuvrirModaleDemande.addEventListener("click", () => {
  
  commentaireExamen.value = "";
  modalExamen.style.display = "flex";
});

// Modale annulation
btnCancelExamen.addEventListener("click", () => {
  modalExamen.style.display = "none";
});

document.getElementById("btnSaveExamen").addEventListener("click", async () => {
  const commentaire = document.getElementById("commentaireExamen").value.trim();

  // Récupérer tous les examens cochés
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']:checked");
  const examens = Array.from(checkboxes).map(cb => cb.value);

  if (examens.length === 0) {
    afficherBulle("❌ Veuillez sélectionner au moins un examen", "alerte");
    return;
  }

  const date = new Date().toLocaleString();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    if (!hospitalisations[index].examens) hospitalisations[index].examens = [];

    // Ajouter chaque examen individuellement
    examens.forEach(type => {
      hospitalisations[index].examens.push({
        type,
        commentaire,
        dateDemande: date,
        realise: false
      });
    });

    await patientRef.update({ hospitalisations });

    modalExamen.style.display = "none";
    afficherBulle("✔️ Examens enregistrés", "administratif");
    ajouterEntreeHistorique(`📋 Examens demandés : ${examens.join(", ")}`);
  } catch (err) {
    console.error("Erreur enregistrement examens :", err);
    afficherBulle("❌ Erreur enregistrement", "alerte");
  }
  
});
  document.getElementById("btnCloturer").addEventListener("click", async () => {
  const code = prompt("Entrez le code secret pour clôturer l'hospitalisation :");
  if (!code) return;

  try {
    const codeDoc = await db.collection("patients").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = codeDoc.data().QhwMJ0mjmUnS8MTNBCFU;

    if (code !== codeAttendu) {
      afficherBulle("❌ Code incorrect", "alerte");
      return;
    }

    // Code correct → démarrage clôture
    document.getElementById("modalCloture").style.display = "flex";
    const bar = document.getElementById("clotureBar");
    bar.style.width = "0%";
    let progress = 0;

    const interval = setInterval(() => {
      progress += 1;
      bar.style.width = `${progress}%`;
      if (progress >= 100) clearInterval(interval);
    }, 30);

    setTimeout(async () => {
      try {
        const now = new Date().toLocaleString();
        const doc = await patientRef.get();
        const data = doc.data();
        const index = data.hospitalisationIndex ?? 0;
        const hospitalisations = data.hospitalisations || [];

        if (hospitalisations[index]) {
          hospitalisations[index].dateFin = now;
          hospitalisations[index].historique = hospitalisations[index].historique || [];
          hospitalisations[index].historique.push({ date: now, texte: "Hospitalisation clôturée" });
          hospitalisations[index].rapport = `Rapport d'hospitalisation pour ${data.nom} ${data.prenom} clôturé le ${now}.`;

          await patientRef.update({
            hospitalisations,
            hospitalisationIndex: index + 1,
            hospitalisationActive: false
          });

          alert("✅ Hospitalisation clôturée.");
window.location.href = "urgences.html?id=QhwMJ0mjmUnS8MTNBCFU";
        }
      } catch (error) {
        console.error("Erreur clôture hospitalisation :", error);
        afficherBulle("⚠️Erreur de clôture", "alerte");
      } finally {
        document.getElementById("modalCloture").style.display = "none";
      }
    }, 3200);

  } catch (err) {
    console.error("Erreur lors de la vérification du code :", err);
    afficherBulle("Erreur de vérification du code", "alerte");
  }
});

  document.getElementById("btnRetour").addEventListener("click", () => {
  window.location.href = "urgences.html?id=QhwMJ0mjmUnS8MTNBCFU";
});

  


 document.getElementById("btnEnregistrerModifs").addEventListener("click", () => {
    document.getElementById("popupNavigation").style.display = "flex";
  });

  document.getElementById("btnVersFiche").addEventListener("click", () => {
    window.open(`Ordonnancier.html?id=${patientId}`, '_blank');
  });
document.getElementById("btnVersExs").addEventListener("click", () => {
    window.open(`prescriptionexamens.html?id=${patientId}`, '_blank');
  });
  document.getElementById("btnVersSynthese").addEventListener("click", () => {
    window.open(`Certificatmedical.html?id=${patientId}`, '_blank');
  });
  document.getElementById("btnVersFiches").addEventListener("click", () => {
    window.open(`fichesconseil.html`, '_blank');
  });

// Gestion Administrative
const modalAdmin = document.getElementById("modalAdmin");
const btnAdmin = document.getElementById("btnAdmin");
const btnFermerAdmin = document.getElementById("btnFermerAdmin");
const btnEnregistrerAdmin = document.getElementById("btnEnregistrerAdmin");
const btnFacturer = document.getElementById("btnFacturer");

btnAdmin.addEventListener("click", async () => {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    document.getElementById("adminId").value = patientId;
	document.getElementById("adminNom").value = data.nom || "";
    document.getElementById("adminPrenom").value = data.prenom || "";
    document.getElementById("adminSexe").value = data.sexe || "";
document.getElementById("adminNaissance").value = data.dateNaissance || "";
    document.getElementById("adminAdresse").value = data.adresse || "";
    document.getElementById("adminTelephone").value = data.telephone || "";
    document.getElementById("adminEmail").value = data.email || "";
    modalAdmin.style.display = "flex";
  } catch (e) {
    console.error("Erreur ouverture admin :", e);
    afficherBulle("❌Erreur chargement gestion dministrative", "alerte");
  }
});

btnFermerAdmin.addEventListener("click", () => {
  modalAdmin.style.display = "none";
});

btnEnregistrerAdmin.addEventListener("click", async () => {
  const adresse = document.getElementById("adminAdresse").value.trim();
  const telephone = document.getElementById("adminTelephone").value.trim();
  const email = document.getElementById("adminEmail").value.trim();
  const sexe = document.getElementById("adminSexe").value;
const dateNaissance = document.getElementById("adminNaissance").value.trim();




  try {
    await patientRef.update({ adresse, telephone, email, sexe, dateNaissance });
    afficherBulle("✔️ Coordonnées mises à jour", "administratif");
    modalAdmin.style.display = "none";
  } catch (e) {
    console.error("Erreur maj admin :", e);
    afficherBulle("❌Erreur enregistrement admin", "alerte");
  }
});

btnFacturer.addEventListener("click", () => {
const modal = document.getElementById('facturationModale');
  modal.style.display = 'flex';

  const duration = 3000 ; 

  setTimeout(() => {
    modal.style.display = 'none';
	});
  window.open(`Facturation.html?id=${patientId}`, "_blank");
});

let tousLesActesRealises = [];

const btnActe = document.getElementById("btnActe");
const modalActe = document.getElementById("modalActe");
const btnFermerActe = document.getElementById("btnFermerActe");
const btnEnregistrerActe = document.getElementById("btnEnregistrerActe");
const selectActe = document.getElementById("selectActe");
const champAutreActe = document.createElement("input");
champAutreActe.type = "text";
champAutreActe.id = "champAutreActe";
champAutreActe.placeholder = "Préciser le type d’acte";
champAutreActe.style.display = "none";
champAutreActe.style.marginTop = "8px";

btnFermerActe.addEventListener("click", () => {
  modalActe.style.display = "none";
  reinitialiserFormulaireActe();
});

btnActe.addEventListener("click", async () => {
  modalActe.style.display = "flex";
  await chargerEtInitialiserRechercheActe();
  await chargerRealisateurs();
  await afficherActesRealises();
  setTimeout(() => {
    if (!document.getElementById("filtreTypeActe")) ajouterFiltreTypeActe();
  }, 300);
});

let tousLesActesDispos = [];

async function chargerEtInitialiserRechercheActe() {
  try {
    const doc = await db.collection("référentiels").doc("actes").get();
    const data = doc.data();
    tousLesActesDispos = Array.isArray(data?.liste) ? data.liste : [];
  } catch (e) {
    console.error("Erreur chargement actes :", e);
    tousLesActesDispos = [];
  }

  const champ = document.getElementById("rechercherActe");
  const suggestions = document.getElementById("suggestionsActes");

  champ.addEventListener("input", () => {
    const texte = champ.value.toLowerCase().trim();
    suggestions.innerHTML = "";

    if (!texte) {
      suggestions.style.display = "none";
      return;
    }

    const filtres = tousLesActesDispos.filter(nom =>
      nom.toLowerCase().includes(texte)
    );

    filtres.forEach(nom => {
      const li = document.createElement("li");
      li.textContent = nom;
      li.style.padding = "6px 10px";
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        champ.value = nom;
        suggestions.style.display = "none";
      });
      suggestions.appendChild(li);
    });

    suggestions.style.display = filtres.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!champ.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.style.display = "none";
    }
  });
}


function mettreAJourListeActes(filtre) {
  const selectActe = document.getElementById("selectActe");
  selectActe.innerHTML = "";

  const actesFiltres = tousLesActesDispos.filter(acte =>
    acte.toLowerCase().includes(filtre)
  );

  actesFiltres.forEach(nom => {
    const opt = document.createElement("option");
    opt.value = nom;
    opt.textContent = nom;
    selectActe.appendChild(opt);
  });

  const optAutre = document.createElement("option");
  optAutre.value = "autre";
  optAutre.textContent = "🔤 Autre (à préciser)";
  selectActe.appendChild(optAutre);
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  const doc = await db.collection("référentiels").doc("personnel").get();
  const data = doc.data();

  select.innerHTML = "";

  if (data && Array.isArray(data.liste)) {
    data.liste.forEach(nom => {
      const opt = document.createElement("option");
      opt.value = nom;
      opt.textContent = nom;
      select.appendChild(opt);
    });
  }
}


async function afficherActesRealises(filtreType = "tous") {
  const doc = await patientRef.get();
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const actes = data.hospitalisations?.[index]?.actes_realises || [];
  tousLesActesRealises = actes;

  const container = document.getElementById("listeActesRealises");
  const liste = filtreType === "tous" ? actes : actes.filter(a => a.type === filtreType);

  if (liste.length === 0) {
    container.innerHTML = `
      <p style="color:#999; font-style:italic;">
        Aucun acte enregistré pour ce patient.
      </p>`;
    return;
  }

  container.innerHTML = "";

  liste.forEach((a, i) => {
    const div = document.createElement("div");
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <strong>${a.date}</strong> <br>
	  <span style="color:#0078d4">💉Acte : ${a.type}</span><br>
      👨‍⚕️ Réalisé par : <strong>${a.realisateur}</strong><br>
      💬 Remarque : <em>${a.remarque || "–"}</em><br>
      <button class="bouton-supprimer" onclick="supprimerActeRealise(${i})">🗑 Supprimer</button>
      <hr/>
    `;
    container.appendChild(div);
  });
}

function ajouterFiltreTypeActe() {
  const select = document.createElement("select");
  select.id = "filtreTypeActe";
  select.innerHTML = `<option value="tous">Tous les types</option>`;
  document.getElementById("listeActesRealises").before(select);

  const typesUniques = [...new Set(tousLesActesRealises.map(a => a.type))];
  typesUniques.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });

  select.addEventListener("change", (e) => {
    afficherActesRealises(e.target.value);
  });
}

async function supprimerActeRealise(index) {
  if (!confirm("Supprimer cet acte ?")) return;

  const doc = await patientRef.get();
  const data = doc.data();
  const iHospi = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  const actes = [...(hospitalisations[iHospi].actes_realises || [])];
  const acteSupprimé = actes[index];

  actes.splice(index, 1);
  hospitalisations[iHospi].actes_realises = actes;

  await patientRef.update({ hospitalisations });

  ajouterEntreeHistorique(`❌ Acte supprimé : ${acteSupprimé.type} (par ${acteSupprimé.realisateur})`);
  afficherActesRealises(document.getElementById("filtreTypeActe")?.value || "tous");
  afficherBulle("🗑️ Acte supprimé", "administratif");
}

btnEnregistrerActe.addEventListener("click", async () => {
  const acte = document.getElementById("rechercherActe").value.trim();
  const realisateur = document.getElementById("selectRealisateur").value;
  const remarque = document.getElementById("remarqueActe").value.trim();
  const date = new Date().toLocaleString();

  if (!acte || !realisateur) {
    afficherBulle("❌ Remplissez les champs obligatoires", "alerte");
    return;
  }

  const doc = await patientRef.get();
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];

  hospitalisations[index].actes_realises = hospitalisations[index].actes_realises || [];
  const nouvelActe = { type: acte, realisateur, remarque, date };
  hospitalisations[index].actes_realises.push(nouvelActe);

  await patientRef.update({ hospitalisations });

  ajouterEntreeHistorique(`➕ Acte ajouté : ${acte} par ${realisateur} (${remarque || "–"})`);
  afficherBulle("✔️ Acte enregistré", "administratif");

  modalActe.style.display = "none";
  reinitialiserFormulaireActe();
  await afficherActesRealises();
});
async function chargerServices() {
  try {
    const doc = await db.collection("référentiels").doc("spécialités").get();
    const data = doc.data();
    const services = data?.spécialités || [];

    const select = document.getElementById("service");
    select.innerHTML = ""; // vide les anciennes options

    services.forEach(service => {
      const option = document.createElement("option");
      option.value = service;
      option.textContent = service;
      select.appendChild(option);
    });

    // Pré-remplir si une valeur existe
    const patientDoc = await patientRef.get();
    const patientData = patientDoc.data();
    const index = patientData.hospitalisationIndex ?? 0;
    const hospi = patientData.hospitalisations?.[index];
    if (hospi?.service) select.value = hospi.service || "";

  } catch (e) {
    console.error("Erreur chargement services :", e);
  }
}

// Écouteur de modification
document.getElementById("service").addEventListener("change", async (e) => {
  const service = e.target.value;
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index] = {
      ...hospitalisations[index],
      service
    };

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Changement de service : ${service}`);
  } catch (err) {
    console.error("Erreur mise à jour service :", err);
  }
});
	
function reinitialiserFormulaireActe() {
  document.getElementById("selectActe").value = "";
  document.getElementById("selectRealisateur").value = "";
  document.getElementById("remarqueActe").value = "";
  champAutreActe.value = "";
  champAutreActe.style.display = "none";
}

async function verifierCodeEtCloturer(idPatient, callbackCloture) {
  const saisie = prompt("Entrez le mot de passe de clôture d'hospitalisation :");
  if (!saisie) return;

  try {
    const doc = await db.collection("codes").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = doc.data().QhwMJ0mjmUnS8MTNBCFU;

    if (saisie !== codeAttendu) {
      afficherBulle("❌ Code incorrect", "alerte");
      return;
    }

    callbackCloture(); // Lance la clôture si le code est bon

  } catch (err) {
    console.error(err);
    afficherBulle("❌Erreur lors de la vérification du code", "alerte");
  }
}
function formatDateHeure(dateString) {
  const date = new Date(dateString);
  const pad = (n) => n.toString().padStart(2, '0');
  const jour = pad(date.getDate());
  const mois = pad(date.getMonth() + 1);
  const annee = date.getFullYear();
  const heures = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  const secondes = pad(date.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}

document.getElementById('readVitaleBtn').addEventListener('click', () => {
  const modal = document.getElementById('vitaleModal');
  modal.style.display = 'flex';

  const duration = 3000 + Math.random() * 7000; // entre 3 et 10 secondes

  setTimeout(() => {
    modal.style.display = 'none';

    const isSuccess = Math.random() < 0.8; // 80% ok-20%erreur

    if (isSuccess) {
      afficherBulle("✅ Lecture Carte Vitale terminée !", "administratif");
    } else {
      afficherBulle("❌ Erreur lecture Carte Vitale - Veuillez ressayer", "alerte");
    }
  }, duration);
});

document.getElementById("btnGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "flex";
});

document.getElementById("btnFermerGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "none";
});

["glasgowYeux", "glasgowVerbal", "glasgowMoteur"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
    const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
    const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
    const total = yeux + verbal + moteur;
    document.getElementById("glasgowTotal").value = total;

    const pronostic = document.getElementById("glasgowPronostic");
    if (total <= 4) pronostic.innerText = " 7 % de bonne récupération et 87 % de mortalité.";
    else if (total <= 7) pronostic.innerText = "34 % de bonne récupération et 53 % de mortalité.";
    else if (total <= 10) pronostic.innerText = " 68 % de bonne récupération et 27 % de mortalité.";
    else pronostic.innerText = " 82 % de bonne récupération et 12 % de mortalité.";
  
  const pronostic2 = document.getElementById("glasgowPronostic2");
    if (total <= 6) pronostic.innerText = "Coma Profond";
    else if (total <= 9) pronostic.innerText = "Coma Lourd";
    else if (total <= 14) pronostic.innerText = "Somnoloence / Coma Léger";
    else pronostic.innerText = "Conscience Normale";
});
});
function toggleSublist(id) {
    const list = document.getElementById(id);
    list.style.display = list.style.display === "block" ? "none" : "block";
  }

  function toggleExam(checkbox) {
    if (checkbox.checked) {
      const item = document.createElement('div');
      item.className = 'prescription-item';
      item.textContent = checkbox.value;
      item.dataset.exam = checkbox.value;
      const del = document.createElement('button');
      del.textContent = "✖";
      del.className = "btn-delete";
      del.onclick = () => {
        item.remove();
        checkbox.checked = false;
      };
      item.appendChild(del);
      document.getElementById('prescription-list').appendChild(item);
    }
  }
document.getElementById("btnEnregistrerGlasgow").addEventListener("click", async () => {
  const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
  const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
  const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
  const total = yeux + verbal + moteur;
  const texte = `Score de Glasgow enregistré : ${total} (Yeux ${yeux}, Verbal ${verbal}, Moteur ${moteur})`;

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    hospitalisations[index].glasgow = { yeux, verbal, moteur, total, date: new Date().toISOString() };

    await patientRef.update({ hospitalisations });

    await ajouterEntreeHistorique(texte);
    afficherBulle("✔️ Score de Glasgow enregistré", "administratif");
    document.getElementById("modalGlasgow").style.display = "none";
  } catch (e) {
    console.error("Erreur enregistrement Glasgow :", e);
    afficherBulle("❌ Erreur enregistrement", "alerte");
  }
});
function ajouterHorodatage() {
  const textarea = document.getElementById("texteRemarque");
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR');
  const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const horodatage = `${dateStr} ${timeStr} - ${medecinNom} : `;

  textarea.value += textarea.value && !textarea.value.endsWith('\n') ? '\n' + horodatage : horodatage;
  textarea.focus();
}

function ajouterHorodatageDans(id) {
  const textarea = document.getElementById(id);
  if (!textarea) return;

  const horodatage = new Date().toLocaleString("fr-FR");
const insertion = `${horodatage} - ${window.medecinNom}\n`;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;

  const texteAvant = textarea.value.substring(0, start);
  const texteApres = textarea.value.substring(end);

  textarea.value = texteAvant + insertion + texteApres;

  const nouvellePosition = start + insertion.length;
  textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
  textarea.focus();
}


async function enregistrerDossierMedical() {
const questionnaire = document.getElementById("questionnaire").value.trim();
  const antecedents = document.getElementById("antecedents").value.trim();
  const traitements = document.getElementById("traitements").value.trim();
  const histoire = document.getElementById("histoire").value.trim();
  const auscultation = document.getElementById("auscultation").value.trim();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index].dossierMedical = {
	questionnaire,
      antecedents,
      traitements,
      histoire,
      auscultation
    };

    await patientRef.update({ hospitalisations });
    afficherBulle("💾 Dossier médical enregistré", "administratif");
    ajouterEntreeHistorique("📝 Dossier médical mis à jour");
  } catch (err) {
    console.error("Erreur enregistrement dossier médical :", err);
    afficherBulle("❌ Erreur lors de l'enregistrement", "alerte");
  }
}

async function enregistrerEvolution() {
  const texte = document.getElementById("evolutionTexte").value.trim();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index].evolution = texte;

    await patientRef.update({ hospitalisations });
    afficherBulle("💾 Évolution enregistrée", "administratif");
    ajouterEntreeHistorique("📈 Évolution mise à jour");
  } catch (err) {
    console.error("Erreur enregistrement évolution :", err);
    afficherBulle("❌ Erreur lors de l'enregistrement", "alerte");
  }
}

document.getElementById("btnVoirRawData").addEventListener("click", async () => {
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

  const modal = document.getElementById("modalRawData");
  const content = document.getElementById("rawDataContent");

  try {
    const docRef = db.collection("patients").doc(id); // 🔁 Assure-toi que `id` est bien défini
    const docSnap = await docRef.get();

    if (docSnap.exists) {
      content.textContent = JSON.stringify(docSnap.data(), null, 2); // Beautified JSON
      modal.style.display = "flex";
    } else {
      content.textContent = "⚠️ Patient introuvable.";
      modal.style.display = "flex";
    }
  } catch (e) {
    content.textContent = "❌ Erreur lors de la récupération des données.";
    modal.style.display = "flex";
  }
});

document.getElementById("closeRawData").addEventListener("click", () => {
  document.getElementById("modalRawData").style.display = "none";
});

async function remplirDepuisAncienneHospi(champ) {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    if (index <= 0) {
      afficherBulle("❌ Aucune hospitalisation antérieure", "alerte");
      return;
    }

    const ancienne = data.hospitalisations?.[index - 1]?.dossierMedical;
    if (!ancienne || !ancienne[champ]) {
      afficherBulle(`❌ Pas d'ancien contenu pour ${champ}`, "alerte");
      return;
    }

    const contenu = ancienne[champ].trim();
    const textarea = document.getElementById(champ);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const avant = textarea.value.substring(0, start);
    const apres = textarea.value.substring(end);
    const insertion = contenu + "\n";

    textarea.value = avant + insertion + apres;

    const nouvellePosition = start + insertion.length;
    textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
    textarea.focus();

    afficherBulle(`📁 Ancien ${champ} inséré`, "administratif");

  } catch (err) {
    console.error("Erreur récupération données précédentes :", err);
    afficherBulle("❌ Erreur de récupération", "alerte");
  }
}

document.getElementById("btnRapportHospi").addEventListener("click", () => {
  const url = `rapporthospitalisation.html?id=${patientId}`;
  document.getElementById("contenu").innerHTML = `
    <iframe src="${url}" style="width:100%;height:100vh;border:none;"></iframe>
  `;
});


loadPatient();
// Ligne de test de fin
console.log("Script terminé correctement ✅");
</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

   let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
        medecinLieu = data.lieu || "";

        // Met à jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise à jour des éléments HTML si présents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- Vérification d'accès à la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("⛔️ Vous n’avez pas accès à cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant — redirection
        alert("Utilisateur non trouvé, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement médecin :", error);
      alert("Une erreur est survenue, veuillez réessayer plus tard.");
    }
  }
});
	function openTab(tabId, evt) {
  document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
  document.querySelectorAll(".tablink").forEach(tl => tl.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  evt.currentTarget.classList.add("active");
}
</script>

</body>
</html>

























