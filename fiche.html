<!DOCTYPE html>
<html lang="fr">
<head>

<link rel="icon" type="image/jpeg" href="logo.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche Patient </title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
   <style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow-y: auto;      /* üî• scroll global possible par d√©faut */
  overflow-x: hidden;    /* pas de scroll horizontal */
}

.bouton-ancienne {
  all: unset;
  cursor: pointer;
  font-size: 1em;
  margin-left: 5px;
  color: #2c7be5;   /* bleu */
  background: transparent !important; /* üëà reste transparent */
}

.bouton-ancienne:hover,
.bouton-ancienne:focus,
.bouton-ancienne:active {
  color: #1b4f9c;   /* un bleu plus fonc√© pour l'effet visuel */
  background: transparent !important; /* üëà pas de fond */
  text-decoration: none; /* pas de soulignement */
  outline: none;  /* pas de bordure focus */
  box-shadow: none; /* pas d‚Äôombre */
}


	  hr {
  border: none;
  height: 4px;
  background-color: #0078d4; 
  border-radius: 2px;
  margin: 20px 0;
}

	 .tabs {
  display: flex;          /* aligne les boutons sur une ligne */
  width: 100%;            /* prend toute la largeur */
}

.tabs {
  display: flex;
  width: 100%;
}

.tablink {
  flex: 1;
  text-align: center;
  padding: 12px;
  border: none;
  cursor: pointer;
  background: #2196f3;      /* bleu normal */
  color: white;             /* texte blanc */
  font-size: 16px;
  transition: transform 0.2s, background 0.2s;
}

.tablink:hover {
  background: #1976d2;      /* bleu plus fonc√© */
  transform: scale(1.05);   /* zoom l√©ger */
}

.tablink.active {
  background: #2196f3;      /* m√™me bleu */
  color: black;             /* texte noir pour l‚Äôactif */
  font-weight: bold;
  transform: scale(1.08);   /* zoom un peu plus marqu√© */
}



.tab-content {
  display: none;
  width: 100%;       /* occupe toute la largeur */
  max-width: none;   /* enl√®ve la limite de largeur */
  box-sizing: border-box;
}
.close-tab {
  all: unset;
  cursor: pointer;
  color: #c62828;     /* rouge vif */
  font-size: 20px;
  font-weight: bold;
  line-height: 1;
  background: transparent !important;  /* üëà force pas de fond */
  transition: transform 0.2s ease, color 0.2s ease;
}

.close-tab:hover,
.close-tab:focus,
.close-tab:active {
  transform: scale(1.3);
  color: #e53935;            /* rouge plus clair */
  background: transparent !important; /* üëà bloque le bleu moche */
  outline: none;             /* pas de contour par d√©faut */
  box-shadow: none;          /* supprime glow √©ventuel */
}

#hospitalisationsContent .card {
  margin-bottom: 20px;
  padding: 15px;
  border-left: 6px solid #0078d4;
}
#hospitalisationsContent h3 {
  margin-top: 0;
  color: #0078d4;
}
#hospitalisationsContent .entry {
  background: #f9f9f9;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 8px;
}


#examensListe,
#actesListe {
  max-width: none !important;  /* supprime la limite de largeur */
  width: 100% !important;      /* √©tire les blocs */
}



textarea {
  width: 100%;
  box-sizing: border-box;
  padding: 8px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical;       /* permet de redimensionner verticalement */
  border: 1px solid #ccc; /* bord fin et gris */
  border-radius: 6px;     /* coins arrondis */
  background-color: #fff; /* fond blanc */
}

/* Hauteur sp√©cifique par champ */
#questionnaire {
  height: 150px;
  resize: vertical;
}

#antecedents {
 height: 150px;
  resize: vertical;
}

#traitements {
 height: 150px;
  resize: vertical;
}

#histoire {
   height: 300px;
  resize: vertical;
}
#auscultation {
  height: 300px;
  resize: vertical;
}


#evolutionTexte {
   height: 500px;
  resize: vertical;
}


#tab-dossier .card {
  max-width: none !important;
  width: 100% !important;
}

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
	  #dossierMedical input[type="text"],
#dossierMedical input[type="number"] {
  width: 100%;
}
	
	.bouton-horloge {
  all: unset;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  margin-left: 5px;
  color: #555;
}
.bouton-horloge:hover,
.bouton-horloge:focus {
  outline: none;
  box-shadow: none;
  background-color: transparent; 
}

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h2 {
      margin: 0;
      color: #0078d4;
    }
    button, select, input[type="text"], input[type="number"] {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s ease;
    }
    button {
      background-color: #0078d4;
      color: white;
      cursor: pointer;
      border: none;
      margin-right: 10px;
    }
    button:hover {
      background-color: #005ea2;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 25px;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    .field-group {
      margin-bottom: 15px;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .inline-fields > div {
      flex: 1;
      min-width: 150px;
    }
  section.panel {
  display: none;
  position: relative;
  width: 100%;
  height: auto;
  z-index: 0;
  overflow: visible; /* ‚úÖ important pour √©viter l‚Äôapparition d‚Äôun scroll interne */
}

section.panel.active {
  display: block;
  z-index: 1;
}
  
/* --- Correction compl√®te pour les cartes de l'historique --- */

/* === Correction finale : cartes d'historique adaptatives === */

#panel-historique,
#hospitalisationsContent {
  position: relative;
  width: 100%;
  overflow: visible;
}


#hospitalisationsContent .card {
  display: block !important;     /* emp√™che flex ou grid de les forcer */
  height: auto !important;       /* s‚Äôadapte au contenu */
  min-height: unset !important;  /* supprime toute hauteur minimale forc√©e */
  flex: none !important;         /* √©vite flex-grow/shrink */
  align-self: auto !important;   /* emp√™che le stretch */
  width: 100% !important;
  max-width: none !important;
  box-sizing: border-box;
  background: #f9f9f9;
  border-left: 6px solid #0078d4;
  border-radius: 8px;
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  overflow: visible !important;  /* grandit selon le contenu */
  word-wrap: break-word;
  white-space: normal;
}


/* Chaque hospitalisation (carte) */
#hospitalisationsContent .card {
  width: 100% !important;         /* prend toute la largeur */
  max-width: none !important;     /* d√©sactive les limites globales */
  box-sizing: border-box;
  background: #f9f9f9;
  border-left: 6px solid #0078d4;
  border-radius: 8px;
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  overflow: visible !important;   /* s‚Äôadapte au contenu long */
  word-wrap: break-word;          /* √©vite les d√©passements horizontaux */
  white-space: normal;            /* le texte revient bien √† la ligne */
}

/* Titre √† l‚Äôint√©rieur des cartes */
#hospitalisationsContent .card h2 {
  margin-top: 0;
  color: #0078d4;
  border-bottom: 3px solid #0078d4;
  padding-bottom: 5px;
  margin-bottom: 15px;
}

/* Paragraphes et sections internes */
#hospitalisationsContent .card p,
#hospitalisationsContent .card div,
#hospitalisationsContent .card h3 {
  max-width: 100%;
  overflow: visible;
  white-space: pre-wrap;
  word-break: break-word;
}


    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.35);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
  background: white;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;         /* Limite la hauteur √† 90% de la fen√™tre */
  overflow-y: auto;         /* Affiche un ascenseur vertical si besoin */
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
}

    .modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #0078d4;
    }
    .modal label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .modal input[type="text"], .modal select, .modal textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
    }
    .modal textarea {
      min-height: 80px;
    }
    .modal-buttons {
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 10px;
      min-width: 90px;
    }
button {
  all: unset;
  display: inline-block;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  min-width: 120px;
  text-align: center;
  font-weight: 500;
  background-color: #0078d4;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Boutons secondaires */
button.secondary {
  background-color: #6c757d;
}

button.secondary:hover {
  background-color: #5a6268;
}

/* Boutons de validation */
button.success {
  background-color: #28a745;
}

button.success:hover {
  background-color: #218838;
}

/* Boutons d‚Äôalerte / suppression */
button.danger {
  background-color: #dc3545;
}

button.danger:hover {
  background-color: #c82333;
}
	  

/* Cartes d‚Äôhospitalisation */
#hospitalisationsContent {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#hospitalisationsContent .card {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  border-left: 8px solid #0078d4;
}

#hospitalisationsContent h3 {
  color: #0078d4;
  margin-top: 10px;
  margin-bottom: 8px;
}

#hospitalisationsContent p {
  margin: 5px 0;
  line-height: 1.5;
  white-space: pre-wrap; /* conserve les sauts de ligne */
  color: #333;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1); }
}



/* Pour groupes de boutons c√¥te √† c√¥te */
.button-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.inline-fields {
  display: flex;
  gap: 20px; /* espace entre les champs */
  flex-wrap: wrap; /* pour que √ßa passe √† la ligne si trop √©troit */
}

.field-group {
  display: flex;
  flex-direction: column;
  min-width: 150px; /* largeur mini des champs */
}
.bouton-supprimer {
  background-color: #e0e0e0;
  color: #555;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  margin-left: 4px;
}
.bouton-supprimer:hover {
  background-color: #ccc;
}

/* === COMPORTEMENT D√âFINITIF DES ASCENSEURS === */



/* Conteneur principal */
.app {
  display: flex;
  height: calc(100vh - 80px); /* occupe tout sauf le header */
  overflow: hidden; /* üö´ aucun scroll global dans le layout */
}

/* Menu fixe √† gauche */
nav {
  width: 260px;
  background: #fff;
  border-right: 1px solid #e0e0e0;
  padding: 15px;
  flex-shrink: 0;
  overflow: hidden; /* üö´ aucun ascenseur ici */
}

/* Zone de contenu √† droite */
.content {
  flex: 1;
  overflow-y: auto;  /* ‚úÖ seul ascenseur vertical ici */
  overflow-x: hidden; /* üö´ pas de scroll horizontal */
  padding: 20px;
  box-sizing: border-box;
  background: #f4f6f8;
}

/* === Comportement responsive (mobile) === */
@media (max-width: 900px) {
 

  nav {
    position: fixed;
    top: 0;
    left: -260px;
    bottom: 0;
    width: 260px;
    background: #fff;
    box-shadow: 3px 0 10px rgba(0,0,0,0.2);
    z-index: 2000;
    transition: left 0.3s ease;
    overflow-y: auto; /* ‚úÖ ici, le menu mobile peut d√©filer si besoin */
  }

  nav.open {
    left: 0;
  }

  .content {
    overflow-y: auto;
    padding: 15px;
  }
}



main {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  overflow: auto;
  flex: 1;
  justify-content: flex-start;
  align-content: flex-start;
}

.card {
  flex: 1 1 300px;
  max-height: 300px;
  overflow: auto;
  box-sizing: border-box;
  padding: 10px;
  margin: 0;
}
#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}


.exam-button {
  background-color: #007BFF;
  color: white;
  padding: 12px;
  width: 100%;
  border: none;
  border-radius: 6px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 16px;
}
.exam-button:hover {
  background-color: #0056b3;
}
.sub-list {
  display: none;
  margin-top: 10px;
  padding-left: 10px;
}
.sub-list label {
  display: block;
  margin: 5px 0;
  cursor: pointer;
}
.prescription-item {
  background: #eef;
  padding: 10px;
  margin: 5px 0;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
}
.btn-delete {
  background-color: red;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 5px 10px;
  cursor: pointer;
}

/* Overlay de la modale */
#modalAdmin.modal-overlay {
  position: fixed;
  inset: 0; /* top:0; right:0; bottom:0; left:0; */
  background-color: rgba(0, 0, 0, 0.6);
  display: flex; /* garder le flex pour le centrage */
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease;
  z-index: 2000;
}

/* Overlay visible */
#modalAdmin.modal-overlay.show {
  opacity: 1;
  visibility: visible;
}

/* Modale elle-m√™me */
#modalAdmin .modal {
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);

  /* Animation d'apparition fluide */
  transform: scale(0.95);
  opacity: 0;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

/* Modale visible */
#modalAdmin.modal-overlay.show .modal {
  transform: scale(1);
  opacity: 1;
}

#modalCloture.modal-overlay {
  z-index: 3000; /* plus haut que #modalAdmin */
}
#modalActe.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 3000;
  display: none;
  justify-content: center;
  align-items: center;
}

#modalActe .modal {
  width: 95%;
  max-width: none;
  max-height: 95vh;
  height: 95vh;
  overflow-y: auto;
  border-radius: 12px;
  background: white;
  padding: 25px;
}


input[type="text"],
input[type="date"],
select {
  width: 100%;
  padding: 8px 12px;
  margin: 6px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
  font-size: 16px;
  font-family: inherit;
  appearance: none; /* pour uniformiser certains navigateurs */
  background-color: #fff;
}
input.text1 {
  width: 120px;   /* largeur fixe, tu peux changer */
  display: inline-block;
}
	  input.text2 {
  width: 200px;   /* largeur fixe, tu peux changer */
  display: inline-block;
}
input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.5); /* optionnel : am√©liore l'int√©gration dans les th√®mes clairs/fonc√©s */
}

label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #f5f5f5; /* optionnel, pour une meilleure lisibilit√© */
  border-bottom: 1px solid #ccc;
}

.left-header h2 {
  margin: 0;
}

.right-header {
  font-size: 0.9em;
  color: #333;
}

  .vidal-search {
    display: flex;
   
    align-items: center;
    margin: 20px 0;
    font-family: Arial, sans-serif;
  }

  /* Input de recherche */
  .vidal-search input[type="text"] {
    padding: 10px;
    font-size: 16px;
    border: 2px solid #d32f2f; /* rouge Vidal */
    border-right: none; /* pour que le bouton soit coll√© */
    border-radius: 4px 0 0 4px; /* coins arrondis c√¥t√© gauche */
    outline: none;
    width: 300px;
  }

  /* Bouton de recherche */
  .vidal-search button {
    padding: 10px 20px;
    background-color: #d32f2f; /* rouge Vidal */
    color: white;
    font-size: 16px;
    border: 2px solid #d32f2f;
    border-radius: 0 4px 4px 0; /* coins arrondis c√¥t√© droit */
    cursor: pointer;
    transition: background-color 0.3s;
  }

  /* Effet au survol */
  .vidal-search button:hover {
    background-color: #b71c1c; /* rouge plus fonc√© au survol */
    border-color: #b71c1c;
  }
	  /* üè• Modale de saisie du code de cl√¥ture */
#modalCodeCloture.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.55); /* voile sombre mais doux */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999; /* üëë au-dessus de tout */
  animation: fadeInOverlay 0.25s ease;
}

/* Fen√™tre centrale */
#modalCodeCloture .modal {
  background: #ffffff;
  border-radius: 14px;
  padding: 30px 25px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
  text-align: center;
  animation: popIn 0.3s ease;
  border-top: 6px solid #0078d4; /* bleu m√©dical */
}

/* Titre */
#modalCodeCloture .modal h3 {
  margin-top: 0;
  color: #0078d4;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 20px;
}

/* Champ input */
#modalCodeCloture input[type="password"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #ccd6e0;
  font-size: 1rem;
  font-family: "Segoe UI", Tahoma, sans-serif;
  box-sizing: border-box;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#modalCodeCloture input[type="password"]:focus {
  border-color: #0078d4;
  box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25);
  outline: none;
}

/* Boutons */
#modalCodeCloture .modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

/* Bouton Valider */
#btnValiderCode {
  background-color: #0078d4;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

#btnValiderCode:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Bouton Annuler */
#btnAnnulerCode {
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

#btnAnnulerCode:hover {
  background-color: #5a6268;
  transform: translateY(-1px);
}

/* Animation d'apparition douce */
@keyframes fadeInOverlay {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes popIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
#loadingScreen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: white;
  font-family: 'Inter', sans-serif;
  transition: opacity 0.5s ease;
}

#loadingScreen.hidden {
  opacity: 0;
}

.loader-content {
  text-align: center;
}

.spinner {
  border: 6px solid rgba(255, 255, 255, 0.3);
  border-top: 6px solid white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


/* üåô Switch ON/OFF */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:checked + .slider:before {
  transform: translateX(22px);
}

footer {
  margin-top: auto;
  padding: 15px;
  text-align: center;
  color: #777;
  font-size: 0.9rem;
}


.nav-title {
  font-weight: bold;
  color: #0078d4;
  margin-bottom: 10px;
}

.nav-item {
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  color: #333;
  transition: background 0.2s, transform 0.1s;
  margin-bottom: 6px;
}

.nav-item:hover {
  background: #eef6ff;
  transform: translateX(3px);
}

.nav-item.active {
  background: linear-gradient(90deg, #eaf4ff, #fff);
  border-left: 4px solid #0078d4;
  color: #0078d4;
  font-weight: bold;
}

.panel {
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 25px;
}
/* ‚úÖ Correction finale : cartes de l‚Äôhistorique auto-hauteur sans scroll */
#hospitalisationsContent .card {
  flex: none !important;       /* ne s'√©tire pas avec flexbox */
  height: auto !important;     /* s‚Äôadapte √† la taille du texte */
  max-height: none !important; /* supprime la limite de hauteur */
  overflow: visible !important;/* pas de scrollbar interne */
}
/* === MENU RESPONSIVE CORRIG√â === */
.menu-toggle {
  display: none;
  background-color: #0078d4;
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
}

/* üì± Version mobile : menu cach√© par d√©faut */
@media (max-width: 900px) {
  .menu-toggle {
    display: inline-block;
  }

  nav {
    position: fixed;
    top: 0;
    left: -260px;
    bottom: 0;
    width: 260px;
    background: #fff;
    box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    transition: left 0.3s ease;
  }

  nav.open {
    left: 0;
  }

  .content {
    padding: 15px;
  }

  /* D√©sactive le scroll horizontal global */
  body {
    overflow-x: hidden;
  }
}

/* üíª Version bureau : menu toujours visible et fixe */
@media (min-width: 901px) {
  nav {
    position: static;
    left: 0;
    width: 260px;
    box-shadow: none;
    transition: none;
  }
  .content {
    margin-left: 0;
  }
}





	   /* === CORRECTION : supprimer la bande blanche √† gauche sur mobile === */


/* === MENU SUP√âRIEUR AVEC D√âROULANTS === */
.top-menu {
  display: flex;
  gap: 10px;
  background: #0078d4;
  padding: 10px 20px;
  border-radius: 0 0 8px 8px;
  position: sticky;
  top: 0;
  z-index: 1500;
}

.dropbtn {
  background: white;
  color: #0078d4;
  font-weight: 600;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s, transform 0.2s;
}

.dropbtn:hover {
  background: #eaf4ff;
  transform: translateY(-2px);
}

/* Conteneur de menu d√©roulant */
.dropdown {
  position: relative;
}

/* Sous-menu cach√© */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  min-width: 180px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  border-radius: 8px;
  margin-top: 8px;
  z-index: 9999;
}

/* Liens du sous-menu */
.dropdown-content a {
  color: #333;
  padding: 10px 14px;
  text-decoration: none;
  display: block;
  transition: background 0.2s;
}

.dropdown-content a:hover {
  background-color: #eef6ff;
}

/* Affichage du menu au clic */
.dropdown.show .dropdown-content {
  display: block;
}


/* --- Sous-onglets du panneau Documents --- */

.docs-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
}

.docs-tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
}


.docs-tab {
  padding: 10px 16px;
  background: #e5e5e5;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

.docs-tab.active {
  background: #0078d4;
  color: white;
}

/************************************
   üîµ R√àGLES GLOBALES (NE PAS TOUCHER)
*************************************/

/* Le site entier NE doit JAMAIS scroller */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;         /* üö´ jamais de scroll global */
}

/* Layout principal */
.app {
  height: calc(100vh - 90px);   /* ajuste si ton header a une autre hauteur */
  display: flex;
  overflow: hidden;             /* üö´ pas de scroll ici */
}

/* Menu lat√©ral fixe */
nav {
  flex-shrink: 0;
  overflow: hidden;             /* üö´ jamais de scroll ici */
}

/**********************************************
   üü© PANELS PAR D√âFAUT (TOUS LES ONGLET SAUF DOCUMENTS)
***********************************************/

.content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;        /* gestion fine par panel */
}

section.panel {
  flex: 1;
  overflow-y: auto;        /* ‚úîÔ∏è chaque panel peut scroller */
  overflow-x: hidden;
  display: none;           /* masqu√© par d√©faut */
}

section.panel.active {
  display: block;
}


/* --- Panel Documents cach√© par d√©faut comme les autres --- */
#panel-documents {
    overflow: hidden !important;
    display: none;          /* ‚õî tr√®s important */
    flex-direction: column; 
}

/* --- Quand le panel Documents est actif --- */
#panel-documents.active {
    display: flex !important;   /* ‚úî remplace display:none */
    flex-direction: column;
}

/* --- Onglets en haut --- */
.docs-tabs {
    flex-shrink: 0;
}

/* --- Iframe occupe toute la hauteur restante --- */
#docsFrame {
    flex: 1;
    width: 100%;
    height: auto;
    border: none;
    overflow: auto;   /* le seul ascenseur visible */
}
#panel-historique {
  display: none;
  flex-direction: column;
  flex: 1;
   overflow-y: auto;
  padding-right: 15px;           /* scroll permanent, plus fluide */
  scrollbar-width: thin;        /* Firefox */
  scrollbar-color: #0078d4 #f4f6f8; /* couleur de la scrollbar */
}
#panel-historique.active {
  display: flex

}

/* Menu lat√©ral compact fa√ßon √âcole Directe */
nav {
  border-top-right-radius: 20px;     /* ‚¨Ö arrondi haut √† droite */
  border-bottom-right-radius: 20px;     /* ‚¨Ö arrondi haut √† droite */

  width: 65px;                    /* ‚¨Ö r√©duit : seulement les emojis visibles */
  transition: width 0.25s ease;
  overflow: hidden;
}

nav:hover {
  width: 260px;                   /* ‚¨Ö se d√©ploie au survol */
}

/* Items du menu */
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;                      /* espace emoji / texte */
  white-space: nowrap;            /* pas de retour ligne */
  padding: 10px 14px;
}

/* Texte cach√© quand le menu est r√©duit */
.nav-item span {
  opacity: 0;
  transition: opacity 0.20s ease;
}

/* Texte visible quand menu ouvert */
nav:hover .nav-item span {
  opacity: 1;
}

.suggestions {
  list-style: none;
  padding: 0;
  margin: 0;
  border: 1px solid #ccc;
  background: white;
  max-height: 150px;
  overflow-y: auto;
  border-radius: 6px;
  display: none;
  position: absolute;
  z-index: 1000;
  width: 100%;
}

.suggestions li {
  padding: 8px;
  cursor: pointer;
}

.suggestions li:hover {
  background: #eef6ff;
}

.alerte-orange {
  margin-top: 5px;
  color: #e65100;
  font-size: 0.9em;
}

.clear-btn {
  all: unset;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  margin-left: 5px;
  color: #555;
}
.clear-btn:hover,
.clear-btn:focus {
  outline: none;
  box-shadow: none;
  background-color: transparent; 
}
/* üî≤ Grille 2x2 √©quipe r√©f√©rente */
.equipe-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* üì¶ Champ avec bouton int√©gr√© */
.input-wrapper {
  position: relative;
  width: 100%;
}

.input-wrapper input {
  width: 100%;
  padding-right: 34px; /* place pour la croix */
}

/* ‚ùå Bouton clear dans le champ */
.input-wrapper .clear-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  color: #888;
  cursor: pointer;
}

.input-wrapper .clear-btn:hover {
  color: #c62828;
}

/* üì± Responsive : une seule colonne sur mobile */
@media (max-width: 700px) {
  .equipe-grid {
    grid-template-columns: 1fr;
  }
}
.topbar {
  position: sticky;
  top: 0;
  z-index: 9999;
  background: #ffffff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  margin-bottom: 15px;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  font-weight: 700;
  font-size: 1.1rem;
  color: #005ea2;
}

.tabs {
  display: flex;
  gap: 8px;
}

.tab {
  background: transparent;
  color: #005ea2;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.tab.active,
.tab:hover {
  background: #e6f0fc;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.icon-btn {
  background: #f0f4f8;
  color: #333;
  border: none;
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 1.1rem;
  cursor: pointer;
}

.icon-btn:hover {
  background: #dbe9ff;
}

/* üîΩ Menu hover */
.hover-menu {
  position: relative;
}

.hover-panel {
  position: absolute;
  top: 120%;
  right: 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  min-width: 180px;
  overflow: hidden;
}

.hover-panel button {
  background: none;
  border: none;
  padding: 10px 14px;
  text-align: left;
  cursor: pointer;
}

.hover-panel button:hover {
  background: #f0f8ff;
}

.hover-menu:hover .hover-panel {
  display: flex;
}
/* üîß Correctif lisibilit√© topbar */
.topbar button,
.topbar .tab,
.topbar .icon-btn {
  color: #1f2937; /* gris fonc√© lisible */
}
.hover-panel button {
  color: #1f2937;
  background: white;
}

.hover-panel button:hover {
  background: #e6f0fc;
  color: #005ea2;
}
.tab.active {
  background: #0078d4;
  color: white;
}
.menu-wrapper {
  position: relative;
}

.menu-panel {
  position: absolute;
  top: 120%;
  right: 0;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  display: none;
  flex-direction: column;
  min-width: 180px;
  z-index: 9999;
  overflow: hidden;
}

.menu-panel button {
  background: none;
  border: none;
  padding: 10px 14px;
  text-align: left;
  cursor: pointer;
  color: #1f2937;
}

.menu-panel button:hover {
  background: #e6f0fc;
  color: #005ea2;
}

/* √©tat ouvert */
.menu-wrapper.open .menu-panel {
  display: flex;
}
.search-wrapper {
  position: relative;
}

.search-results {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  width: 100%;
  max-height: 320px;
  overflow-y: auto;
  background: white;
  border-radius: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
  z-index: 10000;
}

.search-results.hidden {
  display: none;
}

.resultat-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.resultat-item:hover {
  background: #e6f0fc;
}

.topbar,
.search-container {
  position: relative;
}
#recherchePatient {
  display: none;
}
  </style>



</head>
<body>



<!-- √âcran de chargement -->
<div id="loadingScreen">
  <div class="loader-content">
    <div class="spinner"></div>
    <h2>Chargement des donn√©es...</h2>
    <p>Merci de patienter quelques instants</p>
  </div>
</div>


<div class="topbar">
  <div class="topbar-left">
    <div class="logo">üöë GestUrg2</div>

    <div class="tabs">
      <button class="tab" onclick="location.href='urgences.html'">Urgences</button>
      <button class="tab" onclick="location.href='regulation.html'">Tableau</button>
      <button class="tab" onclick="location.href='gestionnaireradiologie.html'">Imagerie</button>
      <button class="tab" onclick="location.href='patients.html'">Patients</button>
      <button class="tab" onclick="location.href='MesOutils.html'">Outils</button>
      <button class="tab active"><span id="patientName"></button>

    </div>
  </div>

  <div class="topbar-right">
Connect√© en tant que <b><span id="nom-medecin"></span></b> (<span id="specialite"></span>)

  </div>
</div>

<header>
  <div class="left-header">
	  <button id="menu-toggle" class="menu-toggle">‚ò∞</button>
		
  </div>

</header>

<div class="app">


<nav>
    <div class="nav-title">Menu</div>
    <div id="navItems">
      <div class="nav-item" data-module="patient">üë§ <span>Identit√© Patient</span></div>
      <div class="nav-item" data-module="equipe">ü•º<span>√âquipe r√©f√©rente</span></div>
<div class="nav-item" data-module="admission">üóÇÔ∏è <span>Admission et orientation</span></div>
<div class="nav-item" data-module="dossier">üìã <span>Dossier M√©dical</span></div>
<div class="nav-item" data-module="constantes">ü©∫ <span>Constantes</span></div>
<div class="nav-item" data-module="medsurgences">üíä <span>M√©dicaments aux Urgences</span></div>
<div class="nav-item" data-module="examens">ü©ª <span>Examens</span></div>
<div class="nav-item" data-module="actes">üíâ <span>Actes</span></div>
<div class="nav-item" data-module="documents">üìë <span>Documents</span></div>
<div class="nav-item" data-module="sortie">üö™ <span>Sortie</span></div>
<div class="nav-item" data-module="historique">üìú <span>Historique</span></div>
<div class="nav-item" data-module="compte">ü™™ <span>Mon Compte</span></div>


    </div>
  </nav>

<div class="content">	
<section id="panel-patient" class="panel" style="display:none;">
 
    <h3>üë§ Identit√© patient</h3>
    
 
  <div>
  <label>CIP (Code d'Identification Patient)</label>
  <span id="idPatient"></span>
</div>

  <div>
    <label>Nom</label>
    <span id="nom"></span>
  </div>
  <div>
    <label>Pr√©nom</label>
    <span id="prenom"></span>
  </div>
  <div>
    <label>Sexe</label>
    <span id="sexe"></span>
  </div>
  <div>
    <label>√Çge</label>
    <span id="age"></span>
  </div>
   <div>
    <label>Vigilance(s)</label>
  <input type="text" id="vigilances" class="text2" />
  </div>
<div>
  <label>Allergies</label>
  <input type="text" id="allergies" placeholder="Ex : P√©nicilline, arachides..." class="text2" />


<div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
  <label style="margin:0;">Allergie(s) importantes</label>
  <label class="switch" style="margin:0;">
    <input type="checkbox" id="importanceAllergies">
    <span class="slider"></span>
  </label>
</div>


  <br><br>
  <button id="btnAdmin" class="btn-admin">üõ† Gestion Administrative</button>

	<button id="btnmailto">üìß Mailto - patient</button>
  <button id="btnVersPdf">üìÑ Cr√©ation d'acc√®s PDF patient</button>
</div>
</section>

<section id="panel-medsurgences" class="panel" style="display:none;">
    <h3>üíä Gestion des m√©dicaments aux Urgences</h3>

  <iframe
  id="medsurgencesFrame"
  style="width:100%; height:calc(100vh - 60px); border:none; border-radius:10px; overflow:hidden;">
</iframe>

</section>


<section id="panel-constantes" class="panel" style="display:none;">
  
    <h3>ü©∫ Constantes</h3>
 


<h4>Scope</h4>

<label class="switch">
  <input type="checkbox" id="patientScopeCheckbox">
  <span class="slider"></span>
</label>
<span style="margin-left:10px; vertical-align:middle;">üîå Patient scop√©</span>



<div id="scopeFields" style="display:none; margin-top:10px;">
  <label for="scopeNum">Num√©ro de scope</label>
  <input type="text" id="scopeNum" class="text1" />
  <button id="btnConnectScope">üîå Connecter</button>
  <span id="scopeLoading" style="display:none; margin-left:10px;">‚è≥ Connexion...</span>
</div>

<div id="scopeSuccess" style="display:none; margin-top:10px;">
  <button id="btnOpenScope">üñ•Ô∏è Ouvrir VisionScope2</button>
</div>


 <hr>
    <label for="temperature">üå° Temp√©rature (¬∞C)</label>
    <input type="number" id="temperature" step="0.1" class="text1"/>
    <label for="fc">‚ù§Ô∏è Fr√©quence cardiaque (bpm)</label>
    <input type="number" id="fc"class="text1" />
    <label for="ta">üíì Tension art√©rielle</label>
    <input type="text" id="ta" class="text1" />
    <label for="saturation">üí® Saturation (%)</label>
    <input type="number" id="saturation" min="0" max="100" step="1" class="text1"/>
    <label for="fr">üòÆüí® FR</label>
    <input type="number" id="fr" min="0" max="50" step="1" class="text1"/>
    <label for="douleur">üòñ Douleur /10</label>
    <input type="number" id="douleur" min="0" max="10" step="1" class = "text1"/>
	<br>
    <button id="btnGlasgow" style="margin-top:10px; background-color:#9b59b6;">üß† Score de Glasgow</button>
    <br><br>
    <button id="btnSaveConst">üíæ Enregistrer constantes</button>
 
  	<br>
  <hr>
	<br>
    <h4>Poids / Taille / IMC</h4>
    <div class="inline-fields">
      <div class="field-group">
        <label for="poids">Poids (kg)</label>
        <input type="number" id="poids" step="0.1" class="text1"/>
     
      <div class="field-group">
        <label for="taille">Taille (cm) </label>
        <input type="number" id="taille" step="1" class="text1"/>
      </div>
      <div class="field-group">
        <label>IMC</label>
        <span id="imc"></span>
      </div>
    </div>
		</div>
		<br>
    <button id="btnSavePoids">üíæ Enregistrer poids/taille/IMC</button>
  
</section>


<section id="panel-historique" class="panel" style="display:none;">

  <h3>üìú Historique</h3>

  <!-- üîç Recherche dans l‚Äôhistorique -->
  <input
    type="text"
    id="rechercheHistorique"
    placeholder="üîç Rechercher (motif, service, date, texte...)"
    style="
      width:100%;
      padding:10px;
      margin-bottom:15px;
      border-radius:8px;
      border:1px solid #ccc;
    "
  />

  <div id="hospitalisationsContent"></div>
</section>



<section id="panel-admission" class="panel" style="display:none;">
  
  <h3> üóÇÔ∏è Admission et orientation</h3>
   <label for="motif">ü§ï Motif d'entr√©e</label>
  <input type="text" id="motif" placeholder="Motif d'entr√©e" class="text2" />

  <label for="moyen">üöë Moyen d'entr√©e</label>
  <input type="text" id="moyen" placeholder="Moyen d'entr√©e" class="text2" />
  <label for="gravite" >üö® Gravit√©</label>
  <select id="gravite"class="text2" >
    <option value="P0">P0</option>
    <option value="P1">P1</option>
    <option value="P2">P2</option>
    <option value="P3">P3</option>
    <option value="Urgences_Vitales">Urgences Vitales</option>
    <option value="Administratif">Administratif</option>
  </select>

<label for="pdcStatut">üßæ Statut PEC</label>

<div style="width:100%; position:relative;">
  <input 
      type="text" 
      id="pdcStatut" 
      class="text2" 
      placeholder="Rechercher un statut PEC..."
      style="width:100%;"
  />

  <ul id="pdcSuggestions"
      style="
          position:absolute;
          width:100%;
          background:white;
          border:1px solid #ccc;
          list-style:none;
          padding:5px;
          margin-top:2px;
          border-radius:6px;
          display:none;
          max-height:150px;
          overflow-y:auto;
          z-index:999;
      ">
  </ul>
</div>


  <label for="service" >üè• Service id√©al</label>
  <select id="service" class="text2"><option value="">Chargement...</option></select>
<label for="circuit">üß≠ Circuit particulier</label>
<select id="circuit" class="text2">
  <option value=""></option>
  <option value="P√©diatrie">P√©diatrie</option>
  <option value="Traumatologie">Traumatologie</option>
  <option value="Gyn√©cologie">Gyn√©cologie</option>
  <option value="Psychiatrie">Psychiatrie</option>
  <option value="Ophtalmologie">Ophtalomologie</option>

</select>
 
    </section>


<section id="panel-equipe" class="panel" style="display:none;">

<h3>üë• √âquipe r√©f√©rente</h3>

<div class="equipe-grid">

  <div class="field-group field-with-clear">
    <label>üë®‚Äç‚öïÔ∏è M√©decin r√©f√©rent</label>
    <div class="input-wrapper">
      <input type="text" id="medecinReferent" placeholder="Rechercher un m√©decin..." autocomplete="off">
      <button type="button" class="clear-btn" id="clearMedecin">‚úñ</button>
    </div>
    <ul id="medecinSuggestions" class="suggestions"></ul>
    <div id="alerteMedecin" class="alerte-orange"></div>
  </div>

  <div class="field-group field-with-clear">
    <label>üë©‚Äç‚öïÔ∏è Infirmier r√©f√©rent</label>
    <div class="input-wrapper">
      <input type="text" id="infirmierReferent" placeholder="Rechercher un infirmier..." autocomplete="off">
      <button type="button" class="clear-btn" id="clearInfirmier">‚úñ</button>
    </div>
    <ul id="infirmierSuggestions" class="suggestions"></ul>
    <div id="alerteInfirmier" class="alerte-orange"></div>
  </div>

  <div class="field-group field-with-clear">
    <label>üßë‚Äç‚öïÔ∏è Interne</label>
    <div class="input-wrapper">
      <input type="text" id="interneReferent" placeholder="Rechercher un interne..." autocomplete="off">
      <button type="button" class="clear-btn" id="clearInterne">‚úñ</button>
    </div>
    <ul id="interneSuggestions" class="suggestions"></ul>
    <div id="alerteInterne" class="alerte-orange"></div>
  </div>

  <div class="field-group field-with-clear">
    <label>üéì Externe</label>
    <div class="input-wrapper">
      <input type="text" id="externeReferent" placeholder="Rechercher un externe..." autocomplete="off">
      <button type="button" class="clear-btn" id="clearExterne">‚úñ</button>
    </div>
    <ul id="externeSuggestions" class="suggestions"></ul>
    <div id="alerteExterne" class="alerte-orange"></div>
  </div>

</div>

</section>

<section id="panel-dossier" class="panel" style="display:none;">

    <h3>üìã Dossier M√©dical</h3>

      <label>Questionnaire IAO <button class="bouton-horloge" onclick="ajouterHorodatageDans('questionnaire')">‚è∞</button></label>
      <textarea id="questionnaire"></textarea>
      <label>Ant√©c√©dents <button class="bouton-horloge" onclick="ajouterHorodatageDans('antecedents')">‚è∞</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('antecedents')">üìÇ</button>
</label>
      <textarea id="antecedents" ></textarea>
      <label>Traitements en cours <button class="bouton-horloge" onclick="ajouterHorodatageDans('traitements')">‚è∞</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('traitements')">üìÇ</button>
</label>
      <textarea id="traitements" ></textarea>
	  
      <label>Histoire de la maladie <button class="bouton-horloge" onclick="ajouterHorodatageDans('histoire')">‚è∞</button></label>
      <textarea id="histoire" ></textarea>
	  
      <label>CR Auscultation Init.<button class="bouton-horloge" onclick="ajouterHorodatageDans('auscultation')">‚è∞</button></label>
      <textarea id="auscultation"></textarea>
	<br>
      <button onclick="enregistrerDossierMedical()">üíæ Enregistrer</button>
     
    	<br>
  <hr>

  
    <h3>üìà √âvolution aux urgences <button class="bouton-horloge" onclick="ajouterHorodatageDans('evolutionTexte')">‚è∞</button></h3>
    <textarea id="evolutionTexte"></textarea>
    <br>
    <button onclick="enregistrerEvolution()">üíæ Enregistrer</button>
 
</section>


<section id="panel-actes" class="panel" style="display:none;">

    <h3>üíâ Actes</h3>

  <label>Type d‚Äôacte</label>
  <input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" />
  <ul id="suggestionsActes"></ul>
  <label>üë®‚Äç‚öïÔ∏è R√©alis√© par</label>
  <select id="selectRealisateur"><option>‚è≥Chargement...</option></select>
  <label>üí¨ Remarques</label>
  <textarea type="text" id="remarqueActe"></textarea>
  <h4>Actes r√©alis√©s :</h4>
  
  <div id="actesListe"></div>
  <div class="modal-buttons">
    <button id="btnFermerActe">‚ùå Annuler</button>
    <button id="btnEnregistrerActe" class="success">‚úîÔ∏è Enregistrer</button>
  </div>
</section>
<section id="panel-examens" class="panel" style="display:none;">

    <h3>‚ò¢Ô∏è Examens</h3>
   
 
  
	<label>Examens demand√©s / r√©alis√©s</label>
<div id="examensListe" class="mt-2 p-2 border rounded bg-gray-50">Aucun examen enregistr√©</div>
  <button id="btnOuvrirModaleDemande" style="margin-top:10px;">‚ûï Nouvelle demande d‚Äôexamen</button>
 
  
</section>


<div class="modal-overlay" id="modalExamen" style="display:none;">
  <div class="modal">
    <h3>Demande d‚Äôexamen</h3>
    <button class="exam-button" onclick="toggleSublist('prise-sang-list')">ü©∏ Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (Num√©ration Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Calc√©mie"> Calc√©mie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan h√©patique"> Bilan h√©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan r√©nal"> Bilan r√©nal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="H√©moglobine glyqu√©e (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="S√©rologies virales (VIH, VHB, VHC)"> S√©rologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Recherche Alcool√©mie"> Alcool√©mie</label>
	  <label><input type="checkbox" onchange="toggleExam(this)" value="Prise de sang autre"> Autre</label>
  </div>
<button class="exam-button" onclick="toggleSublist('urine-list')">üß™ Examens urinaires</button>
<div class="sub-list" id="urine-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobact√©riologique des urines)"> ECBU</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Prot√©inurie des 24h"> Prot√©inurie 24h</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage cr√©atinine urinaire"> Cr√©atinine urinaire</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre">Examens Urinaires Autre</label>
</div>
  <button class="exam-button" onclick="toggleSublist('radio-list')">üì∏ Radiologie</button>
<div class="sub-list" id="radio-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du cr√¢ne"> Cr√¢ne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie Autre"> autre</label>

</div>

<button class="exam-button" onclick="toggleSublist('irm-list')">üß≤ IRM</button>
<div class="sub-list" id="irm-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM c√©r√©brale"> C√©r√©brale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM √©paule"> √âpaule</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="IRM autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('scanner-list')">üñ•Ô∏è Scanner</button>
<div class="sub-list" id="scanner-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner c√©r√©bral"> C√©r√©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner c√©r√©bral"> Angioscanner c√©r√©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Scanner autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('echo-list')">üß≠ √âchographie</button>
<div class="sub-list" id="echo-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie r√©nale"> R√©nale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie h√©patique"> H√©patique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie thyro√Ødienne"> Thyro√Ødienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie mammaire"> Mammaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie testiculaire"> Testiculaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie cardiaque (ETT)"> Cardiaque (ETT)</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres inf√©rieurs"> Doppler veineux MI</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler art√©riel des membres inf√©rieurs"> Doppler art√©riel MI</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value=" √âchographieautre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('eos-list')">ü¶¥ EOS</button>
<div class="sub-list" id="eos-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres inf√©rieurs"> Membres inf√©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres sup√©rieurs"> Membres sup√©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="EOS autre"> autre</label>
</div>
<h4>Examens s√©lectionn√©s :</h4>
<div id="examensSelectionnes" style="margin-bottom: 10px;"></div>

    <label for="commentaireExamen">üí¨ Commentaire</label>
    <textarea id="commentaireExamen" placeholder="D√©tails suppl√©mentaires..."></textarea>
     <button id="btnCancelExamen" class="secondary">‚ùå Fermer</button>
      <button id="btnSaveExamen">‚úÖ Valider</button>
    </div>
</div>
<section id="panel-sortie" class="panel" style="display:none;">
  
    <h3>üö™ Sortie</h3>


<h3>Type de sortie</h3>
    <label><input type="radio" name="typeSortie" value="Retour √† domicile" /> üè° Domicile</label><br/>
    <label><input type="radio" name="typeSortie" value="Hospitalisation" /> üè• Hospitalisation</label><br/>
    <label><input type="radio" name="typeSortie" value="Transfert" /> ‚ÜîÔ∏è Transfert</label><br/>
	    <label><input type="radio" name="typeSortie" value="D√©c√®s" />‚ö∞Ô∏è D√©c√®s</label><br/>
    <label>
      <input type="radio" name="typeSortie" value="autre" /> üî§ Autre
      <input type="text" id="champAutreSortie" placeholder="Pr√©cisez..." style="margin-top: 8px; display:none;" />
    </label>

  

    <h3>Options suppl√©mentaires</h3>
    <label><input type="checkbox" name="optionsSortie" value="Suivi a domicile" /> üìã Suivi √† domicile</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Avis specialiste" /> üë©‚Äç‚öïÔ∏è Avis sp√©cialiste</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Transport  en ambulance" /> üöë Transport ambulance</label><br/>
    <label>
      <input type="checkbox" name="optionsSortie" value="autreOption" /> üî§ Autre option
      <input type="text" id="champAutreOption" placeholder="Pr√©cisez..." style="margin-top: 8px; display:none;" />
    </label>

<h3>üíä Traitement de sortie</h3>
<textarea id="champTraitementSortie"	 rows="3" style="width:100%; margin-bottom: 10px;"></textarea>

  
    <div id="sortieListe"></div> 
    <div class="modal-buttons">
      <button id="btnAnnulerSortie">‚ùå Annuler</button>
      <button id="btnValiderSortie">‚úÖ Valider</button>
    </div>

  
</section>

<section id="panel-documents" class="panel" style="display:none;">
  <h3>üìë Documents</h3>

  <div class="docs-tabs">
        <div id="tab-docs" class="docs-tab active" onclick="openDocsTab('tab-docs','docs.html')">Documents du patient</div>

    <div id="tab-ordo" class="docs-tab active" onclick="openDocsTab('tab-ordo','Ordonnancierf.html')">Ordonnancier</div>
    <div id="tab-cert" class="docs-tab" onclick="openDocsTab('tab-cert','Certificatmedicalf.html')">Certificats</div>
    <div id="tab-exams" class="docs-tab" onclick="openDocsTab('tab-exams','prescriptionexamensf.html')">Examens</div>
        <div id="tab-rapport" class="docs-tab active" onclick="openDocsTab('tab-rapport','rapporthospitalisation.html')">Rapport d'hospitalisation</div>
    <div id="tab-fiches" class="docs-tab" onclick="openDocsTab('tab-fiches','fichesconseilf.html')">Fiches Conseils</div>
    <div id="tab-pdf" class="docs-tab" onclick="openDocsTab('tab-pdf','uploadpdff.html')">PDF patient</div>
    <div id="tab-etiq" class="docs-tab" onclick="openDocsTab('tab-etiq','etiquettesf.html')">√âtiquettes</div>
        <div id="tab-mail" class="docs-tab" onclick="openDocsTab('tab-mail','mailtof.html')">Mails</div>

  </div>

<iframe id="docsFrame" scrolling="auto"></iframe>

</section>

<section id="panel-compte" class="panel" style="display:none;">
    <h3>ü™™ Mon compte</h3>

  <iframe
  id="compteFrame"
  style="width:100%; height:calc(100vh - 60px); border:none; border-radius:10px; overflow:hidden;">
</iframe>
</section>



<!-- Modal Cl√¥ture -->
<div class="modal-overlay" id="modalCloture">
  <div class="modal" style="text-align: center;">
    <h3>‚è≥Cl√¥ture en cours...</h3>
    <div style="background:#eee; border-radius: 10px; overflow:hidden; margin-top: 15px;">
      <div id="clotureBar" style="height: 12px; background-color: #0078d4; width: 0%; transition: width 0.3s;"></div>
    </div>
    <p style="margin-top:10px; color:#666;">Merci de patienter</p>
  </div>
</div>


<!-- Modal Gestion Administrative -->
<div class="modal-overlay" id="modalAdmin">

  <div class="modal">
    <h3>üõ† Gestion Administrative</h3>
    
    <label for="adminId">ID Patient</label>
    <input type="text" id="adminId" disabled />
	
	<label for="adminNom">Nom</label>
    <input type="text" id="adminNom" />
	<label for="adminPrenom">Pr√©nom</label>
<input type="text" id="adminPrenom" />

	
	
	<label for="adminSexe">Sexe</label>
	<select id="adminSexe" >
  <option value="">-- S√©lectionnez --</option>
  <option value="M">M</option>
  <option value="Mme">Mme</option>
  <option value="L'enfant">L'enfant</option>
</select>

	<label for="adminNaissance">Date de naissance</label>
<input type="date" id="adminNaissance"  />

	
    <label for="adminAdresse">Adresse</label>
    <input type="text" id="adminAdresse" />

    <label for="adminTelephone">T√©l√©phone</label>
    <input type="text" id="adminTelephone" />

    <label for="adminEmail">Email</label>
    <input type="text" id="adminEmail" />

    <div class="modal-buttons">
	    <button type="button" id="readVitaleBtn" class="button" style="background-color: #28a745; color: white;">üÜî Lecture Carte Vitale</button>
      <button id="btnFacturer" class="success">üí∂ Facturer</button>
	    <button id="btnCloturer" style="flex:1; background-color:#d9534f;">‚úÖ Cl√¥turer hospitalisation</button>
            <br><br>
			<button id="btnFermerAdmin" class="danger">‚ùåFermer</button>
	  <button id="btnEnregistrerAdmin" class="primary">üíæEnregistrer</button>

    </div>
  </div>
</div>
 
<!-- üèÅ Modale de saisie du code de cl√¥ture -->
<div class="modal-overlay" id="modalCodeCloture" style="display:none;">
  <div class="modal">
    <h3>üîí Cl√¥ture de l‚Äôhospitalisation</h3>
    <label for="codeClotureInput">Entrez le CCH (Code de Cl√¥ture d'Hospitalisation) :</label>
    <input type="password" id="codeClotureInput" placeholder="CCH.....">
    <div class="modal-buttons">
      <button id="btnAnnulerCode" class="secondary">‚ùå Annuler</button>
      <button id="btnValiderCode" class="success">‚úÖ Valider</button>
    </div>
  </div>
</div>

<div id="vitaleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">‚è≥Lecture Carte Vitale en cours...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="facturationModale" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">‚è≥Chargement des informations...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="modal-overlay" id="modalGlasgow">
  <div class="modal">
    <h3>üß† Score de Glasgow</h3>
    <img src="glasgow.jpg" alt="√âchelle de Glasgow" style="width:100%; margin-bottom:15px; border-radius:8px;" />
    
    <label>üëÅ Ouverture des yeux (max 4)</label>
    <input type="number" id="glasgowYeux" min="1" max="4" />

    <label>üó£ R√©ponse verbale (max 5)</label>
    <input type="number" id="glasgowVerbal" min="1" max="5" />

    <label>üí™ R√©ponse motrice (max 6)</label>
    <input type="number" id="glasgowMoteur" min="1" max="6" />

    <label>üéØ Score total</label>
    <input type="number" id="glasgowTotal" disabled />

<div id="glasgowPronostic" style="margin: 10px 0; font-style: italic;"></div>
<div id="glasgowPronostic2" style="margin: 10px 0; font-style: italic;"></div>
    <div class="modal-buttons">
      <button id="btnFermerGlasgow" class="secondary">‚ùå Fermer</button>
      <button id="btnEnregistrerGlasgow" class="success">üíæ Enregistrer</button>
    </div>
  </div>
</div>


 </div>
</div>
<script>
   const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
	 firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
	// R√©cup√©rer l'ID du patient depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
 const patientId = new URLSearchParams(window.location.search).get("id");
// Cr√©er la r√©f√©rence au document patient
const patientRef = db.collection("patients").doc(patientId);

 // Conteneur global pour les bulles
let notificationContainer = document.getElementById('notification-container');
if (!notificationContainer) {
  notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  notificationContainer.style.position = 'fixed';
  notificationContainer.style.top = '12px';
  notificationContainer.style.right = '12px'; // EN HAUT √Ä DROITE
  notificationContainer.style.display = 'flex';
  notificationContainer.style.flexDirection = 'column';
  notificationContainer.style.gap = '8px'; // espace vertical entre bulles
  notificationContainer.style.zIndex = 9999;
  document.body.appendChild(notificationContainer);
}

// Fonction pour afficher une bulle
function afficherBulle(msg, type = 'info') {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.padding = '10px 14px';
  el.style.borderRadius = '8px';
  el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
  el.style.fontSize = '14px';
  el.style.fontWeight = '500';
  el.style.opacity = '0';
  el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  el.style.transform = 'translateY(-10px)';

  // --- Code couleur selon type ---
  switch (type) {
    case 'success':
      el.style.background = '#e6ffed'; // vert clair
      el.style.color = '#064e22';      // texte vert fonc√©
      break;
    case 'error':
      el.style.background = '#ffdede'; // rouge clair
      el.style.color = '#a00';         // texte rouge fonc√©
      break;
    case 'warning':
      el.style.background = '#fff4e5'; // orange clair
      el.style.color = '#663c00';      // texte orange fonc√©
      break;
    default: // info ou autre
      el.style.background = '#333';    // gris fonc√©
      el.style.color = '#fff';         // texte blanc
      break;
  }

  notificationContainer.appendChild(el);


  // Animation d'entr√©e
  requestAnimationFrame(() => {
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';
  });

  // Suppression automatique apr√®s 3 secondes
  setTimeout(() => {
    el.style.opacity = '0';
    el.style.transform = 'translateY(-10px)';
    el.addEventListener('transitionend', () => el.remove());
  }, 3000);
}

const listePDC = [
  "Attente enregistrement",
  "D√©chocage",
  "Acc√®s Direct IAO",
  "UV - Acc√®s direct couch√©s",
  "Attente dossier administratif",
  "IAO - M√©decin g√©n√©raliste",
  "IAO - cricuit court",
  "Attente examen",
  "Attente r√©sultats examen",
  "Attente 1ere consult med",
  "UHCD",
  "Attente 1ere consult int",
  "Attente 1ere consult ext",
  "Attente soins",
  "Attente transfert",
  "Attente consultation externe",
  "Attente d√©cision externe",
  "Circuit long"
];
// --- Barre recherche Statut PDC ---
const pdcInput = document.getElementById("pdcStatut");
const pdcSugg = document.getElementById("pdcSuggestions");

pdcInput.addEventListener("input", () => {
    const txt = pdcInput.value.toLowerCase();
    pdcSugg.innerHTML = "";

    if (txt.length === 0) {
        pdcSugg.style.display = "none";
        return;
    }

    const matches = listePDC.filter(s => s.toLowerCase().includes(txt));

    matches.forEach(m => {
        const li = document.createElement("li");
        li.textContent = m;
        li.style.padding = "6px";
        li.style.cursor = "pointer";
        li.onclick = () => {
            pdcInput.value = m;
            pdcSugg.style.display = "none";
            sauvegarderAdmissionPDC();  
        };
        pdcSugg.appendChild(li);
    });

    pdcSugg.style.display = matches.length > 0 ? "block" : "none";
});

document.addEventListener("click", (e) => {
    if (!pdcSugg.contains(e.target) && e.target !== pdcInput) {
        pdcSugg.style.display = "none";
    }
});
function sauvegarderAdmissionPDC() {
    if (!patientId) return;
 console.log("Fonction sauvegarde PDC ex√©cut√©e");
    console.log("Patient ID :", patientId);
    console.log("Valeur PDC :", document.getElementById("pdcStatut").value);
    const pdcValue = document.getElementById("pdcStatut").value || "";

    db.collection("patients")
      .doc(patientId)
      .update({ pdcStatut: pdcValue })
      .then(() => {
          console.log("Statut PDC enregistr√© :", pdcValue);
      })
      .catch((err) => {
          console.error("Erreur enregistrement PDC :", err);
      });
}

document.getElementById("pdcStatut").addEventListener("change", sauvegarderAdmissionPDC);

document.getElementById("pdcStatut").addEventListener("change", () => {
    console.log("Changement d√©tect√©, lancement sauvegarde");
    sauvegarderAdmissionPDC();
});
function ajouterBoutonEffacer(idChamp) {
    const champ = document.getElementById(idChamp);
    if (!champ) return;

    // Cr√©e le bouton croix
    const btn = document.createElement("button");
    btn.textContent = "‚ùå";
    btn.style.position = "absolute";
    btn.style.right = "8px";
    btn.style.top = "50%";
    btn.style.transform = "translateY(-50%)";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.cursor = "pointer";
    btn.style.fontSize = "14px";
    btn.style.opacity = "0.6";

    // Efface le champ au clic
    btn.addEventListener("click", () => {
        champ.value = "";
        champ.dispatchEvent(new Event("change")); // d√©clenche la sauvegarde si tu l‚Äôutilises
    });

    // Conteneur (n√©cessaire pour que la croix se positionne correctement)
    const wrapper = document.createElement("div");
    wrapper.style.position = "relative";
    wrapper.style.display = "inline-block";
    wrapper.style.width = "100%";

    // On place le champ et le bouton dedans
    champ.parentNode.insertBefore(wrapper, champ);
    wrapper.appendChild(champ);
    wrapper.appendChild(btn);
}

document.querySelector('[data-module="examens"]').addEventListener('click', async () => {
  try {
    const patientDoc = await db.collection("patients").doc(patientId).get();

    if (!patientDoc.exists) {
      window.location.href="aucun-patients.html";
      console.warn("Patient introuvable");
      return;
    }

    const data = patientDoc.data();

    // Le tableau des hospitalisations
    const hospitalisations = data.hospitalisations || [];

    if (hospitalisations.length === 0) {
      console.warn("Aucune hospitalisation trouv√©e");
      return;
    }

    // Trier par dateDebut d√©croissante pour obtenir la derni√®re
    hospitalisations.sort((a, b) => {
      return new Date(b.dateDebut) - new Date(a.dateDebut);
    });

    const derniereHospi = hospitalisations[0];

    // On transmet l'ID patient + l'objet hospitalisation (ou son index)
    await chargerExamens(patientId, derniereHospi.id || derniereHospi);

  } catch (e) {
    console.error("Erreur chargement examens :", e);
  }
});


function openTab(tabId, event) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
  document.querySelectorAll(".tablink").forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  if (event) event.currentTarget.classList.add("active");
   if (tabId === "tab-historique") {
    chargerHistoriqueComplet();
  }
}
// Affichage du module Ordonnancier


	
  function calculerAge(dateNaissance) {
    const birth = new Date(dateNaissance);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    if (
      now.getMonth() < birth.getMonth() ||
      (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age;
  }
// --- R√©f√©rences aux √©l√©ments ---
const sortieListe = document.getElementById("sortieListe");
const champAutreSortie = document.getElementById("champAutreSortie");
const champAutreOption = document.getElementById("champAutreOption");
const champTraitementSortie = document.getElementById("champTraitementSortie");
document.getElementById("btnValiderSortie").addEventListener("click", async () => {
  const type = document.querySelector('input[name="typeSortie"]:checked')?.value || "";
  const options = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  const sortie = {
    type,
    options,
    autreSortieTexte: type === "autre" ? champAutreSortie.value.trim() : "",
    autreOptionTexte: options.includes("autreOption") ? champAutreOption.value.trim() : "",
    destinationTransfert: document.getElementById("champDestinationTransfert")?.value || "",
    serviceHospitalisation: document.getElementById("champServiceHospitalisation")?.value || "",
    avisSpecialiste: document.getElementById("champAvisSpecialiste")?.value || "",
    traitementSortie: champTraitementSortie.value.trim()
  };

  try {
    await updateHospitalisationField("sortie", sortie);
    afficherSortieListe(sortie);
    afficherBulle("‚úîÔ∏è Sortie enregistr√©e", "success");
  } catch (err) {
    console.error("Erreur enregistrement sortie :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de la sortie", "error");
  }
});

document.getElementById("btnAnnulerSortie").addEventListener("click", () => {
  champAutreSortie.value = "";
  champAutreOption.value = "";
  champTraitementSortie.value = "";
  sortieListe.innerHTML = "<p>Aucune sortie enregistr√©e.</p>";
});

// Container dynamique pour les champs sp√©cifiques
let containerDynamique = document.getElementById("optionsSpecifiques");
if (!containerDynamique) {
  containerDynamique = document.createElement("div");
  containerDynamique.id = "optionsSpecifiques";

  // On r√©cup√®re la r√©f√©rence de l'√©l√©ment #sortieListe dans le panel Sortie
  const sortieListe = document.getElementById("sortieListe");

  if (sortieListe) {
    // On ins√®re containerDynamique avant sortieListe
    sortieListe.parentNode.insertBefore(containerDynamique, sortieListe);
  } else {
    // Fallback : si #sortieListe n'existe pas, on ajoute √† la fin du panel
    const panelSortie = document.getElementById("panel-sortie");
    if (panelSortie) {
      panelSortie.appendChild(containerDynamique);
    }
  }
}

async function chargerPatient(patientId) {
  afficherLoader();
  try {
    const doc = await db.collection("patients").doc(patientId).get();
    if (!doc.exists) {
window.location.href="aucun-patients.html";
      return;
    }

 const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    // --- Infos patient ---
	 document.getElementById("idPatient").textContent = patientId || "Non d√©fini";
    document.getElementById("nom").textContent = data.nom || "";
    document.getElementById("prenom").textContent = data.prenom || "";
    document.getElementById("sexe").textContent = data.sexe || "";
    document.getElementById("poids").value = data.poids || "";
    document.getElementById("taille").value = data.taille || "";
       document.getElementById("pdcStatut").value = data.pdcStatut || "";

    // Allergies
document.getElementById("allergies").value = data.allergies || "aucun";
document.getElementById("vigilances").value = data.vigilances || "aucune";

document.getElementById("importanceAllergies").checked = data.importanceAllergies === true;

const patientNameSpan = document.getElementById("patientName");

patientNameSpan.textContent =
  `Fiche Patient - ${data.prenom || ""} ${data.nom || ""} `;

const closeBtn = document.createElement("span");
closeBtn.className = "close-tab";
closeBtn.id = "closeBtn";
closeBtn.textContent = "‚ùå";

closeBtn.onclick = (e) => {
  e.stopPropagation();

  if (from) {
    window.location.href = `${from}.html`;
  } else {
    window.location.href = 'index.html';
  }
};

patientNameSpan.appendChild(closeBtn);





    // IMC
    const poids = parseFloat(data.poids);
    const taille = parseFloat(data.taille);
    const elImc = document.getElementById("imc");
    if (!isNaN(poids) && !isNaN(taille) && taille > 0) {
      elImc.textContent = (poids / ((taille / 100) ** 2)).toFixed(1);
    } else {
      elImc.textContent = "‚Äì";
    }

    // √Çge
    if (data.dateNaissance) {
      const age = calculerAge(data.dateNaissance);
      document.getElementById("age").textContent = !isNaN(age) ? `${age} ans` : "Inconnu";
    }

    // --- Hospitalisation courante ---
    if (hospi) {
      // üîπ Informations d‚Äôhospitalisation
      document.getElementById("gravite").value = hospi.gravite || "";
      document.getElementById("motif").value = hospi.motif || "";
      document.getElementById("moyen").value = hospi.moyen || "";
      document.getElementById("circuit").value = hospi.circuit || "";


      // üîπ Constantes vitales
      document.getElementById("temperature").value = hospi.constantes?.temperature || "";
      document.getElementById("fc").value = hospi.constantes?.fc || "";
      document.getElementById("ta").value = hospi.constantes?.ta || "";
      document.getElementById("saturation").value = hospi.constantes?.saturation || "";
	  document.getElementById("fr").value = hospi.constantes?.fr || "";
      document.getElementById("douleur").value = hospi.constantes?.douleur || "";

      // üîπ Dossier m√©dical (nouvelle section)
      const dm = hospi.dossierMedical || {};
	  document.getElementById("questionnaire").value = dm.questionnaire || "";
      document.getElementById("antecedents").value = dm.antecedents || "";
      document.getElementById("traitements").value = dm.traitements || "";
      document.getElementById("histoire").value = dm.histoire || "";
      document.getElementById("auscultation").value = dm.auscultation || "";

      // üîπ √âvolution aux urgences
      document.getElementById("evolutionTexte").value = hospi.evolution || "";

		if (hospi.sortie) {
  afficherSortieListe(hospi.sortie);
}

	}
   const hospiSnap = await db.collection("patients")
      .doc(patientId)
      .collection("hospitalisations")
      .orderBy("dateAdmission", "desc") // ou autre crit√®re
      .limit(1)
      .get();

    if (!hospiSnap.empty) {
      const hospiDoc = hospiSnap.docs[0];   // dernier s√©jour
      // --- Charger actes & examens depuis les sous-collections ---
      await chargerActes();
      await chargerExamens(patientId, hospiDoc.id);
    }

    // Services et R√©alisateurs
    chargerServices();
    chargerRealisateurs();
      await chargerEquipeReferente();
    
	
  } catch (err) {
    console.error("Erreur chargement patient :", err);
    afficherBulle("‚ùå Erreur de chargement", "error");
  } 
  masquerLoader();
}
// Champ allergies
document.getElementById("allergies").addEventListener("change", async () => {
  const value = document.getElementById("allergies").value.trim() || "aucun";
  await patientRef.update({ allergies: value });
  afficherBulle("üíæ Allergies enregistr√©es", "success");
});
document.getElementById("vigilances").addEventListener("change", async () => {
  const value = document.getElementById("vigilances").value.trim() || "aucun";
  await patientRef.update({ vigilances: value });
  afficherBulle("üíæ Vigilances enregistr√©es", "success");
});

// Switch allergie(s) importantes
document.getElementById("importanceAllergies").addEventListener("change", async () => {
  const isImportant = document.getElementById("importanceAllergies").checked;
  await patientRef.update({ importanceAllergies: isImportant });
  afficherBulle(isImportant ? "‚ö†Ô∏è Allergie(s) importantes activ√©e(s)" : "‚úÖ Pas d‚Äôallergie majeure", "default");
});

async function updateHospitalisationField(field, value) {
  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];

    hospitalisations[index] = { ...hospitalisations[index], [field]: value };

    await patientRef.update({ hospitalisations });

    ajouterEntreeHistorique(`Modification de ${field} : ${value}`);
    
  } catch (err) {
    console.error(`Erreur mise √† jour ${field} :`, err);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "error");
  }
}


	document.getElementById("btnOuvrirModaleDemande").addEventListener("click", () => {
  document.getElementById("modalExamen").style.display = "block";
});

	
// --- Rafra√Æchissement des champs dynamiques ---
function rafraichirChampsSortie() {
  const typeSortie = document.querySelector('input[name="typeSortie"]:checked')?.value;
  const optionsSortie = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  containerDynamique.innerHTML = "";

  if (typeSortie === "Transfert") {
    const label = document.createElement("label");
    label.textContent = "Destination du transfert";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champDestinationTransfert";
    input.placeholder = "Ex: CHU Lyon";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  if (typeSortie === "Hospitalisation") {
    const label = document.createElement("label");
    label.textContent = "Service hospitalisation";
    const select = document.createElement("select");
    select.id = "champServiceHospitalisation";

    // R√©cup√©ration dynamique depuis Firestore
    db.collection("r√©f√©rentiels").doc("sp√©cialit√©s").get().then(doc => {
      const data = doc.data();
      (data?.sp√©cialit√©s || []).forEach(service => {
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });
    });

    containerDynamique.appendChild(label);
    containerDynamique.appendChild(select);
  }

  if (optionsSortie.includes("Avis specialiste")) {
    const label = document.createElement("label");
    label.textContent = "Sp√©cialiste consult√©";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champAvisSpecialiste";
    input.placeholder = "Ex: Dr Dupont (Cardio)";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  // Affichage du champ "autre option"
  champAutreOption.style.display = optionsSortie.includes("autreOption") ? "block" : "none";
}
const params = new URLSearchParams(window.location.search);
const from = params.get('from'); // r√©cup√®re "urgences" ou autre



// --- Gestion champ "autre sortie" ---
document.querySelectorAll('input[name="typeSortie"]').forEach(radio => {
  radio.addEventListener("change", () => {
    champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
    rafraichirChampsSortie();
  });
});

document.querySelectorAll('input[name="optionsSortie"]').forEach(cb => {
  cb.addEventListener("change", rafraichirChampsSortie);
});

// --- Affichage sortie ---
function afficherSortieListe(sortie) {
  if (!sortie || !sortie.type) {
    sortieListe.innerHTML = "<p>Aucune sortie enregistr√©e.</p>";
    return;
  }

  let html = `
    <p><strong>Type de sortie :</strong> ${sortie.type}</p>
    <p><strong>Options :</strong> ${sortie.options?.join(", ") || "Aucune"}</p>
  `;

  if (sortie.destinationTransfert) html += `<p><strong>‚ÜîÔ∏è Destination :</strong> ${sortie.destinationTransfert}</p>`;
  if (sortie.serviceHospitalisation) html += `<p><strong>üè• Service :</strong> ${sortie.serviceHospitalisation}</p>`;
  if (sortie.avisSpecialiste) html += `<p><strong>üë®‚Äç‚öïÔ∏è Sp√©cialiste :</strong> ${sortie.avisSpecialiste}</p>`;
  if (sortie.autreOptionTexte) html += `<p><strong>üî§ Autre option :</strong> ${sortie.autreOptionTexte}</p>`;
  if (sortie.traitementSortie) html += `<p><strong>üíä Traitement de sortie :</strong> ${sortie.traitementSortie}</p>`;

  html += `<button id="btnSupprimerSortie" class="danger" style="margin-top:10px;">üóë Supprimer</button>`;
  sortieListe.innerHTML = html;

  document.getElementById("btnSupprimerSortie").addEventListener("click", async () => {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    delete hospitalisations[index].sortie;
    if (hospitalisations[index].traitementSortie) hospitalisations[index].traitementSortie = "";

    await patientRef.update({ hospitalisations });
    sortieListe.innerHTML = "<p>Sortie supprim√©e.</p>";
    afficherBulle("üóëÔ∏è Sortie supprim√©e", "success");
  });
}
document.addEventListener("DOMContentLoaded", () => {
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
  if (patientId) {
    chargerPatient(patientId);
  }
});


function formaterDate(dateStr) {
  if (!dateStr) return "";
  const match = dateStr.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (match) {
    const [_, jj, mm, aaaa] = match;
    return `${aaaa}-${mm}-${jj}`;
  }
  if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return dateStr;
  }
  return "";
}
    
// --- Recherche et suggestions d'actes ---
const inputActe = document.getElementById("rechercherActe");
const suggestionsActes = document.getElementById("suggestionsActes");

inputActe.addEventListener("input", async (e) => {
  const recherche = e.target.value.trim().toLowerCase();
  suggestionsActes.innerHTML = "";

  // attendre au moins 2 caract√®res
  if (recherche.length < 2) return;

  try {
    // üîπ R√©cup√®re la liste des actes depuis Firestore
    const doc = await db.collection("r√©f√©rentiels").doc("actes").get();
    const data = doc.data();
    const actes = data?.liste || [];

    // üîπ Filtrage des r√©sultats
    const filtres = actes.filter(a => a.toLowerCase().includes(recherche));

    if (filtres.length === 0) {
      suggestionsActes.innerHTML = "<li style='color:#999;'>Aucun r√©sultat</li>";
      return;
    }

    // üîπ Affichage des suggestions
    filtres.forEach(acte => {
      const li = document.createElement("li");
      li.textContent = acte;
      li.style.cursor = "pointer";
      li.style.padding = "5px";
      li.addEventListener("mouseover", () => li.style.background = "#eee");
      li.addEventListener("mouseout", () => li.style.background = "transparent");
      li.addEventListener("click", () => {
        inputActe.value = acte;      // remplir la barre avec l‚Äôacte choisi
        suggestionsActes.innerHTML = ""; // vider les suggestions
      });
      suggestionsActes.appendChild(li);
    });
  } catch (err) {
    console.error("Erreur recherche actes :", err);
    suggestionsActes.innerHTML = "<li style='color:red;'>‚ö†Ô∏è Erreur de chargement</li>";
  }
});


document.getElementById("gravite").addEventListener("change", e => {
  updateHospitalisationField("gravite", e.target.value);
});
document.getElementById("circuit").addEventListener("change", async (e) => {
   updateHospitalisationField("circuit", e.target.value);
});

document.getElementById("motif").addEventListener("blur", e => {
  updateHospitalisationField("motif", e.target.value.trim());
});
document.getElementById("moyen").addEventListener("blur", e => {
  updateHospitalisationField("moyen", e.target.value.trim());
});

async function ajouterEntreeHistorique(texte) {
  const date = new Date().toLocaleString();
  const entree = { date, texte };

  try {
   

    afficherHistorique(entree);
  } catch (error) {
    console.error("Erreur ajout historique :", error);
  }
}




  document.getElementById("btnSavePoids").addEventListener("click", async () => {
  const poids = parseFloat(document.getElementById("poids").value);
  const taille = parseFloat(document.getElementById("taille").value);

  if (!poids || !taille) {
    afficherBulle("‚ùå Veuillez entrer un poids et une taille valides", "warning");
    return;
  }

  try {
    await patientRef.update({ poids, taille });
    ajouterEntreeHistorique(`Poids/Taille/IMC enregistr√©s: ${poids}kg / ${taille}cm`);
    afficherBulle("‚úîÔ∏è Poids et taille enregistr√©s", "success");
    chargerPatient(patientId); // üîÑ recalcul IMC
  } catch (err) {
    console.error("Erreur enregistrement poids/taille :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement du poids/taille", "error");
  }
});





document.getElementById("btnSaveConst").addEventListener("click", async () => {
  const constantes = {
    temperature: document.getElementById("temperature").value.trim() || "",
    fc: document.getElementById("fc").value.trim() || "",
    ta: document.getElementById("ta").value.trim() || "",
    saturation: document.getElementById("saturation").value.trim() || "",
    fr: document.getElementById("fr").value.trim() || "",
    douleur: document.getElementById("douleur").value.trim() || ""
  };

  try {
    await updateHospitalisationField("constantes", constantes);
    afficherBulle("‚úîÔ∏è Constantes enregistr√©es", "success");
  } catch (err) {
    console.error("Erreur enregistrement constantes :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement des constantes", "error");
  }
});


  async function initialiserScope(patientId) {
  const doc = await patientRef.get();
  if (!doc.exists) return;

  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospi = data.hospitalisations?.[index] || {};

  const checkbox = document.getElementById("patientScopeCheckbox");
  const fields = document.getElementById("scopeFields");
  const successDiv = document.getElementById("scopeSuccess");
  const numInput = document.getElementById("scopeNum");

  // üîπ Lecture depuis Firestore
  if (hospi.scope) {
    checkbox.checked = hospi.scope.scopeActive || false;
    if (hospi.scope.scopeActive) {
      fields.style.display = "block";
      numInput.value = hospi.scope.numero || "";
      successDiv.style.display = "block";
    }
  }

  // üîπ Changement de statut du scope
  checkbox.addEventListener("change", async () => {
    const actif = checkbox.checked;
    if (!actif) {
      fields.style.display = "none";
      successDiv.style.display = "none";
      await updateHospitalisationField("scope", { scopeActive: false, numero: "" });
      afficherBulle("‚úîÔ∏è Scope d√©sactiv√©", "success");
      return;
    }
    fields.style.display = "block";
    await updateHospitalisationField("scope", { scopeActive: true, numero: "" });
  });

  // üîπ Simulation de connexion au scope
  document.getElementById("btnConnectScope").addEventListener("click", async () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("‚ùåVeuillez entrer un num√©ro de scope", "warning");
      return;
    }
    document.getElementById("scopeLoading").style.display = "inline";
    setTimeout(async () => {
      document.getElementById("scopeLoading").style.display = "none";
      successDiv.style.display = "block";
      await updateHospitalisationField("scope", { scopeActive: true, numero });
      afficherBulle(`‚úîÔ∏è Scope ${numero} connect√©`, "success");
    }, 1500);
  });

  // üîπ Ouverture du scope.html
  document.getElementById("btnOpenScope").addEventListener("click", () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("‚ùåNum√©ro de scope manquant", "warning");
      return;
    }
    window.location.href =`scope.html?id=${encodeURIComponent(patientId)}`;
  });
}

// üß† Int√©gration dans le chargement patient
document.addEventListener("DOMContentLoaded", async () => {
  if (patientId) {
    await chargerPatient(patientId);
    await initialiserScope(patientId);
  }
});

  const historiqueContainer = document.getElementById("historique");

// Fonction pour charger tout l'historique de l'hospitalisation en cours
async function chargerHistorique() {
  try {
    const doc = await patientRef.get();
    const data = doc.data();

    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    if (!hospi || !hospi.historique || hospi.historique.length === 0) {
      historiqueContainer.innerHTML = "<p>Aucune entr√©e dans l'historique.</p>";
      return;
    }

    historiqueContainer.innerHTML = ""; // on vide avant d'afficher

    hospi.historique.forEach(entry => {
      afficherHistorique(entry);
    });
    // üîÅ R√©appliquer le filtre apr√®s chargement
const recherche = document.getElementById("rechercheHistorique");
if (recherche && recherche.value.trim() !== "") {
  recherche.dispatchEvent(new Event("input"));
}

  } catch (error) {
    console.error("Erreur chargement historique :", error);
  }
}

// Fonction d'affichage d'une seule entr√©e dans le DOM
function afficherHistorique(entry) {
  const card = document.createElement("div");
  card.className = "card";

  // üîé TEXTE SERVANT √Ä LA RECHERCHE
  const texteRecherche = `
    ${entry.date || ""}
    ${entry.type || ""}
    ${entry.auteur || ""}
    ${entry.contenu || ""}
  `.toLowerCase();

  card.dataset.search = texteRecherche;

  card.innerHTML = `
    <p><strong>${entry.date}</strong></p>
    <p>${entry.contenu}</p>
  `;

  historiqueContainer.appendChild(card);
}


  function afficherHistoriqueAncienne(hospitalisation, index) {
    if (!historiqueAncienContainer) return;
    const titre = document.createElement("div");
    titre.innerHTML = `<strong style="color:#d9534f">Hospitalisation ${index + 1} (${hospitalisation.dateDebut} - ${hospitalisation.dateFin || "en cours"})</strong>`;
    historiqueAncienContainer.appendChild(titre);
    hospitalisation.historique?.forEach(entry => afficherHistorique(entry, "ancien"));
  }
  function clearHistoriqueAnciennes() {
    if(historiqueAncienContainer) historiqueAncienContainer.innerHTML = "";
  }
  function clearHistorique() {
    if(historiqueContainer) historiqueContainer.innerHTML = "";
  }
  const btnDemandeExamen = document.getElementById("btnDemandeExamen");
const fenetreExamens = document.getElementById("fenetreExamens");
const listeExamens = document.getElementById("listeExamens");
const btnOuvrirModaleDemande = document.getElementById("btnOuvrirModaleDemande");


const modalExamen = document.getElementById("modalExamen");
const typeExamen = document.getElementById("typeExamen");
const commentaireExamen = document.getElementById("commentaireExamen");
const btnSaveExamen = document.getElementById("btnSaveExamen");





btnOuvrirModaleDemande.addEventListener("click", () => {
  
  commentaireExamen.value = "";
  modalExamen.style.display = "flex";
});

// Modale annulation
btnCancelExamen.addEventListener("click", () => {
  modalExamen.style.display = "none";
});

document.getElementById("btnSaveExamen").addEventListener("click", async () => {
  const commentaire = document.getElementById("commentaireExamen").value.trim();

  // R√©cup√©rer tous les examens coch√©s
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']:checked");
  const examens = Array.from(checkboxes).map(cb => cb.value);

  if (examens.length === 0) {
    afficherBulle("‚ùå Veuillez s√©lectionner au moins un examen", "warning");
    return;
  }

  const date = new Date().toLocaleString();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    if (!hospitalisations[index].examens) hospitalisations[index].examens = [];

    // Ajouter chaque examen individuellement
    examens.forEach(type => {
      hospitalisations[index].examens.push({
        type,
        commentaire,
        dateDemande: date,
        realise: false
      });
    });

    await patientRef.update({ hospitalisations });

    modalExamen.style.display = "none";
    afficherBulle("‚úîÔ∏è Examens enregistr√©s", "success");
    ajouterEntreeHistorique(`üìã Examens demand√©s : ${examens.join(", ")}`);
	  reinitialiserFormulaireExamen();
	  chargerExamens();
  } catch (err) {
    console.error("Erreur enregistrement examens :", err);
    afficherBulle("‚ùå Erreur enregistrement", "error");
  }
  
});
	function reinitialiserFormulaireExamen() {
  // D√©coche tous les checkboxes dans le modal
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']");
  checkboxes.forEach(cb => cb.checked = false);

  // Vide le commentaire
  document.getElementById("commentaireExamen").value = "";
}

  // --- Gestion modale de saisie du code ---
const modalCode = document.getElementById("modalCodeCloture");
const inputCode = document.getElementById("codeClotureInput");
const btnAnnulerCode = document.getElementById("btnAnnulerCode");
const btnValiderCode = document.getElementById("btnValiderCode");

// üîπ Ouvrir la modale quand on clique sur "Cl√¥turer"
document.getElementById("btnCloturer").addEventListener("click", () => {
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

// üîπ Annuler ‚Üí fermer la modale
btnAnnulerCode.addEventListener("click", () => {
  modalCode.style.display = "none";
});

// üîπ Valider le code et ex√©cuter la cl√¥ture
btnValiderCode.addEventListener("click", async () => {
  const code = inputCode.value.trim();
  if (!code) {
    afficherBulle("‚ö†Ô∏è Veuillez entrer un code", "warning");
    return;
  }

  try {
    const codeDoc = await db.collection("patients").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = codeDoc.data().CCH;

    if (code !== codeAttendu) {
      afficherBulle("‚ùå Code incorrect", "warning");
      return;
    }

    // ‚úÖ Code correct ‚Üí d√©marrer la cl√¥ture
    modalCode.style.display = "none";
    document.getElementById("modalCloture").style.display = "flex";

    const bar = document.getElementById("clotureBar");
    bar.style.width = "0%";
    let progress = 0;

    const interval = setInterval(() => {
      progress += 1;
      bar.style.width = `${progress}%`;
      if (progress >= 100) clearInterval(interval);
    }, 30);

    // üïì Simulation du traitement de cl√¥ture
    setTimeout(async () => {
      try {
        const now = new Date().toLocaleString();
        const doc = await patientRef.get();
        const data = doc.data();
        const index = data.hospitalisationIndex ?? 0;
        const hospitalisations = data.hospitalisations || [];

        if (hospitalisations[index]) {
          hospitalisations[index].dateFin = now;
          hospitalisations[index].historique = hospitalisations[index].historique || [];
          hospitalisations[index].historique.push({ date: now, texte: "Hospitalisation cl√¥tur√©e" });
          hospitalisations[index].rapport = `Rapport d'hospitalisation pour ${data.nom} ${data.prenom} cl√¥tur√© le ${now}.`;
// üîÑ Mise √† jour automatique du Statut PDC lors de la cl√¥ture
if (patientId) {
    db.collection("patients").doc(patientId).update({
        pdcStatut: "Attente enregistrement"
    }).then(() => {
        console.log("Statut PDC mis √† jour : Attente enregistrement");
        const pdcField = document.getElementById("pdcStatut");
        if (pdcField) pdcField.value = "Attente enregistrement"; // mise √† jour affichage
    });
}

          await patientRef.update({
            hospitalisations,
            hospitalisationIndex: index + 1,
            hospitalisationActive: false
          });

          afficherBulle("‚úÖ Hospitalisation cl√¥tur√©e", "success");
// R√©cup√©ration des param√®tres de l'URL
const params = new URLSearchParams(window.location.search);
const from = params.get('from'); // r√©cup√®re "urgences" ou autre

// Redirection dynamique selon le param√®tre
if (from) {
    window.location.href = `${from}.html`;
} else {
    // Redirection par d√©faut si aucun param√®tre
    window.location.href = 'index.html';
}
        }
      } catch (error) {
        console.error("Erreur cl√¥ture hospitalisation :", error);
        afficherBulle("‚ö†Ô∏è Erreur de cl√¥ture", "error");
      } finally {
        document.getElementById("modalCloture").style.display = "none";
      }
    }, 3200);

  } catch (err) {
    console.error("Erreur lors de la v√©rification du code :", err);
    afficherBulle("Erreur de v√©rification du code", "error");
  }
});

  

document.getElementById("btnAdmin").addEventListener("click", () => {
   modalAdmin.classList.add("show");
});


 
document.getElementById("btnVersPdf").addEventListener("click", () => {
    window.location.href =`uploadpdf.html?id=${patientId}`;
  });

document.getElementById("btnmailto").addEventListener("click", () => {
    window.location.href =`mailto.html?id=${patientId}`;
  });
;

// Gestion Administrative
const modalAdmin = document.getElementById("modalAdmin");
const btnAdmin = document.getElementById("btnAdmin");
const btnFermerAdmin = document.getElementById("btnFermerAdmin");
const btnEnregistrerAdmin = document.getElementById("btnEnregistrerAdmin");
const btnFacturer = document.getElementById("btnFacturer");

btnAdmin.addEventListener("click", async () => {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    document.getElementById("adminId").value = patientId;
	document.getElementById("adminNom").value = data.nom || "";
    document.getElementById("adminPrenom").value = data.prenom || "";
    document.getElementById("adminSexe").value = data.sexe || "";
document.getElementById("adminNaissance").value = data.dateNaissance || "";
    document.getElementById("adminAdresse").value = data.adresse || "";
    document.getElementById("adminTelephone").value = data.telephone || "";
    document.getElementById("adminEmail").value = data.email || "";
 modalAdmin.classList.add("show");
  } catch (e) {
    console.error("Erreur ouverture admin :", e);
    afficherBulle("‚ùåErreur chargement gestion dministrative", "error");
  }
});

btnFermerAdmin.addEventListener("click", () => {
  modalAdmin.classList.remove("show");
});

btnEnregistrerAdmin.addEventListener("click", async () => {
  const adresse = document.getElementById("adminAdresse").value.trim();
  const telephone = document.getElementById("adminTelephone").value.trim();
  const email = document.getElementById("adminEmail").value.trim();
  const sexe = document.getElementById("adminSexe").value;
const dateNaissance = document.getElementById("adminNaissance").value.trim();




  try {
    await patientRef.update({ adresse, telephone, email, sexe, dateNaissance });
    afficherBulle("‚úîÔ∏è Coordonn√©es mises √† jour", "success");
    modalAdmin.style.display = "none";
  } catch (e) {
    console.error("Erreur maj admin :", e);
    afficherBulle("‚ùåErreur enregistrement donn√©es administratives", "error");
  }
});

btnFacturer.addEventListener("click", () => {
  window.location.href =`Facturation.html?id=${patientId}`;
});

let tousLesActesRealises = [];


const btnFermerActe = document.getElementById("btnFermerActe");
const btnEnregistrerActe = document.getElementById("btnEnregistrerActe");
const selectActe = document.getElementById("selectActe");
const champAutreActe = document.createElement("input");
champAutreActe.type = "text";
champAutreActe.id = "champAutreActe";
champAutreActe.placeholder = "Pr√©ciser le type d‚Äôacte";
champAutreActe.style.display = "none";
champAutreActe.style.marginTop = "8px";

document.getElementById("btnFermerActe").addEventListener("click", () => {
  afficherBulle("‚ÑπÔ∏è Fermeture sans enregistrement", "default");
});



let tousLesActesDispos = [];

async function chargerEtInitialiserRechercheActe() {
  try {
    const doc = await db.collection("r√©f√©rentiels").doc("actes").get();
    const data = doc.data();
    tousLesActesDispos = Array.isArray(data?.liste) ? data.liste : [];
  } catch (e) {
    console.error("Erreur chargement actes :", e);
    tousLesActesDispos = [];
  }

  const champ = document.getElementById("rechercherActe");
  const suggestions = document.getElementById("suggestionsActes");

  champ.addEventListener("input", () => {
    const texte = champ.value.toLowerCase().trim();
    suggestions.innerHTML = "";

    if (!texte) {
      suggestions.style.display = "none";
      return;
    }

    const filtres = tousLesActesDispos.filter(nom =>
      nom.toLowerCase().includes(texte)
    );

    filtres.forEach(nom => {
      const li = document.createElement("li");
      li.textContent = nom;
      li.style.padding = "6px 10px";
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        champ.value = nom;
        suggestions.style.display = "none";
      });
      suggestions.appendChild(li);
    });

    suggestions.style.display = filtres.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!champ.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.style.display = "none";
    }
  });
}


function mettreAJourListeActes(filtre) {
  const selectActe = document.getElementById("selectActe");
  selectActe.innerHTML = "";

  const actesFiltres = tousLesActesDispos.filter(acte =>
    acte.toLowerCase().includes(filtre)
  );

  actesFiltres.forEach(nom => {
    const opt = document.createElement("option");
    opt.value = nom;
    opt.textContent = nom;
    selectActe.appendChild(opt);
  });

  const optAutre = document.createElement("option");
  optAutre.value = "autre";
  optAutre.textContent = "üî§ Autre (√† pr√©ciser)";
  selectActe.appendChild(optAutre);
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  const doc = await db.collection("r√©f√©rentiels").doc("personnel").get();
  const data = doc.data();

  select.innerHTML = "";

  if (data && Array.isArray(data.liste)) {
    data.liste.forEach(nom => {
      const opt = document.createElement("option");
      opt.value = nom;
      opt.textContent = nom;
      select.appendChild(opt);
    });
  }
}



function ajouterFiltreTypeActe() {
  const select = document.createElement("select");
  select.id = "filtreTypeActe";
  select.innerHTML = `<option value="tous">Tous les types</option>`;
  document.getElementById("actesListe").before(select);

  const typesUniques = [...new Set(tousLesActesRealises.map(a => a.type))];
  typesUniques.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });

  select.addEventListener("change", (e) => {
    chargerActes();
  });
}

async function supprimerActeRealise(index) {
  if (!confirm("Supprimer cet acte ?")) return;

  const doc = await patientRef.get();
  const data = doc.data();
  const iHospi = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  const actes = [...(hospitalisations[iHospi].actes_realises || [])];
  const acteSupprim√© = actes[index];

  actes.splice(index, 1);
  hospitalisations[iHospi].actes_realises = actes;

  await patientRef.update({ hospitalisations });

  ajouterEntreeHistorique(`‚ùå Acte supprim√© : ${acteSupprim√©.type} (par ${acteSupprim√©.realisateur})`);
  afficherActesRealises(document.getElementById("filtreTypeActe")?.value || "tous");
  afficherBulle("üóëÔ∏è Acte supprim√©", "success");
}

document.getElementById("btnEnregistrerActe").addEventListener("click", async () => {
  const type = document.getElementById("rechercherActe").value.trim();
  const realisateur = document.getElementById("selectRealisateur").value;
  const remarque = document.getElementById("remarqueActe").value.trim();

  if (!type) {
    afficherBulle("‚ùå Veuillez saisir un type d‚Äôacte", "warning");
    return;
  }

  const acte = {
    type,
    realisateur,
    remarque,
   date: new Date().toLocaleString("fr-FR", {
  day: "2-digit",
  month: "2-digit",
  year: "numeric",
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit"
})

  };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];
    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].actes = hospitalisations[index].actes || [];
    hospitalisations[index].actes.push(acte);

    await patientRef.update({ hospitalisations });

    afficherBulle("‚úîÔ∏è Acte enregistr√©", "success");
    document.getElementById("rechercherActe").value = "";
    document.getElementById("remarqueActe").value = "";
  } catch (err) {
    console.error("Erreur enregistrement acte :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de l‚Äôacte", "error");
  }
});

async function chargerServices() {
  try {
    const doc = await db.collection("r√©f√©rentiels").doc("sp√©cialit√©s").get();
    const data = doc.data();
    const services = data?.sp√©cialit√©s || [];

    const select = document.getElementById("service");
    select.innerHTML = ""; // vide les anciennes options

    services.forEach(service => {
      const option = document.createElement("option");
      option.value = service;
      option.textContent = service;
      select.appendChild(option);
    });

    // Pr√©-remplir si une valeur existe
    const patientDoc = await patientRef.get();
    const patientData = patientDoc.data();
    const index = patientData.hospitalisationIndex ?? 0;
    const hospi = patientData.hospitalisations?.[index];
    if (hospi?.service) select.value = hospi.service || "";

  } catch (e) {
    console.error("Erreur chargement services :", e);
  }
}

// √âcouteur de modification
document.getElementById("service").addEventListener("change", async (e) => {
  const service = e.target.value;
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index] = {
      ...hospitalisations[index],
      service
    };

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Changement de service : ${service}`);
  } catch (err) {
    console.error("Erreur mise √† jour service :", err);
  }
});
	
function reinitialiserFormulaireActe() {
  document.getElementById("selectActe").value = "";
  document.getElementById("selectRealisateur").value = "";
  document.getElementById("remarqueActe").value = "";
  champAutreActe.value = "";
  champAutreActe.style.display = "none";
}

function formatDateHeure(dateString) {
  const date = new Date(dateString);
  const pad = (n) => n.toString().padStart(2, '0');
  const jour = pad(date.getDate());
  const mois = pad(date.getMonth() + 1);
  const annee = date.getFullYear();
  const heures = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  const secondes = pad(date.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}

document.getElementById('readVitaleBtn').addEventListener('click', () => {
  const modal = document.getElementById('vitaleModal');
  modal.style.display = 'flex';

  const duration = 3000 + Math.random() * 7000; // entre 3 et 10 secondes

  setTimeout(() => {
    modal.style.display = 'none';

    const isSuccess = Math.random() < 0.8; // 80% ok-20%erreur

    if (isSuccess) {
      afficherBulle("‚úÖ Lecture Carte Vitale termin√©e !", "success");
    } else {
      afficherBulle("‚ùå Erreur lecture Carte Vitale - Veuillez ressayer", "warning");
    }
  }, duration);
});

document.getElementById("btnGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "flex";
});

document.getElementById("btnFermerGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "none";
});

["glasgowYeux", "glasgowVerbal", "glasgowMoteur"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
    const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
    const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
    const total = yeux + verbal + moteur;
    document.getElementById("glasgowTotal").value = total;

    const pronostic = document.getElementById("glasgowPronostic");
    if (total <= 4) pronostic.innerText = " 7 % de bonne r√©cup√©ration et 87 % de mortalit√©.";
    else if (total <= 7) pronostic.innerText = "34 % de bonne r√©cup√©ration et 53 % de mortalit√©.";
    else if (total <= 10) pronostic.innerText = " 68 % de bonne r√©cup√©ration et 27 % de mortalit√©.";
    else pronostic.innerText = " 82 % de bonne r√©cup√©ration et 12 % de mortalit√©.";
  
  const pronostic2 = document.getElementById("glasgowPronostic2");
    if (total <= 6) pronostic.innerText = "Coma Profond";
    else if (total <= 9) pronostic.innerText = "Coma Lourd";
    else if (total <= 14) pronostic.innerText = "Somnoloence / Coma L√©ger";
    else pronostic.innerText = "Conscience Normale";
});
});
function toggleSublist(id) {
    const list = document.getElementById(id);
    list.style.display = list.style.display === "block" ? "none" : "block";
  }

	
document.getElementById("btnEnregistrerGlasgow").addEventListener("click", async () => {
  const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
  const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
  const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
  const total = yeux + verbal + moteur;
  const texte = `Score de Glasgow enregistr√© : ${total} (Yeux ${yeux}, Verbal ${verbal}, Moteur ${moteur})`;

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    hospitalisations[index].glasgow = { yeux, verbal, moteur, total, date: new Date().toISOString() };

    await patientRef.update({ hospitalisations });

    await ajouterEntreeHistorique(texte);
    afficherBulle("‚úîÔ∏è Score de Glasgow enregistr√©", "succcess");
    document.getElementById("modalGlasgow").style.display = "none";
  } catch (e) {
    console.error("Erreur enregistrement Glasgow :", e);
    afficherBulle("‚ùå Erreur enregistrement", "error");
  }
});
function ajouterHorodatage() {
  const textarea = document.getElementById("texteRemarque");
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR');
  const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const horodatage = `${dateStr} ${timeStr} - ${medecinNom} : `;

  textarea.value += textarea.value && !textarea.value.endsWith('\n') ? '\n' + horodatage : horodatage;
  textarea.focus();
}

function ajouterHorodatageDans(id) {
  const textarea = document.getElementById(id);
  if (!textarea) return;

  const horodatage = new Date().toLocaleString("fr-FR");
const insertion = `${horodatage} - ${window.medecinNom}\n`;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;

  const texteAvant = textarea.value.substring(0, start);
  const texteApres = textarea.value.substring(end);

  textarea.value = texteAvant + insertion + texteApres;

  const nouvellePosition = start + insertion.length;
  textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
  textarea.focus();
}


async function enregistrerDossierMedical() {
  const dossierMedical = {
    questionnaire: document.getElementById("questionnaire").value.trim(),
    antecedents: document.getElementById("antecedents").value.trim(),
    traitements: document.getElementById("traitements").value.trim(),
    histoire: document.getElementById("histoire").value.trim(),
    auscultation: document.getElementById("auscultation").value.trim()
  };

  try {
    await updateHospitalisationField("dossierMedical", dossierMedical);
    afficherBulle("‚úîÔ∏è Dossier m√©dical enregistr√©", "success");
  } catch (err) {
    console.error("Erreur enregistrement dossier m√©dical :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement du dossier m√©dical", "error");
  }
}



async function enregistrerEvolution() {
  const evolution = document.getElementById("evolutionTexte").value.trim();

  try {
    await updateHospitalisationField("evolution", evolution);
    afficherBulle("‚úîÔ∏è √âvolution enregistr√©e", "success");
  } catch (err) {
    console.error("Erreur enregistrement √©volution :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de l‚Äô√©volution", "error");
  }
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>‚è≥Chargement...</option>";
  try {
    const snapshot = await db.collection("r√©f√©rentiels").doc("r√©alisateurs").get();
    const data = snapshot.data();
    select.innerHTML = "";
    (data?.liste || []).forEach(realisateur => {
      const option = document.createElement("option");
      option.value = realisateur;
      option.textContent = realisateur;
      select.appendChild(option);
    });
  } catch (e) {
    console.error("Erreur chargement r√©alisateurs :", e);
    select.innerHTML = "<option>‚ö†Ô∏è Erreur chargement</option>";
  }
}

async function chargerHistoriqueComplet() {
  const contenu = document.getElementById("hospitalisationsContent");
  if (!contenu) {
    console.error("Element #hospitalisationsContent introuvable");
    return;
  }
  contenu.innerHTML = "<p>‚è≥ Chargement...</p>";

  try {
    const patientDoc = await db.collection("patients").doc(patientId).get();
    if (!patientDoc.exists) {
      contenu.innerHTML = "<p>‚ùå Patient introuvable</p>";
      window.location.href="aucun-patients.html";

      return;
    }

    const data = patientDoc.data();
    let hospitalisations = Array.isArray(data.hospitalisations) ? data.hospitalisations : [];

    // on enl√®ve la derni√®re hospitalisation (courante)
    if (hospitalisations.length > 1) {
      hospitalisations = hospitalisations.slice(0, -1);
    } else {
      hospitalisations = [];
    }

    if (hospitalisations.length === 0) {
      contenu.innerHTML = "<p>Aucune hospitalisation ant√©rieure.</p>";
      return;
    }

    contenu.innerHTML = "";

    // afficher les hospitalisations les plus r√©centes d'abord
    hospitalisations
      .slice()
      .reverse()
      .forEach((hospi, idx) => {
        const card = document.createElement("div");
        card.className = "card";

        // üè• titre avec num√©ro d‚Äôhospitalisation
    const numero = hospitalisations.length - idx;


        const titre = document.createElement("h2");
        titre.textContent = `üè• Hospitalisation n¬∞${numero}`;
        titre.style.color = "#0078d4";
        titre.style.borderBottom = "3px solid #0078d4";
        titre.style.paddingBottom = "5px";
        titre.style.marginTop = "0";
        titre.style.marginBottom = "15px";

        // --- Donn√©es de l'hospitalisation ---
        const date = hospi.dateDebut || "Date inconnue";
        const datef = hospi.dateFin || "Date inconnue";
        const motif = hospi.motif || "‚Äî";
        const gravite = hospi.gravite || "‚Äî";
        const evolution = hospi.evolution || "Aucune √©volution enregistr√©e.";
        const dossier = hospi.dossierMedical || {};
        const sortie = hospi.sortie || null;
        const rapport = hospi.rapport || "Pas de rapport d'hospitalisation valid√©";

        // --- Construction du contenu HTML ---
        const parts = [];
        parts.push(`<div class="entry"><strong>üìÖ Admission :</strong> ${date}</div>`);
        parts.push(`<div class="entry"><strong>üìÖ Sortie :</strong> ${datef}</div>`);
        parts.push(`<div class="entry"><strong>Motif :</strong> ${motif}</div>`);
        parts.push(`<div class="entry"><strong>Gravit√© :</strong> ${gravite}</div>`);
        parts.push(`<hr>`);
        parts.push(`<h3>üìã Dossier m√©dical</h3>`);
        parts.push(`<p><strong>Questionnaire IAO :</strong><br>${dossier.questionnaire || "‚Äî"}</p>`);
        parts.push(`<p><strong>Ant√©c√©dents :</strong><br>${dossier.antecedents || "‚Äî"}</p>`);
        parts.push(`<p><strong>Traitements :</strong><br>${dossier.traitements || "‚Äî"}</p>`);
        parts.push(`<p><strong>Histoire de la maladie :</strong><br>${dossier.histoire || "‚Äî"}</p>`);
        parts.push(`<p><strong>CR Auscultation :</strong><br>${dossier.auscultation || "‚Äî"}</p>`);
        parts.push(`<hr>`);
        parts.push(`<h3>üìà √âvolution aux urgences</h3>`);
        parts.push(`<p style="white-space:pre-wrap">${evolution}</p>`);

        // --- Sortie ---
        if (sortie) {
          parts.push(`<hr>`);
          parts.push(`<h3>üö™ Sortie</h3>`);
          parts.push(`<p><strong>Type :</strong> ${sortie.type || "‚Äî"}</p>`);
          if (sortie.serviceHospitalisation)
            parts.push(`<p><strong>üè• Service hospitalisation :</strong> ${sortie.serviceHospitalisation}</p>`);
          if (sortie.destinationTransfert)
            parts.push(`<p><strong>‚ÜîÔ∏è Destination transfert :</strong> ${sortie.destinationTransfert}</p>`);
          if (sortie.avisSpecialiste)
            parts.push(`<p><strong>üë©‚Äç‚öïÔ∏è Avis sp√©cialiste :</strong> ${sortie.avisSpecialiste}</p>`);
          if (Array.isArray(sortie.options) && sortie.options.length > 0)
            parts.push(`<p><strong>üìã Options :</strong> ${sortie.options.join(", ")}</p>`);
          if (sortie.traitementSortie)
            parts.push(`<p><strong>üíä Traitement de sortie :</strong><br>${sortie.traitementSortie}</p>`);
          if (sortie.autreSortieTexte)
            parts.push(`<p><strong>üî§ Autre :</strong> ${sortie.autreSortieTexte}</p>`);
          if (sortie.autreOptionTexte)
            parts.push(`<p><strong>üî§ Autre option :</strong> ${sortie.autreOptionTexte}</p>`);
        }

        parts.push(`<p><strong></strong> ${rapport}</p>`);

        // --- Injection dans la carte ---
        card.innerHTML = parts.join("\n");
        card.prepend(titre); // ‚úÖ ajoute le titre au d√©but sans l'√©craser
        contenu.appendChild(card);
        card.style.display = "";

      });

  } catch (err) {
    console.error("Erreur chargement historique :", err);
    contenu.innerHTML = "<p>‚ùå Erreur lors du chargement de l'historique.</p>";
  }
}






async function chargerExamens() {
  try {
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const data = snap.data();
    const hosp = data.hospitalisations?.[data.hospitalisationIndex];
    if (!hosp || !hosp.examens) {
      document.getElementById("examensListe").innerHTML = "<i>Aucun examen enregistr√©.</i>";
      return;
    }

    const liste = hosp.examens.map(ex => `
      <div class="examen-encart" style="margin-bottom:8px; padding:10px; border-radius:8px; background:${ex.realise ? '#eaf9ea' : '#f5faff'};">
        <p><b>‚ò¢Ô∏èType :</b> ${ex.type || "N/A"}</p>
        <p><b>üí¨Commentaire :</b> ${ex.commentaire || ""}</p>
        <p><b>üìÖDate demande :</b> ${ex.dateDemande || "?"}</p>
        ${ex.realise ? `<p><b>‚úÖ R√©alis√© le :</b> ${ex.dateRealisation || "?"}</p>
		<p><b>üìÑCompte rendu :</b> ${ex.compteRendu || ""}</p>` : ""}
      </div>
    `).join("");

    document.getElementById("examensListe").innerHTML = liste || "<i>Aucun examen enregistr√©.</i>";
  } catch (e) {
    console.error("Erreur lors du chargement des examens :", e);
    document.getElementById("examensListe").innerHTML = "<i>Erreur de chargement.</i>";
  }
}

const originalOpenTab = window.openTab;
window.openTab = function(tabName, evt) {
  originalOpenTab(tabName, evt);
  if (tabName === "tab-exam-actes") {
    chargerExamens();
  }
};
async function chargerActes() {
  try {
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const data = snap.data();
    const hosp = data.hospitalisations?.[data.hospitalisationIndex];

    // Si aucun acte trouv√©
    if (!hosp || !hosp.actes) {
      document.getElementById("actesListe").innerHTML = "<i>Aucun acte enregistr√©.</i>";
      return;
    }

    // Construire l'affichage HTML
    const liste = hosp.actes.map((acte, i) => `
  <div class="prescription-item" style="margin-bottom:8px; padding:10px; border-radius:8px; background:#f5faff;">
    <p><b>üíâ Type :</b> ${acte.type || "N/A"}</p>
    <p><b>üë®‚Äç‚öïÔ∏è R√©alis√© par :</b> ${acte.realisateur || "?"}</p>
    <p><b>üìÖ Date :</b> ${acte.date || "?"}</p>
    ${acte.remarque ? `<p><b>üí¨ Remarque :</b> ${acte.remarque}</p>` : ""}
    <button class="btn-delete" onclick="supprimerActe(${i})">üóë</button>
  </div>
`).join("");
    document.getElementById("actesListe").innerHTML = liste || "<i>Aucun acte enregistr√©.</i>";
  } catch (e) {
    console.error("Erreur lors du chargement des actes :", e);
    document.getElementById("actesListe").innerHTML = "<i>Erreur de chargement.</i>";
  }
}


async function supprimerActe(indexActe) {
  try {
    if (!confirm("Supprimer cet acte ?")) return;

    // Charger le document patient
    const snap = await patientRef.get();
    if (!snap.exists) {
      window.location.href="aucun-patients.html";

      afficherBulle("‚ùå Patient introuvable", "error");
      return;
    }

    const data = snap.data();
    const hospIndex = data.hospitalisationIndex ?? 0;
    const hospitalisations = data.hospitalisations || [];
    const hosp = hospitalisations[hospIndex];

    if (!hosp || !hosp.actes) {
      afficherBulle("‚ùå Aucun acte √† supprimer", "warning");
      return;
    }

    // Supprimer l'acte √† l'indice donn√©
    hosp.actes.splice(indexActe, 1);

    // Mettre √† jour Firestore
    hospitalisations[hospIndex] = hosp;
    await patientRef.update({ hospitalisations });

    afficherBulle("üóëÔ∏è Acte supprim√©", "success");
    await chargerActes(); // üîÑ Rafra√Æchir la liste √† l‚Äô√©cran
  } catch (err) {
    console.error("Erreur suppression acte :", err);
    afficherBulle("‚ùå Erreur lors de la suppression", "error");
  }
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>‚è≥ Chargement...</option>";

  try {
    // On suppose que tu stockes les r√©alisateurs dans "r√©f√©rentiels/realisateurs"
    const doc = await db.collection("r√©f√©rentiels").doc("personnel").get();
    const data = doc.data();
    const liste = data?.liste || [];

    if (liste.length === 0) {
      select.innerHTML = "<option>Aucun disponible</option>";
      return;
    }

    select.innerHTML = "";
    liste.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Erreur chargement r√©alisateurs :", err);
    select.innerHTML = "<option>‚ö†Ô∏è Erreur de chargement</option>";
  }
}
// --- Fonction pour charger et afficher les examens ---

async function remplirDepuisAncienneHospi(champ) {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    if (index <= 0) {
      afficherBulle("‚ùå Aucune hospitalisation ant√©rieure", "warning");
      return;
    }

    const ancienne = data.hospitalisations?.[index - 1]?.dossierMedical;
    if (!ancienne || !ancienne[champ]) {
      afficherBulle(`‚ùå Pas d'ancien contenu pour ${champ}`, "warning");
      return;
    }

    const contenu = ancienne[champ].trim();
    const textarea = document.getElementById(champ);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const avant = textarea.value.substring(0, start);
    const apres = textarea.value.substring(end);
    const insertion = contenu + "\n";

    textarea.value = avant + insertion + apres;

    const nouvellePosition = start + insertion.length;
    textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
    textarea.focus();

    afficherBulle(`üìÅ Ancien ${champ} ins√©r√©`, "default");

  } catch (err) {
    console.error("Erreur r√©cup√©ration donn√©es pr√©c√©dentes :", err);
    afficherBulle("‚ùå Erreur de r√©cup√©ration", "error");
  }
}




document.addEventListener("DOMContentLoaded", () => {
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";

  if (patientId) {
    chargerPatient(patientId);   // ‚úÖ passer l‚ÄôID
    chargerActes();
  } else {
    afficherBulle("‚ùå Aucun patientId fourni dans l‚ÄôURL", "warning");
  }
});


	// --- Affiche l‚Äô√©cran de chargement ---
window.afficherLoader = function() {
  let loader = document.getElementById("loadingScreen");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loadingScreen";
    loader.innerHTML = `
      <div class="loader-content">
        <div class="spinner"></div>
        <h2>Chargement...</h2>
      </div>
    `;
    document.body.appendChild(loader);
  }
  loader.style.display = "flex";
  loader.classList.remove("hidden");
};

// --- Masque l‚Äô√©cran de chargement ---
window.masquerLoader = function() {
  const loader = document.getElementById("loadingScreen");
  if (loader) {
    loader.classList.add("hidden");
    setTimeout(() => {
      loader.style.display = "none";
    }, 500); // d√©lai pour l‚Äôanimation
  }
};

function openDocsTab(tabId, file) {
    // r√©cup√®re l‚ÄôID du patient
    const url = file + "?id=" + patientId;

    // active l‚Äôonglet
    document.querySelectorAll(".docs-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");

    // charge l‚ÄôURL avec ?id=
    document.getElementById("docsFrame").src = url;
}
function openSection(panelId) {
    // Masquer toutes les sections
    document.querySelectorAll(".panel").forEach(panel => {
        panel.classList.remove("active");
        panel.style.display = "none";
    });

    // Activer la section demand√©e
    const panel = document.getElementById(panelId);
    if (panel) {
        panel.style.display = "block";
        panel.classList.add("active");
    }

    // Mettre √† jour la barre lat√©rale si elle existe
    document.querySelectorAll(".nav-item").forEach(item => {
        item.classList.remove("active");
        if (item.dataset.module === panelId.replace("panel-", "")) {
            item.classList.add("active");
        }
        if (panelId === "panel-medsurgences") {
    const url = "medsurgences.html?id=" + patientId;
    document.getElementById("medsurgencesFrame").src = url;
}
if (panelId === "panel-compte") {
    const url = "viewaccount.html";
    document.getElementById("compteFrame").src = url;
}
    });
}
window.openDocumentFromMenu = function(tabId, file) {
    // 1Ô∏è‚É£ Ouvrir la section Documents
    openSection('panel-documents');

    // 2Ô∏è‚É£ Activer l'onglet d√©sir√©
    document.querySelectorAll(".docs-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");

    // 3Ô∏è‚É£ Construire l'URL avec le patientId
    const url = file + "?id=" + patientId;

    // 4Ô∏è‚É£ Charger dans l‚Äôiframe
    document.getElementById("docsFrame").src = url;
};



// ===============================
// üë• √âQUIPE R√âF√âRENTE ‚Äî VERSION D√âFINITIVE (SANS DATE)
// ===============================

const patientIdEquipe = new URLSearchParams(window.location.search).get("id");
const patientRefEquipe = db.collection("patients").doc(patientIdEquipe);

// ===============================
// üîé Utilitaire hospitalisation courante
// ===============================
function getHospFromData(data) {
  const idx = data.hospitalisationIndex;
  if (!Array.isArray(data.hospitalisations) || !data.hospitalisations[idx]) {
    throw "Hospitalisation invalide";
  }
  return { idx, hosp: data.hospitalisations[idx] };
}

// ===============================
// üíæ SAUVEGARDE √âQUIPE (TRANSACTION SAFE)
// ===============================
async function saveEquipe(roleKey, equipeData) {
  await db.runTransaction(async (tx) => {
    const snap = await tx.get(patientRefEquipe);
    if (!snap.exists) throw "Patient introuvable";

    const data = snap.data();
    const { idx } = getHospFromData(data);

    const hospitalisations = [...data.hospitalisations];

    hospitalisations[idx] = {
      ...hospitalisations[idx],
      equipe: {
        ...(hospitalisations[idx].equipe || {}),
        [roleKey]: equipeData
      }
    };

    tx.update(patientRefEquipe, { hospitalisations });
  });
}

// ===============================
// ‚ùå SUPPRESSION √âQUIPE
// ===============================
async function removeEquipe(roleKey) {
  await db.runTransaction(async (tx) => {
    const snap = await tx.get(patientRefEquipe);
    if (!snap.exists) return;

    const data = snap.data();
    const { idx } = getHospFromData(data);

    const hospitalisations = [...data.hospitalisations];
    if (hospitalisations[idx].equipe) {
      delete hospitalisations[idx].equipe[roleKey];
    }

    tx.update(patientRefEquipe, { hospitalisations });
  });
}

// ===============================
// üë• CHARGEMENT √âQUIPE
// ===============================
async function chargerEquipeReferente() {
  const snap = await patientRefEquipe.get();
  if (!snap.exists) return;

  const data = snap.data();
  const { hosp } = getHospFromData(data);
  const equipe = hosp.equipe || {};

  setEquipeInput("medecinReferent", equipe.medecinReferent, "doc", "alerteMedecin");
  setEquipeInput("infirmierReferent", equipe.infirmierReferent, "infirmier", "alerteInfirmier");
  setEquipeInput("interneReferent", equipe.interneReferent, "Int", "alerteInterne");
  setEquipeInput("externeReferent", equipe.externeReferent, "Ext", "alerteExterne");
}

// ===============================
// üîé Recherche utilisateur
// ===============================
function setupUserSearchEquipe(inputId, listId, expectedType, alertId, roleKey) {
  const input = document.getElementById(inputId);
  const list = document.getElementById(listId);
  const alertBox = document.getElementById(alertId);

  input.addEventListener("input", async () => {
    const q = input.value.toLowerCase();
    list.innerHTML = "";
    list.style.display = "none";
    if (alertBox) alertBox.style.display = "none";
    if (q.length < 2) return;

    const snap = await db.collection("medecins").get();

    snap.forEach(d => {
      const u = d.data();
      if (!u.nom.toLowerCase().includes(q)) return;

      const li = document.createElement("li");
      li.textContent = `${u.nom} (${u.type})`;

      li.onclick = async () => {
        const equipeData = {
          id: d.id,
          nom: u.nom,
          type: u.type
        };

        await saveEquipe(roleKey, equipeData);

        input.value = u.nom;
        list.style.display = "none";
        afficherBulle("‚úÖ √âquipe enregistr√©e", "success");

        if (expectedType && u.type !== expectedType && alertBox) {
          alertBox.textContent = `‚ö†Ô∏è ${u.type} au lieu de ${expectedType}`;
          alertBox.style.display = "block";
        }

        chargerEquipeReferente();
      };

      list.appendChild(li);
      list.style.display = "block";
    });
  });
}

// ===============================
// ‚ùå Boutons croix
// ===============================
function setupClearButton(inputId, clearBtnId, roleKey) {
  document.getElementById(clearBtnId).onclick = async () => {
    await removeEquipe(roleKey);
    document.getElementById(inputId).value = "";
    afficherBulle("‚úÖ Membre supprim√©", "success");
    chargerEquipeReferente();
  };
}

// ===============================
// üîî UI
// ===============================
function setEquipeInput(inputId, data, expectedType, alertId) {
  const input = document.getElementById(inputId);
  const alertBox = document.getElementById(alertId);

  if (!data) {
    input.value = "";
    if (alertBox) alertBox.style.display = "none";
    return;
  }

  input.value = data.nom;
  if (expectedType && data.type !== expectedType && alertBox) {
    alertBox.textContent = `‚ö†Ô∏è ${data.type} au lieu de ${expectedType}`;
    alertBox.style.display = "block";
  } else if (alertBox) {
    alertBox.style.display = "none";
  }
}

// ===============================
// üöÄ INIT
// ===============================
setupUserSearchEquipe("medecinReferent", "medecinSuggestions", "doc", "alerteMedecin", "medecinReferent");
setupUserSearchEquipe("infirmierReferent", "infirmierSuggestions", "infirmier", "alerteInfirmier", "infirmierReferent");
setupUserSearchEquipe("interneReferent", "interneSuggestions", "Int", "alerteInterne", "interneReferent");
setupUserSearchEquipe("externeReferent", "externeSuggestions", "Ext", "alerteExterne", "externeReferent");

setupClearButton("medecinReferent", "clearMedecin", "medecinReferent");
setupClearButton("infirmierReferent", "clearInfirmier", "infirmierReferent");
setupClearButton("interneReferent", "clearInterne", "interneReferent");
setupClearButton("externeReferent", "clearExterne", "externeReferent");

chargerEquipeReferente();


async function getHospitalisationEnCours() {
  const snap = await db
    .collection("patients")
    .doc(idPatient)
    .collection("hospitalisations")
    .where("cloturee", "==", false)
    .limit(1)
    .get();

  if (snap.empty) return null;
console.log("snap empty ?", snap.empty);
if (!snap.empty) console.log("Hospitalisation trouv√©e :", snap.docs[0].id);
  return snap.docs[0].id;
}

const input = document.getElementById("rechercheHistorique");

// üî• on supprime toute logique parasite
input.replaceWith(input.cloneNode(true));
const cleanInput = document.getElementById("rechercheHistorique");

cleanInput.addEventListener("input", function () {
  const recherche = this.value.toLowerCase().trim();

  document.querySelectorAll("#hospitalisationsContent .card")
    .forEach(card => {
      const texte = card.textContent.toLowerCase();
      card.style.display = texte.includes(recherche) ? "" : "none";
    });
});




document.getElementById("rechercheHistorique").addEventListener("keydown", function(e){
  if (e.key === "Escape") {
    this.value = "";
    this.dispatchEvent(new Event("input"));
  }
});


// Ligne de test de fin
console.log("Script termin√© correctement ‚úÖ");
</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

   let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
        medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici          
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});
function initNavigation() {
  const items = document.querySelectorAll('.nav-item');

  items.forEach(item => {
    item.addEventListener('click', () => {
      // Gestion active sur les boutons
      items.forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      // Masquer tous les panels proprement (via classes)
      document.querySelectorAll('section[id^="panel-"]').forEach(sec => {
        sec.classList.remove('active');
      });

      // Afficher le panel correspondant en ajoutant la classe active
      const module = item.getAttribute('data-module');
      const panel = document.getElementById('panel-' + module);
      if (panel) panel.classList.add('active');

      // Charger l‚Äôhistorique si n√©cessaire
      if (module === 'historique') {
        if (typeof chargerHistoriqueComplet === 'function') chargerHistoriqueComplet();
      }

      // Gestion sp√©cifique : mode Documents -> scroll interne iframe
      if (module === 'documents') {
        document.body.classList.add('no-scroll-docs'); // voir CSS que tu as ajout√© avant
      } else {
        document.body.classList.remove('no-scroll-docs');
      }
    });
  });
  // Gestion sp√©ciale de l'ouverture de la section Documents
document.querySelector('[data-module="documents"]').addEventListener('click', () => {

    const last = localStorage.getItem("lastDocsTab");

    if (last) {
        // üîÅ Revenir sur le dernier onglet visit√©
        const { tabId, url } = JSON.parse(last);
        openDocsTab(tabId, url);
    } else {
        // üÜï 1er lancement : ouvrir l‚Äôonglet par d√©faut
        openDocsTab('tab-docs', 'docs.html');   // mets ici ton onglet par d√©faut
    }
});

}

document.addEventListener("DOMContentLoaded", () => {
  // 1) Supprimer tout 'style.display' inline anciennement laiss√© dans le HTML (si pr√©sent)
  document.querySelectorAll('section[id^="panel-"]').forEach(sec => {
    sec.style.display = ''; // vide l'inline-style pour que notre CSS s'applique
    sec.classList.remove('active');
  });

  // 2) Activer l‚Äôonglet par d√©faut (celui qui a .nav-item.active)
  const ongletActif = document.querySelector('.nav-item.active') || document.querySelector('.nav-item');
  if (ongletActif) {
    const module = ongletActif.getAttribute('data-module');
    const panel = document.getElementById('panel-' + module);
    if (panel) panel.classList.add('active');

    // Appliquer la classe no-scroll-docs si n√©cessaire
    if (module === 'documents') {
      document.body.classList.add('no-scroll-docs');
    } else {
      document.body.classList.remove('no-scroll-docs');
    }
  }

  // Initialiser la navigation
  initNavigation();
});


// --- Gestion du menu responsive ---
const menuToggle = document.getElementById("menu-toggle");
const nav = document.querySelector("nav");
const navItems = document.querySelectorAll(".nav-item");

menuToggle.addEventListener("click", () => {
  nav.classList.toggle("open");
});

// Ferme le menu automatiquement quand on s√©lectionne un onglet
navItems.forEach(item => {
  item.addEventListener("click", () => {
    if (window.innerWidth <= 900) {
      nav.classList.remove("open");
    }
  });
});

// Ferme le menu si on clique √† l‚Äôext√©rieur (mobile)
document.addEventListener("click", e => {
  if (window.innerWidth <= 900 && nav.classList.contains("open")) {
    if (!nav.contains(e.target) && e.target !== menuToggle) {
      nav.classList.remove("open");
    }
  }
});
// --- Gestion des menus d√©roulants sup√©rieurs ---
document.querySelectorAll('.dropbtn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    const parent = btn.parentElement;
    const isOpen = parent.classList.contains('show');

    // Fermer tous les autres menus
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

    // Ouvrir/fermer celui cliqu√©
    if (!isOpen) parent.classList.add('show');
  });
});

// Fermer les menus si on clique ailleurs
document.addEventListener('click', () => {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
});
  function LogOut () {
    signOut(auth)
      .then(() => {
        window.location.href = "index.html";
      })
      .catch((error) => {
        afficherBulle("Erreur de d√©connexion" ,"error");
      });
  }
document.addEventListener("DOMContentLoaded", () => {

    const btnOrdo = document.querySelector('[data-module="medsurgences"]');

    btnOrdo.addEventListener("click", () => {
        // Charger l‚Äôordonnancier avec l‚ÄôID patient
        const iframe = document.getElementById("medsurgencesFrame");
        iframe.src = "medsurgences.html?id=" + patientId;
    });
        const btncompte = document.querySelector('[data-module="compte"]');

btncompte.addEventListener("click", () => {
        const iframe = document.getElementById("compteFrame");
        iframe.src = "viewacountf.html";
    });
});

document.addEventListener("DOMContentLoaded", () => {
  const panelDocs = document.getElementById("panel-documents");

  const observer = new MutationObserver(() => {
    if (panelDocs.style.display !== "none") {

      // attendre que patientId soit disponible
      const waitForPatientId = setInterval(() => {
        if (typeof patientId !== "undefined" && patientId !== null && patientId !== "") {

          clearInterval(waitForPatientId);

          // ouvrir l‚Äôonglet correctement AVEC l'id
          openDocsTab("tab-docs", "docs.html");

          observer.disconnect();
        }
      }, 50); // v√©rifie toutes les 50 ms
    }
  });

  observer.observe(panelDocs, { attributes: true, attributeFilter: ["style"] });
});


document.addEventListener("DOMContentLoaded", () => {
  // --- Parcourir toutes les sections avec onglets internes ---
  document.querySelectorAll('section[id^="panel-"]').forEach(section => {
    // Si la section est active au d√©marrage
    if (section.classList.contains('active')) {
      ouvrirPremierOnglet(section);
    }

    // Observer les changements de classe "active" pour ouvrir le premier onglet si n√©cessaire
    const observer = new MutationObserver(() => {
      if (section.classList.contains('active')) {
        ouvrirPremierOnglet(section);
      }
    });
    observer.observe(section, { attributes: true, attributeFilter: ['class'] });
  });

  // Fonction qui ouvre le premier onglet d'une section
  function ouvrirPremierOnglet(section) {
    const subTabs = section.querySelectorAll('.sub-tab'); // tes sous-onglets
    const subContents = section.querySelectorAll('.sub-tab-content'); // contenu associ√©
    if (subTabs.length === 0) return;

    // Retirer active de tous les onglets et contenus
    subTabs.forEach(tab => tab.classList.remove('active'));
    subContents.forEach(content => content.classList.remove('active'));

    // Activer le premier
    subTabs[0].classList.add('active');
    if (subContents[0]) subContents[0].classList.add('active');

    // Si c'est la section Documents, charger le contenu
    if (section.id === 'panel-documents' && typeof openDocsTab === 'function') {
      const defaultTabId = subTabs[0].id;
      const defaultUrl = subTabs[0].getAttribute('data-url');
      openDocsTab(defaultTabId, defaultUrl);
    }
  }
});
// Quand on ouvre l'onglet Documents, on charge automatiquement l'historique
document.querySelector('[data-module="documents"]').addEventListener('click', () => {
    // s√©lectionne automatiquement le bon onglet
    openDocsTab('tab-docs', 'docs.html');
});




</script>

</body>
</html>



>