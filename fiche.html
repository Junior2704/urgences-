<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="icon" type="image/jpeg" href="logo.jpg">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche Patient</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <style>
	  .tabs {
  display: flex;
  border-bottom: 2px solid #ccc;
  margin-bottom: 15px;
}
.tablink {
  background: #f5f5f5;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  font-weight: bold;
  transition: background 0.3s;
}
.tablink:hover {
  background: #e0e0e0;
}
.tablink.active {
  background: #0078d4;
  color: white;
}
.tab-content {
  display: none;
}

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
	.bouton-horloge {
  all: unset;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  margin-left: 5px;
  color: #555;
}
.bouton-horloge:hover,
.bouton-horloge:focus {
  outline: none;
  box-shadow: none;
  background-color: transparent; 
}

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h2 {
      margin: 0;
      color: #0078d4;
    }
    button, select, input[type="text"], input[type="number"] {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s ease;
    }
    button {
      background-color: #0078d4;
      color: white;
      cursor: pointer;
      border: none;
      margin-right: 10px;
    }
    button:hover {
      background-color: #005ea2;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 25px;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    .field-group {
      margin-bottom: 15px;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .inline-fields > div {
      flex: 1;
      min-width: 150px;
    }
    .corps {
      max-width: 320px;
      margin-top: 10px;
      position: relative;
      user-select: none;
    }
    #corps-img {
      width: 100%;
      border-radius: 12px;
      cursor: crosshair;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .annotation {
      position: absolute;
      background: #0078d4cc;
      color: white;
      padding: 3px 6px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      user-select: none;
      transform: translate(-50%, -120%);
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    #historique {
      max-width: 600px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 15px;
      max-height: 250px;
      overflow: visible;
    }
    .entry {
      border-left: 4px solid #0078d4;
      padding-left: 10px;
      margin-bottom: 12px;
      font-size: 14px;
      color: #444;
    }
    .entry strong {
      display: block;
      font-weight: 700;
      margin-bottom: 3px;
      color: #0078d4;
    }
    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.35);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
  background: white;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;         /* Limite la hauteur Ã  90% de la fenÃªtre */
  overflow-y: auto;         /* Affiche un ascenseur vertical si besoin */
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
}

    .modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #0078d4;
    }
    .modal label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .modal input[type="text"], .modal select, .modal textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
    }
    .modal textarea {
      min-height: 80px;
    }
    .modal-buttons {
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 10px;
      min-width: 90px;
    }
button {
  all: unset;
  display: inline-block;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  min-width: 120px;
  text-align: center;
  font-weight: 500;
  background-color: #0078d4;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Boutons secondaires */
button.secondary {
  background-color: #6c757d;
}

button.secondary:hover {
  background-color: #5a6268;
}

/* Boutons de validation */
button.success {
  background-color: #28a745;
}

button.success:hover {
  background-color: #218838;
}

/* Boutons dâ€™alerte / suppression */
button.danger {
  background-color: #dc3545;
}

button.danger:hover {
  background-color: #c82333;
}
#closeRawData {
  font-size: 20px;
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  color: #c62828;
  cursor: pointer;
  line-height: 1;
  box-shadow: none;
  outline: none;
}


#closeRawData:hover,
#closeRawData:focus,
#closeRawData:active {
  background: transparent !important;
  color: #c62828 !important;
  transform: none !important;
  box-shadow: none !important;
}


/* Pour groupes de boutons cÃ´te Ã  cÃ´te */
.button-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.inline-fields {
  display: flex;
  gap: 20px; /* espace entre les champs */
  flex-wrap: wrap; /* pour que Ã§a passe Ã  la ligne si trop Ã©troit */
}

.field-group {
  display: flex;
  flex-direction: column;
  min-width: 150px; /* largeur mini des champs */
}
.bouton-supprimer {
  background-color: #e0e0e0;
  color: #555;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  margin-left: 4px;
}
.bouton-supprimer:hover {
  background-color: #ccc;
}

html, body {
  margin: 0;
  padding: 0;
  height: 100vh;

}

body {
  display: block;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

main {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  overflow: auto;
  flex: 1;
  justify-content: flex-start;
  align-content: flex-start;
}

.card {
  flex: 1 1 300px;
  max-height: 300px;
  overflow: auto;
  box-sizing: border-box;
  padding: 10px;
  margin: 0;
}
#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}

.exam-button {
  background-color: #007BFF;
  color: white;
  padding: 12px;
  width: 100%;
  border: none;
  border-radius: 6px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 16px;
}
.exam-button:hover {
  background-color: #0056b3;
}
.sub-list {
  display: none;
  margin-top: 10px;
  padding-left: 10px;
}
.sub-list label {
  display: block;
  margin: 5px 0;
  cursor: pointer;
}
.prescription-item {
  background: #eef;
  padding: 10px;
  margin: 5px 0;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
}
.btn-delete {
  background-color: red;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 5px 10px;
  cursor: pointer;
}

/* Modale Gestion Administrative plein Ã©cran */
#modalAdmin.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0, 0, 0, 0.6);
  z-index: 2000;
  justify-content: center;
  align-items: center;
}

#modalAdmin .modal {
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.btn-admin {
  background-color: #5cb85c; 
  color: white;
  border: none;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.btn-admin:hover {
  background-color: #218838;
  transform: translateY(-1px);
}
#modalCloture.modal-overlay {
  z-index: 3000; /* plus haut que #modalAdmin */
}
#modalActe.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 3000;
  display: none;
  justify-content: center;
  align-items: center;
}

#modalActe .modal {
  width: 95%;
  max-width: none;
  max-height: 95vh;
  height: 95vh;
  overflow-y: auto;
  border-radius: 12px;
  background: white;
  padding: 25px;
}
#loadingOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  flex-direction: column;
  color: white;
  font-family: 'Segoe UI', sans-serif;
  font-size: 1.2rem;
  pointer-events: all;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}
#dossierMedical {
  max-height: 300px;
  overflow-y: auto;
}

#dossierMedical .contenu-dossier-medical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
#dossierMedical textarea {
  resize: vertical;
  min-height: 60px;
}
#evolutionTexte {
width: 100%;
  box-sizing: border-box;
  min-height: 500px;
  resize: vertical;
}
input[type="text"],
input[type="date"],
select {
  width: 100%;
  padding: 8px 12px;
  margin: 6px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
  font-size: 16px;
  font-family: inherit;
  appearance: none; /* pour uniformiser certains navigateurs */
  background-color: #fff;
}

input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.5); /* optionnel : amÃ©liore l'intÃ©gration dans les thÃ¨mes clairs/foncÃ©s */
}

label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #f5f5f5; /* optionnel, pour une meilleure lisibilitÃ© */
  border-bottom: 1px solid #ccc;
}

.left-header h2 {
  margin: 0;
}

.right-header {
  font-size: 0.9em;
  color: #333;
}
.tabs {
  display: flex;
  overflow-x: auto;      /* Scroll horizontal si trop dâ€™onglets */
  border-bottom: 2px solid #ccc;
  margin-bottom: 15px;
}
.tablink {
  flex-shrink: 0;
  background: #f5f5f5;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
}
.tablink.active {
  background: #0078d4;
  color: white;
}
.tab-content {
  display: none;
}
.tab-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.tab-header h3 {
  margin: 0;
  color: #0078d4;
}
.close-tab {
  background: transparent;
  border: none;
  font-size: 1.4rem;
  color: #c0392b;
  cursor: pointer;
}
.close-tab:hover {
  color: #e74c3c;
}


  </style>
</head>
<body>

<div id="loadingOverlay">
<div>Chargement du patient en cours...</div>
  <div class="spinner"></div>
  
</div>

<header>
  <div class="left-header">
    <h2>Fiche Patient</h2>
  </div>
  <div class="right-header">
    ConnectÃ© en tant que <b><span id="nom-medecin"></span></b> (<span id="specialite"></span>)
  </div>
</header>

<main>
<div id="contenu"></div>
<div class="tabs">
  <button class="tablink active" onclick="openTab('tab-patient', event)">ğŸ‘¤ Patient</button>
  <button class="tablink" onclick="openTab('tab-constantes', event)">ğŸ©º Constantes</button>
  <button class="tablink" onclick="openTab('tab-historique', event)">ğŸ“œ Historique</button>
  <button class="tablink" onclick="openTab('tab-dossier', event)">ğŸ“‹ Dossier MÃ©dical</button>
  <button class="tablink" onclick="openTab('tab-exam-actes', event)">ğŸ’‰ Actes / Examens</button>
  <button class="tablink" onclick="openTab('tab-sortie-docs', event)">ğŸšª Sortie / Documents</button>
</div>
	
<div id="tab-patient" class="tab-content" style="display:block;">
  <div class="tab-header">
    <h3>ğŸ‘¤ Patient</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <div class="card">
    <div>
      <label>Nom</label> <span id="nom"></span>
    </div>
    <div>
      <label>PrÃ©nom</label> <span id="prenom"></span>
    </div>
    <div>
      <label>Sexe</label> <span id="sexe"></span>
    </div>
    <div>
      <label>Ã‚ge</label> <span id="age"></span>
    </div>
    <div class="field-group">
      <label for="gravite">ğŸš¨ GravitÃ©</label>
      <select id="gravite">
        <option value="P0">P0</option>
        <option value="P1">P1</option>
        <option value="P2">P2</option>
        <option value="P3">P3</option>
        <option value="Urgences_Vitales">Urgences Vitales</option>
        <option value="Administratif">Administratif</option>
      </select>
    </div>
    <div class="field-group">
      <label for="service">ğŸ¥ Service idÃ©al</label>
      <select id="service"><option value="">Chargement...</option></select>
    </div>
    <div class="field-group">
      <label for="motif">ğŸ¤• Motif d'entrÃ©e</label>
      <input type="text" id="motif" placeholder="Motif d'entrÃ©e" />
    </div>
    <div class="field-group">
      <label for="moyen">ğŸš‘ Moyen d'entrÃ©e</label>
      <input type="text" id="moyen" placeholder="Moyen d'entrÃ©e" />
    </div>
    <button id="btnAdmin" class="btn-admin">ğŸ›  Gestion Administrative</button>
    <button id="btnVoirRawData" style="margin-top:10px;">ğŸ§¾ DonnÃ©es brutes</button>
  </div>
</div>

<div id="tab-constantes" class="tab-content">
  <div class="tab-header">
    <h3>ğŸ©º Constantes</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <div class="card">
    <label for="temperature">ğŸŒ¡ TempÃ©rature (Â°C)</label>
    <input type="number" id="temperature" step="0.1" />
    <label for="fc">â¤ï¸ FrÃ©quence cardiaque (bpm)</label>
    <input type="number" id="fc" />
    <label for="ta">ğŸ’“ Tension artÃ©rielle</label>
    <input type="text" id="ta" />
    <label for="saturation">ğŸ’¨ Saturation (%)</label>
    <input type="number" id="saturation" min="0" max="100" step="1" />
    <label for="fr">ğŸ˜®ğŸ’¨ FR</label>
    <input type="number" id="fr" min="0" max="100" step="1" />
    <label for="douleur">ğŸ˜– Douleur /10</label>
    <input type="number" id="douleur" min="0" max="10" step="1" />
    <button id="btnGlasgow" style="margin-top:10px; background-color:#9b59b6;">ğŸ§  Score de Glasgow</button>
    <br><br>
    <button id="btnSaveConst">ğŸ’¾ Enregistrer constantes</button>
  </div>
  <div class="card">
    <h3>Poids / Taille / IMC</h3>
    <div class="inline-fields">
      <div class="field-group">
        <label for="poids">Poids (kg)</label>
        <input type="number" id="poids" step="0.1" />
      </div>
      <div class="field-group">
        <label for="taille">Taille (cm)</label>
        <input type="number" id="taille" step="1" />
      </div>
      <div class="field-group">
        <label>IMC</label>
        <span id="imc"></span>
      </div>
    </div>
    <button id="btnSavePoids">ğŸ’¾ Enregistrer poids/taille</button>
  </div>
</div>


<div id="tab-historique" class="tab-content">
  <div class="tab-header">
    <h3>ğŸ“œ Historique</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <div class="card">
    <h3>Historique de l'hospitalisation en cours</h3>
    <div id="historique"></div>
  </div>
</div>



<div id="tab-dossier" class="tab-content">
  <div class="tab-header">
    <h3>ğŸ“‹ Dossier MÃ©dical</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <div class="card" id="dossierMedical">
    <div class="contenu-dossier-medical">
      <label>Questionnaire IAO <button class="bouton-horloge" onclick="ajouterHorodatageDans('questionnaire')">â°</button></label>
      <textarea id="questionnaire" style="height:80px;"></textarea>
      <label>AntÃ©cÃ©dents <button class="bouton-horloge" onclick="ajouterHorodatageDans('antecedents')">â°</button></label>
      <textarea id="antecedents" style="height:80px;"></textarea>
      <label>Traitements en cours <button class="bouton-horloge" onclick="ajouterHorodatageDans('traitements')">â°</button></label>
      <textarea id="traitements" style="height:80px;"></textarea>
      <label>Histoire de la maladie <button class="bouton-horloge" onclick="ajouterHorodatageDans('histoire')">â°</button></label>
      <textarea id="histoire" style="height:150px;"></textarea>
      <label>CR Auscultation <button class="bouton-horloge" onclick="ajouterHorodatageDans('auscultation')">â°</button></label>
      <textarea id="auscultation" style="height:300px;"></textarea>
      <button onclick="enregistrerDossierMedical()">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
  <div class="card" id="evolutionUrgences">
    <h3>ğŸ“ˆ Ã‰volution aux urgences <button class="bouton-horloge" onclick="ajouterHorodatageDans('evolutionTexte')">â°</button></h3>
    <textarea id="evolutionTexte"></textarea>
    <br>
    <button onclick="enregistrerEvolution()">ğŸ’¾ Enregistrer</button>
  </div>
</div>


<<div id="tab-exam-actes" class="tab-content">
  <div class="tab-header">
    <h3>â˜¢ï¸ Examens & ğŸ’‰ Actes</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <h4>ğŸ“‹ Examens</h4>
  <div id="listeExamens"></div>
  <button id="btnOuvrirModaleDemande" style="margin-top:10px;">â• Nouvelle demande dâ€™examen</button>
  <h4>Examens sÃ©lectionnÃ©s :</h4>
  <div id="examensSelectionnes" style="margin-bottom: 10px;"></div>
  <label for="commentaireExamen">ğŸ’¬ Commentaire</label>
  <textarea id="commentaireExamen"></textarea>
  <div class="modal-buttons">
    <button id="btnCancelExamen">âŒ Annuler</button>
    <button id="btnSaveExamen">âœ… Valider</button>
  </div>
  <hr>
  <h4>ğŸ’‰ Actes</h4>
  <label>Type dâ€™acte</label>
  <input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" />
  <ul id="suggestionsActes"></ul>
  <label>ğŸ‘¨â€âš•ï¸ RÃ©alisÃ© par</label>
  <select id="selectRealisateur"><option>â³Chargement...</option></select>
  <label>ğŸ’¬ Remarques</label>
  <textarea id="remarqueActe"></textarea>
  <h4>Actes rÃ©alisÃ©s :</h4>
  <input type="text" id="rechercheActe" placeholder="ğŸ” Rechercher un acte..." />
  <div id="listeActesRealises"></div>
  <div class="modal-buttons">
    <button id="btnFermerActe">âŒ Fermer</button>
    <button id="btnEnregistrerActe" class="success">âœ”ï¸ Enregistrer</button>
  </div>
</div>



<div class="modal-overlay" id="modalExamen" style="display:none;">
  <div class="modal">
    <h3>Demande dâ€™examen</h3>
    <button class="exam-button" onclick="toggleSublist('prise-sang-list')">ğŸ©¸ Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (NumÃ©ration Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CalcÃ©mie"> CalcÃ©mie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan hÃ©patique"> Bilan hÃ©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan rÃ©nal"> Bilan rÃ©nal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="HÃ©moglobine glyquÃ©e (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="SÃ©rologies virales (VIH, VHB, VHC)"> SÃ©rologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Mesure taux alcoolÃ©mie dans le sang"> Mesure taux alcoolÃ©mie</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
  </div>
<button class="exam-button" onclick="toggleSublist('urine-list')">ğŸ§ª Examens urinaires</button>
<div class="sub-list" id="urine-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobactÃ©riologique des urines)"> ECBU</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="ProtÃ©inurie des 24h"> ProtÃ©inurie 24h</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage crÃ©atinine urinaire"> CrÃ©atinine urinaire</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
  <button class="exam-button" onclick="toggleSublist('radio-list')">ğŸ“¸ Radiologie</button>
<div class="sub-list" id="radio-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du crÃ¢ne"> CrÃ¢ne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>

</div>

<button class="exam-button" onclick="toggleSublist('irm-list')">ğŸ§² IRM</button>
<div class="sub-list" id="irm-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM cÃ©rÃ©brale"> CÃ©rÃ©brale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM Ã©paule"> Ã‰paule</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('scanner-list')">ğŸ–¥ï¸ Scanner</button>
<div class="sub-list" id="scanner-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner cÃ©rÃ©bral"> CÃ©rÃ©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner cÃ©rÃ©bral"> Angioscanner cÃ©rÃ©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('echo-list')">ğŸ§­ Ã‰chographie</button>
<div class="sub-list" id="echo-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie rÃ©nale"> RÃ©nale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie hÃ©patique"> HÃ©patique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie thyroÃ¯dienne"> ThyroÃ¯dienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie mammaire"> Mammaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie testiculaire"> Testiculaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie cardiaque (ETT)"> Cardiaque (ETT)</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres infÃ©rieurs"> Doppler veineux MI</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler artÃ©riel des membres infÃ©rieurs"> Doppler artÃ©riel MI</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('eos-list')">ğŸ¦´ EOS</button>
<div class="sub-list" id="eos-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres infÃ©rieurs"> Membres infÃ©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres supÃ©rieurs"> Membres supÃ©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre"> autre</label>
</div>
<h4>Examens sÃ©lectionnÃ©s :</h4>
<div id="examensSelectionnes" style="margin-bottom: 10px;"></div>

    <label for="commentaireExamen">ğŸ’¬ Commentaire</label>
    <textarea id="commentaireExamen" placeholder="DÃ©tails supplÃ©mentaires..."></textarea>
    
      <button id="btnSaveExamen">âœ… Valider</button>
    </div>

<div id="tab-sortie-docs" class="tab-content">
  <div class="tab-header">
    <h3>ğŸšª Sortie & ğŸ“„ Documents</h3>
    <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
  <h4>ğŸšª Sortie</h4>
  <label><input type="radio" name="typeSortie" value="Retour Ã  domicile" /> ğŸ¡ Domicile</label><br/>
  <label><input type="radio" name="typeSortie" value="Hospitalisation" /> ğŸ¥ Hospitalisation</label><br/>
  <label><input type="radio" name="typeSortie" value="Transfert" /> â†”ï¸ Transfert</label><br/>
  <label><input type="radio" name="typeSortie" value="DÃ©cÃ¨s" /> âš°ï¸ DÃ©cÃ¨s</label><br/>
  <textarea id="champTraitementSortie"></textarea>
  <div id="sortieListe"></div>
  <div class="modal-buttons">
    <button id="btnAnnulerSortie">âŒ Annuler</button>
    <button id="btnValiderSortie">âœ… Valider</button>
  </div>
  <hr>
  <h4>ğŸ“„ Documents</h4>
  <button id="btnRapportHospi">ğŸ“ƒ Rapport d'hospitalisation</button>
  <button id="btnVersFiche">ğŸ“„ Ordonnancier</button>
  <button id="btnVersExs">ğŸ“„ Prescripteur d'examens</button>
  <button id="btnVersSynthese">ğŸ“„ Certificat mÃ©dical</button>
  <button id="btnVersFiches">ğŸ“„ Fiches Conseils</button>
</div>


<!-- FenÃªtre modale cachÃ©e au dÃ©part -->
<div id="popupNavigation" style="
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  ">
    <h2>Liste des documents disponibles</h2>
	<button id="btnRapportHospi" style="margin:10px; padding:10px 20px;">ğŸ“ƒ Rapport d'hospitalisation</button>
    <button id="btnVersFiche" style="margin:10px; padding:10px 20px;">ğŸ“„ Ordonnancier</button>
	<button id="btnVersExs" style="margin:10px; padding:10px 20px;">ğŸ“„ Prescripteur d'examens</button>
    <button id="btnVersSynthese" style="margin:10px; padding:10px 20px;">ğŸ“„ Certificat mÃ©dical</button><br/>
	<button id="btnVersFiches" style="margin:10px; padding:10px 20px;">ğŸ“„ Fiches Conseils</button><br/>
	<button style="margin:10px; padding:10px 20px;" onclick="window.open('https://eduscol.education.fr/1207/poursuite-de-la-scolarite-avec-des-traitements-medicaux-particuliers', '_blank')">
  ğŸ“„ PAI (lien externe)
</button><br/>
    <button onclick="document.getElementById('popupNavigation').style.display='none'" style="margin-top:20px;">âŒ Fermer</button>
  </div>
</div>

<!-- Modal Sortie -->
<div class="modal-overlay" id="modalSortie">
  <div class="modal">
    <h3>Type de sortie</h3>
    <label><input type="radio" name="typeSortie" value="Retour Ã  domicile" /> ğŸ¡ Domicile</label><br/>
    <label><input type="radio" name="typeSortie" value="Hospitalisation" /> ğŸ¥ Hospitalisation</label><br/>
    <label><input type="radio" name="typeSortie" value="Transfert" /> â†”ï¸ Transfert</label><br/>
	    <label><input type="radio" name="typeSortie" value="DÃ©cÃ¨s" />âš°ï¸ DÃ©cÃ¨s</label><br/>
    <label>
      <input type="radio" name="typeSortie" value="autre" /> ğŸ”¤ Autre
      <input type="text" id="champAutreSortie" placeholder="PrÃ©cisez..." style="margin-top: 8px; display:none;" />
    </label>

    <hr/>

    <h3>Options supplÃ©mentaires</h3>
    <label><input type="checkbox" name="optionsSortie" value="Suivi a domicile" /> ğŸ“‹ Suivi Ã  domicile</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Avis specialiste" /> ğŸ‘©â€âš•ï¸ Avis spÃ©cialiste</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Transport  en ambulance" /> ğŸš‘ Transport ambulance</label><br/>
    <label>
      <input type="checkbox" name="optionsSortie" value="autreOption" /> ğŸ”¤ Autre option
      <input type="text" id="champAutreOption" placeholder="PrÃ©cisez..." style="margin-top: 8px; display:none;" />
    </label>
	<hr/>
<h3>ğŸ’Š Traitement de sortie</h3>
<textarea id="champTraitementSortie"	 rows="3" style="width:100%; margin-bottom: 10px;"></textarea>

    <hr/>

    <div id="sortieListe"></div> 
    <div class="modal-buttons">
      <button id="btnAnnulerSortie">âŒ Annuler</button>
      <button id="btnValiderSortie">âœ… Valider</button>
    </div>
  </div>
</div>

<!-- Modal ClÃ´ture -->
<div class="modal-overlay" id="modalCloture">
  <div class="modal" style="text-align: center;">
    <h3>â³ClÃ´ture en cours...</h3>
    <div style="background:#eee; border-radius: 10px; overflow:hidden; margin-top: 15px;">
      <div id="clotureBar" style="height: 12px; background-color: #0078d4; width: 0%; transition: width 0.3s;"></div>
    </div>
    <p style="margin-top:10px; color:#666;">Merci de patienter</p>
  </div>
</div>

</main>
<!-- Modal Gestion Administrative -->
<div class="modal-overlay" id="modalAdmin" style="display:none;">
  <div class="modal">
    <h3>ğŸ›  Gestion Administrative</h3>
    
    <label for="adminId">ID Patient</label>
    <input type="text" id="adminId" disabled />
	
	<label for="adminNom">Nom</label>
    <input type="text" id="adminNom" />
	<label for="adminPrenom">PrÃ©nom</label>
<input type="text" id="adminPrenom" />

	
	
	<label for="adminSexe">Sexe</label>
	<select id="adminSexe" >
  <option value="">-- SÃ©lectionnez --</option>
  <option value="M">M</option>
  <option value="Mme">Mme</option>
  <option value="L'enfant">L'enfant</option>
</select>

	<label for="adminNaissance">Date de naissance</label>
<input type="date" id="adminNaissance"  />

	
    <label for="adminAdresse">Adresse</label>
    <input type="text" id="adminAdresse" />

    <label for="adminTelephone">TÃ©lÃ©phone</label>
    <input type="text" id="adminTelephone" />

    <label for="adminEmail">Email</label>
    <input type="text" id="adminEmail" />

    <div class="modal-buttons">
	    <button type="button" id="readVitaleBtn" class="button" style="background-color: #28a745; color: white;">ğŸ†” Lecture Carte Vitale</button>
      <button id="btnFacturer" class="success">ğŸ’¶ Facturer</button>
	    <button id="btnCloturer" style="flex:1; background-color:#d9534f;">âœ… ClÃ´turer hospitalisation</button>
            <br><br>
			<button id="btnFermerAdmin" class="danger">âŒFermer</button>
	  <button id="btnEnregistrerAdmin" class="primary">ğŸ’¾Enregistrer</button>

    </div>
  </div>
</div>
<div class="modal-overlay" id="modalActe">
  <div class="modal">
    <h3>â•Ajouter un acte</h3>
<label>ğŸ’‰Type dâ€™acte</label>
<input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" />
<ul id="suggestionsActes" style="list-style:none; padding:0; margin-top:5px; border:1px solid #ccc; border-radius:6px; max-height:150px; overflow-y:auto; display:none; background:white; position:relative; z-index:100;"></ul>


    <label>ğŸ‘¨â€âš•ï¸RÃ©alisÃ© par</label>
    <select id="selectRealisateur"><option>â³Chargement...</option></select>

    <label>ğŸ’¬Remarques</label>
    <textarea id="remarqueActe" placeholder="Remarques sur lâ€™acte..."></textarea>

<h4>Actes rÃ©alisÃ©s :</h4>
<input type="text" id="rechercheActe" placeholder="ğŸ” Rechercher un acte..." style="width:100%; padding:8px; margin-bottom:12px; border-radius:8px; border:1px solid #ccc;" />
<div id="listeActesRealises" style="max-height:150px; overflow-y:auto; font-size:0.9em;"></div>

    <div class="modal-buttons">
      <button id="btnFermerActe">âŒFermer</button>
      <button id="btnEnregistrerActe" class="success">âœ”ï¸Enregistrer</button>
    </div>
  </div>
  </div>
 

<div id="vitaleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">â³Lecture Carte Vitale en cours...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="facturationModale" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">â³Chargement des informations...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="modal-overlay" id="modalGlasgow">
  <div class="modal">
    <h3>ğŸ§  Score de Glasgow</h3>
    <img src="glasgow.jpg" alt="Ã‰chelle de Glasgow" style="width:100%; margin-bottom:15px; border-radius:8px;" />
    
    <label>ğŸ‘ Ouverture des yeux (max 4)</label>
    <input type="number" id="glasgowYeux" min="1" max="4" />

    <label>ğŸ—£ RÃ©ponse verbale (max 5)</label>
    <input type="number" id="glasgowVerbal" min="1" max="5" />

    <label>ğŸ’ª RÃ©ponse motrice (max 6)</label>
    <input type="number" id="glasgowMoteur" min="1" max="6" />

    <label>ğŸ¯ Score total</label>
    <input type="number" id="glasgowTotal" disabled />

<div id="glasgowPronostic" style="margin: 10px 0; font-style: italic;"></div>
<div id="glasgowPronostic2" style="margin: 10px 0; font-style: italic;"></div>
    <div class="modal-buttons">
      <button id="btnFermerGlasgow" class="secondary">âŒ Fermer</button>
      <button id="btnEnregistrerGlasgow" class="success">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const urlParams = new URLSearchParams(window.location.search);
  const patientId = urlParams.get("id");
  if (!patientId) {
    alert("Erreur : aucun patient sÃ©lectionnÃ©.");
    throw new Error("Aucun patient id dans lâ€™URL");
  }
  const patientRef = db.collection("patients").doc(patientId);

  function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => bulle.remove(), 3000);
  }

  function calculerAge(dateNaissance) {
    const birth = new Date(dateNaissance);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    if (
      now.getMonth() < birth.getMonth() ||
      (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age;
  }
async function chargerServices() {
  const servicesSelect = document.getElementById("service");
  servicesSelect.innerHTML = "";
  const doc = await db.collection("rÃ©fÃ©rentiels").doc("spÃ©cialitÃ©s").get();
  const data = doc.data();
  (data?.spÃ©cialitÃ©s || []).forEach(service => {
    const option = document.createElement("option");
    option.value = service;
    option.textContent = service;
    servicesSelect.appendChild(option);
  });
}

  // ===================== GESTION DES ONGLETS =====================
  function openTab(tabId, event) {
    document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
    document.querySelectorAll(".tablink").forEach(tl => tl.classList.remove("active"));

    document.getElementById(tabId).style.display = "block";
    if (event) event.currentTarget.classList.add("active");

    // Charger automatiquement les donnÃ©es selon lâ€™onglet
    if (tabId === "tab-sortie-docs") {
      chargerSortie();
    }
    if (tabId === "tab-exam-actes") {
      chargerExamens();
      chargerActes();
    }
    if (tabId === "tab-dossier") {
      // dossier mÃ©dical dÃ©jÃ  rempli via loadPatient
    }
    if (tabId === "tab-patient") {
      // dÃ©jÃ  gÃ©rÃ© via loadPatient
    }
  }

  // ===================== SORTIE =====================
  const modalSortie = document.getElementById("modalSortie");
  const btnAnnulerSortie = document.getElementById("btnAnnulerSortie");
  const btnValiderSortie = document.getElementById("btnValiderSortie");
  const sortieListe = document.getElementById("sortieListe");
  const champAutreSortie = document.getElementById("champAutreSortie");
  const champAutreOption = document.getElementById("champAutreOption");

  // Container dynamique pour options spÃ©cifiques
  const containerDynamique = document.createElement("div");
  containerDynamique.id = "optionsSpecifiques";
  let parent = document.querySelector("#tab-sortie-docs");
  if (parent && sortieListe) {
      parent.insertBefore(containerDynamique, sortieListe);
  } else if (parent) {
      parent.appendChild(containerDynamique);
  }
  // ===================== FONCTIONS SORTIE =====================
  async function chargerSortie() {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const sortie = data.hospitalisations?.[index]?.sortie || {};

    document.getElementById("champTraitementSortie").value = sortie.traitementSortie || "";

    // SÃ©lection du type
    document.querySelectorAll('input[name="typeSortie"]').forEach(r => {
      r.checked = (r.value === sortie.type);
    });

    // Champ 'autre'
    if (sortie.type && !["Retour Ã  domicile", "Hospitalisation", "Transfert"].includes(sortie.type)) {
      document.querySelector('input[name="typeSortie"][value="autre"]').checked = true;
      champAutreSortie.value = sortie.type;
      champAutreSortie.style.display = "block";
    } else {
      champAutreSortie.value = "";
      champAutreSortie.style.display = "none";
    }

    // Options cochÃ©es
    document.querySelectorAll('input[name="optionsSortie"]').forEach(cb => {
      cb.checked = sortie.options?.includes(cb.value);
    });

    champAutreOption.style.display = sortie.options?.includes("autreOption") ? "block" : "none";
    champAutreOption.value = sortie.autreOptionTexte || "";

    afficherSortieListe(sortie);
  }

  function afficherSortieListe(sortie) {
    if (!sortie || !sortie.type) {
      sortieListe.innerHTML = "<p>Aucune sortie enregistrÃ©e.</p>";
      return;
    }

    let html = `
      <p><strong>Type de sortie :</strong> ${sortie.type}</p>
      <p><strong>Options :</strong> ${sortie.options?.join(", ") || "Aucune"}</p>
    `;

    if (sortie.destinationTransfert) {
      html += `<p><strong>â†”ï¸ Destination :</strong> ${sortie.destinationTransfert}</p>`;
    }
    if (sortie.serviceHospitalisation) {
      html += `<p><strong>ğŸ¥ Service :</strong> ${sortie.serviceHospitalisation}</p>`;
    }
    if (sortie.avisSpecialiste) {
      html += `<p><strong>ğŸ‘¨â€âš•ï¸ SpÃ©cialiste :</strong> ${sortie.avisSpecialiste}</p>`;
    }
    if (sortie.autreOptionTexte) {
      html += `<p><strong>ğŸ”¤ Autre option :</strong> ${sortie.autreOptionTexte}</p>`;
    }
    if (sortie.traitementSortie) {
      html += `<p><strong>ğŸ’Š Traitement de sortie :</strong> ${sortie.traitementSortie}</p>`;
    }

    html += `<button id="btnSupprimerSortie" class="danger" style="margin-top:10px;">ğŸ—‘ Supprimer</button>`;
    sortieListe.innerHTML = html;

    document.getElementById("btnSupprimerSortie").addEventListener("click", async () => {
      const doc = await patientRef.get();
      const data = doc.data();
      const index = data.hospitalisationIndex ?? 0;
      const hospitalisations = [...(data.hospitalisations || [])];

      // Supprimer la sortie
      delete hospitalisations[index].sortie;
      if (hospitalisations[index].traitementSortie) {
        hospitalisations[index].traitementSortie = "";
      }

      await patientRef.update({ hospitalisations });
      sortieListe.innerHTML = "<p>Sortie supprimÃ©e.</p>";
      afficherBulle("ğŸ—‘ï¸ Sortie supprimÃ©e", "administratif");
    });
  }

  btnValiderSortie.addEventListener("click", async () => {
    const checked = document.querySelector('input[name="typeSortie"]:checked');
    const traitementSortie = document.getElementById("champTraitementSortie").value.trim();
    if (!checked) return alert("Veuillez sÃ©lectionner un type de sortie.");

    let type = checked.value;
    if (type === "autre") {
      type = champAutreSortie.value.trim();
      if (!type) return afficherBulle("âŒ PrÃ©cisez le type de sortie", "alerte");
    }

    const options = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);
    const autreOptionTexte = options.includes("autreOption") ? champAutreOption.value.trim() : "";

    const sortie = {
      type,
      options,
      autreOptionTexte,
      traitementSortie,
      date: new Date().toLocaleString()
    };

    try {
      const doc = await patientRef.get();
      const data = doc.data();
      const index = data.hospitalisationIndex ?? 0;
      const hospitalisations = [...(data.hospitalisations || [])];
      hospitalisations[index] = { ...hospitalisations[index], sortie };

      await patientRef.update({ hospitalisations });
      afficherBulle("âœ”ï¸ Sortie enregistrÃ©e", "administratif");
      afficherSortieListe(sortie);
    } catch (err) {
      console.error("Erreur enregistrement sortie :", err);
      afficherBulle("âŒ Erreur enregistrement", "alerte");
    }
  });

  btnAnnulerSortie.addEventListener("click", () => {
    chargerSortie();
  });

  // ===================== EXAMENS =====================
  async function chargerExamens() {
    try {
      const doc = await patientRef.get();
      const data = doc.data();
      const index = data.hospitalisationIndex ?? 0;
      const hospi = data.hospitalisations?.[index] || {};
      const examens = hospi.examens || [];

      const examensSelectionnes = document.getElementById("examensSelectionnes");
      examensSelectionnes.innerHTML = "";

      if (examens.length === 0) {
        examensSelectionnes.innerHTML = "<p>Aucun examen enregistrÃ©.</p>";
        return;
      }

      examens.forEach(exam => {
        const div = document.createElement("div");
        div.textContent = `â€¢ ${exam.nom} (${exam.commentaire || "â€”"})`;
        examensSelectionnes.appendChild(div);
      });
    } catch (err) {
      console.error("Erreur chargement examens :", err);
      afficherBulle("âŒ Erreur chargement examens", "alerte");
    }
  }

  // ===================== ACTES =====================
  async function chargerActes() {
    try {
      const doc = await patientRef.get();
      const data = doc.data();
      const index = data.hospitalisationIndex ?? 0;
      const hospi = data.hospitalisations?.[index] || {};
      const actes = hospi.actes || [];

      const listeActesRealises = document.getElementById("listeActesRealises");
      listeActesRealises.innerHTML = "";

      if (actes.length === 0) {
        listeActesRealises.innerHTML = "<p>Aucun acte enregistrÃ©.</p>";
        return;
      }

      actes.forEach(acte => {
        const div = document.createElement("div");
        div.className = "prescription-item";
        div.innerHTML = `
          <span>${acte.type} â€” ${acte.realisateur || "?"}</span>
          <span>${acte.remarque || ""}</span>
        `;
        listeActesRealises.appendChild(div);
      });
    } catch (err) {
      console.error("Erreur chargement actes :", err);
      afficherBulle("âŒ Erreur chargement actes", "alerte");
    }
  }

  // ===================== DOCUMENTS =====================
  async function chargerDocuments() {
    // Ici tu peux ajouter de la logique si tu stockes en base
    // Pour l'instant, les boutons de gÃ©nÃ©ration de documents fonctionnent directement
  }
  // ===================== PATIENT =====================
  async function loadPatient() {
    const overlay = document.getElementById("loadingOverlay");
    if (overlay) overlay.style.display = "flex";

    try {
      const doc = await patientRef.get();
      if (!doc.exists) {
        afficherBulle("âŒ Patient introuvable", "alerte");
        return;
      }

      const data = doc.data();
      const index = data.hospitalisationIndex ?? 0;
      const hospi = data.hospitalisations?.[index];

      // ğŸ”¹ Informations patient
      document.getElementById("nom").textContent = data.nom || "";
      document.getElementById("prenom").textContent = data.prenom || "";
      document.getElementById("sexe").textContent = data.sexe || "";
      document.getElementById("poids").value = data.poids || "";
      document.getElementById("taille").value = data.taille || "";

      // ğŸ”¹ Calcul IMC
      const elImc = document.getElementById("imc");
      const poids = parseFloat(data.poids);
      const taille = parseFloat(data.taille);
      if (!isNaN(poids) && !isNaN(taille) && taille > 0) {
        const imc = poids / ((taille / 100) ** 2);
        elImc.textContent = imc.toFixed(1);
      } else {
        elImc.textContent = "â€“";
      }

      // ğŸ”¹ Calcul Ã¢ge
      const elAge = document.getElementById("age");
      if (elAge && data.dateNaissance) {
        const age = calculerAge(data.dateNaissance);
        elAge.textContent = !isNaN(age) ? `${age} ans` : "Inconnu";
      }

      if (hospi) {
        // ğŸ”¹ Informations dâ€™hospitalisation
        document.getElementById("gravite").value = hospi.gravite || "";
        document.getElementById("motif").value = hospi.motif || "";
        document.getElementById("moyen").value = hospi.moyen || "";

        // ğŸ”¹ Constantes vitales
        document.getElementById("temperature").value = hospi.constantes?.temperature || "";
        document.getElementById("fc").value = hospi.constantes?.fc || "";
        document.getElementById("ta").value = hospi.constantes?.ta || "";
        document.getElementById("saturation").value = hospi.constantes?.saturation || "";
        document.getElementById("fr").value = hospi.constantes?.fr || "";
        document.getElementById("douleur").value = hospi.constantes?.douleur || "";

        // ğŸ”¹ Dossier mÃ©dical
        const dm = hospi.dossierMedical || {};
        document.getElementById("questionnaire").value = dm.questionnaire || "";
        document.getElementById("antecedents").value = dm.antecedents || "";
        document.getElementById("traitements").value = dm.traitements || "";
        document.getElementById("histoire").value = dm.histoire || "";
        document.getElementById("auscultation").value = dm.auscultation || "";

        // ğŸ”¹ Ã‰volution aux urgences
        document.getElementById("evolutionTexte").value = hospi.evolution || "";

        // ğŸ”¹ Services / historique
        chargerServices();
        clearHistorique();
        await chargerHistorique();
      }

    } catch (error) {
      console.error("Erreur chargement patient :", error);
      afficherBulle("âŒ Erreur de chargement", "alerte");
    } finally {
      if (overlay) overlay.style.display = "none";
    }
  }

  // ===================== AUTRES FONCTIONS EXISTANTES =====================
  // Ici tu gardes toutes tes autres fonctions : 
  // - sauvegarde des constantes
  // - gestion poids/taille/IMC
  // - Ã©volution
  // - historique
  // - Glasgow
  // - services
  // - gestion administrative
  // - etc.
  //
  // âš ï¸ Rien nâ€™a Ã©tÃ© supprimÃ©, on a seulement retirÃ©
  // les anciens listeners de boutons pour "ouvrir modale sortie/examens/actes/documents".
  // Leur logique est dÃ©sormais appelÃ©e dans openTab() automatiquement.

  // ===================== LANCEMENT =====================
  loadPatient();
</script>

</body>
</html>










