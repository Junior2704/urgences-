<!DOCTYPE html>
<html lang="fr">
<head>

<link rel="icon" type="image/jpeg" href="logo.jpg">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche Patient</title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <style>
	 /* Inputs text et number */
/* =========================== */
/* Inputs text et number */
/* =========================== */
#dossierMedical input[type="text"],
#dossierMedical input[type="number"],
input[type="text"],
input[type="date"],
select,
textarea {
  width: 100%;
  box-sizing: border-box;
  font-size: clamp(0.875rem, 1vw, 1rem);
  padding: clamp(0.5em, 1vw, 0.75em);
  border-radius: 0.5em;
  border: 1px solid #ccc;
  font-family: inherit;
  background-color: #fff;
  resize: vertical;
  margin: 0.375em 0;
  appearance: none;
}

/* Largeurs sp√©cifiques remplac√©es par % */
input.text1 { width: 20%; min-width: 80px; display: inline-block; }
input.text2 { width: 35%; min-width: 120px; display: inline-block; }

/* =========================== */
/* Boutons */
/* =========================== */
button, .bouton-ancienne, .bouton-horloge, .btn-delete, .btn-admin, .exam-button, .bouton-supprimer {
  cursor: pointer;
  font-size: clamp(0.875rem, 1vw, 1rem);
  border-radius: 0.5em;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-sizing: border-box;
  display: inline-block;
  text-align: center;
}

/* Bouton principal */
button {
  background-color: #0078d4;
  color: white;
  border: none;
  padding: clamp(0.5em, 1vw, 0.75em) clamp(0.75em, 2vw, 1em);
  min-width: clamp(80px, 15vw, 120px);
  box-shadow: 0 0.125em 0.25em rgba(0,0,0,0.1);
}

button:hover { background-color: #005ea2; transform: translateY(-1px); }

/* Boutons secondaires */
button.secondary { background-color: #6c757d; }
button.secondary:hover { background-color: #5a6268; }

/* Boutons succ√®s */
button.success { background-color: #28a745; }
button.success:hover { background-color: #218838; }

/* Boutons danger */
button.danger { background-color: #dc3545; }
button.danger:hover { background-color: #c82333; }

/* Bouton ancienne */
.bouton-ancienne {
  all: unset;
  color: #2c7be5;
  background: transparent !important;
  margin-left: 0.3em;
}
.bouton-ancienne:hover,
.bouton-ancienne:focus,
.bouton-ancienne:active { color: #1b4f9c; }

/* Bouton horloge */
.bouton-horloge { all: unset; color: #555; margin-left: 0.3em; }
.bouton-horloge:hover, .bouton-horloge:focus { outline: none; background-color: transparent; }

/* Boutons suppression */
.bouton-supprimer { background-color: #e0e0e0; color: #555; padding: 0.125em 0.375em; font-size: 0.75rem; margin-left: 0.25em; }
.bouton-supprimer:hover { background-color: #ccc; }

/* =========================== */
/* Header */
/* =========================== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.625em 1.25em;
  background-color: #f5f5f5;
  border-bottom: 1px solid #ccc;
}

header h2 { margin: 0; color: #0078d4; }
.right-header { font-size: 0.9em; color: #333; }

/* =========================== */
/* Tabs */
/* =========================== */
.tabs { display: flex; width: 100%; flex-wrap: wrap; }
.tablink {
  flex: 1 1 auto;
  text-align: center;
  padding: clamp(0.5em, 1vw, 0.75em);
  border: none;
  cursor: pointer;
  background: #2196f3;
  color: white;
  font-size: clamp(0.9rem, 1vw, 1rem);
  transition: transform 0.2s, background 0.2s;
}
.tablink:hover { background: #1976d2; transform: scale(1.05); }
.tablink.active { background: #2196f3; color: black; font-weight: bold; transform: scale(1.08); }

/* Tab content */
.tab-content { display: none; width: 100%; max-width: none; box-sizing: border-box; }

/* =========================== */
/* Close tab */
.close-tab {
  all: unset; cursor: pointer; color: #c62828; font-size: clamp(1.25rem,2vw,1.25rem);
  font-weight: bold; line-height:1; background: transparent !important; transition: transform 0.2s, color 0.2s;
}
.close-tab:hover, .close-tab:focus, .close-tab:active { transform: scale(1.3); color:#e53935; }

/* =========================== */
/* Card / Containers */
.card {
  background: white;
  border-radius: 0.625em;
  box-shadow: 0 0.1875em 0.5em rgba(0,0,0,0.1);
  padding: 1.25em;
  margin-bottom: 1.5625em;
  flex: 1 1 300px;
  max-width: 100%;
  overflow: auto;
  box-sizing: border-box;
}

/* Historique */
#historique { max-width: 600px; background: #fff; border-radius: 0.625em; box-shadow:0 0.1875em 0.5em rgba(0,0,0,0.1); padding:0.9375em; max-height:250px; overflow: visible; }
.entry { border-left:0.25em solid #0078d4; padding-left:0.625em; margin-bottom:0.75em; font-size:0.875rem; color:#444; }
.entry strong { display:block; font-weight:700; margin-bottom:0.1875em; color:#0078d4; }

/* =========================== */
/* Form groups / inline fields */
.field-group { display:flex; flex-direction:column; margin-bottom:0.9375em; min-width:150px; }
.inline-fields { display:flex; gap:1.25em; flex-wrap:wrap; }
.inline-fields > div { flex:1 1 clamp(150px,20%,300px); }

/* =========================== */
/* Corps humain */
.corps { max-width:320px; margin-top:0.625em; position:relative; user-select:none; }
#corps-img { width:100%; border-radius:0.75em; cursor:crosshair; box-shadow:0 0.125em 0.375em rgba(0,0,0,0.15); }
.annotation { position:absolute; background:#0078d4cc; color:white; padding:0.1875em 0.375em; border-radius:0.375em; font-size:0.75rem; pointer-events:none; white-space:nowrap; transform:translate(-50%,-120%); box-shadow:0 0.0625em 0.1875em rgba(0,0,0,0.3); }

/* =========================== */
/* Modales */
.modal-overlay {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.35); display:none; justify-content:center; align-items:center; z-index:1000;
}
.modal {
  background:white; border-radius:0.75em; padding:1.5625em; width:90%; max-width:800px; max-height:90vh; overflow-y:auto; box-shadow:0 0.25em 0.9375em rgba(0,0,0,0.25);
}
.modal h3 { margin-top:0; margin-bottom:0.9375em; color:#0078d4; }
.modal label { font-weight:600; margin-bottom:0.375em; display:block; }
.modal input, .modal select, .modal textarea { width:100%; box-sizing:border-box; margin-bottom:0.9375em; padding:0.5em; border-radius:0.375em; border:1px solid #ccc; font-size:clamp(0.875rem,1vw,1rem); resize:vertical; }
.modal textarea { min-height:80px; }
.modal-buttons { text-align:right; }
.modal-buttons button { margin-left:0.625em; min-width:90px; }

/* =========================== */
/* Sp√©cial - Exam / prescription / hospitalisation */
.exam-button { background-color:#007BFF; color:white; padding:0.75em; width:100%; border:none; border-radius:0.375em; margin-top:0.625em; font-size:1rem; cursor:pointer; }
.exam-button:hover { background-color:#0056b3; }

.prescription-item { background:#eef; padding:0.625em; margin:0.3125em 0; border-radius:0.375em; display:flex; justify-content:space-between; }
.btn-delete { background-color:red; color:white; border:none; border-radius:0.375em; padding:0.3125em 0.625em; cursor:pointer; }

.sub-list { display:none; margin-top:0.625em; padding-left:0.625em; }
.sub-list label { display:block; margin:0.3125em 0; cursor:pointer; }

/* =========================== */
/* Loading overlay */
#loadingOverlay {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center; flex-direction:column;
  z-index:10000; color:white; font-family:'Segoe UI', sans-serif; font-size:clamp(1rem,1.5vw,1.2rem); pointer-events:all;
}
.spinner { width:60px; height:60px; border:6px solid #f3f3f3; border-top:6px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1.25em; }
@keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }

/* =========================== */
/* Vid√©al Search */
.vidal-search { display:flex; align-items:center; margin:1.25em 0; font-family:Arial,sans-serif; }
.vidal-search input[type="text"] { padding:0.625em; font-size:1rem; border:2px solid #d32f2f; border-right:none; border-radius:0.25em 0 0 0.25em; width:100%; max-width:300px; }
.vidal-search button { padding:0.625em 1.25em; background:#d32f2f; color:white; font-size:1rem; border:2px solid #d32f2f; border-radius:0 0.25em 0.25em 0; cursor:pointer; }
.vidal-search button:hover { background:#b71c1c; border-color:#b71c1c; }

/* =========================== */
/* Animations */
@keyframes fadeIn { from{opacity:0; transform:scale(0.98);} to{opacity:1; transform:scale(1);} }
@keyframes fadeout { to { opacity:0; transform:translateX(-20px); } }

/* =========================== */
/* Media Queries pour petits √©crans */
@media (max-width: 768px) {
  .inline-fields { flex-direction: column; }
  header { flex-direction: column; align-items:flex-start; }
  button { width:100%; margin-bottom:0.5em; }
  .card { min-width:100%; }
}


  </style>
</head>
<body>

<div id="loadingOverlay">
<div>Chargement du patient en cours...</div>
  <div class="spinner"></div>
  
</div>

<header>
  <div class="left-header">
    <h2>Fiche Patient</h2>
  </div>
  <div class="right-header">
    Connect√© en tant que <b><span id="nom-medecin"></span></b> (<span id="specialite"></span>)
	  <button class="close-tab" onclick="window.location.href='urgences.html'">‚ùå</button>
  </div>
</header>

<main>
<div id="contenu"></div>
<div class="tabs">
  <button class="tablink active" onclick="openTab('tab-patient', event)">üë§ Identit√© Patient</button>
  <button class="tablink" onclick="openTab('tab-constantes', event)">ü©∫ Constantes</button>
  <button class="tablink" onclick="openTab('tab-historique', event)">üìú Historique</button>
  <button class="tablink" onclick="openTab('tab-dossier', event)">üìã Dossier M√©dical</button>
  <button class="tablink" onclick="openTab('tab-exam-actes', event)">üíâ Actes / Examens</button>
  <button class="tablink" onclick="openTab('tab-sortie-docs', event)">üö™ Sortie / Documents</button>
</div>

	
<div id="tab-patient" class="tab-content" style="display:block;">
  <div class="tab-header">
    <h3>üë§ Identit√© patient</h3>
    
  </div>
  <div>
  <label>CIP (Code d'Identification Patient)</label>
  <span id="idPatient"></span>
</div>

  <div>
    <label>Nom</label>
    <span id="nom"></span>
  </div>
  <div>
    <label>Pr√©nom</label>
    <span id="prenom"></span>
  </div>
  <div>
    <label>Sexe</label>
    <span id="sexe"></span>
  </div>
  <div>
    <label>√Çge</label>
    <span id="age"></span>
  </div>

  <label for="gravite" >üö® Gravit√©</label>
  <select id="gravite"class="text2" >
    <option value="P0">P0</option>
    <option value="P1">P1</option>
    <option value="P2">P2</option>
    <option value="P3">P3</option>
    <option value="Urgences_Vitales">Urgences Vitales</option>
    <option value="Administratif">Administratif</option>
  </select>

  <label for="service" >üè• Service id√©al</label>
  <select id="service" class="text2"><option value="">Chargement...</option></select>

  <label for="motif">ü§ï Motif d'entr√©e</label>
  <input type="text" id="motif" placeholder="Motif d'entr√©e" class="text2" />

  <label for="moyen">üöë Moyen d'entr√©e</label>
  <input type="text" id="moyen" placeholder="Moyen d'entr√©e" class="text2" />

  <br><br>
  <button id="btnAdmin" class="btn-admin">üõ† Gestion Administrative</button>
  <button id="btnVoirRawData">üßæ Historique des hospitalisations</button>
</div>


<div id="tab-constantes" class="tab-content">
  <div class="tab-header">
    <h3>ü©∫ Constantes</h3>
 
  </div>
 <hr>
<h3>Scope</h3>
<label>
  <input type="checkbox" id="patientScopeCheckbox"> Patient scop√©
</label>

<div id="scopeFields" style="display:none; margin-top:10px;">
  <label for="scopeNum">Num√©ro de scope</label>
  <input type="text" id="scopeNum" class="text1" />
  <button id="btnConnectScope">üîå Connecter</button>
  <span id="scopeLoading" style="display:none; margin-left:10px;">‚è≥ Connexion...</span>
</div>

<div id="scopeSuccess" style="display:none; margin-top:10px;">
  <button id="btnOpenScope">üñ•Ô∏è Ouvrir VisionScope2</button>
</div>
    <label for="temperature">üå° Temp√©rature (¬∞C)</label>
    <input type="number" id="temperature" step="0.1" class="text1"/>
    <label for="fc">‚ù§Ô∏è Fr√©quence cardiaque (bpm)</label>
    <input type="number" id="fc"class="text1" />
    <label for="ta">üíì Tension art√©rielle</label>
    <input type="text" id="ta" class="text1" />
    <label for="saturation">üí® Saturation (%)</label>
    <input type="number" id="saturation" min="0" max="100" step="1" class="text1"/>
    <label for="fr">üòÆüí® FR</label>
    <input type="number" id="fr" min="0" max="50" step="1" class="text1"/>
    <label for="douleur">üòñ Douleur /10</label>
    <input type="number" id="douleur" min="0" max="10" step="1" class = "text1"/>
	<br>
    <button id="btnGlasgow" style="margin-top:10px; background-color:#9b59b6;">üß† Score de Glasgow</button>
    <br><br>
    <button id="btnSaveConst">üíæ Enregistrer constantes</button>
 
  	<br>
  <hr>
	<br>
    <h3>Poids / Taille / IMC</h3>
    <div class="inline-fields">
      <div class="field-group">
        <label for="poids">Poids (kg)</label>
        <input type="number" id="poids" step="0.1" class="text1"/>
     
      <div class="field-group">
        <label for="taille">Taille (cm) </label>
        <input type="number" id="taille" step="1" class="text1"/>
      </div>
      <div class="field-group">
        <label>IMC</label>
        <span id="imc"></span>
      </div>
    </div>
		</div>
		<br>
    <button id="btnSavePoids">üíæ Enregistrer poids/taille/IMC</button>
  
</div>


<div id="tab-historique" class="tab-content">
  <div class="tab-header">
    <h3>üìú Historique</h3>    
  </div>
  
    <h3>Historique de l'hospitalisation en cours</h3>
    <div id="historique"></div>
 
</div>



<div id="tab-dossier" class="tab-content">
  <div class="tab-header">
    <h3>üìã Dossier M√©dical</h3>
  </div>
      <label>Questionnaire IAO <button class="bouton-horloge" onclick="ajouterHorodatageDans('questionnaire')">‚è∞</button></label>
      <textarea id="questionnaire"></textarea>
      <label>Ant√©c√©dents <button class="bouton-horloge" onclick="ajouterHorodatageDans('antecedents')">‚è∞</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('antecedents')">üìÇ</button>
</label>
      <textarea id="antecedents" ></textarea>
      <label>Traitements en cours <button class="bouton-horloge" onclick="ajouterHorodatageDans('traitements')">‚è∞</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('traitements')">üìÇ</button>
</label>
      <textarea id="traitements" ></textarea>
      <label>Histoire de la maladie <button class="bouton-horloge" onclick="ajouterHorodatageDans('histoire')">‚è∞</button></label>
      <textarea id="histoire" style=></textarea>
      <label>CR Auscultation Init.<button class="bouton-horloge" onclick="ajouterHorodatageDans('auscultation')">‚è∞</button></label>
      <textarea id="auscultation"></textarea>
	<br>
      <button onclick="enregistrerDossierMedical()">üíæ Enregistrer</button>
     
    	<br>
  <hr>
	<br>
  
    <h3>üìà √âvolution aux urgences <button class="bouton-horloge" onclick="ajouterHorodatageDans('evolutionTexte')">‚è∞</button></h3>
    <textarea id="evolutionTexte"></textarea>
    <br>
    <button onclick="enregistrerEvolution()">üíæ Enregistrer</button>
 
</div>


<div id="tab-exam-actes" class="tab-content">
  <div class="tab-header">
    <h3>‚ò¢Ô∏è Examens & üíâ Actes</h3>
   
  </div>
  <h4>üìã Examens</h4>
	<label>Examens demand√©s / r√©alis√©s</label>
<div id="examensListe" class="mt-2 p-2 border rounded bg-gray-50"></div>
  <button id="btnOuvrirModaleDemande" style="margin-top:10px;">‚ûï Nouvelle demande d‚Äôexamen</button>
 
  
	<br>
  <hr>
	<br>
  <h4>üíâ Actes</h4>
  <label>Type d‚Äôacte</label>
  <input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" />
  <ul id="suggestionsActes"></ul>
  <label>üë®‚Äç‚öïÔ∏è R√©alis√© par</label>
  <select id="selectRealisateur"><option>‚è≥Chargement...</option></select>
  <label>üí¨ Remarques</label>
  <textarea id="remarqueActe"></textarea>
  <h4>Actes r√©alis√©s :</h4>
  
  <div id="actesListe"></div>
  <div class="modal-buttons">
    <button id="btnFermerActe">‚ùå Annuler</button>
    <button id="btnEnregistrerActe" class="success">‚úîÔ∏è Enregistrer</button>
  </div>
</div>



<div class="modal-overlay" id="modalExamen" style="display:none;">
  <div class="modal">
    <h3>Demande d‚Äôexamen</h3>
    <button class="exam-button" onclick="toggleSublist('prise-sang-list')">ü©∏ Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (Num√©ration Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Calc√©mie"> Calc√©mie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan h√©patique"> Bilan h√©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan r√©nal"> Bilan r√©nal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="H√©moglobine glyqu√©e (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="S√©rologies virales (VIH, VHB, VHC)"> S√©rologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Recherche Alcool√©mie"> Alcool√©mie</label>
	  <label><input type="checkbox" onchange="toggleExam(this)" value="Prise de sang autre"> Autre</label>
  </div>
<button class="exam-button" onclick="toggleSublist('urine-list')">üß™ Examens urinaires</button>
<div class="sub-list" id="urine-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobact√©riologique des urines)"> ECBU</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Prot√©inurie des 24h"> Prot√©inurie 24h</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage cr√©atinine urinaire"> Cr√©atinine urinaire</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre">Examens Urinaires Autre</label>
</div>
  <button class="exam-button" onclick="toggleSublist('radio-list')">üì∏ Radiologie</button>
<div class="sub-list" id="radio-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du cr√¢ne"> Cr√¢ne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie Autre"> autre</label>

</div>

<button class="exam-button" onclick="toggleSublist('irm-list')">üß≤ IRM</button>
<div class="sub-list" id="irm-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM c√©r√©brale"> C√©r√©brale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM √©paule"> √âpaule</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="IRM autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('scanner-list')">üñ•Ô∏è Scanner</button>
<div class="sub-list" id="scanner-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner c√©r√©bral"> C√©r√©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner c√©r√©bral"> Angioscanner c√©r√©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Scanner autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('echo-list')">üß≠ √âchographie</button>
<div class="sub-list" id="echo-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie r√©nale"> R√©nale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie h√©patique"> H√©patique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie thyro√Ødienne"> Thyro√Ødienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie mammaire"> Mammaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie testiculaire"> Testiculaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="√âchographie cardiaque (ETT)"> Cardiaque (ETT)</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres inf√©rieurs"> Doppler veineux MI</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler art√©riel des membres inf√©rieurs"> Doppler art√©riel MI</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value=" √âchographieautre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('eos-list')">ü¶¥ EOS</button>
<div class="sub-list" id="eos-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres inf√©rieurs"> Membres inf√©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres sup√©rieurs"> Membres sup√©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="EOS autre"> autre</label>
</div>
<h4>Examens s√©lectionn√©s :</h4>
<div id="examensSelectionnes" style="margin-bottom: 10px;"></div>

    <label for="commentaireExamen">üí¨ Commentaire</label>
    <textarea id="commentaireExamen" placeholder="D√©tails suppl√©mentaires..."></textarea>
     <button id="btnCancelExamen" class="secondary">‚ùå Fermer</button>
      <button id="btnSaveExamen">‚úÖ Valider</button>
    </div>
</div>
<div id="tab-sortie-docs" class="tab-content">
  <div class="tab-header">
    <h3>üö™ Sortie & üìÑ Documents</h3>

  </div>
<h3>Type de sortie</h3>
    <label><input type="radio" name="typeSortie" value="Retour √† domicile" /> üè° Domicile</label><br/>
    <label><input type="radio" name="typeSortie" value="Hospitalisation" /> üè• Hospitalisation</label><br/>
    <label><input type="radio" name="typeSortie" value="Transfert" /> ‚ÜîÔ∏è Transfert</label><br/>
	    <label><input type="radio" name="typeSortie" value="D√©c√®s" />‚ö∞Ô∏è D√©c√®s</label><br/>
    <label>
      <input type="radio" name="typeSortie" value="autre" /> üî§ Autre
      <input type="text" id="champAutreSortie" placeholder="Pr√©cisez..." style="margin-top: 8px; display:none;" />
    </label>

    <hr/>

    <h3>Options suppl√©mentaires</h3>
    <label><input type="checkbox" name="optionsSortie" value="Suivi a domicile" /> üìã Suivi √† domicile</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Avis specialiste" /> üë©‚Äç‚öïÔ∏è Avis sp√©cialiste</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Transport  en ambulance" /> üöë Transport ambulance</label><br/>
    <label>
      <input type="checkbox" name="optionsSortie" value="autreOption" /> üî§ Autre option
      <input type="text" id="champAutreOption" placeholder="Pr√©cisez..." style="margin-top: 8px; display:none;" />
    </label>
	<hr/>
<h3>üíä Traitement de sortie</h3>
<textarea id="champTraitementSortie"	 rows="3" style="width:100%; margin-bottom: 10px;"></textarea>

    <hr/>

    <div id="sortieListe"></div> 
    <div class="modal-buttons">
      <button id="btnAnnulerSortie">‚ùå Annuler</button>
      <button id="btnValiderSortie">‚úÖ Valider</button>
    </div>
  <hr>
  <h4>üìÑ Documents</h4>
	<br>
<form class="vidal-search" action="https://www.vidal.fr/recherche.html" method="get" target="_blank">
  <input type="text" name="query" placeholder="Rechercher sur le Vidal">
  <button type="submit">Rechercher</button>
</form>


  <button id="btnRapportHospi">üìÉ Rapport d'hospitalisation</button>
	<br><br>
  <button id="btnVersFiche">üìÑ Ordonnancier</button>
	<br><br>
  <button id="btnVersExs">üìÑ Prescripteur d'examens</button>
	<br><br>
  <button id="btnVersSynthese">üìÑ Certificat m√©dical</button>
	<br><br>
  <button id="btnVersFiches">üìÑ Fiches Conseils</button>
</div>


<div id="modalRawData" class="modal-overlay">
  <div class="modal">
    <div class="modal-content">
      <button id="closeRawData" title="Fermer la fen√™tre">‚ùå</button>
      <h2>üìä Hospitalisations du patient</h2>
      <div id="hospitalisationsContent"></div>
    </div>
  </div>
</div>

	


<!-- Modal Cl√¥ture -->
<div class="modal-overlay" id="modalCloture">
  <div class="modal" style="text-align: center;">
    <h3>‚è≥Cl√¥ture en cours...</h3>
    <div style="background:#eee; border-radius: 10px; overflow:hidden; margin-top: 15px;">
      <div id="clotureBar" style="height: 12px; background-color: #0078d4; width: 0%; transition: width 0.3s;"></div>
    </div>
    <p style="margin-top:10px; color:#666;">Merci de patienter</p>
  </div>
</div>

</main>
<!-- Modal Gestion Administrative -->
<div class="modal-overlay" id="modalAdmin" style="display:none;">
  <div class="modal">
    <h3>üõ† Gestion Administrative</h3>
    
    <label for="adminId">ID Patient</label>
    <input type="text" id="adminId" disabled />
	
	<label for="adminNom">Nom</label>
    <input type="text" id="adminNom" />
	<label for="adminPrenom">Pr√©nom</label>
<input type="text" id="adminPrenom" />

	
	
	<label for="adminSexe">Sexe</label>
	<select id="adminSexe" >
  <option value="">-- S√©lectionnez --</option>
  <option value="M">M</option>
  <option value="Mme">Mme</option>
  <option value="L'enfant">L'enfant</option>
</select>

	<label for="adminNaissance">Date de naissance</label>
<input type="date" id="adminNaissance"  />

	
    <label for="adminAdresse">Adresse</label>
    <input type="text" id="adminAdresse" />

    <label for="adminTelephone">T√©l√©phone</label>
    <input type="text" id="adminTelephone" />

    <label for="adminEmail">Email</label>
    <input type="text" id="adminEmail" />

    <div class="modal-buttons">
	    <button type="button" id="readVitaleBtn" class="button" style="background-color: #28a745; color: white;">üÜî Lecture Carte Vitale</button>
      <button id="btnFacturer" class="success">üí∂ Facturer</button>
	    <button id="btnCloturer" style="flex:1; background-color:#d9534f;">‚úÖ Cl√¥turer hospitalisation</button>
            <br><br>
			<button id="btnFermerAdmin" class="danger">‚ùåFermer</button>
	  <button id="btnEnregistrerAdmin" class="primary">üíæEnregistrer</button>

    </div>
  </div>
</div>
 

<div id="vitaleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">‚è≥Lecture Carte Vitale en cours...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="facturationModale" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">‚è≥Chargement des informations...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="modal-overlay" id="modalGlasgow">
  <div class="modal">
    <h3>üß† Score de Glasgow</h3>
    <img src="glasgow.jpg" alt="√âchelle de Glasgow" style="width:100%; margin-bottom:15px; border-radius:8px;" />
    
    <label>üëÅ Ouverture des yeux (max 4)</label>
    <input type="number" id="glasgowYeux" min="1" max="4" />

    <label>üó£ R√©ponse verbale (max 5)</label>
    <input type="number" id="glasgowVerbal" min="1" max="5" />

    <label>üí™ R√©ponse motrice (max 6)</label>
    <input type="number" id="glasgowMoteur" min="1" max="6" />

    <label>üéØ Score total</label>
    <input type="number" id="glasgowTotal" disabled />

<div id="glasgowPronostic" style="margin: 10px 0; font-style: italic;"></div>
<div id="glasgowPronostic2" style="margin: 10px 0; font-style: italic;"></div>
    <div class="modal-buttons">
      <button id="btnFermerGlasgow" class="secondary">‚ùå Fermer</button>
      <button id="btnEnregistrerGlasgow" class="success">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<script>
   const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
	 firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
	// R√©cup√©rer l'ID du patient depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// Cr√©er la r√©f√©rence au document patient
const patientRef = db.collection("patients").doc(patientId);

  function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }
function openTab(tabId, event) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
  document.querySelectorAll(".tablink").forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  if (event) event.currentTarget.classList.add("active");
}

  function calculerAge(dateNaissance) {
    const birth = new Date(dateNaissance);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    if (
      now.getMonth() < birth.getMonth() ||
      (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age;
  }
// --- R√©f√©rences aux √©l√©ments ---
const sortieListe = document.getElementById("sortieListe");
const champAutreSortie = document.getElementById("champAutreSortie");
const champAutreOption = document.getElementById("champAutreOption");
const champTraitementSortie = document.getElementById("champTraitementSortie");
document.getElementById("btnValiderSortie").addEventListener("click", async () => {
  const type = document.querySelector('input[name="typeSortie"]:checked')?.value || "";
  const options = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  const sortie = {
    type,
    options,
    autreSortieTexte: type === "autre" ? champAutreSortie.value.trim() : "",
    autreOptionTexte: options.includes("autreOption") ? champAutreOption.value.trim() : "",
    destinationTransfert: document.getElementById("champDestinationTransfert")?.value || "",
    serviceHospitalisation: document.getElementById("champServiceHospitalisation")?.value || "",
    avisSpecialiste: document.getElementById("champAvisSpecialiste")?.value || "",
    traitementSortie: champTraitementSortie.value.trim()
  };

  try {
    await updateHospitalisationField("sortie", sortie);
    afficherSortieListe(sortie);
    afficherBulle("‚úîÔ∏è Sortie enregistr√©e", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement sortie :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de la sortie", "alerte");
  }
});

document.getElementById("btnAnnulerSortie").addEventListener("click", () => {
  champAutreSortie.value = "";
  champAutreOption.value = "";
  champTraitementSortie.value = "";
  sortieListe.innerHTML = "<p>Aucune sortie enregistr√©e.</p>";
});

// Container dynamique pour les champs sp√©cifiques
let containerDynamique = document.getElementById("optionsSpecifiques");
if (!containerDynamique) {
  containerDynamique = document.createElement("div");
  containerDynamique.id = "optionsSpecifiques";
  document.querySelector("#tab-sortie-docs").insertBefore(containerDynamique, sortieListe);
}
async function chargerPatient(patientId) {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "flex";

  try {
    const doc = await db.collection("patients").doc(patientId).get();
    if (!doc.exists) {
      afficherBulle("‚ùå Patient introuvable", "alerte");
      return;
    }

 const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    // --- Infos patient ---
	 document.getElementById("idPatient").textContent = patientId || "Non d√©fini";
    document.getElementById("nom").textContent = data.nom || "";
    document.getElementById("prenom").textContent = data.prenom || "";
    document.getElementById("sexe").textContent = data.sexe || "";
    document.getElementById("poids").value = data.poids || "";
    document.getElementById("taille").value = data.taille || "";

    // IMC
    const poids = parseFloat(data.poids);
    const taille = parseFloat(data.taille);
    const elImc = document.getElementById("imc");
    if (!isNaN(poids) && !isNaN(taille) && taille > 0) {
      elImc.textContent = (poids / ((taille / 100) ** 2)).toFixed(1);
    } else {
      elImc.textContent = "‚Äì";
    }

    // √Çge
    if (data.dateNaissance) {
      const age = calculerAge(data.dateNaissance);
      document.getElementById("age").textContent = !isNaN(age) ? `${age} ans` : "Inconnu";
    }

    // --- Hospitalisation courante ---
    if (hospi) {
      // üîπ Informations d‚Äôhospitalisation
      document.getElementById("gravite").value = hospi.gravite || "";
      document.getElementById("motif").value = hospi.motif || "";
      document.getElementById("moyen").value = hospi.moyen || "";

      // üîπ Constantes vitales
      document.getElementById("temperature").value = hospi.constantes?.temperature || "";
      document.getElementById("fc").value = hospi.constantes?.fc || "";
      document.getElementById("ta").value = hospi.constantes?.ta || "";
      document.getElementById("saturation").value = hospi.constantes?.saturation || "";
	  document.getElementById("fr").value = hospi.constantes?.fr || "";
      document.getElementById("douleur").value = hospi.constantes?.douleur || "";

      // üîπ Dossier m√©dical (nouvelle section)
      const dm = hospi.dossierMedical || {};
	  document.getElementById("questionnaire").value = dm.questionnaire || "";
      document.getElementById("antecedents").value = dm.antecedents || "";
      document.getElementById("traitements").value = dm.traitements || "";
      document.getElementById("histoire").value = dm.histoire || "";
      document.getElementById("auscultation").value = dm.auscultation || "";

      // üîπ √âvolution aux urgences
      document.getElementById("evolutionTexte").value = hospi.evolution || "";
	}
   const hospiSnap = await db.collection("patients")
      .doc(patientId)
      .collection("hospitalisations")
      .orderBy("dateAdmission", "desc") // ou autre crit√®re
      .limit(1)
      .get();

    if (!hospiSnap.empty) {
      const hospiDoc = hospiSnap.docs[0];   // dernier s√©jour
      // --- Charger actes & examens depuis les sous-collections ---
      await chargerActes(patientId);
      await chargerExamens(patientId, hospiDoc.id);
    }

    // Services et R√©alisateurs
    chargerServices();
    chargerRealisateurs();

  } catch (err) {
    console.error("Erreur chargement patient :", err);
    afficherBulle("‚ùå Erreur de chargement", "alerte");
  } finally {
    if (overlay) overlay.style.display = "none";
  }
}

async function updateHospitalisationField(field, value) {
  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];

    hospitalisations[index] = { ...hospitalisations[index], [field]: value };

    await patientRef.update({ hospitalisations });

    ajouterEntreeHistorique(`Modification de ${field} : ${value}`);
    
  } catch (err) {
    console.error(`Erreur mise √† jour ${field} :`, err);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
}


	document.getElementById("btnOuvrirModaleDemande").addEventListener("click", () => {
  document.getElementById("modalExamen").style.display = "block";
});

	
// --- Rafra√Æchissement des champs dynamiques ---
function rafraichirChampsSortie() {
  const typeSortie = document.querySelector('input[name="typeSortie"]:checked')?.value;
  const optionsSortie = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  containerDynamique.innerHTML = "";

  if (typeSortie === "Transfert") {
    const label = document.createElement("label");
    label.textContent = "Destination du transfert";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champDestinationTransfert";
    input.placeholder = "Ex: CHU Lyon";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  if (typeSortie === "Hospitalisation") {
    const label = document.createElement("label");
    label.textContent = "Service hospitalisation";
    const select = document.createElement("select");
    select.id = "champServiceHospitalisation";

    // R√©cup√©ration dynamique depuis Firestore
    db.collection("r√©f√©rentiels").doc("sp√©cialit√©s").get().then(doc => {
      const data = doc.data();
      (data?.sp√©cialit√©s || []).forEach(service => {
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });
    });

    containerDynamique.appendChild(label);
    containerDynamique.appendChild(select);
  }

  if (optionsSortie.includes("Avis specialiste")) {
    const label = document.createElement("label");
    label.textContent = "Sp√©cialiste consult√©";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champAvisSpecialiste";
    input.placeholder = "Ex: Dr Dupont (Cardio)";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  // Affichage du champ "autre option"
  champAutreOption.style.display = optionsSortie.includes("autreOption") ? "block" : "none";
}

// --- Gestion champ "autre sortie" ---
document.querySelectorAll('input[name="typeSortie"]').forEach(radio => {
  radio.addEventListener("change", () => {
    champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
    rafraichirChampsSortie();
  });
});

document.querySelectorAll('input[name="optionsSortie"]').forEach(cb => {
  cb.addEventListener("change", rafraichirChampsSortie);
});

// --- Affichage sortie ---
function afficherSortieListe(sortie) {
  if (!sortie || !sortie.type) {
    sortieListe.innerHTML = "<p>Aucune sortie enregistr√©e.</p>";
    return;
  }

  let html = `
    <p><strong>Type de sortie :</strong> ${sortie.type}</p>
    <p><strong>Options :</strong> ${sortie.options?.join(", ") || "Aucune"}</p>
  `;

  if (sortie.destinationTransfert) html += `<p><strong>‚ÜîÔ∏è Destination :</strong> ${sortie.destinationTransfert}</p>`;
  if (sortie.serviceHospitalisation) html += `<p><strong>üè• Service :</strong> ${sortie.serviceHospitalisation}</p>`;
  if (sortie.avisSpecialiste) html += `<p><strong>üë®‚Äç‚öïÔ∏è Sp√©cialiste :</strong> ${sortie.avisSpecialiste}</p>`;
  if (sortie.autreOptionTexte) html += `<p><strong>üî§ Autre option :</strong> ${sortie.autreOptionTexte}</p>`;
  if (sortie.traitementSortie) html += `<p><strong>üíä Traitement de sortie :</strong> ${sortie.traitementSortie}</p>`;

  html += `<button id="btnSupprimerSortie" class="danger" style="margin-top:10px;">üóë Supprimer</button>`;
  sortieListe.innerHTML = html;

  document.getElementById("btnSupprimerSortie").addEventListener("click", async () => {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    delete hospitalisations[index].sortie;
    if (hospitalisations[index].traitementSortie) hospitalisations[index].traitementSortie = "";

    await patientRef.update({ hospitalisations });
    sortieListe.innerHTML = "<p>Sortie supprim√©e.</p>";
    afficherBulle("üóëÔ∏è Sortie supprim√©e", "administratif");
  });
}
document.addEventListener("DOMContentLoaded", () => {
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
  if (patientId) {
    chargerPatient(patientId);
  }
});


function formaterDate(dateStr) {
  if (!dateStr) return "";
  const match = dateStr.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (match) {
    const [_, jj, mm, aaaa] = match;
    return `${aaaa}-${mm}-${jj}`;
  }
  if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return dateStr;
  }
  return "";
}
    
// --- Recherche et suggestions d'actes ---
const inputActe = document.getElementById("rechercherActe");
const suggestionsActes = document.getElementById("suggestionsActes");

inputActe.addEventListener("input", async (e) => {
  const recherche = e.target.value.trim().toLowerCase();
  suggestionsActes.innerHTML = "";

  // attendre au moins 2 caract√®res
  if (recherche.length < 2) return;

  try {
    // üîπ R√©cup√®re la liste des actes depuis Firestore
    const doc = await db.collection("r√©f√©rentiels").doc("actes").get();
    const data = doc.data();
    const actes = data?.liste || [];

    // üîπ Filtrage des r√©sultats
    const filtres = actes.filter(a => a.toLowerCase().includes(recherche));

    if (filtres.length === 0) {
      suggestionsActes.innerHTML = "<li style='color:#999;'>Aucun r√©sultat</li>";
      return;
    }

    // üîπ Affichage des suggestions
    filtres.forEach(acte => {
      const li = document.createElement("li");
      li.textContent = acte;
      li.style.cursor = "pointer";
      li.style.padding = "5px";
      li.addEventListener("mouseover", () => li.style.background = "#eee");
      li.addEventListener("mouseout", () => li.style.background = "transparent");
      li.addEventListener("click", () => {
        inputActe.value = acte;      // remplir la barre avec l‚Äôacte choisi
        suggestionsActes.innerHTML = ""; // vider les suggestions
      });
      suggestionsActes.appendChild(li);
    });
  } catch (err) {
    console.error("Erreur recherche actes :", err);
    suggestionsActes.innerHTML = "<li style='color:red;'>‚ö†Ô∏è Erreur de chargement</li>";
  }
});


document.getElementById("gravite").addEventListener("change", e => {
  updateHospitalisationField("gravite", e.target.value);
});

document.getElementById("motif").addEventListener("blur", e => {
  updateHospitalisationField("motif", e.target.value.trim());
});
document.getElementById("moyen").addEventListener("blur", e => {
  updateHospitalisationField("moyen", e.target.value.trim());
});

async function ajouterEntreeHistorique(texte) {
  const date = new Date().toLocaleString();
  const entree = { date, texte };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    const hospitalisations = data.hospitalisations || [];
    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].historique = hospitalisations[index].historique || [];

    hospitalisations[index].historique.push(entree);

    await patientRef.update({ hospitalisations });

    afficherHistorique(entree);
  } catch (error) {
    console.error("Erreur ajout historique :", error);
  }
}




  document.getElementById("btnSavePoids").addEventListener("click", async () => {
  const poids = parseFloat(document.getElementById("poids").value);
  const taille = parseFloat(document.getElementById("taille").value);

  if (!poids || !taille) {
    afficherBulle("‚ùå Veuillez entrer un poids et une taille valides", "alerte");
    return;
  }

  try {
    await patientRef.update({ poids, taille });
    ajouterEntreeHistorique(`Poids/Taille/IMC enregistr√©s: ${poids}kg / ${taille}cm`);
    afficherBulle("‚úîÔ∏è Poids et taille enregistr√©s", "administratif");
    chargerPatient(); // üîÑ recalcul IMC
  } catch (err) {
    console.error("Erreur enregistrement poids/taille :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement du poids/taille", "alerte");
  }
});





document.getElementById("btnSaveConst").addEventListener("click", async () => {
  const constantes = {
    temperature: document.getElementById("temperature").value.trim() || "",
    fc: document.getElementById("fc").value.trim() || "",
    ta: document.getElementById("ta").value.trim() || "",
    saturation: document.getElementById("saturation").value.trim() || "",
    fr: document.getElementById("fr").value.trim() || "",
    douleur: document.getElementById("douleur").value.trim() || ""
  };

  try {
    await updateHospitalisationField("constantes", constantes);
    afficherBulle("‚úîÔ∏è Constantes enregistr√©es", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement constantes :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement des constantes", "alerte");
  }
});


  async function initialiserScope(patientId) {
  const doc = await patientRef.get();
  if (!doc.exists) return;

  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospi = data.hospitalisations?.[index] || {};

  const checkbox = document.getElementById("patientScopeCheckbox");
  const fields = document.getElementById("scopeFields");
  const successDiv = document.getElementById("scopeSuccess");
  const numInput = document.getElementById("scopeNum");

  // üîπ Lecture depuis Firestore
  if (hospi.scope) {
    checkbox.checked = hospi.scope.scopeActive || false;
    if (hospi.scope.scopeActive) {
      fields.style.display = "block";
      numInput.value = hospi.scope.numero || "";
      successDiv.style.display = "block";
    }
  }

  // üîπ Changement de statut du scope
  checkbox.addEventListener("change", async () => {
    const actif = checkbox.checked;
    if (!actif) {
      fields.style.display = "none";
      successDiv.style.display = "none";
      await updateHospitalisationField("scope", { scopeActive: false, numero: "" });
      afficherBulle("‚úîÔ∏è Scope d√©sactiv√©", "administratif");
      return;
    }
    fields.style.display = "block";
    await updateHospitalisationField("scope", { scopeActive: true, numero: "" });
  });

  // üîπ Simulation de connexion au scope
  document.getElementById("btnConnectScope").addEventListener("click", async () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("‚ùåVeuillez entrer un num√©ro de scope", "alerte");
      return;
    }
    document.getElementById("scopeLoading").style.display = "inline";
    setTimeout(async () => {
      document.getElementById("scopeLoading").style.display = "none";
      successDiv.style.display = "block";
      await updateHospitalisationField("scope", { scopeActive: true, numero });
      afficherBulle(`‚úîÔ∏è Scope ${numero} connect√©`, "administratif");
    }, 1500);
  });

  // üîπ Ouverture du scope.html
  document.getElementById("btnOpenScope").addEventListener("click", () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("‚ùåNum√©ro de scope manquant", "alerte");
      return;
    }
    window.open(`scope.html?num=${encodeURIComponent(numero)}`, "_blank");
  });
}

// üß† Int√©gration dans le chargement patient
document.addEventListener("DOMContentLoaded", async () => {
  if (patientId) {
    await chargerPatient(patientId);
    await initialiserScope(patientId);
  }
});

  const historiqueContainer = document.getElementById("historique");

// Fonction pour charger tout l'historique de l'hospitalisation en cours
async function chargerHistorique() {
  try {
    const doc = await patientRef.get();
    const data = doc.data();

    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    if (!hospi || !hospi.historique || hospi.historique.length === 0) {
      historiqueContainer.innerHTML = "<p>Aucune entr√©e dans l'historique.</p>";
      return;
    }

    historiqueContainer.innerHTML = ""; // on vide avant d'afficher

    hospi.historique.forEach(entry => {
      afficherHistorique(entry);
    });
  } catch (error) {
    console.error("Erreur chargement historique :", error);
  }
}

// Fonction d'affichage d'une seule entr√©e dans le DOM
function afficherHistorique(entry) {
  if (!historiqueContainer) return;
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = `<strong>${entry.date}</strong><br>${entry.texte}`;
  historiqueContainer.appendChild(div);
}

  function afficherHistoriqueAncienne(hospitalisation, index) {
    if (!historiqueAncienContainer) return;
    const titre = document.createElement("div");
    titre.innerHTML = `<strong style="color:#d9534f">Hospitalisation ${index + 1} (${hospitalisation.dateDebut} - ${hospitalisation.dateFin || "en cours"})</strong>`;
    historiqueAncienContainer.appendChild(titre);
    hospitalisation.historique?.forEach(entry => afficherHistorique(entry, "ancien"));
  }
  function clearHistoriqueAnciennes() {
    if(historiqueAncienContainer) historiqueAncienContainer.innerHTML = "";
  }
  function clearHistorique() {
    if(historiqueContainer) historiqueContainer.innerHTML = "";
  }
  const btnDemandeExamen = document.getElementById("btnDemandeExamen");
const fenetreExamens = document.getElementById("fenetreExamens");
const listeExamens = document.getElementById("listeExamens");
const btnOuvrirModaleDemande = document.getElementById("btnOuvrirModaleDemande");


const modalExamen = document.getElementById("modalExamen");
const typeExamen = document.getElementById("typeExamen");
const commentaireExamen = document.getElementById("commentaireExamen");
const btnSaveExamen = document.getElementById("btnSaveExamen");





btnOuvrirModaleDemande.addEventListener("click", () => {
  
  commentaireExamen.value = "";
  modalExamen.style.display = "flex";
});

// Modale annulation
btnCancelExamen.addEventListener("click", () => {
  modalExamen.style.display = "none";
});

document.getElementById("btnSaveExamen").addEventListener("click", async () => {
  const commentaire = document.getElementById("commentaireExamen").value.trim();

  // R√©cup√©rer tous les examens coch√©s
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']:checked");
  const examens = Array.from(checkboxes).map(cb => cb.value);

  if (examens.length === 0) {
    afficherBulle("‚ùå Veuillez s√©lectionner au moins un examen", "alerte");
    return;
  }

  const date = new Date().toLocaleString();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    if (!hospitalisations[index].examens) hospitalisations[index].examens = [];

    // Ajouter chaque examen individuellement
    examens.forEach(type => {
      hospitalisations[index].examens.push({
        type,
        commentaire,
        dateDemande: date,
        realise: false
      });
    });

    await patientRef.update({ hospitalisations });

    modalExamen.style.display = "none";
    afficherBulle("‚úîÔ∏è Examens enregistr√©s", "administratif");
    ajouterEntreeHistorique(`üìã Examens demand√©s : ${examens.join(", ")}`);
	  reinitialiserFormulaireExamen();
	  chargerExamens();
  } catch (err) {
    console.error("Erreur enregistrement examens :", err);
    afficherBulle("‚ùå Erreur enregistrement", "alerte");
  }
  
});
	function reinitialiserFormulaireExamen() {
  // D√©coche tous les checkboxes dans le modal
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']");
  checkboxes.forEach(cb => cb.checked = false);

  // Vide le commentaire
  document.getElementById("commentaireExamen").value = "";
}

  document.getElementById("btnCloturer").addEventListener("click", async () => {
  const code = prompt("Entrez le code secret pour cl√¥turer l'hospitalisation :");
  if (!code) return;

  try {
    const codeDoc = await db.collection("patients").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = codeDoc.data().QhwMJ0mjmUnS8MTNBCFU;

    if (code !== codeAttendu) {
      afficherBulle("‚ùå Code incorrect", "alerte");
      return;
    }

    // Code correct ‚Üí d√©marrage cl√¥ture
    document.getElementById("modalCloture").style.display = "flex";
    const bar = document.getElementById("clotureBar");
    bar.style.width = "0%";
    let progress = 0;

    const interval = setInterval(() => {
      progress += 1;
      bar.style.width = `${progress}%`;
      if (progress >= 100) clearInterval(interval);
    }, 30);

    setTimeout(async () => {
      try {
        const now = new Date().toLocaleString();
        const doc = await patientRef.get();
        const data = doc.data();
        const index = data.hospitalisationIndex ?? 0;
        const hospitalisations = data.hospitalisations || [];

        if (hospitalisations[index]) {
          hospitalisations[index].dateFin = now;
          hospitalisations[index].historique = hospitalisations[index].historique || [];
          hospitalisations[index].historique.push({ date: now, texte: "Hospitalisation cl√¥tur√©e" });
          hospitalisations[index].rapport = `Rapport d'hospitalisation pour ${data.nom} ${data.prenom} cl√¥tur√© le ${now}.`;

          await patientRef.update({
            hospitalisations,
            hospitalisationIndex: index + 1,
            hospitalisationActive: false
          });

          alert("‚úÖ Hospitalisation cl√¥tur√©e.");
window.location.href = "urgences.html?id=QhwMJ0mjmUnS8MTNBCFU";
        }
      } catch (error) {
        console.error("Erreur cl√¥ture hospitalisation :", error);
        afficherBulle("‚ö†Ô∏èErreur de cl√¥ture", "alerte");
      } finally {
        document.getElementById("modalCloture").style.display = "none";
      }
    }, 3200);

  } catch (err) {
    console.error("Erreur lors de la v√©rification du code :", err);
    afficherBulle("Erreur de v√©rification du code", "alerte");
  }
});
  

document.getElementById("btnAdmin").addEventListener("click", () => {
  document.getElementById("modalAdmin").style.display = "block";
});


  document.getElementById("btnVersFiche").addEventListener("click", () => {
    window.open(`Ordonnancier.html?id=${patientId}`, '_blank');
  });
document.getElementById("btnVersExs").addEventListener("click", () => {
    window.open(`prescriptionexamens.html?id=${patientId}`, '_blank');
  });
  document.getElementById("btnVersSynthese").addEventListener("click", () => {
    window.open(`Certificatmedical.html?id=${patientId}`, '_blank');
  });
  document.getElementById("btnVersFiches").addEventListener("click", () => {
    window.open(`fichesconseil.html`, '_blank');
  });



// Gestion Administrative
const modalAdmin = document.getElementById("modalAdmin");
const btnAdmin = document.getElementById("btnAdmin");
const btnFermerAdmin = document.getElementById("btnFermerAdmin");
const btnEnregistrerAdmin = document.getElementById("btnEnregistrerAdmin");
const btnFacturer = document.getElementById("btnFacturer");

btnAdmin.addEventListener("click", async () => {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    document.getElementById("adminId").value = patientId;
	document.getElementById("adminNom").value = data.nom || "";
    document.getElementById("adminPrenom").value = data.prenom || "";
    document.getElementById("adminSexe").value = data.sexe || "";
document.getElementById("adminNaissance").value = data.dateNaissance || "";
    document.getElementById("adminAdresse").value = data.adresse || "";
    document.getElementById("adminTelephone").value = data.telephone || "";
    document.getElementById("adminEmail").value = data.email || "";
    modalAdmin.style.display = "flex";
  } catch (e) {
    console.error("Erreur ouverture admin :", e);
    afficherBulle("‚ùåErreur chargement gestion dministrative", "alerte");
  }
});

btnFermerAdmin.addEventListener("click", () => {
  modalAdmin.style.display = "none";
});

btnEnregistrerAdmin.addEventListener("click", async () => {
  const adresse = document.getElementById("adminAdresse").value.trim();
  const telephone = document.getElementById("adminTelephone").value.trim();
  const email = document.getElementById("adminEmail").value.trim();
  const sexe = document.getElementById("adminSexe").value;
const dateNaissance = document.getElementById("adminNaissance").value.trim();




  try {
    await patientRef.update({ adresse, telephone, email, sexe, dateNaissance });
    afficherBulle("‚úîÔ∏è Coordonn√©es mises √† jour", "administratif");
    modalAdmin.style.display = "none";
  } catch (e) {
    console.error("Erreur maj admin :", e);
    afficherBulle("‚ùåErreur enregistrement admin", "alerte");
  }
});

btnFacturer.addEventListener("click", () => {
  window.open(`Facturation.html?id=${patientId}`, "_blank");
});

let tousLesActesRealises = [];


const btnFermerActe = document.getElementById("btnFermerActe");
const btnEnregistrerActe = document.getElementById("btnEnregistrerActe");
const selectActe = document.getElementById("selectActe");
const champAutreActe = document.createElement("input");
champAutreActe.type = "text";
champAutreActe.id = "champAutreActe";
champAutreActe.placeholder = "Pr√©ciser le type d‚Äôacte";
champAutreActe.style.display = "none";
champAutreActe.style.marginTop = "8px";

document.getElementById("btnFermerActe").addEventListener("click", () => {
  afficherBulle("‚ÑπÔ∏è Fermeture sans enregistrement", "administratif");
});



let tousLesActesDispos = [];

async function chargerEtInitialiserRechercheActe() {
  try {
    const doc = await db.collection("r√©f√©rentiels").doc("actes").get();
    const data = doc.data();
    tousLesActesDispos = Array.isArray(data?.liste) ? data.liste : [];
  } catch (e) {
    console.error("Erreur chargement actes :", e);
    tousLesActesDispos = [];
  }

  const champ = document.getElementById("rechercherActe");
  const suggestions = document.getElementById("suggestionsActes");

  champ.addEventListener("input", () => {
    const texte = champ.value.toLowerCase().trim();
    suggestions.innerHTML = "";

    if (!texte) {
      suggestions.style.display = "none";
      return;
    }

    const filtres = tousLesActesDispos.filter(nom =>
      nom.toLowerCase().includes(texte)
    );

    filtres.forEach(nom => {
      const li = document.createElement("li");
      li.textContent = nom;
      li.style.padding = "6px 10px";
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        champ.value = nom;
        suggestions.style.display = "none";
      });
      suggestions.appendChild(li);
    });

    suggestions.style.display = filtres.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!champ.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.style.display = "none";
    }
  });
}


function mettreAJourListeActes(filtre) {
  const selectActe = document.getElementById("selectActe");
  selectActe.innerHTML = "";

  const actesFiltres = tousLesActesDispos.filter(acte =>
    acte.toLowerCase().includes(filtre)
  );

  actesFiltres.forEach(nom => {
    const opt = document.createElement("option");
    opt.value = nom;
    opt.textContent = nom;
    selectActe.appendChild(opt);
  });

  const optAutre = document.createElement("option");
  optAutre.value = "autre";
  optAutre.textContent = "üî§ Autre (√† pr√©ciser)";
  selectActe.appendChild(optAutre);
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  const doc = await db.collection("r√©f√©rentiels").doc("personnel").get();
  const data = doc.data();

  select.innerHTML = "";

  if (data && Array.isArray(data.liste)) {
    data.liste.forEach(nom => {
      const opt = document.createElement("option");
      opt.value = nom;
      opt.textContent = nom;
      select.appendChild(opt);
    });
  }
}


async function afficherActesRealises(filtreType = "tous") {
  const doc = await patientRef.get();
  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const actes = data.hospitalisations?.[index]?.actes_realises || [];
  tousLesActesRealises = actes;

  const container = document.getElementById("listeActesRealises");
  const liste = filtreType === "tous" ? actes : actes.filter(a => a.type === filtreType);

  if (liste.length === 0) {
    container.innerHTML = `
      <p style="color:#999; font-style:italic;">
        Aucun acte enregistr√© pour ce patient.
      </p>`;
    return;
  }

  container.innerHTML = "";

  liste.forEach((a, i) => {
    const div = document.createElement("div");
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <strong>${a.date}</strong> <br>
	  <span style="color:#0078d4">üíâActe : ${a.type}</span><br>
      üë®‚Äç‚öïÔ∏è R√©alis√© par : <strong>${a.realisateur}</strong><br>
      üí¨ Remarque : <em>${a.remarque || "‚Äì"}</em><br>
      <button class="bouton-supprimer" onclick="supprimerActeRealise(${i})">üóë Supprimer</button>
      <hr/>
    `;
    container.appendChild(div);
  });
}

function ajouterFiltreTypeActe() {
  const select = document.createElement("select");
  select.id = "filtreTypeActe";
  select.innerHTML = `<option value="tous">Tous les types</option>`;
  document.getElementById("listeActesRealises").before(select);

  const typesUniques = [...new Set(tousLesActesRealises.map(a => a.type))];
  typesUniques.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });

  select.addEventListener("change", (e) => {
    afficherActesRealises(e.target.value);
  });
}

async function supprimerActeRealise(index) {
  if (!confirm("Supprimer cet acte ?")) return;

  const doc = await patientRef.get();
  const data = doc.data();
  const iHospi = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  const actes = [...(hospitalisations[iHospi].actes_realises || [])];
  const acteSupprim√© = actes[index];

  actes.splice(index, 1);
  hospitalisations[iHospi].actes_realises = actes;

  await patientRef.update({ hospitalisations });

  ajouterEntreeHistorique(`‚ùå Acte supprim√© : ${acteSupprim√©.type} (par ${acteSupprim√©.realisateur})`);
  afficherActesRealises(document.getElementById("filtreTypeActe")?.value || "tous");
  afficherBulle("üóëÔ∏è Acte supprim√©", "administratif");
}

document.getElementById("btnEnregistrerActe").addEventListener("click", async () => {
  const type = document.getElementById("rechercherActe").value.trim();
  const realisateur = document.getElementById("selectRealisateur").value;
  const remarque = document.getElementById("remarqueActe").value.trim();

  if (!type) {
    afficherBulle("‚ùå Veuillez saisir un type d‚Äôacte", "alerte");
    return;
  }

  const acte = {
    type,
    realisateur,
    remarque,
   date: new Date().toLocaleString("fr-FR", {
  day: "2-digit",
  month: "2-digit",
  year: "numeric",
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit"
})

  };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];
    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].actes = hospitalisations[index].actes || [];
    hospitalisations[index].actes.push(acte);

    await patientRef.update({ hospitalisations });

    afficherBulle("‚úîÔ∏è Acte enregistr√©", "administratif");
    document.getElementById("rechercherActe").value = "";
    document.getElementById("remarqueActe").value = "";
  } catch (err) {
    console.error("Erreur enregistrement acte :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de l‚Äôacte", "alerte");
  }
});

async function chargerServices() {
  try {
    const doc = await db.collection("r√©f√©rentiels").doc("sp√©cialit√©s").get();
    const data = doc.data();
    const services = data?.sp√©cialit√©s || [];

    const select = document.getElementById("service");
    select.innerHTML = ""; // vide les anciennes options

    services.forEach(service => {
      const option = document.createElement("option");
      option.value = service;
      option.textContent = service;
      select.appendChild(option);
    });

    // Pr√©-remplir si une valeur existe
    const patientDoc = await patientRef.get();
    const patientData = patientDoc.data();
    const index = patientData.hospitalisationIndex ?? 0;
    const hospi = patientData.hospitalisations?.[index];
    if (hospi?.service) select.value = hospi.service || "";

  } catch (e) {
    console.error("Erreur chargement services :", e);
  }
}

// √âcouteur de modification
document.getElementById("service").addEventListener("change", async (e) => {
  const service = e.target.value;
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index] = {
      ...hospitalisations[index],
      service
    };

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Changement de service : ${service}`);
  } catch (err) {
    console.error("Erreur mise √† jour service :", err);
  }
});
	
function reinitialiserFormulaireActe() {
  document.getElementById("selectActe").value = "";
  document.getElementById("selectRealisateur").value = "";
  document.getElementById("remarqueActe").value = "";
  champAutreActe.value = "";
  champAutreActe.style.display = "none";
}

async function verifierCodeEtCloturer(idPatient, callbackCloture) {
  const saisie = prompt("Entrez le mot de passe de cl√¥ture d'hospitalisation :");
  if (!saisie) return;

  try {
    const doc = await db.collection("codes").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = doc.data().QhwMJ0mjmUnS8MTNBCFU;

    if (saisie !== codeAttendu) {
      afficherBulle("‚ùå Code incorrect", "alerte");
      return;
    }

    callbackCloture(); // Lance la cl√¥ture si le code est bon

  } catch (err) {
    console.error(err);
    afficherBulle("‚ùåErreur lors de la v√©rification du code", "alerte");
  }
}
function formatDateHeure(dateString) {
  const date = new Date(dateString);
  const pad = (n) => n.toString().padStart(2, '0');
  const jour = pad(date.getDate());
  const mois = pad(date.getMonth() + 1);
  const annee = date.getFullYear();
  const heures = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  const secondes = pad(date.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}

document.getElementById('readVitaleBtn').addEventListener('click', () => {
  const modal = document.getElementById('vitaleModal');
  modal.style.display = 'flex';

  const duration = 3000 + Math.random() * 7000; // entre 3 et 10 secondes

  setTimeout(() => {
    modal.style.display = 'none';

    const isSuccess = Math.random() < 0.8; // 80% ok-20%erreur

    if (isSuccess) {
      afficherBulle("‚úÖ Lecture Carte Vitale termin√©e !", "administratif");
    } else {
      afficherBulle("‚ùå Erreur lecture Carte Vitale - Veuillez ressayer", "alerte");
    }
  }, duration);
});

document.getElementById("btnGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "flex";
});

document.getElementById("btnFermerGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "none";
});

["glasgowYeux", "glasgowVerbal", "glasgowMoteur"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
    const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
    const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
    const total = yeux + verbal + moteur;
    document.getElementById("glasgowTotal").value = total;

    const pronostic = document.getElementById("glasgowPronostic");
    if (total <= 4) pronostic.innerText = " 7 % de bonne r√©cup√©ration et 87 % de mortalit√©.";
    else if (total <= 7) pronostic.innerText = "34 % de bonne r√©cup√©ration et 53 % de mortalit√©.";
    else if (total <= 10) pronostic.innerText = " 68 % de bonne r√©cup√©ration et 27 % de mortalit√©.";
    else pronostic.innerText = " 82 % de bonne r√©cup√©ration et 12 % de mortalit√©.";
  
  const pronostic2 = document.getElementById("glasgowPronostic2");
    if (total <= 6) pronostic.innerText = "Coma Profond";
    else if (total <= 9) pronostic.innerText = "Coma Lourd";
    else if (total <= 14) pronostic.innerText = "Somnoloence / Coma L√©ger";
    else pronostic.innerText = "Conscience Normale";
});
});
function toggleSublist(id) {
    const list = document.getElementById(id);
    list.style.display = list.style.display === "block" ? "none" : "block";
  }

	
document.getElementById("btnEnregistrerGlasgow").addEventListener("click", async () => {
  const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
  const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
  const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
  const total = yeux + verbal + moteur;
  const texte = `Score de Glasgow enregistr√© : ${total} (Yeux ${yeux}, Verbal ${verbal}, Moteur ${moteur})`;

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    hospitalisations[index].glasgow = { yeux, verbal, moteur, total, date: new Date().toISOString() };

    await patientRef.update({ hospitalisations });

    await ajouterEntreeHistorique(texte);
    afficherBulle("‚úîÔ∏è Score de Glasgow enregistr√©", "administratif");
    document.getElementById("modalGlasgow").style.display = "none";
  } catch (e) {
    console.error("Erreur enregistrement Glasgow :", e);
    afficherBulle("‚ùå Erreur enregistrement", "alerte");
  }
});
function ajouterHorodatage() {
  const textarea = document.getElementById("texteRemarque");
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR');
  const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const horodatage = `${dateStr} ${timeStr} - ${medecinNom} : `;

  textarea.value += textarea.value && !textarea.value.endsWith('\n') ? '\n' + horodatage : horodatage;
  textarea.focus();
}

function ajouterHorodatageDans(id) {
  const textarea = document.getElementById(id);
  if (!textarea) return;

  const horodatage = new Date().toLocaleString("fr-FR");
const insertion = `${horodatage} - ${window.medecinNom}\n`;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;

  const texteAvant = textarea.value.substring(0, start);
  const texteApres = textarea.value.substring(end);

  textarea.value = texteAvant + insertion + texteApres;

  const nouvellePosition = start + insertion.length;
  textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
  textarea.focus();
}


async function enregistrerDossierMedical() {
  const dossierMedical = {
    questionnaire: document.getElementById("questionnaire").value.trim(),
    antecedents: document.getElementById("antecedents").value.trim(),
    traitements: document.getElementById("traitements").value.trim(),
    histoire: document.getElementById("histoire").value.trim(),
    auscultation: document.getElementById("auscultation").value.trim()
  };

  try {
    await updateHospitalisationField("dossierMedical", dossierMedical);
    afficherBulle("‚úîÔ∏è Dossier m√©dical enregistr√©", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement dossier m√©dical :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement du dossier m√©dical", "alerte");
  }
}



async function enregistrerEvolution() {
  const evolution = document.getElementById("evolutionTexte").value.trim();

  try {
    await updateHospitalisationField("evolution", evolution);
    afficherBulle("‚úîÔ∏è √âvolution enregistr√©e", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement √©volution :", err);
    afficherBulle("‚ùå Erreur lors de l‚Äôenregistrement de l‚Äô√©volution", "alerte");
  }
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>‚è≥Chargement...</option>";
  try {
    const snapshot = await db.collection("r√©f√©rentiels").doc("r√©alisateurs").get();
    const data = snapshot.data();
    select.innerHTML = "";
    (data?.liste || []).forEach(realisateur => {
      const option = document.createElement("option");
      option.value = realisateur;
      option.textContent = realisateur;
      select.appendChild(option);
    });
  } catch (e) {
    console.error("Erreur chargement r√©alisateurs :", e);
    select.innerHTML = "<option>‚ö†Ô∏è Erreur chargement</option>";
  }
}

async function chargerHistoriqueComplet() {
  const contenu = document.getElementById("hospitalisationsContent");
  if (!contenu) {
    console.error("Element #hospitalisationsContent introuvable");
    return;
  }
  contenu.innerHTML = "<p>‚è≥ Chargement...</p>";

  try {
    const patientDoc = await db.collection("patients").doc(patientId).get();
    if (!patientDoc.exists) {
      contenu.innerHTML = "<p>‚ùå Patient introuvable</p>";
      return;
    }

    const data = patientDoc.data();
    let hospitalisations = Array.isArray(data.hospitalisations) ? data.hospitalisations : [];

if (hospitalisations.length > 1) {
      hospitalisations = hospitalisations.slice(0, -1);
    } else {
      hospitalisations = []; // aucune hospitalisation pr√©c√©dente
    }

    if (hospitalisations.length === 0) {
      contenu.innerHTML = "<p>Aucune hospitalisation ant√©rieure.</p>";
      return;
    }

    contenu.innerHTML = "";

    hospitalisations
      .slice() // copie
      .reverse() // plus r√©centes d'abord
      .forEach((hospi, idx) => {
        const card = document.createElement("div");
        card.className = "card";

      const date = hospi.dateDebut || hospi.dateDebut || "Date inconnue";
		 const datef = hospi.dateFin || hospi.dateFin || "Date inconnue";
      const motif = hospi.motif || "‚Äî";
      const gravite = hospi.gravite || "‚Äî";
      const evolution = hospi.evolution || "Aucune √©volution enregistr√©e.";
      const dossier = hospi.dossierMedical || {};
      const sortie = hospi.sortie || null;
	  const rapport = hospi.rapport || "Pas de rapport d'hospitalisation valid√©";

      // construire le HTML via un tableau de parties (plus s√ªr)
      const parts = [];

      parts.push(`<div class="entry"><strong>üìÖ Admission :</strong> ${date}</div>`);
		parts.push(`<div class="entry"><strong>üìÖ Sortie :</strong> ${datef}</div>`);
      parts.push(`<div class="entry"><strong>Motif :</strong> ${motif}</div>`);
      parts.push(`<div class="entry"><strong>Gravit√© :</strong> ${gravite}</div>`);
      parts.push(`<hr>`);
      parts.push(`<h3>üìã Dossier m√©dical</h3>`);
		parts.push(`<p><strong>Questionnaire IAO :</strong><br>${dossier.questionnaire || "‚Äî"}</p>`);
      parts.push(`<p><strong>Ant√©c√©dents :</strong><br>${dossier.antecedents || "‚Äî"}</p>`);
      parts.push(`<p><strong>Traitements :</strong><br>${dossier.traitements || "‚Äî"}</p>`);
      parts.push(`<p><strong>Histoire de la maladie :</strong><br>${dossier.histoire || "‚Äî"}</p>`);
      parts.push(`<p><strong>CR Auscultation :</strong><br>${dossier.auscultation || "‚Äî"}</p>`);
      parts.push(`<hr>`);
      parts.push(`<h3>üìà √âvolution aux urgences</h3>`);
      parts.push(`<p style="white-space:pre-wrap">${evolution}</p>`);

      // ajout de la sortie si pr√©sente
      if (sortie) {
        parts.push(`<hr>`);
        parts.push(`<h3>üö™ Sortie</h3>`);
        parts.push(`<p><strong>Type :</strong> ${sortie.type || "‚Äî"}</p>`);

        if (sortie.serviceHospitalisation)
          parts.push(`<p><strong>üè• Service hospitalisation :</strong> ${sortie.serviceHospitalisation}</p>`);

        if (sortie.destinationTransfert)
          parts.push(`<p><strong>‚ÜîÔ∏è Destination transfert :</strong> ${sortie.destinationTransfert}</p>`);

        if (sortie.avisSpecialiste)
          parts.push(`<p><strong>üë©‚Äç‚öïÔ∏è Avis sp√©cialiste :</strong> ${sortie.avisSpecialiste}</p>`);

        if (Array.isArray(sortie.options) && sortie.options.length > 0)
          parts.push(`<p><strong>üìã Options :</strong> ${sortie.options.join(", ")}</p>`);

        if (sortie.traitementSortie)
          parts.push(`<p><strong>üíä Traitement de sortie :</strong><br>${sortie.traitementSortie}</p>`);

        if (sortie.autreSortieTexte)
          parts.push(`<p><strong>üî§ Autre :</strong> ${sortie.autreSortieTexte}</p>`);

        if (sortie.autreOptionTexte)
          parts.push(`<p><strong>üî§ Autre option :</strong> ${sortie.autreOptionTexte}</p>`);
      }
 parts.push(`<p><strong></strong> ${rapport}</p>`);
      // affecter le HTML final
      card.innerHTML = parts.join("\n");
      contenu.appendChild(card);
    });

  } catch (err) {
    console.error("Erreur chargement historique :", err);
    contenu.innerHTML = "<p>‚ùå Erreur lors du chargement de l'historique.</p>";
  }
}
// --- Lier le bouton d‚Äôouverture de l‚Äôhistorique ---
document.getElementById("btnVoirRawData").addEventListener("click", async () => {
  document.getElementById("modalRawData").style.display = "flex";
  await chargerHistoriqueComplet();
});

// --- Bouton fermeture modale ---
document.getElementById("closeRawData").addEventListener("click", () => {
  document.getElementById("modalRawData").style.display = "none";
});

async function chargerActes(patientId) {
  const container = document.getElementById("actesListe");
  container.innerHTML = "<p>‚è≥ Chargement des actes...</p>";

  try {
    const doc = await db.collection("patients").doc(patientId).get();
    if (!doc.exists) {
      container.innerHTML = "<p style='color:red;'>‚ùå Patient introuvable.</p>";
      return;
    }

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0; // hospitalisation active
    const hospi = data.hospitalisations?.[index];

    if (!hospi || !hospi.actes || hospi.actes.length === 0) {
      container.innerHTML = "<p>Aucun acte enregistr√© pour ce s√©jour.</p>";
      return;
    }

    // --- Affichage des actes ---
    container.innerHTML = "";
    hospi.actes.forEach((acte) => {
      const div = document.createElement("div");
      div.className = "prescription-item";
      div.innerHTML = `
        <div>
          <strong>${acte.type || "Acte inconnu"}</strong><br>
          üë®‚Äç‚öïÔ∏è ${acte.realisateur || "‚Äì"}<br>
          üìÖ ${acte.date || "‚Äì"}<br>
          üí¨ ${acte.remarque || ""}
        </div>
      `;
      container.appendChild(div);
    });

  } catch (err) {
    console.error("Erreur chargement actes :", err);
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è Erreur lors du chargement des actes</p>";
  }
}




// fonction utilitaire pour supprimer un acte
async function supprimerActe(patientId, hospiId, acteId) {
  if (!confirm("Supprimer cet acte ?")) return;
  try {
    await db.collection("patients")
      .doc(patientId)
      .collection("hospitalisation")
      .doc(hospiId)
      .collection("actes")
      .doc(acteId)
      .delete();
    afficherBulle("üóëÔ∏è Acte supprim√©", "administratif");
    await chargerActes(patientId); // üîÑ refresh
  } catch (err) {
    console.error("Erreur suppression acte :", err);
    afficherBulle("‚ùå Erreur lors de la suppression", "alerte");
  }
}
async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>‚è≥ Chargement...</option>";

  try {
    // On suppose que tu stockes les r√©alisateurs dans "r√©f√©rentiels/realisateurs"
    const doc = await db.collection("r√©f√©rentiels").doc("personnel").get();
    const data = doc.data();
    const liste = data?.liste || [];

    if (liste.length === 0) {
      select.innerHTML = "<option>Aucun disponible</option>";
      return;
    }

    select.innerHTML = "";
    liste.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Erreur chargement r√©alisateurs :", err);
    select.innerHTML = "<option>‚ö†Ô∏è Erreur de chargement</option>";
  }
}
// --- Fonction pour charger et afficher les examens ---
async function chargerExamens() {
  try {
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const data = snap.data();
    const hosp = data.hospitalisations?.[data.hospitalisationIndex];
    if (!hosp || !hosp.examens) {
      document.getElementById("examensListe").innerHTML = "<i>Aucun examen enregistr√©.</i>";
      return;
    }

    const liste = hosp.examens.map(ex => `
      <div class="examen-encart" style="margin-bottom:8px; padding:10px; border-radius:8px; background:${ex.realise ? '#eaf9ea' : '#f5faff'};">
        <p><b>‚ò¢Ô∏èType :</b> ${ex.type || "N/A"}</p>
        <p><b>üí¨Commentaire :</b> ${ex.commentaire || ""}</p>
        <p><b>üìÖDate demande :</b> ${ex.dateDemande || "?"}</p>
        ${ex.realise ? `<p><b>‚úÖ R√©alis√© le :</b> ${ex.dateRealisation || "?"}</p>
		<p><b>üìÑCompte rendu :</b> ${ex.compteRendu || ""}</p>` : ""}
      </div>
    `).join("");

    document.getElementById("examensListe").innerHTML = liste || "<i>Aucun examen enregistr√©.</i>";
  } catch (e) {
    console.error("Erreur lors du chargement des examens :", e);
    document.getElementById("examensListe").innerHTML = "<i>Erreur de chargement.</i>";
  }
}

const originalOpenTab = window.openTab;
window.openTab = function(tabName, evt) {
  originalOpenTab(tabName, evt);
  if (tabName === "tab-exam-actes") {
    chargerExamens();
  }
};
async function remplirDepuisAncienneHospi(champ) {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    if (index <= 0) {
      afficherBulle("‚ùå Aucune hospitalisation ant√©rieure", "alerte");
      return;
    }

    const ancienne = data.hospitalisations?.[index - 1]?.dossierMedical;
    if (!ancienne || !ancienne[champ]) {
      afficherBulle(`‚ùå Pas d'ancien contenu pour ${champ}`, "alerte");
      return;
    }

    const contenu = ancienne[champ].trim();
    const textarea = document.getElementById(champ);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const avant = textarea.value.substring(0, start);
    const apres = textarea.value.substring(end);
    const insertion = contenu + "\n";

    textarea.value = avant + insertion + apres;

    const nouvellePosition = start + insertion.length;
    textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
    textarea.focus();

    afficherBulle(`üìÅ Ancien ${champ} ins√©r√©`, "administratif");

  } catch (err) {
    console.error("Erreur r√©cup√©ration donn√©es pr√©c√©dentes :", err);
    afficherBulle("‚ùå Erreur de r√©cup√©ration", "alerte");
  }
}

document.getElementById("btnRapportHospi").addEventListener("click", () => {
    window.open(`rapporthospitalisation.html?id=${patientId}`, '_blank');
  });


document.addEventListener("DOMContentLoaded", () => {


  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";

  if (patientId) {
    chargerPatient(patientId);   // ‚úÖ passer l‚ÄôID
  } else {
    afficherBulle("‚ùå Aucun patientId fourni dans l‚ÄôURL", "alerte");
  }
});

// Ligne de test de fin
console.log("Script termin√© correctement ‚úÖ");
</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

   let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
        medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});
	function openTab(tabId, evt) {
  document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
  document.querySelectorAll(".tablink").forEach(tl => tl.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  evt.currentTarget.classList.add("active");
}
</script>

</body>
</html>


























































































































































