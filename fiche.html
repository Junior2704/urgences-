<!DOCTYPE html>
<html lang="fr">
<head>

<link rel="icon" type="image/jpeg" href="logo.jpg">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche Patient </title>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
   <style>

.bouton-ancienne {
  all: unset;
  cursor: pointer;
  font-size: 1em;
  margin-left: 5px;
  color: #2c7be5;   /* bleu */
  background: transparent !important; /* ğŸ‘ˆ reste transparent */
}

.bouton-ancienne:hover,
.bouton-ancienne:focus,
.bouton-ancienne:active {
  color: #1b4f9c;   /* un bleu plus foncÃ© pour l'effet visuel */
  background: transparent !important; /* ğŸ‘ˆ pas de fond */
  text-decoration: none; /* pas de soulignement */
  outline: none;  /* pas de bordure focus */
  box-shadow: none; /* pas dâ€™ombre */
}


	  hr {
  border: none;
  height: 4px;
  background-color: #0078d4; 
  border-radius: 2px;
  margin: 20px 0;
}

	 .tabs {
  display: flex;          /* aligne les boutons sur une ligne */
  width: 100%;            /* prend toute la largeur */
}

.tabs {
  display: flex;
  width: 100%;
}

.tablink {
  flex: 1;
  text-align: center;
  padding: 12px;
  border: none;
  cursor: pointer;
  background: #2196f3;      /* bleu normal */
  color: white;             /* texte blanc */
  font-size: 16px;
  transition: transform 0.2s, background 0.2s;
}

.tablink:hover {
  background: #1976d2;      /* bleu plus foncÃ© */
  transform: scale(1.05);   /* zoom lÃ©ger */
}

.tablink.active {
  background: #2196f3;      /* mÃªme bleu */
  color: black;             /* texte noir pour lâ€™actif */
  font-weight: bold;
  transform: scale(1.08);   /* zoom un peu plus marquÃ© */
}



.tab-content {
  display: none;
  width: 100%;       /* occupe toute la largeur */
  max-width: none;   /* enlÃ¨ve la limite de largeur */
  box-sizing: border-box;
}
.close-tab {
  all: unset;
  cursor: pointer;
  color: #c62828;     /* rouge vif */
  font-size: 20px;
  font-weight: bold;
  line-height: 1;
  background: transparent !important;  /* ğŸ‘ˆ force pas de fond */
  transition: transform 0.2s ease, color 0.2s ease;
}

.close-tab:hover,
.close-tab:focus,
.close-tab:active {
  transform: scale(1.3);
  color: #e53935;            /* rouge plus clair */
  background: transparent !important; /* ğŸ‘ˆ bloque le bleu moche */
  outline: none;             /* pas de contour par dÃ©faut */
  box-shadow: none;          /* supprime glow Ã©ventuel */
}

#hospitalisationsContent .card {
  margin-bottom: 20px;
  padding: 15px;
  border-left: 6px solid #0078d4;
}
#hospitalisationsContent h3 {
  margin-top: 0;
  color: #0078d4;
}
#hospitalisationsContent .entry {
  background: #f9f9f9;
  padding: 8px;
  border-radius: 6px;
  margin-bottom: 8px;
}


#examensListe,
#actesListe {
  max-width: none !important;  /* supprime la limite de largeur */
  width: 100% !important;      /* Ã©tire les blocs */
}



textarea {
  width: 100%;
  box-sizing: border-box;
  padding: 8px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical;       /* permet de redimensionner verticalement */
  border: 1px solid #ccc; /* bord fin et gris */
  border-radius: 6px;     /* coins arrondis */
  background-color: #fff; /* fond blanc */
}

/* Hauteur spÃ©cifique par champ */
#questionnaire {
  height: 150px;
  resize: vertical;
}

#antecedents {
 height: 150px;
  resize: vertical;
}

#traitements {
 height: 150px;
  resize: vertical;
}

#histoire {
   height: 300px;
  resize: vertical;
}
#auscultation {
  height: 300px;
  resize: vertical;
}


#evolutionTexte {
   height: 500px;
  resize: vertical;
}


#tab-dossier .card {
  max-width: none !important;
  width: 100% !important;
}

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
	  #dossierMedical input[type="text"],
#dossierMedical input[type="number"] {
  width: 100%;
}
	
	.bouton-horloge {
  all: unset;
  cursor: pointer;
  font-size: 1.1em;
  line-height: 1;
  margin-left: 5px;
  color: #555;
}
.bouton-horloge:hover,
.bouton-horloge:focus {
  outline: none;
  box-shadow: none;
  background-color: transparent; 
}

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h2 {
      margin: 0;
      color: #0078d4;
    }
    button, select, input[type="text"], input[type="number"] {
      font-size: 1rem;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s ease;
    }
    button {
      background-color: #0078d4;
      color: white;
      cursor: pointer;
      border: none;
      margin-right: 10px;
    }
    button:hover {
      background-color: #005ea2;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 25px;
      max-width: 600px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    .field-group {
      margin-bottom: 15px;
    }
    .inline-fields {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .inline-fields > div {
      flex: 1;
      min-width: 150px;
    }
  section.panel {
  display: none;
  position: relative;
  width: 100%;
  height: auto;
  z-index: 0;
  overflow: visible; /* âœ… important pour Ã©viter lâ€™apparition dâ€™un scroll interne */
}

section.panel.active {
  display: block;
  z-index: 1;
}
  
/* --- Correction complÃ¨te pour les cartes de l'historique --- */

/* === Correction finale : cartes d'historique adaptatives === */

#panel-historique,
#hospitalisationsContent {
  position: relative;
  width: 100%;
  overflow: visible;
}


#hospitalisationsContent .card {
  display: block !important;     /* empÃªche flex ou grid de les forcer */
  height: auto !important;       /* sâ€™adapte au contenu */
  min-height: unset !important;  /* supprime toute hauteur minimale forcÃ©e */
  flex: none !important;         /* Ã©vite flex-grow/shrink */
  align-self: auto !important;   /* empÃªche le stretch */
  width: 100% !important;
  max-width: none !important;
  box-sizing: border-box;
  background: #f9f9f9;
  border-left: 6px solid #0078d4;
  border-radius: 8px;
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  overflow: visible !important;  /* grandit selon le contenu */
  word-wrap: break-word;
  white-space: normal;
}


/* Chaque hospitalisation (carte) */
#hospitalisationsContent .card {
  width: 100% !important;         /* prend toute la largeur */
  max-width: none !important;     /* dÃ©sactive les limites globales */
  box-sizing: border-box;
  background: #f9f9f9;
  border-left: 6px solid #0078d4;
  border-radius: 8px;
  padding: 15px 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  overflow: visible !important;   /* sâ€™adapte au contenu long */
  word-wrap: break-word;          /* Ã©vite les dÃ©passements horizontaux */
  white-space: normal;            /* le texte revient bien Ã  la ligne */
}

/* Titre Ã  lâ€™intÃ©rieur des cartes */
#hospitalisationsContent .card h2 {
  margin-top: 0;
  color: #0078d4;
  border-bottom: 3px solid #0078d4;
  padding-bottom: 5px;
  margin-bottom: 15px;
}

/* Paragraphes et sections internes */
#hospitalisationsContent .card p,
#hospitalisationsContent .card div,
#hospitalisationsContent .card h3 {
  max-width: 100%;
  overflow: visible;
  white-space: pre-wrap;
  word-break: break-word;
}


    .modal-overlay {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.35);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
  background: white;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;         /* Limite la hauteur Ã  90% de la fenÃªtre */
  overflow-y: auto;         /* Affiche un ascenseur vertical si besoin */
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
}

    .modal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #0078d4;
    }
    .modal label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }
    .modal input[type="text"], .modal select, .modal textarea {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      resize: vertical;
    }
    .modal textarea {
      min-height: 80px;
    }
    .modal-buttons {
      text-align: right;
    }
    .modal-buttons button {
      margin-left: 10px;
      min-width: 90px;
    }
button {
  all: unset;
  display: inline-block;
  padding: 10px 16px;
  font-size: 1rem;
  border-radius: 8px;
  min-width: 120px;
  text-align: center;
  font-weight: 500;
  background-color: #0078d4;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Boutons secondaires */
button.secondary {
  background-color: #6c757d;
}

button.secondary:hover {
  background-color: #5a6268;
}

/* Boutons de validation */
button.success {
  background-color: #28a745;
}

button.success:hover {
  background-color: #218838;
}

/* Boutons dâ€™alerte / suppression */
button.danger {
  background-color: #dc3545;
}

button.danger:hover {
  background-color: #c82333;
}
	  

/* Cartes dâ€™hospitalisation */
#hospitalisationsContent {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

#hospitalisationsContent .card {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
  border-left: 8px solid #0078d4;
}

#hospitalisationsContent h3 {
  color: #0078d4;
  margin-top: 10px;
  margin-bottom: 8px;
}

#hospitalisationsContent p {
  margin: 5px 0;
  line-height: 1.5;
  white-space: pre-wrap; /* conserve les sauts de ligne */
  color: #333;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.98); }
  to { opacity: 1; transform: scale(1); }
}



/* Pour groupes de boutons cÃ´te Ã  cÃ´te */
.button-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.inline-fields {
  display: flex;
  gap: 20px; /* espace entre les champs */
  flex-wrap: wrap; /* pour que Ã§a passe Ã  la ligne si trop Ã©troit */
}

.field-group {
  display: flex;
  flex-direction: column;
  min-width: 150px; /* largeur mini des champs */
}
.bouton-supprimer {
  background-color: #e0e0e0;
  color: #555;
  border: none;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  cursor: pointer;
  margin-left: 4px;
}
.bouton-supprimer:hover {
  background-color: #ccc;
}

/* === COMPORTEMENT DÃ‰FINITIF DES ASCENSEURS === */

/* EmpÃªche tout scroll global et horizontal */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden; /* ğŸš« plus dâ€™ascenseur global */
}

/* Conteneur principal */
.app {
  display: flex;
  height: calc(100vh - 80px); /* occupe tout sauf le header */
  overflow: hidden; /* ğŸš« aucun scroll global dans le layout */
}

/* Menu fixe Ã  gauche */
nav {
  width: 260px;
  background: #fff;
  border-right: 1px solid #e0e0e0;
  padding: 15px;
  flex-shrink: 0;
  overflow: hidden; /* ğŸš« aucun ascenseur ici */
}

/* Zone de contenu Ã  droite */
.content {
  flex: 1;
  overflow-y: auto;  /* âœ… seul ascenseur vertical ici */
  overflow-x: hidden; /* ğŸš« pas de scroll horizontal */
  padding: 20px;
  box-sizing: border-box;
  background: #f4f6f8;
}

/* === Comportement responsive (mobile) === */
@media (max-width: 900px) {
  html, body {
    overflow: visible; /* le menu mobile utilise un overlay fixe */
  }

  nav {
    position: fixed;
    top: 0;
    left: -260px;
    bottom: 0;
    width: 260px;
    background: #fff;
    box-shadow: 3px 0 10px rgba(0,0,0,0.2);
    z-index: 2000;
    transition: left 0.3s ease;
    overflow-y: auto; /* âœ… ici, le menu mobile peut dÃ©filer si besoin */
  }

  nav.open {
    left: 0;
  }

  .content {
    overflow-y: auto;
    padding: 15px;
  }
}



main {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 10px;
  overflow: auto;
  flex: 1;
  justify-content: flex-start;
  align-content: flex-start;
}

.card {
  flex: 1 1 300px;
  max-height: 300px;
  overflow: auto;
  box-sizing: border-box;
  padding: 10px;
  margin: 0;
}
#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}

.exam-button {
  background-color: #007BFF;
  color: white;
  padding: 12px;
  width: 100%;
  border: none;
  border-radius: 6px;
  margin-top: 10px;
  cursor: pointer;
  font-size: 16px;
}
.exam-button:hover {
  background-color: #0056b3;
}
.sub-list {
  display: none;
  margin-top: 10px;
  padding-left: 10px;
}
.sub-list label {
  display: block;
  margin: 5px 0;
  cursor: pointer;
}
.prescription-item {
  background: #eef;
  padding: 10px;
  margin: 5px 0;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
}
.btn-delete {
  background-color: red;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 5px 10px;
  cursor: pointer;
}

/* Overlay de la modale */
#modalAdmin.modal-overlay {
  position: fixed;
  inset: 0; /* top:0; right:0; bottom:0; left:0; */
  background-color: rgba(0, 0, 0, 0.6);
  display: flex; /* garder le flex pour le centrage */
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease;
  z-index: 2000;
}

/* Overlay visible */
#modalAdmin.modal-overlay.show {
  opacity: 1;
  visibility: visible;
}

/* Modale elle-mÃªme */
#modalAdmin .modal {
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);

  /* Animation d'apparition fluide */
  transform: scale(0.95);
  opacity: 0;
  transition: transform 0.2s ease, opacity 0.2s ease;
}

/* Modale visible */
#modalAdmin.modal-overlay.show .modal {
  transform: scale(1);
  opacity: 1;
}

#modalCloture.modal-overlay {
  z-index: 3000; /* plus haut que #modalAdmin */
}
#modalActe.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 3000;
  display: none;
  justify-content: center;
  align-items: center;
}

#modalActe .modal {
  width: 95%;
  max-width: none;
  max-height: 95vh;
  height: 95vh;
  overflow-y: auto;
  border-radius: 12px;
  background: white;
  padding: 25px;
}


input[type="text"],
input[type="date"],
select {
  width: 100%;
  padding: 8px 12px;
  margin: 6px 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
  font-size: 16px;
  font-family: inherit;
  appearance: none; /* pour uniformiser certains navigateurs */
  background-color: #fff;
}
input.text1 {
  width: 120px;   /* largeur fixe, tu peux changer */
  display: inline-block;
}
	  input.text2 {
  width: 200px;   /* largeur fixe, tu peux changer */
  display: inline-block;
}
input[type="date"]::-webkit-inner-spin-button,
input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(0.5); /* optionnel : amÃ©liore l'intÃ©gration dans les thÃ¨mes clairs/foncÃ©s */
}

label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #f5f5f5; /* optionnel, pour une meilleure lisibilitÃ© */
  border-bottom: 1px solid #ccc;
}

.left-header h2 {
  margin: 0;
}

.right-header {
  font-size: 0.9em;
  color: #333;
}

  .vidal-search {
    display: flex;
   
    align-items: center;
    margin: 20px 0;
    font-family: Arial, sans-serif;
  }

  /* Input de recherche */
  .vidal-search input[type="text"] {
    padding: 10px;
    font-size: 16px;
    border: 2px solid #d32f2f; /* rouge Vidal */
    border-right: none; /* pour que le bouton soit collÃ© */
    border-radius: 4px 0 0 4px; /* coins arrondis cÃ´tÃ© gauche */
    outline: none;
    width: 300px;
  }

  /* Bouton de recherche */
  .vidal-search button {
    padding: 10px 20px;
    background-color: #d32f2f; /* rouge Vidal */
    color: white;
    font-size: 16px;
    border: 2px solid #d32f2f;
    border-radius: 0 4px 4px 0; /* coins arrondis cÃ´tÃ© droit */
    cursor: pointer;
    transition: background-color 0.3s;
  }

  /* Effet au survol */
  .vidal-search button:hover {
    background-color: #b71c1c; /* rouge plus foncÃ© au survol */
    border-color: #b71c1c;
  }
	  /* ğŸ¥ Modale de saisie du code de clÃ´ture */
#modalCodeCloture.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.55); /* voile sombre mais doux */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999; /* ğŸ‘‘ au-dessus de tout */
  animation: fadeInOverlay 0.25s ease;
}

/* FenÃªtre centrale */
#modalCodeCloture .modal {
  background: #ffffff;
  border-radius: 14px;
  padding: 30px 25px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
  text-align: center;
  animation: popIn 0.3s ease;
  border-top: 6px solid #0078d4; /* bleu mÃ©dical */
}

/* Titre */
#modalCodeCloture .modal h3 {
  margin-top: 0;
  color: #0078d4;
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 20px;
}

/* Champ input */
#modalCodeCloture input[type="password"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #ccd6e0;
  font-size: 1rem;
  font-family: "Segoe UI", Tahoma, sans-serif;
  box-sizing: border-box;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#modalCodeCloture input[type="password"]:focus {
  border-color: #0078d4;
  box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25);
  outline: none;
}

/* Boutons */
#modalCodeCloture .modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

/* Bouton Valider */
#btnValiderCode {
  background-color: #0078d4;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

#btnValiderCode:hover {
  background-color: #005ea2;
  transform: translateY(-1px);
}

/* Bouton Annuler */
#btnAnnulerCode {
  background-color: #6c757d;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

#btnAnnulerCode:hover {
  background-color: #5a6268;
  transform: translateY(-1px);
}

/* Animation d'apparition douce */
@keyframes fadeInOverlay {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes popIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
#loadingScreen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 99999;
  color: white;
  font-family: 'Inter', sans-serif;
  transition: opacity 0.5s ease;
}

#loadingScreen.hidden {
  opacity: 0;
}

.loader-content {
  text-align: center;
}

.spinner {
  border: 6px solid rgba(255, 255, 255, 0.3);
  border-top: 6px solid white;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}


/* ğŸŒ™ Switch ON/OFF */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:checked + .slider:before {
  transform: translateX(22px);
}

footer {
  margin-top: auto;
  padding: 15px;
  text-align: center;
  color: #777;
  font-size: 0.9rem;
}


.nav-title {
  font-weight: bold;
  color: #0078d4;
  margin-bottom: 10px;
}

.nav-item {
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  color: #333;
  transition: background 0.2s, transform 0.1s;
  margin-bottom: 6px;
}

.nav-item:hover {
  background: #eef6ff;
  transform: translateX(3px);
}

.nav-item.active {
  background: linear-gradient(90deg, #eaf4ff, #fff);
  border-left: 4px solid #0078d4;
  color: #0078d4;
  font-weight: bold;
}

.panel {
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 25px;
}
/* âœ… Correction finale : cartes de lâ€™historique auto-hauteur sans scroll */
#hospitalisationsContent .card {
  flex: none !important;       /* ne s'Ã©tire pas avec flexbox */
  height: auto !important;     /* sâ€™adapte Ã  la taille du texte */
  max-height: none !important; /* supprime la limite de hauteur */
  overflow: visible !important;/* pas de scrollbar interne */
}
/* === MENU RESPONSIVE CORRIGÃ‰ === */
.menu-toggle {
  display: none;
  background-color: #0078d4;
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
}

/* ğŸ“± Version mobile : menu cachÃ© par dÃ©faut */
@media (max-width: 900px) {
  .menu-toggle {
    display: inline-block;
  }

  nav {
    position: fixed;
    top: 0;
    left: -260px;
    bottom: 0;
    width: 260px;
    background: #fff;
    box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    transition: left 0.3s ease;
  }

  nav.open {
    left: 0;
  }

  .content {
    padding: 15px;
  }

  /* DÃ©sactive le scroll horizontal global */
  body {
    overflow-x: hidden;
  }
}

/* ğŸ’» Version bureau : menu toujours visible et fixe */
@media (min-width: 901px) {
  nav {
    position: static;
    left: 0;
    width: 260px;
    box-shadow: none;
    transition: none;
  }
  .content {
    margin-left: 0;
  }
}
html, body {
  overflow-x: hidden !important; /* stoppe tout dÃ©placement horizontal */
}




	   /* === CORRECTION : supprimer la bande blanche Ã  gauche sur mobile === */
@media (max-width: 900px) {
  html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden !important; /* ğŸš« empÃªche tout dÃ©bordement horizontal */
    background-color: #f4f6f8; /* mÃªme fond que ton contenu */
  }

  .app {
    overflow: hidden;
    width: 100vw; /* âœ… force Ã  prendre toute la largeur visible */
    position: relative;
  }

  nav {
    position: fixed;
    top: 0;
    left: -260px;
    width: 260px;
    bottom: 0;
    background: #fff;
    box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
    transition: left 0.3s ease;
    z-index: 2000;
  }

  nav.open {
    left: 0;
  }

  .content {
    width: 100vw; /* âœ… empÃªche tout â€œvideâ€ Ã  gauche */
    padding: 15px;
    background: #f4f6f8;
    box-sizing: border-box;
  }
}


/* === MENU SUPÃ‰RIEUR AVEC DÃ‰ROULANTS === */
.top-menu {
  display: flex;
  gap: 10px;
  background: #0078d4;
  padding: 10px 20px;
  border-radius: 0 0 8px 8px;
  position: sticky;
  top: 0;
  z-index: 1500;
}

.dropbtn {
  background: white;
  color: #0078d4;
  font-weight: 600;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s, transform 0.2s;
}

.dropbtn:hover {
  background: #eaf4ff;
  transform: translateY(-2px);
}

/* Conteneur de menu dÃ©roulant */
.dropdown {
  position: relative;
}

/* Sous-menu cachÃ© */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #fff;
  min-width: 180px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  border-radius: 8px;
  margin-top: 8px;
  z-index: 9999;
}

/* Liens du sous-menu */
.dropdown-content a {
  color: #333;
  padding: 10px 14px;
  text-decoration: none;
  display: block;
  transition: background 0.2s;
}

.dropdown-content a:hover {
  background-color: #eef6ff;
}

/* Affichage du menu au clic */
.dropdown.show .dropdown-content {
  display: block;
}

  </style>



</head>
<body>
<!-- === MENU HORIZONTAL SUPÃ‰RIEUR === -->
<div class="top-menu">
  <div class="dropdown">
    <button class="dropbtn">ğŸ“‘ Documents â–¼</button>
    <div class="dropdown-content">
      <a href="#" onclick="window.location.href='Ordonnancier.html?id=' + patientId">Ordonnancier</a>
      <a href="#" onclick="window.location.href='Certificatmedical.html?id=' + patientId">Certificats MÃ©dicaux</a>
      <a href="#" onclick="window.location.href='prescriptionexamens.html?id=' + patientId">Prescipteur d'examens</a>
      <a href="#" onclick="window.location.href='rapporthospitalisationl.html?id=' + patientId">Rapport d'hospitalisation</a>
      <a href="#" onclick="window.location.href='fichesconseil.html?id=' + patientId">Fiches Conseils</a>
      <a href="#" onclick="window.location.href='uploadpdf.html?id=' + patientId">AccÃ¨s PDF patients</a>
      <a href="#" onclick="window.location.href='etiquettes.html?id=' + patientId">Etiquettes</a>



    </div>
  </div>

  <div class="dropdown">
    <button class="dropbtn">ğŸ‘¤ Patient â–¼</button>
    <div class="dropdown-content">
      <a href="#" onclick="openSection('panel-patient')">IdentitÃ©</a>
      <a href="#" onclick="openSection('panel-admission')">Admission et Orientation</a>
      <a href="#" onclick="openSection('panel-constantes')">Admission et Orientation</a>
      <a href="#" onclick="openSection('panel-dossier')">Dosiier MÃ©dical</a>


    </div>
  </div>

  <div class="dropdown">
    <button class="dropbtn">âš™ï¸ Administration â–¼</button>
    <div class="dropdown-content">
      <a href="#" onclick="window.location.href='viewacount.html'">Mon compte</a>
      <a href="#" onclick="LogOut">Se Deconnecter</a>
    </div>
  </div>
</div>

<!-- Ã‰cran de chargement -->
<div id="loadingScreen">
  <div class="loader-content">
    <div class="spinner"></div>
    <h2>Chargement des donnÃ©es...</h2>
    <p>Merci de patienter quelques instants</p>
  </div>
</div>

<header>
  <div class="left-header">
	  <button id="menu-toggle" class="menu-toggle">â˜°</button>
 <h2 id="patientName">Fiche Patient</h2>
	   <span id="currentTime"></span>
		
  </div>
  <div class="right-header">
    ConnectÃ© en tant que <b><span id="nom-medecin"></span></b> (<span id="specialite"></span>)
	  <button class="close-tab" onclick="window.location.href='urgences.html'">âŒ</button>
  </div>
</header>
<div class="app">


 <nav>
    <div class="nav-title">Patient</div>
    <div id="navItems">
      <div class="nav-item active" data-module="patient">ğŸ‘¤ IdentitÃ© Patient</div>
	  <div class="nav-item" data-module="admission">ğŸ—‚ï¸ Admission et orientation</div>
      <div class="nav-item" data-module="constantes">ğŸ©º Constantes</div>
      <div class="nav-item" data-module="medsurgences">ğŸ’Š MÃ©dicaments aux Urgences</div>
      <div class="nav-item" data-module="dossier">ğŸ“‹ Dossier MÃ©dical</div>
      <div class="nav-item" data-module="actes">ğŸ’‰ Actes</div>
	        <div class="nav-item" data-module="examens">ğŸ©» Examens</div>

      <div class="nav-item" data-module="sortie">ğŸšª Sortie</div>
	  <div class="nav-item" data-module="documents">ğŸ“‘ Documents</div>

      <div class="nav-item" data-module="historique">ğŸ“œ Historique</div>
    </div>
  </nav>

<div class="content">	
<section id="panel-patient" class="panel" style="display:none;">
 
    <h3>ğŸ‘¤ IdentitÃ© patient</h3>
    
 
  <div>
  <label>CIP (Code d'Identification Patient)</label>
  <span id="idPatient"></span>
</div>

  <div>
    <label>Nom</label>
    <span id="nom"></span>
  </div>
  <div>
    <label>PrÃ©nom</label>
    <span id="prenom"></span>
  </div>
  <div>
    <label>Sexe</label>
    <span id="sexe"></span>
  </div>
  <div>
    <label>Ã‚ge</label>
    <span id="age"></span>
  </div>
<div>
  <label>Allergies</label>
  <input type="text" id="allergies" placeholder="Ex : PÃ©nicilline, arachides..." class="text2" />


<div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
  <label style="margin:0;">Allergie(s) importantes</label>
  <label class="switch" style="margin:0;">
    <input type="checkbox" id="importanceAllergies">
    <span class="slider"></span>
  </label>
</div>


  <br><br>
  <button id="btnAdmin" class="btn-admin">ğŸ›  Gestion Administrative</button>

	<button id="btnmailto">ğŸ“§ Mailto - patient</button>
  <button id="btnVersPdf">ğŸ“„ CrÃ©ation d'accÃ¨s PDF patient</button>
</div>
</section>

<section id="panel-medsurgences" class="panel" style="display:none;">
    <h3>ğŸ’Š Gestion des mÃ©dicaments aux Urgences</h3>

    <iframe id="medsurgencesFrame"
            style="width:100%; height:90vh; border:none; border-radius:10px;">
    </iframe>
</section>


<section id="panel-constantes" class="panel" style="display:none;">
  
    <h3>ğŸ©º Constantes</h3>
 


<h4>Scope</h4>

<label class="switch">
  <input type="checkbox" id="patientScopeCheckbox">
  <span class="slider"></span>
</label>
<span style="margin-left:10px; vertical-align:middle;">ğŸ”Œ Patient scopÃ©</span>



<div id="scopeFields" style="display:none; margin-top:10px;">
  <label for="scopeNum">NumÃ©ro de scope</label>
  <input type="text" id="scopeNum" class="text1" />
  <button id="btnConnectScope">ğŸ”Œ Connecter</button>
  <span id="scopeLoading" style="display:none; margin-left:10px;">â³ Connexion...</span>
</div>

<div id="scopeSuccess" style="display:none; margin-top:10px;">
  <button id="btnOpenScope">ğŸ–¥ï¸ Ouvrir VisionScope2</button>
</div>


 <hr>
    <label for="temperature">ğŸŒ¡ TempÃ©rature (Â°C)</label>
    <input type="number" id="temperature" step="0.1" class="text1"/>
    <label for="fc">â¤ï¸ FrÃ©quence cardiaque (bpm)</label>
    <input type="number" id="fc"class="text1" />
    <label for="ta">ğŸ’“ Tension artÃ©rielle</label>
    <input type="text" id="ta" class="text1" />
    <label for="saturation">ğŸ’¨ Saturation (%)</label>
    <input type="number" id="saturation" min="0" max="100" step="1" class="text1"/>
    <label for="fr">ğŸ˜®ğŸ’¨ FR</label>
    <input type="number" id="fr" min="0" max="50" step="1" class="text1"/>
    <label for="douleur">ğŸ˜– Douleur /10</label>
    <input type="number" id="douleur" min="0" max="10" step="1" class = "text1"/>
	<br>
    <button id="btnGlasgow" style="margin-top:10px; background-color:#9b59b6;">ğŸ§  Score de Glasgow</button>
    <br><br>
    <button id="btnSaveConst">ğŸ’¾ Enregistrer constantes</button>
 
  	<br>
  <hr>
	<br>
    <h4>Poids / Taille / IMC</h4>
    <div class="inline-fields">
      <div class="field-group">
        <label for="poids">Poids (kg)</label>
        <input type="number" id="poids" step="0.1" class="text1"/>
     
      <div class="field-group">
        <label for="taille">Taille (cm) </label>
        <input type="number" id="taille" step="1" class="text1"/>
      </div>
      <div class="field-group">
        <label>IMC</label>
        <span id="imc"></span>
      </div>
    </div>
		</div>
		<br>
    <button id="btnSavePoids">ğŸ’¾ Enregistrer poids/taille/IMC</button>
  
</section>


<section id="panel-historique" class="panel" style="display:none;">

    <h3>ğŸ“œ Historique</h3>    

  

  <div id="hospitalisationsContent"></div>
</section>


<section id="panel-admission" class="panel" style="display:none;">
  
  <h3> ğŸ—‚ï¸ Admission et orientation</h3>
  <label for="gravite" >ğŸš¨ GravitÃ©</label>
  <select id="gravite"class="text2" >
    <option value="P0">P0</option>
    <option value="P1">P1</option>
    <option value="P2">P2</option>
    <option value="P3">P3</option>
    <option value="Urgences_Vitales">Urgences Vitales</option>
    <option value="Administratif">Administratif</option>
  </select>

  <label for="service" >ğŸ¥ Service idÃ©al</label>
  <select id="service" class="text2"><option value="">Chargement...</option></select>
<label for="circuit">ğŸ§­ Circuit particulier</label>
<select id="circuit" class="text2">
  <option value=""></option>
  <option value="PÃ©diatrie">PÃ©diatrie</option>
  <option value="Traumatologie">Traumatologie</option>
  <option value="GynÃ©cologie">GynÃ©cologie</option>
  <option value="Psychiatrie">Psychiatrie</option>
  <option value="Ophtalmologie">Ophtalomologie</option>

</select>

  <label for="motif">ğŸ¤• Motif d'entrÃ©e</label>
  <input type="text" id="motif" placeholder="Motif d'entrÃ©e" class="text2" />

  <label for="moyen">ğŸš‘ Moyen d'entrÃ©e</label>
  <input type="text" id="moyen" placeholder="Moyen d'entrÃ©e" class="text2" />

    </section>
<section id="panel-dossier" class="panel" style="display:none;">

    <h3>ğŸ“‹ Dossier MÃ©dical</3>

      <label>Questionnaire IAO <button class="bouton-horloge" onclick="ajouterHorodatageDans('questionnaire')">â°</button></label>
      <textarea id="questionnaire"></textarea>
      <label>AntÃ©cÃ©dents <button class="bouton-horloge" onclick="ajouterHorodatageDans('antecedents')">â°</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('antecedents')">ğŸ“‚</button>
</label>
      <textarea id="antecedents" ></textarea>
      <label>Traitements en cours <button class="bouton-horloge" onclick="ajouterHorodatageDans('traitements')">â°</button>
	  <button class="bouton-ancienne" onclick="remplirDepuisAncienneHospi('traitements')">ğŸ“‚</button>
</label>
      <textarea id="traitements" ></textarea>
	  
      <label>Histoire de la maladie <button class="bouton-horloge" onclick="ajouterHorodatageDans('histoire')">â°</button></label>
      <textarea id="histoire" ></textarea>
	  
      <label>CR Auscultation Init.<button class="bouton-horloge" onclick="ajouterHorodatageDans('auscultation')">â°</button></label>
      <textarea id="auscultation"></textarea>
	<br>
      <button onclick="enregistrerDossierMedical()">ğŸ’¾ Enregistrer</button>
     
    	<br>
  <hr>

  
    <h3>ğŸ“ˆ Ã‰volution aux urgences <button class="bouton-horloge" onclick="ajouterHorodatageDans('evolutionTexte')">â°</button></h3>
    <textarea id="evolutionTexte"></textarea>
    <br>
    <button onclick="enregistrerEvolution()">ğŸ’¾ Enregistrer</button>
 
</section>


<section id="panel-actes" class="panel" style="display:none;">

    <h3>ğŸ’‰ Actes</h3>

  <label>Type dâ€™acte</label>
  <input type="text" id="rechercherActe" placeholder="Rechercher un acte..." autocomplete="off" />
  <ul id="suggestionsActes"></ul>
  <label>ğŸ‘¨â€âš•ï¸ RÃ©alisÃ© par</label>
  <select id="selectRealisateur"><option>â³Chargement...</option></select>
  <label>ğŸ’¬ Remarques</label>
  <textarea type="text" id="remarqueActe"></textarea>
  <h4>Actes rÃ©alisÃ©s :</h4>
  
  <div id="actesListe"></div>
  <div class="modal-buttons">
    <button id="btnFermerActe">âŒ Annuler</button>
    <button id="btnEnregistrerActe" class="success">âœ”ï¸ Enregistrer</button>
  </div>
</section>
<section id="panel-examens" class="panel" style="display:none;">

    <h3>â˜¢ï¸ Examens</h3>
   
 
  
	<label>Examens demandÃ©s / rÃ©alisÃ©s</label>
<div id="examensListe" class="mt-2 p-2 border rounded bg-gray-50">Aucun Ã©xamen enregistrÃ©</div>
  <button id="btnOuvrirModaleDemande" style="margin-top:10px;">â• Nouvelle demande dâ€™examen</button>
 
  
</section>


<div class="modal-overlay" id="modalExamen" style="display:none;">
  <div class="modal">
    <h3>Demande dâ€™examen</h3>
    <button class="exam-button" onclick="toggleSublist('prise-sang-list')">ğŸ©¸ Prise de sang</button>
  <div class="sub-list" id="prise-sang-list">
    <label><input type="checkbox" onchange="toggleExam(this)" value="NFS (NumÃ©ration Formule Sanguine)"> NFS</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CRP"> CRP</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Ionogramme"> Ionogramme</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="CalcÃ©mie"> CalcÃ©mie</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan hÃ©patique"> Bilan hÃ©patique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan rÃ©nal"> Bilan rÃ©nal</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="TSH, T3, T4"> TSH, T3, T4</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="HÃ©moglobine glyquÃ©e (HbA1c)"> HbA1c</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan lipidique"> Bilan lipidique</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Troponine"> Troponine</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Groupage sanguin"> Groupage</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="SÃ©rologies virales (VIH, VHB, VHC)"> SÃ©rologies VIH, VHB, VHC</label>
    <label><input type="checkbox" onchange="toggleExam(this)" value="Bilan coagulation (TP, TCA)"> Coagulation (TP, TCA)</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Recherche AlcoolÃ©mie"> AlcoolÃ©mie</label>
	  <label><input type="checkbox" onchange="toggleExam(this)" value="Prise de sang autre"> Autre</label>
  </div>
<button class="exam-button" onclick="toggleSublist('urine-list')">ğŸ§ª Examens urinaires</button>
<div class="sub-list" id="urine-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="ECBU (Examen cytobactÃ©riologique des urines)"> ECBU</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="ProtÃ©inurie des 24h"> ProtÃ©inurie 24h</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Bandelette urinaire"> Bandelette urinaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de sang dans les urines"> Sang dans les urines</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Recherche de drogues urinaires"> Recherche de drogues</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Test de grossesse urinaire"> Test de grossesse</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Dosage crÃ©atinine urinaire"> CrÃ©atinine urinaire</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="autre">Examens Urinaires Autre</label>
</div>
  <button class="exam-button" onclick="toggleSublist('radio-list')">ğŸ“¸ Radiologie</button>
<div class="sub-list" id="radio-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du crÃ¢ne"> CrÃ¢ne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du thorax"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de l'abdomen"> Abdomen</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du bassin"> Bassin</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie de la cheville"> Cheville</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du poignet"> Poignet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie du coude"> Coude</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des mains"> Mains</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie des pieds"> Pieds</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Radiographie Autre"> autre</label>

</div>

<button class="exam-button" onclick="toggleSublist('irm-list')">ğŸ§² IRM</button>
<div class="sub-list" id="irm-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM cÃ©rÃ©brale"> CÃ©rÃ©brale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM hypophysaire"> Hypophysaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis dorsal"> Rachis dorsal</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM Ã©paule"> Ã‰paule</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="IRM avec injection"> Avec injection</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="IRM autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('scanner-list')">ğŸ–¥ï¸ Scanner</button>
<div class="sub-list" id="scanner-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner cÃ©rÃ©bral"> CÃ©rÃ©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner thoracique"> Thorax</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner abdomino-pelvien"> Abdomino-pelvien</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis cervical"> Rachis cervical</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner rachis lombaire"> Rachis lombaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner des sinus"> Sinus</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Scanner genou"> Genou</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner cÃ©rÃ©bral"> Angioscanner cÃ©rÃ©bral</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner thoracique"> Angioscanner thoracique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Angioscanner abdominal"> Angioscanner abdominal</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="Scanner autre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('echo-list')">ğŸ§­ Ã‰chographie</button>
<div class="sub-list" id="echo-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie abdominale"> Abdominale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie pelvienne"> Pelvienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie rÃ©nale"> RÃ©nale</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie hÃ©patique"> HÃ©patique</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie thyroÃ¯dienne"> ThyroÃ¯dienne</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie mammaire"> Mammaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie testiculaire"> Testiculaire</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Ã‰chographie cardiaque (ETT)"> Cardiaque (ETT)</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler veineux des membres infÃ©rieurs"> Doppler veineux MI</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="Doppler artÃ©riel des membres infÃ©rieurs"> Doppler artÃ©riel MI</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value=" Ã‰chographieautre"> autre</label>
</div>
<button class="exam-button" onclick="toggleSublist('eos-list')">ğŸ¦´ EOS</button>
<div class="sub-list" id="eos-list">
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS rachis complet"> Rachis complet</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres infÃ©rieurs"> Membres infÃ©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS membres supÃ©rieurs"> Membres supÃ©rieurs</label>
  <label><input type="checkbox" onchange="toggleExam(this)" value="EOS posture globale"> Posture globale</label>
	<label><input type="checkbox" onchange="toggleExam(this)" value="EOS autre"> autre</label>
</div>
<h4>Examens sÃ©lectionnÃ©s :</h4>
<div id="examensSelectionnes" style="margin-bottom: 10px;"></div>

    <label for="commentaireExamen">ğŸ’¬ Commentaire</label>
    <textarea id="commentaireExamen" placeholder="DÃ©tails supplÃ©mentaires..."></textarea>
     <button id="btnCancelExamen" class="secondary">âŒ Fermer</button>
      <button id="btnSaveExamen">âœ… Valider</button>
    </div>
</div>
<section id="panel-sortie" class="panel" style="display:none;">
  
    <h3>ğŸšª Sortie</h3>


<h3>Type de sortie</h3>
    <label><input type="radio" name="typeSortie" value="Retour Ã  domicile" /> ğŸ¡ Domicile</label><br/>
    <label><input type="radio" name="typeSortie" value="Hospitalisation" /> ğŸ¥ Hospitalisation</label><br/>
    <label><input type="radio" name="typeSortie" value="Transfert" /> â†”ï¸ Transfert</label><br/>
	    <label><input type="radio" name="typeSortie" value="DÃ©cÃ¨s" />âš°ï¸ DÃ©cÃ¨s</label><br/>
    <label>
      <input type="radio" name="typeSortie" value="autre" /> ğŸ”¤ Autre
      <input type="text" id="champAutreSortie" placeholder="PrÃ©cisez..." style="margin-top: 8px; display:none;" />
    </label>

  

    <h3>Options supplÃ©mentaires</h3>
    <label><input type="checkbox" name="optionsSortie" value="Suivi a domicile" /> ğŸ“‹ Suivi Ã  domicile</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Avis specialiste" /> ğŸ‘©â€âš•ï¸ Avis spÃ©cialiste</label><br/>
    <label><input type="checkbox" name="optionsSortie" value="Transport  en ambulance" /> ğŸš‘ Transport ambulance</label><br/>
    <label>
      <input type="checkbox" name="optionsSortie" value="autreOption" /> ğŸ”¤ Autre option
      <input type="text" id="champAutreOption" placeholder="PrÃ©cisez..." style="margin-top: 8px; display:none;" />
    </label>

<h3>ğŸ’Š Traitement de sortie</h3>
<textarea id="champTraitementSortie"	 rows="3" style="width:100%; margin-bottom: 10px;"></textarea>

  
    <div id="sortieListe"></div> 
    <div class="modal-buttons">
      <button id="btnAnnulerSortie">âŒ Annuler</button>
      <button id="btnValiderSortie">âœ… Valider</button>
    </div>

  
</section>

<section id="panel-documents" class="panel" style="display:none;">
  
    <h3>ğŸ“‘ Documents</h3>

<form class="vidal-search" action="https://www.vidal.fr/recherche.html" method="get" target="_blank">
  <input type="text" name="query" placeholder="Rechercher sur le Vidal">
  <button type="submit">Rechercher</button>
</form>


  <button id="btnRapportHospi">ğŸ“ƒ Rapport d'hospitalisation</button>
	<br><br>
  <button id="btnVersFiche">ğŸ“„ Ordonnancier</button>
	<br><br>
  <button id="btnVersExs">ğŸ“„ Prescripteur d'examens</button>
	<br><br>
  <button id="btnVersSynthese">ğŸ“„ Certificat mÃ©dical</button>
	<br><br>
  <button id="btnVersFiches">ğŸ“„ Fiches Conseils</button>
	<br><br>
  <button id="btnVersPdf2">ğŸ“„ CrÃ©ation d'accÃ¨s PDF patient</button>
	<br><br>
  <button id="btnVersEti">ğŸ“„ Etiquettes patient</button>
</section>




<!-- Modal ClÃ´ture -->
<div class="modal-overlay" id="modalCloture">
  <div class="modal" style="text-align: center;">
    <h3>â³ClÃ´ture en cours...</h3>
    <div style="background:#eee; border-radius: 10px; overflow:hidden; margin-top: 15px;">
      <div id="clotureBar" style="height: 12px; background-color: #0078d4; width: 0%; transition: width 0.3s;"></div>
    </div>
    <p style="margin-top:10px; color:#666;">Merci de patienter</p>
  </div>
</div>

</main>
<!-- Modal Gestion Administrative -->
<div class="modal-overlay" id="modalAdmin">

  <div class="modal">
    <h3>ğŸ›  Gestion Administrative</h3>
    
    <label for="adminId">ID Patient</label>
    <input type="text" id="adminId" disabled />
	
	<label for="adminNom">Nom</label>
    <input type="text" id="adminNom" />
	<label for="adminPrenom">PrÃ©nom</label>
<input type="text" id="adminPrenom" />

	
	
	<label for="adminSexe">Sexe</label>
	<select id="adminSexe" >
  <option value="">-- SÃ©lectionnez --</option>
  <option value="M">M</option>
  <option value="Mme">Mme</option>
  <option value="L'enfant">L'enfant</option>
</select>

	<label for="adminNaissance">Date de naissance</label>
<input type="date" id="adminNaissance"  />

	
    <label for="adminAdresse">Adresse</label>
    <input type="text" id="adminAdresse" />

    <label for="adminTelephone">TÃ©lÃ©phone</label>
    <input type="text" id="adminTelephone" />

    <label for="adminEmail">Email</label>
    <input type="text" id="adminEmail" />

    <div class="modal-buttons">
	    <button type="button" id="readVitaleBtn" class="button" style="background-color: #28a745; color: white;">ğŸ†” Lecture Carte Vitale</button>
      <button id="btnFacturer" class="success">ğŸ’¶ Facturer</button>
	    <button id="btnCloturer" style="flex:1; background-color:#d9534f;">âœ… ClÃ´turer hospitalisation</button>
            <br><br>
			<button id="btnFermerAdmin" class="danger">âŒFermer</button>
	  <button id="btnEnregistrerAdmin" class="primary">ğŸ’¾Enregistrer</button>

    </div>
  </div>
</div>
 
<!-- ğŸ Modale de saisie du code de clÃ´ture -->
<div class="modal-overlay" id="modalCodeCloture" style="display:none;">
  <div class="modal">
    <h3>ğŸ”’ ClÃ´ture de lâ€™hospitalisation</h3>
    <label for="codeClotureInput">Entrez le CCH (Code de ClÃ´ture d'Hospitalisation) :</label>
    <input type="password" id="codeClotureInput" placeholder="CCH.....">
    <div class="modal-buttons">
      <button id="btnAnnulerCode" class="secondary">âŒ Annuler</button>
      <button id="btnValiderCode" class="success">âœ… Valider</button>
    </div>
  </div>
</div>

<div id="vitaleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">â³Lecture Carte Vitale en cours...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="facturationModale" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <div class="spinner" style="margin-bottom:15px;"></div>
    <div style="font-size:18px; font-weight:600;">â³Chargement des informations...</div>
  </div>
</div>

<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="modal-overlay" id="modalGlasgow">
  <div class="modal">
    <h3>ğŸ§  Score de Glasgow</h3>
    <img src="glasgow.jpg" alt="Ã‰chelle de Glasgow" style="width:100%; margin-bottom:15px; border-radius:8px;" />
    
    <label>ğŸ‘ Ouverture des yeux (max 4)</label>
    <input type="number" id="glasgowYeux" min="1" max="4" />

    <label>ğŸ—£ RÃ©ponse verbale (max 5)</label>
    <input type="number" id="glasgowVerbal" min="1" max="5" />

    <label>ğŸ’ª RÃ©ponse motrice (max 6)</label>
    <input type="number" id="glasgowMoteur" min="1" max="6" />

    <label>ğŸ¯ Score total</label>
    <input type="number" id="glasgowTotal" disabled />

<div id="glasgowPronostic" style="margin: 10px 0; font-style: italic;"></div>
<div id="glasgowPronostic2" style="margin: 10px 0; font-style: italic;"></div>
    <div class="modal-buttons">
      <button id="btnFermerGlasgow" class="secondary">âŒ Fermer</button>
      <button id="btnEnregistrerGlasgow" class="success">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>
<footer> Â© 2025 â€” GestUrg2 | Fiche Patient  </footer>

 </div>
</div>
<script>
   const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
    storageBucket: "urgences-a8ed4.appspot.com",  
    messagingSenderId: "392921498200",
    appId: "1:392921498200:web:7ccce767332c67c697c02d",
    measurementId: "G-C74MK2KYDL"
  };
	 firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
	// RÃ©cupÃ©rer l'ID du patient depuis l'URL
const urlParams = new URLSearchParams(window.location.search);
const patientId = urlParams.get("id");

// CrÃ©er la rÃ©fÃ©rence au document patient
const patientRef = db.collection("patients").doc(patientId);

  function afficherBulle(texte, type) {
    let container = document.getElementById('bubble-container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'bubble-container';
      document.body.appendChild(container);
    }
    const bulle = document.createElement('div');
    bulle.className = `bubble ${type}`;
    bulle.textContent = texte;
    container.appendChild(bulle);
    setTimeout(() => {
      bulle.remove();
    }, 3000);
  }
function openTab(tabId, event) {
  document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
  document.querySelectorAll(".tablink").forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  if (event) event.currentTarget.classList.add("active");
   if (tabId === "tab-historique") {
    chargerHistoriqueComplet();
  }
}
// Affichage du module Ordonnancier


	
  function calculerAge(dateNaissance) {
    const birth = new Date(dateNaissance);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    if (
      now.getMonth() < birth.getMonth() ||
      (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())
    ) {
      age--;
    }
    return age;
  }
// --- RÃ©fÃ©rences aux Ã©lÃ©ments ---
const sortieListe = document.getElementById("sortieListe");
const champAutreSortie = document.getElementById("champAutreSortie");
const champAutreOption = document.getElementById("champAutreOption");
const champTraitementSortie = document.getElementById("champTraitementSortie");
document.getElementById("btnValiderSortie").addEventListener("click", async () => {
  const type = document.querySelector('input[name="typeSortie"]:checked')?.value || "";
  const options = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  const sortie = {
    type,
    options,
    autreSortieTexte: type === "autre" ? champAutreSortie.value.trim() : "",
    autreOptionTexte: options.includes("autreOption") ? champAutreOption.value.trim() : "",
    destinationTransfert: document.getElementById("champDestinationTransfert")?.value || "",
    serviceHospitalisation: document.getElementById("champServiceHospitalisation")?.value || "",
    avisSpecialiste: document.getElementById("champAvisSpecialiste")?.value || "",
    traitementSortie: champTraitementSortie.value.trim()
  };

  try {
    await updateHospitalisationField("sortie", sortie);
    afficherSortieListe(sortie);
    afficherBulle("âœ”ï¸ Sortie enregistrÃ©e", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement sortie :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement de la sortie", "alerte");
  }
});

document.getElementById("btnAnnulerSortie").addEventListener("click", () => {
  champAutreSortie.value = "";
  champAutreOption.value = "";
  champTraitementSortie.value = "";
  sortieListe.innerHTML = "<p>Aucune sortie enregistrÃ©e.</p>";
});

// Container dynamique pour les champs spÃ©cifiques
let containerDynamique = document.getElementById("optionsSpecifiques");
if (!containerDynamique) {
  containerDynamique = document.createElement("div");
  containerDynamique.id = "optionsSpecifiques";

  // On rÃ©cupÃ¨re la rÃ©fÃ©rence de l'Ã©lÃ©ment #sortieListe dans le panel Sortie
  const sortieListe = document.getElementById("sortieListe");

  if (sortieListe) {
    // On insÃ¨re containerDynamique avant sortieListe
    sortieListe.parentNode.insertBefore(containerDynamique, sortieListe);
  } else {
    // Fallback : si #sortieListe n'existe pas, on ajoute Ã  la fin du panel
    const panelSortie = document.getElementById("panel-sortie");
    if (panelSortie) {
      panelSortie.appendChild(containerDynamique);
    }
  }
}

async function chargerPatient(patientId) {
  afficherLoader();
  try {
    const doc = await db.collection("patients").doc(patientId).get();
    if (!doc.exists) {
      afficherBulle("âŒ Patient introuvable", "alerte");
      return;
    }

 const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    // --- Infos patient ---
	 document.getElementById("idPatient").textContent = patientId || "Non dÃ©fini";
    document.getElementById("nom").textContent = data.nom || "";
    document.getElementById("prenom").textContent = data.prenom || "";
    document.getElementById("sexe").textContent = data.sexe || "";
    document.getElementById("poids").value = data.poids || "";
    document.getElementById("taille").value = data.taille || "";
    // Allergies
document.getElementById("allergies").value = data.allergies || "aucun";
document.getElementById("importanceAllergies").checked = data.importanceAllergies === true;




    // IMC
    const poids = parseFloat(data.poids);
    const taille = parseFloat(data.taille);
    const elImc = document.getElementById("imc");
    if (!isNaN(poids) && !isNaN(taille) && taille > 0) {
      elImc.textContent = (poids / ((taille / 100) ** 2)).toFixed(1);
    } else {
      elImc.textContent = "â€“";
    }

    // Ã‚ge
    if (data.dateNaissance) {
      const age = calculerAge(data.dateNaissance);
      document.getElementById("age").textContent = !isNaN(age) ? `${age} ans` : "Inconnu";
    }

    // --- Hospitalisation courante ---
    if (hospi) {
      // ğŸ”¹ Informations dâ€™hospitalisation
      document.getElementById("gravite").value = hospi.gravite || "";
      document.getElementById("motif").value = hospi.motif || "";
      document.getElementById("moyen").value = hospi.moyen || "";
      document.getElementById("circuit").value = hospi.circuit || "";


      // ğŸ”¹ Constantes vitales
      document.getElementById("temperature").value = hospi.constantes?.temperature || "";
      document.getElementById("fc").value = hospi.constantes?.fc || "";
      document.getElementById("ta").value = hospi.constantes?.ta || "";
      document.getElementById("saturation").value = hospi.constantes?.saturation || "";
	  document.getElementById("fr").value = hospi.constantes?.fr || "";
      document.getElementById("douleur").value = hospi.constantes?.douleur || "";

      // ğŸ”¹ Dossier mÃ©dical (nouvelle section)
      const dm = hospi.dossierMedical || {};
	  document.getElementById("questionnaire").value = dm.questionnaire || "";
      document.getElementById("antecedents").value = dm.antecedents || "";
      document.getElementById("traitements").value = dm.traitements || "";
      document.getElementById("histoire").value = dm.histoire || "";
      document.getElementById("auscultation").value = dm.auscultation || "";

      // ğŸ”¹ Ã‰volution aux urgences
      document.getElementById("evolutionTexte").value = hospi.evolution || "";

		if (hospi.sortie) {
  afficherSortieListe(hospi.sortie);
}

	}
   const hospiSnap = await db.collection("patients")
      .doc(patientId)
      .collection("hospitalisations")
      .orderBy("dateAdmission", "desc") // ou autre critÃ¨re
      .limit(1)
      .get();

    if (!hospiSnap.empty) {
      const hospiDoc = hospiSnap.docs[0];   // dernier sÃ©jour
      // --- Charger actes & examens depuis les sous-collections ---
      await chargerActes();
      await chargerExamens(patientId, hospiDoc.id);
    }

    // Services et RÃ©alisateurs
    chargerServices();
    chargerRealisateurs();
	 

  } catch (err) {
    console.error("Erreur chargement patient :", err);
    afficherBulle("âŒ Erreur de chargement", "alerte");
  } 
  masquerLoader();
}
// Champ allergies
document.getElementById("allergies").addEventListener("change", async () => {
  const value = document.getElementById("allergies").value.trim() || "aucun";
  await patientRef.update({ allergies: value });
  afficherBulle("ğŸ’¾ Allergies enregistrÃ©es", "administratif");
});

// Switch allergie(s) importantes
document.getElementById("importanceAllergies").addEventListener("change", async () => {
  const isImportant = document.getElementById("importanceAllergies").checked;
  await patientRef.update({ importanceAllergies: isImportant });
  afficherBulle(isImportant ? "âš ï¸ Allergie(s) importantes activÃ©e(s)" : "âœ… Pas dâ€™allergie majeure", "administratif");
});

async function updateHospitalisationField(field, value) {
  try {
    const doc = await patientRef.get();
    if (!doc.exists) return;

    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];

    hospitalisations[index] = { ...hospitalisations[index], [field]: value };

    await patientRef.update({ hospitalisations });

    ajouterEntreeHistorique(`Modification de ${field} : ${value}`);
    
  } catch (err) {
    console.error(`Erreur mise Ã  jour ${field} :`, err);
    afficherBulle("âŒ Erreur dâ€™enregistrement", "alerte");
  }
}


	document.getElementById("btnOuvrirModaleDemande").addEventListener("click", () => {
  document.getElementById("modalExamen").style.display = "block";
});

	
// --- RafraÃ®chissement des champs dynamiques ---
function rafraichirChampsSortie() {
  const typeSortie = document.querySelector('input[name="typeSortie"]:checked')?.value;
  const optionsSortie = Array.from(document.querySelectorAll('input[name="optionsSortie"]:checked')).map(cb => cb.value);

  containerDynamique.innerHTML = "";

  if (typeSortie === "Transfert") {
    const label = document.createElement("label");
    label.textContent = "Destination du transfert";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champDestinationTransfert";
    input.placeholder = "Ex: CHU Lyon";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  if (typeSortie === "Hospitalisation") {
    const label = document.createElement("label");
    label.textContent = "Service hospitalisation";
    const select = document.createElement("select");
    select.id = "champServiceHospitalisation";

    // RÃ©cupÃ©ration dynamique depuis Firestore
    db.collection("rÃ©fÃ©rentiels").doc("spÃ©cialitÃ©s").get().then(doc => {
      const data = doc.data();
      (data?.spÃ©cialitÃ©s || []).forEach(service => {
        const option = document.createElement("option");
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });
    });

    containerDynamique.appendChild(label);
    containerDynamique.appendChild(select);
  }

  if (optionsSortie.includes("Avis specialiste")) {
    const label = document.createElement("label");
    label.textContent = "SpÃ©cialiste consultÃ©";
    const input = document.createElement("input");
    input.type = "text";
    input.id = "champAvisSpecialiste";
    input.placeholder = "Ex: Dr Dupont (Cardio)";
    containerDynamique.appendChild(label);
    containerDynamique.appendChild(input);
  }

  // Affichage du champ "autre option"
  champAutreOption.style.display = optionsSortie.includes("autreOption") ? "block" : "none";
}

// --- Gestion champ "autre sortie" ---
document.querySelectorAll('input[name="typeSortie"]').forEach(radio => {
  radio.addEventListener("change", () => {
    champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
    rafraichirChampsSortie();
  });
});

document.querySelectorAll('input[name="optionsSortie"]').forEach(cb => {
  cb.addEventListener("change", rafraichirChampsSortie);
});

// --- Affichage sortie ---
function afficherSortieListe(sortie) {
  if (!sortie || !sortie.type) {
    sortieListe.innerHTML = "<p>Aucune sortie enregistrÃ©e.</p>";
    return;
  }

  let html = `
    <p><strong>Type de sortie :</strong> ${sortie.type}</p>
    <p><strong>Options :</strong> ${sortie.options?.join(", ") || "Aucune"}</p>
  `;

  if (sortie.destinationTransfert) html += `<p><strong>â†”ï¸ Destination :</strong> ${sortie.destinationTransfert}</p>`;
  if (sortie.serviceHospitalisation) html += `<p><strong>ğŸ¥ Service :</strong> ${sortie.serviceHospitalisation}</p>`;
  if (sortie.avisSpecialiste) html += `<p><strong>ğŸ‘¨â€âš•ï¸ SpÃ©cialiste :</strong> ${sortie.avisSpecialiste}</p>`;
  if (sortie.autreOptionTexte) html += `<p><strong>ğŸ”¤ Autre option :</strong> ${sortie.autreOptionTexte}</p>`;
  if (sortie.traitementSortie) html += `<p><strong>ğŸ’Š Traitement de sortie :</strong> ${sortie.traitementSortie}</p>`;

  html += `<button id="btnSupprimerSortie" class="danger" style="margin-top:10px;">ğŸ—‘ Supprimer</button>`;
  sortieListe.innerHTML = html;

  document.getElementById("btnSupprimerSortie").addEventListener("click", async () => {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    delete hospitalisations[index].sortie;
    if (hospitalisations[index].traitementSortie) hospitalisations[index].traitementSortie = "";

    await patientRef.update({ hospitalisations });
    sortieListe.innerHTML = "<p>Sortie supprimÃ©e.</p>";
    afficherBulle("ğŸ—‘ï¸ Sortie supprimÃ©e", "administratif");
  });
}
document.addEventListener("DOMContentLoaded", () => {
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";
  if (patientId) {
    chargerPatient(patientId);
  }
});


function formaterDate(dateStr) {
  if (!dateStr) return "";
  const match = dateStr.match(/^(\d{2})[-\/](\d{2})[-\/](\d{4})$/);
  if (match) {
    const [_, jj, mm, aaaa] = match;
    return `${aaaa}-${mm}-${jj}`;
  }
  if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return dateStr;
  }
  return "";
}
    
// --- Recherche et suggestions d'actes ---
const inputActe = document.getElementById("rechercherActe");
const suggestionsActes = document.getElementById("suggestionsActes");

inputActe.addEventListener("input", async (e) => {
  const recherche = e.target.value.trim().toLowerCase();
  suggestionsActes.innerHTML = "";

  // attendre au moins 2 caractÃ¨res
  if (recherche.length < 2) return;

  try {
    // ğŸ”¹ RÃ©cupÃ¨re la liste des actes depuis Firestore
    const doc = await db.collection("rÃ©fÃ©rentiels").doc("actes").get();
    const data = doc.data();
    const actes = data?.liste || [];

    // ğŸ”¹ Filtrage des rÃ©sultats
    const filtres = actes.filter(a => a.toLowerCase().includes(recherche));

    if (filtres.length === 0) {
      suggestionsActes.innerHTML = "<li style='color:#999;'>Aucun rÃ©sultat</li>";
      return;
    }

    // ğŸ”¹ Affichage des suggestions
    filtres.forEach(acte => {
      const li = document.createElement("li");
      li.textContent = acte;
      li.style.cursor = "pointer";
      li.style.padding = "5px";
      li.addEventListener("mouseover", () => li.style.background = "#eee");
      li.addEventListener("mouseout", () => li.style.background = "transparent");
      li.addEventListener("click", () => {
        inputActe.value = acte;      // remplir la barre avec lâ€™acte choisi
        suggestionsActes.innerHTML = ""; // vider les suggestions
      });
      suggestionsActes.appendChild(li);
    });
  } catch (err) {
    console.error("Erreur recherche actes :", err);
    suggestionsActes.innerHTML = "<li style='color:red;'>âš ï¸ Erreur de chargement</li>";
  }
});


document.getElementById("gravite").addEventListener("change", e => {
  updateHospitalisationField("gravite", e.target.value);
});
document.getElementById("circuit").addEventListener("change", async (e) => {
   updateHospitalisationField("circuit", e.target.value);
});

document.getElementById("motif").addEventListener("blur", e => {
  updateHospitalisationField("motif", e.target.value.trim());
});
document.getElementById("moyen").addEventListener("blur", e => {
  updateHospitalisationField("moyen", e.target.value.trim());
});

async function ajouterEntreeHistorique(texte) {
  const date = new Date().toLocaleString();
  const entree = { date, texte };

  try {
   

    afficherHistorique(entree);
  } catch (error) {
    console.error("Erreur ajout historique :", error);
  }
}




  document.getElementById("btnSavePoids").addEventListener("click", async () => {
  const poids = parseFloat(document.getElementById("poids").value);
  const taille = parseFloat(document.getElementById("taille").value);

  if (!poids || !taille) {
    afficherBulle("âŒ Veuillez entrer un poids et une taille valides", "alerte");
    return;
  }

  try {
    await patientRef.update({ poids, taille });
    ajouterEntreeHistorique(`Poids/Taille/IMC enregistrÃ©s: ${poids}kg / ${taille}cm`);
    afficherBulle("âœ”ï¸ Poids et taille enregistrÃ©s", "administratif");
    chargerPatient(patientId); // ğŸ”„ recalcul IMC
  } catch (err) {
    console.error("Erreur enregistrement poids/taille :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement du poids/taille", "alerte");
  }
});





document.getElementById("btnSaveConst").addEventListener("click", async () => {
  const constantes = {
    temperature: document.getElementById("temperature").value.trim() || "",
    fc: document.getElementById("fc").value.trim() || "",
    ta: document.getElementById("ta").value.trim() || "",
    saturation: document.getElementById("saturation").value.trim() || "",
    fr: document.getElementById("fr").value.trim() || "",
    douleur: document.getElementById("douleur").value.trim() || ""
  };

  try {
    await updateHospitalisationField("constantes", constantes);
    afficherBulle("âœ”ï¸ Constantes enregistrÃ©es", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement constantes :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement des constantes", "alerte");
  }
});


  async function initialiserScope(patientId) {
  const doc = await patientRef.get();
  if (!doc.exists) return;

  const data = doc.data();
  const index = data.hospitalisationIndex ?? 0;
  const hospi = data.hospitalisations?.[index] || {};

  const checkbox = document.getElementById("patientScopeCheckbox");
  const fields = document.getElementById("scopeFields");
  const successDiv = document.getElementById("scopeSuccess");
  const numInput = document.getElementById("scopeNum");

  // ğŸ”¹ Lecture depuis Firestore
  if (hospi.scope) {
    checkbox.checked = hospi.scope.scopeActive || false;
    if (hospi.scope.scopeActive) {
      fields.style.display = "block";
      numInput.value = hospi.scope.numero || "";
      successDiv.style.display = "block";
    }
  }

  // ğŸ”¹ Changement de statut du scope
  checkbox.addEventListener("change", async () => {
    const actif = checkbox.checked;
    if (!actif) {
      fields.style.display = "none";
      successDiv.style.display = "none";
      await updateHospitalisationField("scope", { scopeActive: false, numero: "" });
      afficherBulle("âœ”ï¸ Scope dÃ©sactivÃ©", "administratif");
      return;
    }
    fields.style.display = "block";
    await updateHospitalisationField("scope", { scopeActive: true, numero: "" });
  });

  // ğŸ”¹ Simulation de connexion au scope
  document.getElementById("btnConnectScope").addEventListener("click", async () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("âŒVeuillez entrer un numÃ©ro de scope", "alerte");
      return;
    }
    document.getElementById("scopeLoading").style.display = "inline";
    setTimeout(async () => {
      document.getElementById("scopeLoading").style.display = "none";
      successDiv.style.display = "block";
      await updateHospitalisationField("scope", { scopeActive: true, numero });
      afficherBulle(`âœ”ï¸ Scope ${numero} connectÃ©`, "administratif");
    }, 1500);
  });

  // ğŸ”¹ Ouverture du scope.html
  document.getElementById("btnOpenScope").addEventListener("click", () => {
    const numero = numInput.value.trim();
    if (!numero) {
      afficherBulle("âŒNumÃ©ro de scope manquant", "alerte");
      return;
    }
    window.location.href =`scope.html?id=${encodeURIComponent(patientId)}`;
  });
}

// ğŸ§  IntÃ©gration dans le chargement patient
document.addEventListener("DOMContentLoaded", async () => {
  if (patientId) {
    await chargerPatient(patientId);
    await initialiserScope(patientId);
  }
});

  const historiqueContainer = document.getElementById("historique");

// Fonction pour charger tout l'historique de l'hospitalisation en cours
async function chargerHistorique() {
  try {
    const doc = await patientRef.get();
    const data = doc.data();

    const index = data.hospitalisationIndex ?? 0;
    const hospi = data.hospitalisations?.[index];

    if (!hospi || !hospi.historique || hospi.historique.length === 0) {
      historiqueContainer.innerHTML = "<p>Aucune entrÃ©e dans l'historique.</p>";
      return;
    }

    historiqueContainer.innerHTML = ""; // on vide avant d'afficher

    hospi.historique.forEach(entry => {
      afficherHistorique(entry);
    });
  } catch (error) {
    console.error("Erreur chargement historique :", error);
  }
}

// Fonction d'affichage d'une seule entrÃ©e dans le DOM
function afficherHistorique(entry) {
  if (!historiqueContainer) return;
  const div = document.createElement("div");
  div.className = "entry";
  div.innerHTML = `<strong>${entry.date}</strong><br>${entry.texte}`;
  historiqueContainer.appendChild(div);
}

  function afficherHistoriqueAncienne(hospitalisation, index) {
    if (!historiqueAncienContainer) return;
    const titre = document.createElement("div");
    titre.innerHTML = `<strong style="color:#d9534f">Hospitalisation ${index + 1} (${hospitalisation.dateDebut} - ${hospitalisation.dateFin || "en cours"})</strong>`;
    historiqueAncienContainer.appendChild(titre);
    hospitalisation.historique?.forEach(entry => afficherHistorique(entry, "ancien"));
  }
  function clearHistoriqueAnciennes() {
    if(historiqueAncienContainer) historiqueAncienContainer.innerHTML = "";
  }
  function clearHistorique() {
    if(historiqueContainer) historiqueContainer.innerHTML = "";
  }
  const btnDemandeExamen = document.getElementById("btnDemandeExamen");
const fenetreExamens = document.getElementById("fenetreExamens");
const listeExamens = document.getElementById("listeExamens");
const btnOuvrirModaleDemande = document.getElementById("btnOuvrirModaleDemande");


const modalExamen = document.getElementById("modalExamen");
const typeExamen = document.getElementById("typeExamen");
const commentaireExamen = document.getElementById("commentaireExamen");
const btnSaveExamen = document.getElementById("btnSaveExamen");





btnOuvrirModaleDemande.addEventListener("click", () => {
  
  commentaireExamen.value = "";
  modalExamen.style.display = "flex";
});

// Modale annulation
btnCancelExamen.addEventListener("click", () => {
  modalExamen.style.display = "none";
});

document.getElementById("btnSaveExamen").addEventListener("click", async () => {
  const commentaire = document.getElementById("commentaireExamen").value.trim();

  // RÃ©cupÃ©rer tous les examens cochÃ©s
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']:checked");
  const examens = Array.from(checkboxes).map(cb => cb.value);

  if (examens.length === 0) {
    afficherBulle("âŒ Veuillez sÃ©lectionner au moins un examen", "alerte");
    return;
  }

  const date = new Date().toLocaleString();

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    if (!hospitalisations[index].examens) hospitalisations[index].examens = [];

    // Ajouter chaque examen individuellement
    examens.forEach(type => {
      hospitalisations[index].examens.push({
        type,
        commentaire,
        dateDemande: date,
        realise: false
      });
    });

    await patientRef.update({ hospitalisations });

    modalExamen.style.display = "none";
    afficherBulle("âœ”ï¸ Examens enregistrÃ©s", "administratif");
    ajouterEntreeHistorique(`ğŸ“‹ Examens demandÃ©s : ${examens.join(", ")}`);
	  reinitialiserFormulaireExamen();
	  chargerExamens();
  } catch (err) {
    console.error("Erreur enregistrement examens :", err);
    afficherBulle("âŒ Erreur enregistrement", "alerte");
  }
  
});
	function reinitialiserFormulaireExamen() {
  // DÃ©coche tous les checkboxes dans le modal
  const checkboxes = document.querySelectorAll("#modalExamen input[type='checkbox']");
  checkboxes.forEach(cb => cb.checked = false);

  // Vide le commentaire
  document.getElementById("commentaireExamen").value = "";
}

  // --- Gestion modale de saisie du code ---
const modalCode = document.getElementById("modalCodeCloture");
const inputCode = document.getElementById("codeClotureInput");
const btnAnnulerCode = document.getElementById("btnAnnulerCode");
const btnValiderCode = document.getElementById("btnValiderCode");

// ğŸ”¹ Ouvrir la modale quand on clique sur "ClÃ´turer"
document.getElementById("btnCloturer").addEventListener("click", () => {
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

// ğŸ”¹ Annuler â†’ fermer la modale
btnAnnulerCode.addEventListener("click", () => {
  modalCode.style.display = "none";
});

// ğŸ”¹ Valider le code et exÃ©cuter la clÃ´ture
btnValiderCode.addEventListener("click", async () => {
  const code = inputCode.value.trim();
  if (!code) {
    afficherBulle("âš ï¸ Veuillez entrer un code", "alerte");
    return;
  }

  try {
    const codeDoc = await db.collection("patients").doc("QhwMJ0mjmUnS8MTNBCFU").get();
    const codeAttendu = codeDoc.data().CCH;

    if (code !== codeAttendu) {
      afficherBulle("âŒ Code incorrect", "alerte");
      return;
    }

    // âœ… Code correct â†’ dÃ©marrer la clÃ´ture
    modalCode.style.display = "none";
    document.getElementById("modalCloture").style.display = "flex";

    const bar = document.getElementById("clotureBar");
    bar.style.width = "0%";
    let progress = 0;

    const interval = setInterval(() => {
      progress += 1;
      bar.style.width = `${progress}%`;
      if (progress >= 100) clearInterval(interval);
    }, 30);

    // ğŸ•“ Simulation du traitement de clÃ´ture
    setTimeout(async () => {
      try {
        const now = new Date().toLocaleString();
        const doc = await patientRef.get();
        const data = doc.data();
        const index = data.hospitalisationIndex ?? 0;
        const hospitalisations = data.hospitalisations || [];

        if (hospitalisations[index]) {
          hospitalisations[index].dateFin = now;
          hospitalisations[index].historique = hospitalisations[index].historique || [];
          hospitalisations[index].historique.push({ date: now, texte: "Hospitalisation clÃ´turÃ©e" });
          hospitalisations[index].rapport = `Rapport d'hospitalisation pour ${data.nom} ${data.prenom} clÃ´turÃ© le ${now}.`;

          await patientRef.update({
            hospitalisations,
            hospitalisationIndex: index + 1,
            hospitalisationActive: false
          });

          afficherBulle("âœ… Hospitalisation clÃ´turÃ©e", "administratif");
          window.location.href = `urgences.html`;
        }
      } catch (error) {
        console.error("Erreur clÃ´ture hospitalisation :", error);
        afficherBulle("âš ï¸ Erreur de clÃ´ture", "alerte");
      } finally {
        document.getElementById("modalCloture").style.display = "none";
      }
    }, 3200);

  } catch (err) {
    console.error("Erreur lors de la vÃ©rification du code :", err);
    afficherBulle("Erreur de vÃ©rification du code", "alerte");
  }
});

  

document.getElementById("btnAdmin").addEventListener("click", () => {
   modalAdmin.classList.add("show");
});


  document.getElementById("btnVersFiche").addEventListener("click", () => {
    window.location.href =`Ordonnancier.html?id=${patientId}`;
  });
document.getElementById("btnVersExs").addEventListener("click", () => {
    window.location.href =`prescriptionexamens.html?id=${patientId}`;
  });
  document.getElementById("btnVersSynthese").addEventListener("click", () => {
    window.location.href =`Certificatmedical.html?id=${patientId}`;
  });
  document.getElementById("btnVersFiches").addEventListener("click", () => {
    window.location.href =`fichesconseil.html?id=${patientId}`;
  });
document.getElementById("btnVersPdf").addEventListener("click", () => {
    window.location.href =`uploadpdf.html?id=${patientId}`;
  });
document.getElementById("btnVersPdf2").addEventListener("click", () => {
    window.location.href =`uploadpdf.html?id=${patientId}`;
  });
document.getElementById("btnmailto").addEventListener("click", () => {
    window.location.href =`mailto.html?id=${patientId}`;
  });
document.getElementById("btnVersEti").addEventListener("click", () => {
    window.location.href =`etiquettes.html?id=${patientId}`;
  });

// Gestion Administrative
const modalAdmin = document.getElementById("modalAdmin");
const btnAdmin = document.getElementById("btnAdmin");
const btnFermerAdmin = document.getElementById("btnFermerAdmin");
const btnEnregistrerAdmin = document.getElementById("btnEnregistrerAdmin");
const btnFacturer = document.getElementById("btnFacturer");

btnAdmin.addEventListener("click", async () => {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    document.getElementById("adminId").value = patientId;
	document.getElementById("adminNom").value = data.nom || "";
    document.getElementById("adminPrenom").value = data.prenom || "";
    document.getElementById("adminSexe").value = data.sexe || "";
document.getElementById("adminNaissance").value = data.dateNaissance || "";
    document.getElementById("adminAdresse").value = data.adresse || "";
    document.getElementById("adminTelephone").value = data.telephone || "";
    document.getElementById("adminEmail").value = data.email || "";
 modalAdmin.classList.add("show");
  } catch (e) {
    console.error("Erreur ouverture admin :", e);
    afficherBulle("âŒErreur chargement gestion dministrative", "alerte");
  }
});

btnFermerAdmin.addEventListener("click", () => {
  modalAdmin.classList.remove("show");
});

btnEnregistrerAdmin.addEventListener("click", async () => {
  const adresse = document.getElementById("adminAdresse").value.trim();
  const telephone = document.getElementById("adminTelephone").value.trim();
  const email = document.getElementById("adminEmail").value.trim();
  const sexe = document.getElementById("adminSexe").value;
const dateNaissance = document.getElementById("adminNaissance").value.trim();




  try {
    await patientRef.update({ adresse, telephone, email, sexe, dateNaissance });
    afficherBulle("âœ”ï¸ CoordonnÃ©es mises Ã  jour", "administratif");
    modalAdmin.style.display = "none";
  } catch (e) {
    console.error("Erreur maj admin :", e);
    afficherBulle("âŒErreur enregistrement admin", "alerte");
  }
});

btnFacturer.addEventListener("click", () => {
  window.location.href =`Facturation.html?id=${patientId}`;
});

let tousLesActesRealises = [];


const btnFermerActe = document.getElementById("btnFermerActe");
const btnEnregistrerActe = document.getElementById("btnEnregistrerActe");
const selectActe = document.getElementById("selectActe");
const champAutreActe = document.createElement("input");
champAutreActe.type = "text";
champAutreActe.id = "champAutreActe";
champAutreActe.placeholder = "PrÃ©ciser le type dâ€™acte";
champAutreActe.style.display = "none";
champAutreActe.style.marginTop = "8px";

document.getElementById("btnFermerActe").addEventListener("click", () => {
  afficherBulle("â„¹ï¸ Fermeture sans enregistrement", "administratif");
});



let tousLesActesDispos = [];

async function chargerEtInitialiserRechercheActe() {
  try {
    const doc = await db.collection("rÃ©fÃ©rentiels").doc("actes").get();
    const data = doc.data();
    tousLesActesDispos = Array.isArray(data?.liste) ? data.liste : [];
  } catch (e) {
    console.error("Erreur chargement actes :", e);
    tousLesActesDispos = [];
  }

  const champ = document.getElementById("rechercherActe");
  const suggestions = document.getElementById("suggestionsActes");

  champ.addEventListener("input", () => {
    const texte = champ.value.toLowerCase().trim();
    suggestions.innerHTML = "";

    if (!texte) {
      suggestions.style.display = "none";
      return;
    }

    const filtres = tousLesActesDispos.filter(nom =>
      nom.toLowerCase().includes(texte)
    );

    filtres.forEach(nom => {
      const li = document.createElement("li");
      li.textContent = nom;
      li.style.padding = "6px 10px";
      li.style.cursor = "pointer";
      li.addEventListener("click", () => {
        champ.value = nom;
        suggestions.style.display = "none";
      });
      suggestions.appendChild(li);
    });

    suggestions.style.display = filtres.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!champ.contains(e.target) && !suggestions.contains(e.target)) {
      suggestions.style.display = "none";
    }
  });
}


function mettreAJourListeActes(filtre) {
  const selectActe = document.getElementById("selectActe");
  selectActe.innerHTML = "";

  const actesFiltres = tousLesActesDispos.filter(acte =>
    acte.toLowerCase().includes(filtre)
  );

  actesFiltres.forEach(nom => {
    const opt = document.createElement("option");
    opt.value = nom;
    opt.textContent = nom;
    selectActe.appendChild(opt);
  });

  const optAutre = document.createElement("option");
  optAutre.value = "autre";
  optAutre.textContent = "ğŸ”¤ Autre (Ã  prÃ©ciser)";
  selectActe.appendChild(optAutre);
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  const doc = await db.collection("rÃ©fÃ©rentiels").doc("personnel").get();
  const data = doc.data();

  select.innerHTML = "";

  if (data && Array.isArray(data.liste)) {
    data.liste.forEach(nom => {
      const opt = document.createElement("option");
      opt.value = nom;
      opt.textContent = nom;
      select.appendChild(opt);
    });
  }
}



function ajouterFiltreTypeActe() {
  const select = document.createElement("select");
  select.id = "filtreTypeActe";
  select.innerHTML = `<option value="tous">Tous les types</option>`;
  document.getElementById("actesListe").before(select);

  const typesUniques = [...new Set(tousLesActesRealises.map(a => a.type))];
  typesUniques.forEach(type => {
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    select.appendChild(opt);
  });

  select.addEventListener("change", (e) => {
    chargerActes();
  });
}

async function supprimerActeRealise(index) {
  if (!confirm("Supprimer cet acte ?")) return;

  const doc = await patientRef.get();
  const data = doc.data();
  const iHospi = data.hospitalisationIndex ?? 0;
  const hospitalisations = [...(data.hospitalisations || [])];
  const actes = [...(hospitalisations[iHospi].actes_realises || [])];
  const acteSupprimÃ© = actes[index];

  actes.splice(index, 1);
  hospitalisations[iHospi].actes_realises = actes;

  await patientRef.update({ hospitalisations });

  ajouterEntreeHistorique(`âŒ Acte supprimÃ© : ${acteSupprimÃ©.type} (par ${acteSupprimÃ©.realisateur})`);
  afficherActesRealises(document.getElementById("filtreTypeActe")?.value || "tous");
  afficherBulle("ğŸ—‘ï¸ Acte supprimÃ©", "administratif");
}

document.getElementById("btnEnregistrerActe").addEventListener("click", async () => {
  const type = document.getElementById("rechercherActe").value.trim();
  const realisateur = document.getElementById("selectRealisateur").value;
  const remarque = document.getElementById("remarqueActe").value.trim();

  if (!type) {
    afficherBulle("âŒ Veuillez saisir un type dâ€™acte", "alerte");
    return;
  }

  const acte = {
    type,
    realisateur,
    remarque,
   date: new Date().toLocaleString("fr-FR", {
  day: "2-digit",
  month: "2-digit",
  year: "numeric",
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit"
})

  };

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = Array.isArray(data.hospitalisations) ? [...data.hospitalisations] : [];
    hospitalisations[index] = hospitalisations[index] || {};
    hospitalisations[index].actes = hospitalisations[index].actes || [];
    hospitalisations[index].actes.push(acte);

    await patientRef.update({ hospitalisations });

    afficherBulle("âœ”ï¸ Acte enregistrÃ©", "administratif");
    document.getElementById("rechercherActe").value = "";
    document.getElementById("remarqueActe").value = "";
  } catch (err) {
    console.error("Erreur enregistrement acte :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement de lâ€™acte", "alerte");
  }
});

async function chargerServices() {
  try {
    const doc = await db.collection("rÃ©fÃ©rentiels").doc("spÃ©cialitÃ©s").get();
    const data = doc.data();
    const services = data?.spÃ©cialitÃ©s || [];

    const select = document.getElementById("service");
    select.innerHTML = ""; // vide les anciennes options

    services.forEach(service => {
      const option = document.createElement("option");
      option.value = service;
      option.textContent = service;
      select.appendChild(option);
    });

    // PrÃ©-remplir si une valeur existe
    const patientDoc = await patientRef.get();
    const patientData = patientDoc.data();
    const index = patientData.hospitalisationIndex ?? 0;
    const hospi = patientData.hospitalisations?.[index];
    if (hospi?.service) select.value = hospi.service || "";

  } catch (e) {
    console.error("Erreur chargement services :", e);
  }
}

// Ã‰couteur de modification
document.getElementById("service").addEventListener("change", async (e) => {
  const service = e.target.value;
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];

    hospitalisations[index] = {
      ...hospitalisations[index],
      service
    };

    await patientRef.update({ hospitalisations });
    ajouterEntreeHistorique(`Changement de service : ${service}`);
  } catch (err) {
    console.error("Erreur mise Ã  jour service :", err);
  }
});
	
function reinitialiserFormulaireActe() {
  document.getElementById("selectActe").value = "";
  document.getElementById("selectRealisateur").value = "";
  document.getElementById("remarqueActe").value = "";
  champAutreActe.value = "";
  champAutreActe.style.display = "none";
}

function formatDateHeure(dateString) {
  const date = new Date(dateString);
  const pad = (n) => n.toString().padStart(2, '0');
  const jour = pad(date.getDate());
  const mois = pad(date.getMonth() + 1);
  const annee = date.getFullYear();
  const heures = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  const secondes = pad(date.getSeconds());
  return `${jour}/${mois}/${annee} ${heures}:${minutes}:${secondes}`;
}

document.getElementById('readVitaleBtn').addEventListener('click', () => {
  const modal = document.getElementById('vitaleModal');
  modal.style.display = 'flex';

  const duration = 3000 + Math.random() * 7000; // entre 3 et 10 secondes

  setTimeout(() => {
    modal.style.display = 'none';

    const isSuccess = Math.random() < 0.8; // 80% ok-20%erreur

    if (isSuccess) {
      afficherBulle("âœ… Lecture Carte Vitale terminÃ©e !", "administratif");
    } else {
      afficherBulle("âŒ Erreur lecture Carte Vitale - Veuillez ressayer", "alerte");
    }
  }, duration);
});

document.getElementById("btnGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "flex";
});

document.getElementById("btnFermerGlasgow").addEventListener("click", () => {
  document.getElementById("modalGlasgow").style.display = "none";
});

["glasgowYeux", "glasgowVerbal", "glasgowMoteur"].forEach(id => {
  document.getElementById(id).addEventListener("input", () => {
    const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
    const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
    const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
    const total = yeux + verbal + moteur;
    document.getElementById("glasgowTotal").value = total;

    const pronostic = document.getElementById("glasgowPronostic");
    if (total <= 4) pronostic.innerText = " 7 % de bonne rÃ©cupÃ©ration et 87 % de mortalitÃ©.";
    else if (total <= 7) pronostic.innerText = "34 % de bonne rÃ©cupÃ©ration et 53 % de mortalitÃ©.";
    else if (total <= 10) pronostic.innerText = " 68 % de bonne rÃ©cupÃ©ration et 27 % de mortalitÃ©.";
    else pronostic.innerText = " 82 % de bonne rÃ©cupÃ©ration et 12 % de mortalitÃ©.";
  
  const pronostic2 = document.getElementById("glasgowPronostic2");
    if (total <= 6) pronostic.innerText = "Coma Profond";
    else if (total <= 9) pronostic.innerText = "Coma Lourd";
    else if (total <= 14) pronostic.innerText = "Somnoloence / Coma LÃ©ger";
    else pronostic.innerText = "Conscience Normale";
});
});
function toggleSublist(id) {
    const list = document.getElementById(id);
    list.style.display = list.style.display === "block" ? "none" : "block";
  }

	
document.getElementById("btnEnregistrerGlasgow").addEventListener("click", async () => {
  const yeux = parseInt(document.getElementById("glasgowYeux").value) || 0;
  const verbal = parseInt(document.getElementById("glasgowVerbal").value) || 0;
  const moteur = parseInt(document.getElementById("glasgowMoteur").value) || 0;
  const total = yeux + verbal + moteur;
  const texte = `Score de Glasgow enregistrÃ© : ${total} (Yeux ${yeux}, Verbal ${verbal}, Moteur ${moteur})`;

  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;
    const hospitalisations = [...(data.hospitalisations || [])];
    hospitalisations[index].glasgow = { yeux, verbal, moteur, total, date: new Date().toISOString() };

    await patientRef.update({ hospitalisations });

    await ajouterEntreeHistorique(texte);
    afficherBulle("âœ”ï¸ Score de Glasgow enregistrÃ©", "administratif");
    document.getElementById("modalGlasgow").style.display = "none";
  } catch (e) {
    console.error("Erreur enregistrement Glasgow :", e);
    afficherBulle("âŒ Erreur enregistrement", "alerte");
  }
});
function ajouterHorodatage() {
  const textarea = document.getElementById("texteRemarque");
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR');
  const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  const horodatage = `${dateStr} ${timeStr} - ${medecinNom} : `;

  textarea.value += textarea.value && !textarea.value.endsWith('\n') ? '\n' + horodatage : horodatage;
  textarea.focus();
}

function ajouterHorodatageDans(id) {
  const textarea = document.getElementById(id);
  if (!textarea) return;

  const horodatage = new Date().toLocaleString("fr-FR");
const insertion = `${horodatage} - ${window.medecinNom}\n`;

  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;

  const texteAvant = textarea.value.substring(0, start);
  const texteApres = textarea.value.substring(end);

  textarea.value = texteAvant + insertion + texteApres;

  const nouvellePosition = start + insertion.length;
  textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
  textarea.focus();
}


async function enregistrerDossierMedical() {
  const dossierMedical = {
    questionnaire: document.getElementById("questionnaire").value.trim(),
    antecedents: document.getElementById("antecedents").value.trim(),
    traitements: document.getElementById("traitements").value.trim(),
    histoire: document.getElementById("histoire").value.trim(),
    auscultation: document.getElementById("auscultation").value.trim()
  };

  try {
    await updateHospitalisationField("dossierMedical", dossierMedical);
    afficherBulle("âœ”ï¸ Dossier mÃ©dical enregistrÃ©", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement dossier mÃ©dical :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement du dossier mÃ©dical", "alerte");
  }
}



async function enregistrerEvolution() {
  const evolution = document.getElementById("evolutionTexte").value.trim();

  try {
    await updateHospitalisationField("evolution", evolution);
    afficherBulle("âœ”ï¸ Ã‰volution enregistrÃ©e", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement Ã©volution :", err);
    afficherBulle("âŒ Erreur lors de lâ€™enregistrement de lâ€™Ã©volution", "alerte");
  }
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>â³Chargement...</option>";
  try {
    const snapshot = await db.collection("rÃ©fÃ©rentiels").doc("rÃ©alisateurs").get();
    const data = snapshot.data();
    select.innerHTML = "";
    (data?.liste || []).forEach(realisateur => {
      const option = document.createElement("option");
      option.value = realisateur;
      option.textContent = realisateur;
      select.appendChild(option);
    });
  } catch (e) {
    console.error("Erreur chargement rÃ©alisateurs :", e);
    select.innerHTML = "<option>âš ï¸ Erreur chargement</option>";
  }
}

async function chargerHistoriqueComplet() {
  const contenu = document.getElementById("hospitalisationsContent");
  if (!contenu) {
    console.error("Element #hospitalisationsContent introuvable");
    return;
  }
  contenu.innerHTML = "<p>â³ Chargement...</p>";

  try {
    const patientDoc = await db.collection("patients").doc(patientId).get();
    if (!patientDoc.exists) {
      contenu.innerHTML = "<p>âŒ Patient introuvable</p>";
      return;
    }

    const data = patientDoc.data();
    let hospitalisations = Array.isArray(data.hospitalisations) ? data.hospitalisations : [];

    // on enlÃ¨ve la derniÃ¨re hospitalisation (courante)
    if (hospitalisations.length > 1) {
      hospitalisations = hospitalisations.slice(0, -1);
    } else {
      hospitalisations = [];
    }

    if (hospitalisations.length === 0) {
      contenu.innerHTML = "<p>Aucune hospitalisation antÃ©rieure.</p>";
      return;
    }

    contenu.innerHTML = "";

    // afficher les hospitalisations les plus rÃ©centes d'abord
    hospitalisations
      .slice()
      .reverse()
      .forEach((hospi, idx) => {
        const card = document.createElement("div");
        card.className = "card";

        // ğŸ¥ titre avec numÃ©ro dâ€™hospitalisation
    const numero = hospitalisations.length - idx;


        const titre = document.createElement("h2");
        titre.textContent = `ğŸ¥ Hospitalisation nÂ°${numero}`;
        titre.style.color = "#0078d4";
        titre.style.borderBottom = "3px solid #0078d4";
        titre.style.paddingBottom = "5px";
        titre.style.marginTop = "0";
        titre.style.marginBottom = "15px";

        // --- DonnÃ©es de l'hospitalisation ---
        const date = hospi.dateDebut || "Date inconnue";
        const datef = hospi.dateFin || "Date inconnue";
        const motif = hospi.motif || "â€”";
        const gravite = hospi.gravite || "â€”";
        const evolution = hospi.evolution || "Aucune Ã©volution enregistrÃ©e.";
        const dossier = hospi.dossierMedical || {};
        const sortie = hospi.sortie || null;
        const rapport = hospi.rapport || "Pas de rapport d'hospitalisation validÃ©";

        // --- Construction du contenu HTML ---
        const parts = [];
        parts.push(`<div class="entry"><strong>ğŸ“… Admission :</strong> ${date}</div>`);
        parts.push(`<div class="entry"><strong>ğŸ“… Sortie :</strong> ${datef}</div>`);
        parts.push(`<div class="entry"><strong>Motif :</strong> ${motif}</div>`);
        parts.push(`<div class="entry"><strong>GravitÃ© :</strong> ${gravite}</div>`);
        parts.push(`<hr>`);
        parts.push(`<h3>ğŸ“‹ Dossier mÃ©dical</h3>`);
        parts.push(`<p><strong>Questionnaire IAO :</strong><br>${dossier.questionnaire || "â€”"}</p>`);
        parts.push(`<p><strong>AntÃ©cÃ©dents :</strong><br>${dossier.antecedents || "â€”"}</p>`);
        parts.push(`<p><strong>Traitements :</strong><br>${dossier.traitements || "â€”"}</p>`);
        parts.push(`<p><strong>Histoire de la maladie :</strong><br>${dossier.histoire || "â€”"}</p>`);
        parts.push(`<p><strong>CR Auscultation :</strong><br>${dossier.auscultation || "â€”"}</p>`);
        parts.push(`<hr>`);
        parts.push(`<h3>ğŸ“ˆ Ã‰volution aux urgences</h3>`);
        parts.push(`<p style="white-space:pre-wrap">${evolution}</p>`);

        // --- Sortie ---
        if (sortie) {
          parts.push(`<hr>`);
          parts.push(`<h3>ğŸšª Sortie</h3>`);
          parts.push(`<p><strong>Type :</strong> ${sortie.type || "â€”"}</p>`);
          if (sortie.serviceHospitalisation)
            parts.push(`<p><strong>ğŸ¥ Service hospitalisation :</strong> ${sortie.serviceHospitalisation}</p>`);
          if (sortie.destinationTransfert)
            parts.push(`<p><strong>â†”ï¸ Destination transfert :</strong> ${sortie.destinationTransfert}</p>`);
          if (sortie.avisSpecialiste)
            parts.push(`<p><strong>ğŸ‘©â€âš•ï¸ Avis spÃ©cialiste :</strong> ${sortie.avisSpecialiste}</p>`);
          if (Array.isArray(sortie.options) && sortie.options.length > 0)
            parts.push(`<p><strong>ğŸ“‹ Options :</strong> ${sortie.options.join(", ")}</p>`);
          if (sortie.traitementSortie)
            parts.push(`<p><strong>ğŸ’Š Traitement de sortie :</strong><br>${sortie.traitementSortie}</p>`);
          if (sortie.autreSortieTexte)
            parts.push(`<p><strong>ğŸ”¤ Autre :</strong> ${sortie.autreSortieTexte}</p>`);
          if (sortie.autreOptionTexte)
            parts.push(`<p><strong>ğŸ”¤ Autre option :</strong> ${sortie.autreOptionTexte}</p>`);
        }

        parts.push(`<p><strong></strong> ${rapport}</p>`);

        // --- Injection dans la carte ---
        card.innerHTML = parts.join("\n");
        card.prepend(titre); // âœ… ajoute le titre au dÃ©but sans l'Ã©craser
        contenu.appendChild(card);
      });

  } catch (err) {
    console.error("Erreur chargement historique :", err);
    contenu.innerHTML = "<p>âŒ Erreur lors du chargement de l'historique.</p>";
  }
}






async function chargerExamens() {
  try {
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const data = snap.data();
    const hosp = data.hospitalisations?.[data.hospitalisationIndex];
    if (!hosp || !hosp.examens) {
      document.getElementById("examensListe").innerHTML = "<i>Aucun examen enregistrÃ©.</i>";
      return;
    }

    const liste = hosp.examens.map(ex => `
      <div class="examen-encart" style="margin-bottom:8px; padding:10px; border-radius:8px; background:${ex.realise ? '#eaf9ea' : '#f5faff'};">
        <p><b>â˜¢ï¸Type :</b> ${ex.type || "N/A"}</p>
        <p><b>ğŸ’¬Commentaire :</b> ${ex.commentaire || ""}</p>
        <p><b>ğŸ“…Date demande :</b> ${ex.dateDemande || "?"}</p>
        ${ex.realise ? `<p><b>âœ… RÃ©alisÃ© le :</b> ${ex.dateRealisation || "?"}</p>
		<p><b>ğŸ“„Compte rendu :</b> ${ex.compteRendu || ""}</p>` : ""}
      </div>
    `).join("");

    document.getElementById("examensListe").innerHTML = liste || "<i>Aucun examen enregistrÃ©.</i>";
  } catch (e) {
    console.error("Erreur lors du chargement des examens :", e);
    document.getElementById("examensListe").innerHTML = "<i>Erreur de chargement.</i>";
  }
}

const originalOpenTab = window.openTab;
window.openTab = function(tabName, evt) {
  originalOpenTab(tabName, evt);
  if (tabName === "tab-exam-actes") {
    chargerExamens();
  }
};
async function chargerActes() {
  try {
    const snap = await patientRef.get();
    if (!snap.exists) return;

    const data = snap.data();
    const hosp = data.hospitalisations?.[data.hospitalisationIndex];

    // Si aucun acte trouvÃ©
    if (!hosp || !hosp.actes) {
      document.getElementById("actesListe").innerHTML = "<i>Aucun acte enregistrÃ©.</i>";
      return;
    }

    // Construire l'affichage HTML
    const liste = hosp.actes.map((acte, i) => `
  <div class="prescription-item" style="margin-bottom:8px; padding:10px; border-radius:8px; background:#f5faff;">
    <p><b>ğŸ’‰ Type :</b> ${acte.type || "N/A"}</p>
    <p><b>ğŸ‘¨â€âš•ï¸ RÃ©alisÃ© par :</b> ${acte.realisateur || "?"}</p>
    <p><b>ğŸ“… Date :</b> ${acte.date || "?"}</p>
    ${acte.remarque ? `<p><b>ğŸ’¬ Remarque :</b> ${acte.remarque}</p>` : ""}
    <button class="btn-delete" onclick="supprimerActe(${i})">ğŸ—‘</button>
  </div>
`).join("");
    document.getElementById("actesListe").innerHTML = liste || "<i>Aucun acte enregistrÃ©.</i>";
  } catch (e) {
    console.error("Erreur lors du chargement des actes :", e);
    document.getElementById("actesListe").innerHTML = "<i>Erreur de chargement.</i>";
  }
}


async function supprimerActe(indexActe) {
  try {
    if (!confirm("Supprimer cet acte ?")) return;

    // Charger le document patient
    const snap = await patientRef.get();
    if (!snap.exists) {
      afficherBulle("âŒ Patient introuvable", "alerte");
      return;
    }

    const data = snap.data();
    const hospIndex = data.hospitalisationIndex ?? 0;
    const hospitalisations = data.hospitalisations || [];
    const hosp = hospitalisations[hospIndex];

    if (!hosp || !hosp.actes) {
      afficherBulle("âŒ Aucun acte Ã  supprimer", "alerte");
      return;
    }

    // Supprimer l'acte Ã  l'indice donnÃ©
    hosp.actes.splice(indexActe, 1);

    // Mettre Ã  jour Firestore
    hospitalisations[hospIndex] = hosp;
    await patientRef.update({ hospitalisations });

    afficherBulle("ğŸ—‘ï¸ Acte supprimÃ©", "administratif");
    await chargerActes(); // ğŸ”„ RafraÃ®chir la liste Ã  lâ€™Ã©cran
  } catch (err) {
    console.error("Erreur suppression acte :", err);
    afficherBulle("âŒ Erreur lors de la suppression", "alerte");
  }
}

async function chargerRealisateurs() {
  const select = document.getElementById("selectRealisateur");
  select.innerHTML = "<option>â³ Chargement...</option>";

  try {
    // On suppose que tu stockes les rÃ©alisateurs dans "rÃ©fÃ©rentiels/realisateurs"
    const doc = await db.collection("rÃ©fÃ©rentiels").doc("personnel").get();
    const data = doc.data();
    const liste = data?.liste || [];

    if (liste.length === 0) {
      select.innerHTML = "<option>Aucun disponible</option>";
      return;
    }

    select.innerHTML = "";
    liste.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r;
      opt.textContent = r;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Erreur chargement rÃ©alisateurs :", err);
    select.innerHTML = "<option>âš ï¸ Erreur de chargement</option>";
  }
}
// --- Fonction pour charger et afficher les examens ---

async function remplirDepuisAncienneHospi(champ) {
  try {
    const doc = await patientRef.get();
    const data = doc.data();
    const index = data.hospitalisationIndex ?? 0;

    if (index <= 0) {
      afficherBulle("âŒ Aucune hospitalisation antÃ©rieure", "alerte");
      return;
    }

    const ancienne = data.hospitalisations?.[index - 1]?.dossierMedical;
    if (!ancienne || !ancienne[champ]) {
      afficherBulle(`âŒ Pas d'ancien contenu pour ${champ}`, "alerte");
      return;
    }

    const contenu = ancienne[champ].trim();
    const textarea = document.getElementById(champ);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const avant = textarea.value.substring(0, start);
    const apres = textarea.value.substring(end);
    const insertion = contenu + "\n";

    textarea.value = avant + insertion + apres;

    const nouvellePosition = start + insertion.length;
    textarea.selectionStart = textarea.selectionEnd = nouvellePosition;
    textarea.focus();

    afficherBulle(`ğŸ“ Ancien ${champ} insÃ©rÃ©`, "administratif");

  } catch (err) {
    console.error("Erreur rÃ©cupÃ©ration donnÃ©es prÃ©cÃ©dentes :", err);
    afficherBulle("âŒ Erreur de rÃ©cupÃ©ration", "alerte");
  }
}

document.getElementById("btnRapportHospi").addEventListener("click", () => {
    window.location.href =`rapporthospitalisation.html?id=${patientId}`;
  });


document.addEventListener("DOMContentLoaded", () => {
  rafraichirChampsSortie();
  champAutreSortie.style.display = document.querySelector('input[name="typeSortie"][value="autre"]')?.checked ? "block" : "none";

  if (patientId) {
    chargerPatient(patientId);   // âœ… passer lâ€™ID
    chargerActes();
  } else {
    afficherBulle("âŒ Aucun patientId fourni dans lâ€™URL", "alerte");
  }
});


function updateTime() {
    const now = new Date();
    const formatted = now.toLocaleString(); // date + heure locale
    document.getElementById('currentTime').textContent = formatted;
}



	// --- Affiche lâ€™Ã©cran de chargement ---
window.afficherLoader = function() {
  let loader = document.getElementById("loadingScreen");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loadingScreen";
    loader.innerHTML = `
      <div class="loader-content">
        <div class="spinner"></div>
        <h2>Chargement...</h2>
      </div>
    `;
    document.body.appendChild(loader);
  }
  loader.style.display = "flex";
  loader.classList.remove("hidden");
};

// --- Masque lâ€™Ã©cran de chargement ---
window.masquerLoader = function() {
  const loader = document.getElementById("loadingScreen");
  if (loader) {
    loader.classList.add("hidden");
    setTimeout(() => {
      loader.style.display = "none";
    }, 500); // dÃ©lai pour lâ€™animation
  }
};

updateTime();

	setInterval(updateTime, 1000);
// Ligne de test de fin
console.log("Script terminÃ© correctement âœ…");
</script>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

   let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        medecinNom = data.nom || "";
        medecinSpecialite = data.specialite || "";
        medecinLieu = data.lieu || "";

        // Met Ã  jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise Ã  jour des Ã©lÃ©ments HTML si prÃ©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;

        const lieuElem = document.getElementById("lieu-medecin");
        if (lieuElem) lieuElem.textContent = medecinLieu;

        // --- VÃ©rification d'accÃ¨s Ã  la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("â›”ï¸ Vous nâ€™avez pas accÃ¨s Ã  cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant â€” redirection
        alert("Utilisateur non trouvÃ©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement mÃ©decin :", error);
      alert("Une erreur est survenue, veuillez rÃ©essayer plus tard.");
    }
  }
});
function initNavigation() {
  const items = document.querySelectorAll('.nav-item');
  
  items.forEach(item => {
    item.addEventListener('click', () => {
      // DÃ©sactiver tous les autres onglets
      items.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      
      // Cacher toutes les sections
      document.querySelectorAll('section[id^="panel-"]').forEach(sec => {
        sec.style.display = 'none';
      });

      // Afficher la section correspondante
      const module = item.getAttribute('data-module');
      const panel = document.getElementById('panel-' + module);
      if (panel) panel.style.display = 'block';

      // Charger lâ€™historique UNIQUEMENT si on clique sur lâ€™onglet historique
      if (module === 'historique') {
        chargerHistoriqueComplet();
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // Activer lâ€™onglet par dÃ©faut
  const ongletActif = document.querySelector(".nav-item.active");
  if (ongletActif) {
    const module = ongletActif.getAttribute("data-module");
    const panel = document.getElementById("panel-" + module);
    if (panel) panel.style.display = "block";
  }

  // Initialiser la navigation
  initNavigation();
});

// --- Gestion du menu responsive ---
const menuToggle = document.getElementById("menu-toggle");
const nav = document.querySelector("nav");
const navItems = document.querySelectorAll(".nav-item");

menuToggle.addEventListener("click", () => {
  nav.classList.toggle("open");
});

// Ferme le menu automatiquement quand on sÃ©lectionne un onglet
navItems.forEach(item => {
  item.addEventListener("click", () => {
    if (window.innerWidth <= 900) {
      nav.classList.remove("open");
    }
  });
});

// Ferme le menu si on clique Ã  lâ€™extÃ©rieur (mobile)
document.addEventListener("click", e => {
  if (window.innerWidth <= 900 && nav.classList.contains("open")) {
    if (!nav.contains(e.target) && e.target !== menuToggle) {
      nav.classList.remove("open");
    }
  }
});
// --- Gestion des menus dÃ©roulants supÃ©rieurs ---
document.querySelectorAll('.dropbtn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.stopPropagation();
    const parent = btn.parentElement;
    const isOpen = parent.classList.contains('show');

    // Fermer tous les autres menus
    document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));

    // Ouvrir/fermer celui cliquÃ©
    if (!isOpen) parent.classList.add('show');
  });
});

// Fermer les menus si on clique ailleurs
document.addEventListener('click', () => {
  document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
});
  function LogOut () {
    signOut(auth)
      .then(() => {
        window.location.href = "index.html";
      })
      .catch((error) => {
        afficherBulle("Erreur de dÃ©connexion" ,"alerte");
      });
  }
document.addEventListener("DOMContentLoaded", () => {

    const btnOrdo = document.querySelector('[data-module="medsurgences"]');

    btnOrdo.addEventListener("click", () => {
        // Charger lâ€™ordonnancier avec lâ€™ID patient
        const iframe = document.getElementById("medsurgencesFrame");
        iframe.src = "medsurgences.html?id=" + patientId;
    });

});


</script>

</body>
</html>



